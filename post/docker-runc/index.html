<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Dockerå®¹å™¨è¿è¡Œæ—¶å¼•æ“-runCåˆ†æ</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, docker'>

    <meta property="og:url" content="https://chinalhr.github.io/post/docker-runc/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Dockerå®¹å™¨è¿è¡Œæ—¶å¼•æ“-runCåˆ†æ">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Dockerå®¹å™¨è¿è¡Œæ—¶å¼•æ“-runCåˆ†æ">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/docker-runc/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/docker-runc/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/docker-runc/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Dockerå®¹å™¨è¿è¡Œæ—¶å¼•æ“-runCåˆ†æ</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            April 15, 2021
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/docker">docker</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>å®¹å™¨æŠ€æœ¯çš„æ¼”è¿›ï¼Œæ ‡å‡†çš„OCI Runtimeå®ç°-runCæºç åˆ†æ</p>
</blockquote>
<h2 id="dockercontainerdrunckubernetes">Dockerã€containerdã€runCã€Kubernetes</h2>
<h3 id="ä»dockeråˆ°containerdrunc">ä»Dockeråˆ°containerdã€runC</h3>
<p>Docker æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå®ƒå¯ä»¥å°†ä½ çš„åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªæ ‡å‡†æ ¼å¼çš„é•œåƒï¼Œå¹¶ä¸”ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œã€‚Docker å®¹å™¨å°†ä¸€ç³»åˆ—è½¯ä»¶åŒ…è£…åœ¨ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆä»£ç ã€è¿è¡Œæ—¶å·¥å…·ã€ç³»ç»Ÿå·¥å…·ã€ç³»ç»Ÿä¾èµ–&hellip;)ï¼Œä¿è¯äº†å®¹å™¨å†…åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒçš„ç¨³å®šæ€§ï¼Œä¸ä¼šè¢«å®¹å™¨å¤–çš„ç³»ç»Ÿç¯å¢ƒæ‰€å½±å“ã€‚</p>
<p>2013å¹´Dockerå®£å¸ƒå¼€æºï¼Œåˆå§‹é˜¶æ®µçš„Dockerå®¹å™¨åŒ–åŸºäºLXCå®ç°ï¼Œé•œåƒåˆ†å±‚æ–‡ä»¶ç³»ç»ŸåŸºäºAUFSï¼Œæ ¸å¿ƒåŠŸèƒ½éƒ½æ˜¯åŸºäºå½“æ—¶çš„ç°æˆæŠ€æœ¯ç»„è£…å®ç°ï¼Œä½†ç”±äºå…¶å·¥å…·ç”Ÿæ€å®Œå–„ã€å…¬å…±é•œåƒä»“åº“ã€ç»„å»ºé‡ç”¨ã€å¤šç‰ˆæœ¬æ”¯æŒã€ä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„å®¹å™¨å°è£…ç­‰ç‰¹æ€§ï¼Œè¿™ä¹Ÿä½¿å¾—Dockerç«é€Ÿåœ°æµè¡Œäº†èµ·æ¥ã€‚</p>
<blockquote>
<p>å¯ä»¥å‚è€ƒDockerç›¸å…³çš„FAQï¼š<a href="https://docs.docker.com/engine/faq/#what-does-docker-technology-add-to-just-plain-lxc">https://docs.docker.com/engine/faq</a></p>
</blockquote>
<p>åœ¨2014å¹´å¼€æºäº†åŸºäºGolangå¼€å‘çš„libcontainerï¼Œè¶Šè¿‡LXCç›´æ¥æ“ä½œç³»ç»Ÿ namespaces å’Œ cgroups çš„æ ¸å¿ƒæ¨¡å—ï¼Œä¸å¿…ä¾èµ–LXCæ¥æä¾›å®¹å™¨åŒ–éš”ç¦»èƒ½åŠ›äº†ï¼Œè‡ªèº«æ¶æ„ä¹Ÿä¸æ–­å‘å±•æ‹†åˆ†æˆäº†å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/118020412-a0d46700-b38c-11eb-8dad-3be7e8c0bb71.png">
    <img src="https://user-images.githubusercontent.com/19829495/118020412-a0d46700-b38c-11eb-8dad-3be7e8c0bb71.png" alt="DeepinScreenshot_select-area_20210513013836"  />
    </a>
</div></p>
<p>2015å¹´ï¼ŒDockerè”åˆå¤šå®¶å…¬å¸åˆ¶å®šäº†å¼€æ”¾å®¹å™¨äº¤äº’æ ‡å‡†ï¼ˆOpen Container Initiativeï¼‰ï¼Œå³OCIï¼›åˆ¶å®šäº†å…³äºå®¹å™¨ç›¸å…³çš„è§„èŒƒï¼ŒåŒ…å«è¿è¡Œæ—¶æ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/runtime-spec/blob/main/spec.md">runtime-spec</a>ï¼‰ã€å®¹å™¨é•œåƒæ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/image-spec/blob/main/spec.md">image-spec</a>ï¼‰å’Œé•œåƒåˆ†å‘æ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/distribution-spec/blob/main/spec.md">distribution-spec</a>ï¼‰ã€‚è¿è¡Œæ—¶æ ‡å‡†å®šä¹‰äº†åº”è¯¥å¦‚ä½•è¿è¡Œä¸€ä¸ªå®¹å™¨ã€å¦‚ä½•ç®¡ç†å®¹å™¨çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€å¦‚ä½•ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„åº•å±‚ç‰¹æ€§ï¼ˆnamespacesã€cgroupã€pivot_rootç­‰ï¼‰ï¼›å®¹å™¨é•œåƒæ ‡å‡†è§„å®šäº†å®¹å™¨é•œåƒçš„æ ¼å¼ã€é…ç½®ã€å…ƒæ•°æ®çš„æ ¼å¼ï¼›é•œåƒåˆ†å‘æ ‡å‡†åˆ™è§„å®šäº†é•œåƒæ¨é€å’Œæ‹‰å–çš„ç½‘ç»œäº¤äº’è¿‡ç¨‹ã€‚</p>
<p>ä¹‹åï¼ŒDockerä¸ºäº†ç¬¦åˆOCIæ ‡å‡†ï¼Œå°†åŸæœ¬libcontaineræ¨¡å—ç‹¬ç«‹å‡ºæ¥ï¼Œå°è£…é‡æ„æˆ <a href="https://github.com/opencontainers/runc">runC</a> é¡¹ç›®ï¼ŒæçŒ®ç»™äº†LinuxåŸºé‡‘ä¼šç®¡ç†ï¼Œè€Œåä¸ºäº†èƒ½å¤Ÿå…¼å®¹æ‰€æœ‰ç¬¦åˆæ ‡å‡†çš„OCI Runtimeå®ç°ï¼ŒDockeré‡æ„äº†Docker Daemonå­ç³»ç»Ÿï¼Œå°†å…¶ä¸­ä¸è¿è¡Œæ—¶äº¤äº’çš„éƒ¨åˆ†æŠ½è±¡ä¸º <a href="https://containerd.io/">containerd</a> é¡¹ç›® æçŒ®ç»™äº†CNCFåŸºé‡‘ä¼šç®¡ç†ï¼Œcontainerd è´Ÿè´£ç®¡ç†å®¹å™¨æ‰§è¡Œã€åˆ†å‘ã€ç›‘æ§ã€ç½‘ç»œã€æ„å»ºã€æ—¥å¿—ç­‰åŠŸèƒ½çš„æ ¸å¿ƒæ¨¡å—ï¼Œå†…éƒ¨ä¸ºæ¯ä¸ªå®¹å™¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªcontainerd-shimé€‚é…è¿›ç¨‹ï¼Œä¸runCæ­é…å·¥ä½œã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/118022236-b8145400-b38e-11eb-942c-57e68e255ae7.png">
    <img src="https://user-images.githubusercontent.com/19829495/118022236-b8145400-b38e-11eb-942c-57e68e255ae7.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<h3 id="docker-daemoncontainerdä¸runc">Docker Daemonã€containerdä¸runC</h3>
<p>containerdæä¾›äº†é•œåƒç®¡ç†ï¼ˆé•œåƒã€å…ƒä¿¡æ¯ç­‰ï¼‰ã€å®¹å™¨è¿è¡Œï¼ˆè°ƒç”¨æœ€ç»ˆè¿è¡Œæ—¶ç»„ä»¶æ‰§è¡Œï¼‰çš„åŠŸèƒ½ï¼Œå‘ä¸Šä¸º Docker Daemon æä¾›äº† gRPC æ¥å£ï¼Œä½¿å¾— Docker Daemon  å±è”½ä¸‹é¢çš„ç»“æ„å˜åŒ–ï¼Œç¡®ä¿åŸæœ‰æ¥å£å‘ä¸‹å…¼å®¹ï¼›å‘ä¸‹è¿è¡Œå®¹å™¨ç”±ç¬¦åˆOCIè§„èŒƒçš„å®¹å™¨æ”¯æŒï¼Œå¦‚runCï¼Œä½¿å¾—å¼•æ“å¯ä»¥ç‹¬ç«‹å‡çº§ã€‚</p>
<h3 id="kubernetesä¸docker">Kubernetesä¸Docker</h3>
<p>Kubernetes æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œç¼©æ”¾ï¼Œä»¥åŠå®¹å™¨åŒ–ç®¡ç†åº”ç”¨ç¨‹åºçš„å¼€æºç³»ç»Ÿï¼Œå‰èº«æ˜¯Googleå†…éƒ¨è¿è¡Œå¤šå¹´çš„é›†ç¾¤ç®¡ç†ç³»ç»ŸBorgã€‚</p>
<p>2014å¹´Googleä½¿ç”¨Golangå®Œå…¨é‡å†™åå¼€æºï¼Œè¯ç”Ÿåå¤‡å—äº‘è®¡ç®—ç›¸å…³çš„ä¸šç•Œå·¨å¤´è¿½æ§ï¼Œæˆä¸ºäº‘åŸç”Ÿæ—¶ä»£çš„æ“ä½œç³»ç»Ÿï¼Œè®©å¤æ‚è½¯ä»¶åœ¨äº‘è®¡ç®—ä¸‹è·å¾—éŸ§æ€§ï¼ˆResilienceï¼‰ã€å¼¹æ€§ï¼ˆElasticityï¼‰ã€å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰çš„æœ€ä½³è·¯å¾„ã€‚</p>
<p>2015å¹´Kuberneteså‘å¸ƒäº†ç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬1.0ç‰ˆï¼Œå¹¶ä¸”Googleå®£å¸ƒä¸LinuxåŸºé‡‘ä¼šå…±åŒç­¹å»º<a href="https://www.cncf.io/">äº‘åŸç”ŸåŸºé‡‘ä¼š</a>ï¼ˆCloud Native Computing Foundationï¼ŒCNCFï¼‰ï¼Œå¹¶ä¸”å°†Kubernetesæ‰˜ç®¡åˆ°CNCFï¼Œæˆä¸ºå…¶ç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚</p>
<p>éšç€Kubernetesçš„ç«é€Ÿæµè¡Œï¼Œè‡ªèº«çš„æ¶æ„ä¹Ÿåœ¨æ¸è¿›æ¼”åŒ–ï¼Œæ¼”è¿›è·¯çº¿å¦‚ä¸‹ï¼š</p>
<p>Kubernetes 1.5ç‰ˆæœ¬ä¹‹å‰ä¸Dockeræ˜¯å¼ºç»‘å®šçš„å…³ç³»ï¼ŒKubernetes ç®¡ç†å®¹å™¨çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡å†…éƒ¨çš„DockerManagerå‘Docker Engineå‘é€æŒ‡ä»¤ï¼ˆHTTPæ–¹å¼ï¼‰ï¼Œé€šè¿‡Dockeræ¥æ“ä½œé•œåƒï¼›è°ƒç”¨é“¾è·¯å¦‚ä¸‹æ‰€ç¤º</p>
<pre><code>    Kubernetes Master â†’ kubelet â†’ DockerManager â†’ Docker Engine â†’ containerd â†’ runC
</code></pre><p>Kubernetes 1.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆContainer Runtime Interfaceï¼ŒCRIï¼‰ï¼ŒCRIä¸ºå®šä¹‰å®¹å™¨è¿è¡Œæ—¶åº”è¯¥å¦‚ä½•æ¥å…¥åˆ°kubeletçš„è§„èŒƒæ ‡å‡†ï¼Œå†…éƒ¨çš„DockerManagerä¹Ÿè¢«KubeGenericRuntimeManageræ›¿ä»£ï¼Œå·²æä¾›æ›´é€šç”¨çš„å®ç°ï¼›kubeletä¸KubeGenericRuntimeManagerä¹‹é—´é€šè¿‡gRPCåè®®é€šä¿¡ã€‚ç”±äºDockerä¸èƒ½ç›´æ¥æ”¯æŒCRIï¼Œæ‰€ä»¥Kubernetesæä¾›äº†DockerShimæœåŠ¡ä½œä¸ºDockerä¸CRIçš„é€‚é…å±‚ï¼Œå®ç°äº†DockerManagerçš„åŠŸèƒ½ï¼Œ<strong>æ¼”åŒ–åˆ°è¿™é‡ŒDocker Engineå¯¹Kubernetesæ¥è¯´åªæ˜¯ä¸€é¡¹é»˜è®¤ä¾èµ–</strong>ï¼›è°ƒç”¨é“¾è·¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>    Kubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ DockerShim â†’ Docker Engine â†’ containerd â†’ runC
</code></pre><p>2017å¹´ï¼Œç”±Googleã€RedHatã€Intelã€SUSEã€IBMè”åˆå‘èµ·çš„<a href="https://github.com/cri-o/cri-o">CRI-O</a>ï¼ˆContainer Runtime Interface  Orchestratorï¼‰é¡¹ç›®å‘å¸ƒäº†é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚CRI-Oæ˜¯å®Œå…¨éµå¾ªCRIè§„èŒƒè¿›è¡Œå®ç°çš„ï¼Œè€Œä¸”å¯ä»¥æ”¯æŒæ‰€æœ‰ç¬¦åˆOCIè¿è¡Œæ—¶æ ‡å‡†çš„å®¹å™¨å¼•æ“ï¼Œé»˜è®¤ä½¿ç”¨runCæ­é…å·¥ä½œä¹Ÿå¯æ¢æˆå…¶ä»–OCIè¿è¡Œæ—¶ã€‚æ­¤æ—¶Kuberneteså¯ä»¥é€‰æ‹©ä½¿ç”¨CRI-Oã€cri-containerdã€DockerShimä½œä¸ºCRIå®ç°ï¼Œ<strong>æ¼”åŒ–åˆ°è¿™é‡ŒDocker Engineå¯¹Kubernetesæ¥è¯´åªæ˜¯ä¸€ä¸ªå¯é€‰é¡¹</strong>ï¼›è°ƒç”¨é“¾è·¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>    Kubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ CRI-O â†’ runC
</code></pre><p>2018å¹´ï¼Œç”±DockeræçŒ®ç»™CNCFçš„containerdå‘å¸ƒäº†1.1ç‰ˆï¼Œä¸1.0çš„åŒºåˆ«æ˜¯å®Œå…¨æ”¯æŒCRIæ ‡å‡†ï¼Œæ„å‘³ç€åŸæœ¬ç”¨ä½œCRIé€‚é…å™¨çš„cri-containerdä¸å†éœ€è¦äº†ï¼ŒKubernetesä¹Ÿåœ¨1.10ç‰ˆæœ¬å®£å¸ƒå¼€å§‹æ”¯æŒcontainerd 1.1ï¼Œ<strong>æ¼”åŒ–åˆ°è¿™é‡ŒKuberneteså·²ç»å¯ä»¥å®Œå…¨è„±å¼€Docker Engine</strong>ï¼›è°ƒç”¨é“¾è·¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>    Kubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ containerd â†’ runC
</code></pre><p>2020å¹´ï¼ŒKuberneteså®˜æ–¹å®£å¸ƒä»1.20ç‰ˆæœ¬èµ·æ”¾å¼ƒå¯¹Dockerçš„æ”¯æŒï¼Œå³ä¸åœ¨ç»´æŠ¤DockerShimè¿™ä¸€Dockerä¸CRIçš„é€‚é…å±‚ï¼›å¾€åCRIé€‚é…å™¨å¯ä»¥é€‰æ‹©CRI-Oæˆ–è€…containerdã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/154808848-2c154bed-128d-4a7b-85ca-5ee48b5cd672.jpg">
    <img src="https://user-images.githubusercontent.com/19829495/154808848-2c154bed-128d-4a7b-85ca-5ee48b5cd672.jpg" alt="118159973-47ce0700-b450-11eb-84aa-a54af0d9adb2"  />
    </a>
</div></p>
<h2 id="å®¹å™¨è¿è¡Œæ—¶-runcåˆ†æ">å®¹å™¨è¿è¡Œæ—¶-runCåˆ†æ</h2>
<p>runcæ˜¯ä¸€ä¸ªCLIå·¥å…·ï¼Œç”¨äºæ ¹æ®OCIè§„èŒƒç”Ÿæˆå’Œè¿è¡Œå®¹å™¨ï¼Œè¿™é‡Œä¼šé€šè¿‡runCæºç ç®€å•åˆ†æå…¶è¿è¡ŒåŸç†ä¸æµç¨‹ã€‚runCå¯ä»¥è¯´æ˜¯Dockerå®¹å™¨ä¸­æœ€ä¸ºæ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ç­‰æ“ä½œæœ€ç»ˆéƒ½å°†é€šè¿‡è°ƒç”¨runCå®Œæˆã€‚</p>
<h3 id="ociæ ‡å‡†">OCIæ ‡å‡†</h3>
<p><strong>image spec</strong></p>
<p>OCI å®¹å™¨é•œåƒæ ‡å‡†åŒ…å«å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p>
<ol>
<li>config.jsonï¼šåŒ…å«å®¹å™¨å¿…éœ€çš„å…ƒä¿¡æ¯</li>
<li>rootfsï¼šå®¹å™¨rootæ–‡ä»¶ç³»ç»Ÿï¼Œä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œ</li>
</ol>
<p>config.jsonåŒ…å«çš„å…ƒç´ å¦‚ä¸‹æ‰€ç¤ºï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="https://github.com/opencontainers/runtime-spec/blob/main/config.md">runtime-specç›¸å…³æ–‡æ¡£</a></p>
<pre><code>ociVersionï¼šæŒ‡å®šOCIå®¹å™¨çš„ç‰ˆæœ¬å·
rootï¼šé…ç½®å®¹å™¨çš„rootæ–‡ä»¶ç³»ç»Ÿ
processï¼šé…ç½®å®¹å™¨è¿›ç¨‹ä¿¡æ¯
hostnameï¼šé…ç½®å®¹å™¨çš„ä¸»æœºå
mountsï¼šé…ç½®é¢å¤–çš„æŒ‚è½½ç‚¹
hookï¼šé…ç½®å®¹å™¨ç”Ÿå‘½å‘¨æœŸè§¦å‘é’©å­
</code></pre><p><strong>runtime spec</strong></p>
<p>OCI å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†ä¸»è¦æ˜¯æŒ‡å®šå®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œå’Œ runtime éœ€è¦æä¾›çš„å‘½ä»¤ï¼Œå¦‚ä¸‹çŠ¶æ€æµè½¬å›¾æ‰€ç¤ºï¼š</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/118305620-cd1dee00-b51a-11eb-8fa5-814f86ca0f42.png">
    <img src="https://user-images.githubusercontent.com/19829495/118305620-cd1dee00-b51a-11eb-8fa5-814f86ca0f42.png" alt="DeepinScreenshot_select-area_20210515011303"  />
    </a>
</div></p>
<p><strong>åŸºäºbusyboxåˆ›å»ºOCI runtime bundleç›¸å…³æ–‡ä»¶</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull busybox
mkdir mycontainer <span style="color:#f92672">&amp;&amp;</span> cd mycontainer
mkdir rootfs
<span style="color:#75715e"># åˆ›å»ºrootfsï¼ŒåŸºäºbusyboxé•œåƒ</span>
docker export <span style="color:#66d9ef">$(</span>docker create busybox<span style="color:#66d9ef">)</span> | tar -C rootfs -xvf -
<span style="color:#75715e"># æ ¹æ®OCIè§„èŒƒæ¥ç”Ÿæˆé…ç½®æ–‡ä»¶</span>
runc spec
</code></pre></div><p>æ–‡ä»¶ç›®å½•å¦‚ä¸‹æ‰€ç¤º</p>
<pre><code>â””â”€â”€ mycontainer
    â”œâ”€â”€ config.json
    â””â”€â”€ rootfs
        â”œâ”€â”€ bin
        â”œâ”€â”€ dev
        â”œâ”€â”€ etc
        â”œâ”€â”€ home
        â”œâ”€â”€ proc
        â”œâ”€â”€ root
        â”œâ”€â”€ sys
        â”œâ”€â”€ tmp
        â”œâ”€â”€ usr
        â””â”€â”€ var
</code></pre><h3 id="runcç›¸å…³å‘½ä»¤">runCç›¸å…³å‘½ä»¤</h3>
<p>é€šè¿‡runc -hå¯ä»¥çœ‹åˆ°runcæ”¯æŒçš„å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>checkpoint  checkpointæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œé…åˆrestoreä½¿ç”¨
create      åˆ›å»ºå®¹å™¨
delete      åˆ é™¤å®¹å™¨åŠå®¹å™¨æ‰€æ‹¥æœ‰çš„ä»»ä½•èµ„æº
events      æ˜¾ç¤ºå®¹å™¨äº‹ä»¶ï¼Œå¦‚OOMé€šçŸ¥ï¼Œcpuï¼Œå†…å­˜å’ŒIOä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¿¡æ¯
exec        åœ¨å®¹å™¨å†…æ‰§è¡Œæ–°çš„è¿›ç¨‹
init        åˆå§‹åŒ–namespaceå¹¶å¯åŠ¨è¿›ç¨‹
kill        å‘é€æŒ‡å®šçš„killä¿¡å·ï¼ˆé»˜è®¤å€¼ï¼šSIGTERMï¼‰åˆ°å®¹å™¨çš„initè¿›ç¨‹
list        åˆ—å‡ºå®¹å™¨
pause       æš‚åœå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹
ps          æ˜¾ç¤ºåœ¨å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹
restore     ä»ä¹‹å‰çš„checkpointè¿˜åŸå®¹å™¨
resume      æ¢å¤å®¹å™¨å†…æš‚åœçš„æ‰€æœ‰è¿›ç¨‹
run         åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨
spec        åˆ›å»ºspecificationæ–‡ä»¶
start       åœ¨åˆ›å»ºçš„å®¹å™¨ä¸­æ‰§è¡Œç”¨æˆ·å®šä¹‰çš„è¿›ç¨‹
state       è¾“å‡ºå®¹å™¨çš„çŠ¶æ€
update      æ›´æ–°å®¹å™¨èµ„æºçº¦æŸï¼Œå¦‚cgroupå‚æ•°
</code></pre><p>å®è·µæ“ä½œï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 1. ä¿®æ”¹configæ–‡ä»¶ä¸­çš„processå…ƒç´ çš„terminalä¸args</span>
<span style="color:#e6db74">&#34;process&#34;</span>: <span style="color:#f92672">{</span>
		<span style="color:#e6db74">&#34;terminal&#34;</span>: false,
		<span style="color:#e6db74">&#34;args&#34;</span>: <span style="color:#f92672">[</span>
			<span style="color:#e6db74">&#34;/bin/sleep&#34;</span>, <span style="color:#e6db74">&#34;3600&#34;</span>
		<span style="color:#f92672">]</span>
<span style="color:#75715e"># 2. runc createåˆ›å»ºå®¹å™¨ï¼ˆæ­¤æ—¶çŠ¶æ€ä¸ºcreated,å®¹å™¨å†…è¿›ç¨‹ä¸ºinitè¿›ç¨‹ï¼‰</span>
sudo runc create mycontainer
<span style="color:#75715e"># 3. runc startå¯åŠ¨å®¹å™¨ï¼ˆæ­¤æ—¶çŠ¶æ€ä¸ºrunningï¼Œå®¹å™¨å†…è¿›ç¨‹ä¸ºæˆ‘ä»¬æŒ‡å®šçš„è¿›ç¨‹ï¼‰</span>
sudo runc start mycontainer
<span style="color:#75715e"># 4. runc æš‚åœ/æ¢å¤å®¹å™¨ï¼ˆæš‚åœæ—¶çŠ¶æ€ä¸ºpauseï¼‰</span>
sudo runc pause mycontainer
sudo runc resume mycontainer
<span style="color:#75715e"># 5. runc killå…³é—­å®¹å™¨ï¼ˆæ­¤æ—¶çŠ¶æ€ä¸ºstoppedï¼‰</span>
sudo runc kill mycontainer
<span style="color:#75715e"># 6. runc deleteåˆ é™¤å®¹å™¨</span>
sudo runc delete mycontainer
<span style="color:#75715e"># 7. runc runç»„åˆå‘½ä»¤ï¼Œç»„åˆäº†runc createåˆ›å»ºï¼Œrunc startå¯åŠ¨ä»¥åŠåœ¨é€€å‡ºä¹‹årunc deleteçš„åˆ é™¤å‘½ä»¤</span>
sudo runc run mycontainer
</code></pre></div><h3 id="runc-run">runC-run</h3>
<p>runCæºç åœ¨github <a href="https://github.com/opencontainers/runc">runc</a> é¡¹ç›®å¯ä»¥è·å–åˆ°ï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å¦‚<code>create.go</code>ã€<code>delete.go</code>ç­‰æ–‡ä»¶ä¸ºrunCå‘½ä»¤çš„å®ç°ï¼›<code>libcontainer</code>ç›®å½•ä¸ºæ ¸å¿ƒåŒ…ï¼ˆå‚è€ƒä¸Šæ–‡runCçš„ç”±æ¥ï¼‰ï¼Œå¯è§runCæœ¬è´¨ä¸Šæ˜¯å¯¹<code>libcontainer</code>çš„ä¸€å±‚å°è£…ï¼Œåœ¨<code>libcontainer</code>ä¸ŠåŠ äº†ä¸€å±‚OCIçš„é€‚é…æ“ä½œä¸hookï¼›<code>main.go</code>æ˜¯å…¥å£æ–‡ä»¶ï¼Œä½¿ç”¨ <code>github.com/urfave/cli</code> åº“è¿›è¡Œå‘½ä»¤è¡Œè§£æä¸æ‰§è¡Œå‡½æ•°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tree -L <span style="color:#ae81ff">1</span> -F --dirsfirst
.
â”œâ”€â”€ contrib/
â”œâ”€â”€ docs/
â”œâ”€â”€ libcontainer/
â”œâ”€â”€ man/
â”œâ”€â”€ script/
â”œâ”€â”€ tests/
â”œâ”€â”€ types/
â”œâ”€â”€ vendor/
â”œâ”€â”€ checkpoint.go
â”œâ”€â”€ create.go
â”œâ”€â”€ delete.go
â”œâ”€â”€ events.go
â”œâ”€â”€ exec.go
â”œâ”€â”€ init.go
â”œâ”€â”€ kill.go
â”œâ”€â”€ list.go
â”œâ”€â”€ main.go
â”œâ”€â”€ pause.go
â”œâ”€â”€ ps.go
â”œâ”€â”€ restore.go
â”œâ”€â”€ run.go
â”œâ”€â”€ spec.go
â”œâ”€â”€ start.go
â”œâ”€â”€ state.go
...
</code></pre></div><p>é€šè¿‡<code>run.go</code>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°runCommandç›¸å…³çš„æ‰§è¡Œé€»è¾‘ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">Action</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">checkArgs</span>(<span style="color:#a6e22e">context</span>, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">exactArgs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">revisePidFile</span>(<span style="color:#a6e22e">context</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">setupSpec</span>(<span style="color:#a6e22e">context</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">startContainer</span>(<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">spec</span>, <span style="color:#a6e22e">CT_ACT_RUN</span>, <span style="color:#66d9ef">nil</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#a6e22e">status</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
</code></pre></div><p>è¿™é‡Œä¸»è¦æ¶‰åŠå››æ­¥æ“ä½œï¼š</p>
<ol>
<li>å‚æ•°æ ¡éªŒ</li>
<li>è‹¥æŒ‡å®šäº†pidFileï¼Œè¿›è¡Œè·¯å¾„è½¬æ¢</li>
<li>è¯»å– <code>config.json</code> æ–‡ä»¶è½¬æ¢æˆ spec ç»“æ„å¯¹è±¡</li>
<li>æ ¹æ®é…ç½®å¯åŠ¨å®¹å™¨</li>
</ol>
<p>ç¬¬å››æ­¥æ˜¯æ“ä½œè°ƒç”¨äº†<code>utils_linux.go</code>ä¸‹<code>startContainer</code>æ–¹æ³•è¿›è¡Œå®¹å™¨åˆ›å»ºã€è¿è¡Œï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startContainer</span>(<span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">action</span> <span style="color:#a6e22e">CtAct</span>, <span style="color:#a6e22e">criuOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">libcontainer</span>.<span style="color:#a6e22e">CriuOpts</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Args</span>().<span style="color:#a6e22e">First</span>()
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">container</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createContainer</span>(<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">spec</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">runner</span>{
		<span style="color:#a6e22e">enableSubreaper</span>: !<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;no-subreaper&#34;</span>),
		<span style="color:#a6e22e">shouldDestroy</span>:   <span style="color:#66d9ef">true</span>,
		<span style="color:#a6e22e">container</span>:       <span style="color:#a6e22e">container</span>,
		<span style="color:#a6e22e">listenFDs</span>:       <span style="color:#a6e22e">listenFDs</span>,
		<span style="color:#a6e22e">notifySocket</span>:    <span style="color:#a6e22e">notifySocket</span>,
		<span style="color:#a6e22e">consoleSocket</span>:   <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;console-socket&#34;</span>),
		<span style="color:#a6e22e">detach</span>:          <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;detach&#34;</span>),
		<span style="color:#a6e22e">pidFile</span>:         <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;pid-file&#34;</span>),
		<span style="color:#a6e22e">preserveFDs</span>:     <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;preserve-fds&#34;</span>),
		<span style="color:#a6e22e">action</span>:          <span style="color:#a6e22e">action</span>,
		<span style="color:#a6e22e">criuOpts</span>:        <span style="color:#a6e22e">criuOpts</span>,
		<span style="color:#a6e22e">init</span>:            <span style="color:#66d9ef">true</span>,
		<span style="color:#a6e22e">logLevel</span>:        <span style="color:#a6e22e">logLevel</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Process</span>)
}
</code></pre></div><ol>
<li>é€šè¿‡è°ƒç”¨<code>createContainer</code>åˆ›å»ºå‡ºé€»è¾‘å®¹å™¨ï¼ˆåŒ…å«ä¿å­˜äº†namespaceã€cgroupsã€mounts&hellip;å®¹å™¨é…ç½®ï¼‰</li>
<li>åˆ›å»º<code>runner</code>å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨<code>runner</code>çš„runæ–¹æ³•è¿è¡Œå®¹å™¨è¿›ç¨‹ï¼Œå¹¶è¿›è¡Œå¯¹åº”çš„è®¾ç½®</li>
</ol>
<p><strong>Factoryåˆ›å»ºé€»è¾‘å®¹å™¨</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createContainer</span>(<span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">libcontainer</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
    <span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specconv</span>.<span style="color:#a6e22e">CreateLibcontainerConfig</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specconv</span>.<span style="color:#a6e22e">CreateOpts</span>{
		<span style="color:#a6e22e">CgroupName</span>:       <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">UseSystemdCgroup</span>: <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">GlobalBool</span>(<span style="color:#e6db74">&#34;systemd-cgroup&#34;</span>),
		<span style="color:#a6e22e">NoPivotRoot</span>:      <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;no-pivot&#34;</span>),
		<span style="color:#a6e22e">NoNewKeyring</span>:     <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;no-new-keyring&#34;</span>),
		<span style="color:#a6e22e">Spec</span>:             <span style="color:#a6e22e">spec</span>,
		<span style="color:#a6e22e">RootlessEUID</span>:     <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Geteuid</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">RootlessCgroups</span>:  <span style="color:#a6e22e">rootlessCg</span>,
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">factory</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">loadFactory</span>(<span style="color:#a6e22e">context</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">config</span>)
}
</code></pre></div><ol>
<li>é€šè¿‡<code>specconv.CreateLibcontainerConfig</code>æŠŠspecè½¬æ¢æˆlibcontainerå†…éƒ¨configå¯¹è±¡</li>
<li>é€šè¿‡factory æ¨¡å¼è·å–å¯¹åº”å¹³å°çš„factoryå®ç°ï¼ˆç›®å‰ä»…linuxå¹³å°æ”¯æŒï¼‰,å¦‚<code>libcontainer/factory_linux.go</code>ï¼Œå¹¶è°ƒç”¨å…¶Createæ–¹æ³•æ„å»ºè¿”å›<code>libcontainer.Container</code> å¯¹è±¡ï¼ˆåŒ…å«å®¹å™¨å‘½ä»¤çš„å®ç°ï¼Œå¦‚Runã€Startã€State&hellip;ï¼‰</li>
<li>æ³¨æ„<code>libcontainer/factory_linux.go</code>Newæ–¹æ³•çš„InitPathä¸º<code>/proc/self/exe</code>ï¼ŒInitArgsä¸ºinit</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LinuxFactory</span>) <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">configs</span>.<span style="color:#a6e22e">Config</span>) (<span style="color:#a6e22e">Container</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">linuxContainer</span>{
		<span style="color:#a6e22e">id</span>:            <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">root</span>:          <span style="color:#a6e22e">containerRoot</span>,
		<span style="color:#a6e22e">config</span>:        <span style="color:#a6e22e">config</span>,
		<span style="color:#a6e22e">initPath</span>:      <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">InitPath</span>,
		<span style="color:#a6e22e">initArgs</span>:      <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">InitArgs</span>,
		<span style="color:#a6e22e">criuPath</span>:      <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">CriuPath</span>,
		<span style="color:#a6e22e">newuidmapPath</span>: <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewuidmapPath</span>,
		<span style="color:#a6e22e">newgidmapPath</span>: <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewgidmapPath</span>,
		<span style="color:#a6e22e">cgroupManager</span>: <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewCgroupsManager</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Cgroups</span>, <span style="color:#66d9ef">nil</span>),
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewIntelRdtManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">intelRdtManager</span> = <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewIntelRdtManager</span>(<span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">id</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">state</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">stoppedState</span>{<span style="color:#a6e22e">c</span>: <span style="color:#a6e22e">c</span>}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">root</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">LinuxFactory</span>) <span style="color:#66d9ef">error</span>) (<span style="color:#a6e22e">Factory</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">LinuxFactory</span>{
		<span style="color:#a6e22e">Root</span>:      <span style="color:#a6e22e">root</span>,
		<span style="color:#a6e22e">InitPath</span>:  <span style="color:#e6db74">&#34;/proc/self/exe&#34;</span>,
		<span style="color:#a6e22e">InitArgs</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;init&#34;</span>},
		<span style="color:#a6e22e">Validator</span>: <span style="color:#a6e22e">validate</span>.<span style="color:#a6e22e">New</span>(),
		<span style="color:#a6e22e">CriuPath</span>:  <span style="color:#e6db74">&#34;criu&#34;</span>,
	}
	<span style="color:#a6e22e">Cgroupfs</span>(<span style="color:#a6e22e">l</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">options</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opt</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opt</span>(<span style="color:#a6e22e">l</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">l</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><strong>Runnerè¿è¡Œå®¹å™¨-container_linux.start</strong></p>
<p>runnerçš„runæ–¹æ³•ä¼šæ ¹æ®OCI specs.Processç”Ÿæˆ <code>libcontainer.Process</code>é€»è¾‘processå¯¹è±¡ï¼ˆåŒ…å«è¿›ç¨‹çš„å‘½ä»¤ã€å‚æ•°ã€ç¯å¢ƒå˜é‡ã€ç”¨æˆ·&hellip;ï¼‰ï¼›æ ¹æ®å¯¹åº”çš„commandå¦‚runä¼šè°ƒç”¨containerçš„Runæ–¹æ³•ï¼Œåœ¨linuxå¹³å°ä¸‹æœ€ç»ˆä¼šè°ƒç”¨<code>container_linux</code>çš„startæ–¹æ³•ä¸execæ–¹æ³•ï¼Œstartæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">linuxContainer</span>) <span style="color:#a6e22e">start</span>(<span style="color:#a6e22e">process</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Process</span>) (<span style="color:#a6e22e">retErr</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">parent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">newParentProcess</span>(<span style="color:#a6e22e">process</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;creating new parent process&#34;</span>)
	}
    <span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">start</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;starting container process&#34;</span>)
	}
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">//æ›´æ–°å®¹å™¨çŠ¶æ€ï¼ŒPostStart Hookå›è°ƒ
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">linuxContainer</span>) <span style="color:#a6e22e">newParentProcess</span>(<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Process</span>) (<span style="color:#a6e22e">parentProcess</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">parentInitPipe</span>, <span style="color:#a6e22e">childInitPipe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">NewSockPair</span>(<span style="color:#e6db74">&#34;init&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;creating new init pipe&#34;</span>)
	}
	<span style="color:#a6e22e">messageSockPair</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filePair</span>{<span style="color:#a6e22e">parentInitPipe</span>, <span style="color:#a6e22e">childInitPipe</span>}

	<span style="color:#a6e22e">parentLogPipe</span>, <span style="color:#a6e22e">childLogPipe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Pipe</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Unable to create the log pipe:  %s&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">logFilePair</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filePair</span>{<span style="color:#a6e22e">parentLogPipe</span>, <span style="color:#a6e22e">childLogPipe</span>}

	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">commandTemplate</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">childInitPipe</span>, <span style="color:#a6e22e">childLogPipe</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Init</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">newSetnsProcess</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">messageSockPair</span>, <span style="color:#a6e22e">logFilePair</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">includeExecFifo</span>(<span style="color:#a6e22e">cmd</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;including execfifo in cmd.Exec setup&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">newInitProcess</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">messageSockPair</span>, <span style="color:#a6e22e">logFilePair</span>)
}
</code></pre></div><p><code>newParentProcess</code>æ–¹æ³•æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ol>
<li>åˆ›å»º<code>parentPipe</code> å’Œ <code>childPipe</code> è¿›ç¨‹é€šä¿¡ç®¡é“ç”¨äºçˆ¶è¿›ç¨‹ä¸å®¹å™¨å†…çˆ¶è¿›ç¨‹è¿›è¡Œé€šä¿¡</li>
<li>cmdå°è£…å®¹å™¨çˆ¶è¿›ç¨‹è¿è¡Œæ¨¡æ¿<code>/proc/self/exe - init</code></li>
<li>åˆ›å»ºinitProcessï¼Œå³å®¹å™¨å†…çˆ¶è¿›ç¨‹é€»è¾‘å¯¹è±¡ï¼ŒåŒ…å«ï¼ˆcmdã€é€»è¾‘processå¯¹è±¡ã€paerentPipe<code>å’Œ</code>childPipeç­‰ï¼‰</li>
</ol>
<p><code>newParentProcess</code>è¿”å›initProcesså<code>container_linux</code>çš„startæ–¹æ³•ä¼šè°ƒç”¨initProcessçš„startæ–¹æ³•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">initProcess</span>) <span style="color:#a6e22e">start</span>() (<span style="color:#a6e22e">retErr</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">messageSockPair</span>.<span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#75715e">//å¯åŠ¨å®¹å™¨initè¿›ç¨‹
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">ops</span> = <span style="color:#a6e22e">p</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">messageSockPair</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">logFilePair</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#a6e22e">waitInit</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initWaiter</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">messageSockPair</span>.<span style="color:#a6e22e">parent</span>)
	<span style="color:#f92672">...</span>
    <span style="color:#75715e">//å°†å®¹å™¨pidåŠ å…¥åˆ°cgroup ä¸­
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">pid</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;applying cgroup configuration for process&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">intelRdtManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">intelRdtManager</span>.<span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">pid</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;applying Intel RDT configuration for process&#34;</span>)
		}
	}
    <span style="color:#75715e">//å‘å®¹å™¨initè¿›ç¨‹å‘é€bootstrapDataï¼Œå³åˆå§‹åŒ–æ•°æ®
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">messageSockPair</span>.<span style="color:#a6e22e">parent</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">bootstrapData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;copying bootstrap data to pipe&#34;</span>)
	}
    <span style="color:#75715e">//ç­‰å¾…å®¹å™¨initè¿›ç¨‹åˆå§‹åŒ–
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">waitInit</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">//åˆ›å»ºç½‘ç»œ interface
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">createNetworkInterfaces</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;creating network interfaces&#34;</span>)
	}
    <span style="color:#75715e">//æ›´æ–°SpecçŠ¶æ€
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">updateSpecState</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;updating the spec state&#34;</span>)
	}
    <span style="color:#75715e">// ç»™å®¹å™¨initè¿›ç¨‹å‘é€è¿›ç¨‹é…ç½®ä¿¡æ¯
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendConfig</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;sending config to init process&#34;</span>)
	}
	<span style="color:#75715e">//å’Œå®¹å™¨initè¿›ç¨‹è¿›è¡ŒåŒæ­¥,å¾…å…¶åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæ‰§è¡ŒHookå›è°ƒæ“ä½œï¼Œè®¾ç½®cgroupï¼Œæœ€åï¼Œå…³é—­initç®¡é“ï¼Œå®¹å™¨åˆ›å»ºå®Œæˆ
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ierr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseSync</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">messageSockPair</span>.<span style="color:#a6e22e">parent</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">sync</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">syncT</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    }
	<span style="color:#f92672">...</span>
}
</code></pre></div><p>initProcessçš„startæ“ä½œä¸»è¦æ¶‰åŠå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ‰§è¡Œcmdå‘½ä»¤ï¼Œé€šè¿‡<code>/proc/self/exe - init</code>å¯åŠ¨å®¹å™¨initè¿›ç¨‹æ‰§è¡Œinit commandæ“ä½œ</li>
<li>å‘å®¹å™¨initè¿›ç¨‹å‘é€bootstrapDataåˆå§‹åŒ–æ•°æ®</li>
<li>åˆ›å»ºç½‘ç»œ interface</li>
<li>å’Œå®¹å™¨initè¿›ç¨‹è¿›è¡ŒåŒæ­¥,å¾…å…¶åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæ‰§è¡ŒHookå›è°ƒæ“ä½œï¼Œè®¾ç½®cgroupï¼Œæœ€åï¼Œå…³é—­initç®¡é“ï¼Œå®¹å™¨åˆ›å»ºå®Œæˆ</li>
</ol>
<p><strong>Runnerè¿è¡Œå®¹å™¨-container_linux.exec</strong></p>
<p>å…·ä½“å®ç°å¦‚ä¸‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">linuxContainer</span>) <span style="color:#a6e22e">exec</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">root</span>, <span style="color:#a6e22e">execFifoFilename</span>)
	<span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">initProcess</span>.<span style="color:#a6e22e">pid</span>()
	<span style="color:#a6e22e">blockingFifoOpenCh</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">awaitFifoOpen</span>(<span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">blockingFifoOpenCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handleFifoResult</span>(<span style="color:#a6e22e">result</span>)

		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>):
			<span style="color:#a6e22e">stat</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">pid</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">stat</span>.<span style="color:#a6e22e">State</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">Zombie</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">handleFifoResult</span>(<span style="color:#a6e22e">fifoOpen</span>(<span style="color:#a6e22e">path</span>, <span style="color:#66d9ef">false</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;container process is already dead&#34;</span>)
				}
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}
		}
	}
}
</code></pre></div><p>é€šè¿‡æ‰“å¼€è·¯å¾„<code>exec.fifo</code>çš„ç®¡é“ï¼Œè°ƒç”¨<code>readFromExecFifo</code>ä»ç®¡é“ä¸­å°†å®¹å™¨initè¿›ç¨‹ä»å†™å…¥çš„ä¿¡æ¯è¯»å‡ºã€‚ä¸€æ—¦ç®¡é“ä¸­çš„æ•°æ®è¢«è¯»å‡ºï¼Œå®¹å™¨initè¿›ç¨‹å°†ä¸å†è¢«é˜»å¡ï¼Œå®Œæˆä¹‹åçš„<code>Exec</code>ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ—¶å€™å®¹å™¨initè¿›ç¨‹åˆ‡æ¢ä¸ºcommandæŒ‡å®šçš„è¿›ç¨‹ã€‚</p>
<h3 id="runc-init">runC-init</h3>
<p>ä¸Šæ–‡åˆ†ærunc runæµç¨‹ï¼Œåœ¨æœ€åé€šè¿‡<code>/proc/self/exe - init</code>å¯åŠ¨å®¹å™¨initè¿›ç¨‹æ‰§è¡Œinit commandæ“ä½œï¼Œè¿™é‡Œç›´æ¥è¿½æº¯åˆ°initæ“ä½œçš„æ ¸å¿ƒæ–¹æ³•<code>standard_init_linux.go</code>ä¸‹çš„Initæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">linuxStandardInit</span>) <span style="color:#a6e22e">Init</span>() <span style="color:#66d9ef">error</span> {

	<span style="color:#75715e">//é…ç½®å®¹å™¨ç½‘ç»œä¸è·¯ç”±
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">setupNetwork</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">config</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">setupRoute</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Config</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//è®¾ç½®rootfsï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œchroot
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareRootfs</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">pipe</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">config</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//é…ç½®console, hostname, apparmor, sysctlï¼Œseccompï¼Œuser namespace...
</span><span style="color:#75715e"></span>	<span style="color:#f92672">...</span>
	<span style="color:#75715e">//åŒæ­¥çˆ¶è¿›ç¨‹ initè¿›ç¨‹å‡†å¤‡æ‰§è¡Œexec
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">syncParentReady</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">pipe</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;sync ready&#34;</span>)
	}
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">//å·²å®Œæˆåˆå§‹åŒ–ï¼Œå…³é—­ç®¡é“
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">pipe</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">//å‘exec.fifoç®¡é“å†™å…¥æ•°æ®ï¼Œé˜»å¡åˆ°execæ‰§è¡Œï¼Œè¯»å–ç®¡é“ä¸­çš„æ•°æ®
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/proc/self/fd/&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">fifoFd</span>), <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">O_WRONLY</span>|<span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">O_CLOEXEC</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;open exec fifo&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">fd</span>, []byte(<span style="color:#e6db74">&#34;0&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;write 0 exec fifo&#34;</span>)
	}
	<span style="color:#75715e">//è°ƒç”¨Execç³»ç»Ÿå‘½ä»¤ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>:], <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Environ</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSystemErrorWithCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;exec user process&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>è¿™é‡Œæ¶‰åŠå¦‚ä¸‹å‡ æ­¥æ“ä½œï¼š</p>
<ol>
<li>é…ç½®å®¹å™¨ç½‘ç»œä¸è·¯ç”±</li>
<li>è®¾ç½®rootfsï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œchroot</li>
<li>é…ç½®console, hostname, apparmor, sysctlï¼Œseccompï¼Œuser namespace</li>
<li>åŒæ­¥çˆ¶è¿›ç¨‹ï¼Œè®©çˆ¶è¿›ç¨‹æ‰§è¡Œhookç­‰æ“ä½œ</li>
<li>è°ƒç”¨Execç³»ç»Ÿå‘½ä»¤ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹ï¼Œæ­¤æ—¶å®¹å™¨çš„initè¿›ç¨‹ä¼šæ›¿æ¢æˆç”¨æˆ·è¿›ç¨‹</li>
</ol>
<p>æœ€åï¼Œåœ¨Initæ‰§è¡Œä¹‹å‰ï¼Œä¼šè¢«<code>/runc/libcontainer/nsenter</code>åŠ«æŒï¼Œåœ¨Goçš„runtimeä¹‹å‰æ‰§è¡Œå¯¹åº”çš„Cä»£ç ï¼Œä»initç®¡é“ä¸­è¯»å–å®¹å™¨çš„é…ç½®ï¼Œè®¾ç½®namespaceï¼Œè°ƒç”¨<code>setns</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå°†å®¹å™¨initè¿›ç¨‹åŠ å…¥åˆ°å¯¹åº”çš„namespaceä¸­ã€‚</p>
<h3 id="runc-run-init-è¿è¡Œæµç¨‹">runC-run-init-è¿è¡Œæµç¨‹</h3>
<p><strong>runC-runè¿è¡Œæµç¨‹</strong></p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/118503688-6f2d1880-b75d-11eb-9942-6e277f249012.jpg">
    <img src="https://user-images.githubusercontent.com/19829495/118503688-6f2d1880-b75d-11eb-9942-6e277f249012.jpg" alt="runc-run"  />
    </a>
</div></p>
<p><strong>runC-initè¿è¡Œæµç¨‹</strong></p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/118503773-81a75200-b75d-11eb-8d0d-85b912864e9b.jpg">
    <img src="https://user-images.githubusercontent.com/19829495/118503773-81a75200-b75d-11eb-8d0d-85b912864e9b.jpg" alt="runc-init"  />
    </a>
</div></p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://icyfenix.cn/immutable-infrastructure/container/history.html">https://icyfenix.cn/immutable-infrastructure/container/history.html</a></li>
</ul>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#dockercontainerdrunckubernetes">Dockerã€containerdã€runCã€Kubernetes</a>
          <ul>
            <li><a href="#ä»dockeråˆ°containerdrunc">ä»Dockeråˆ°containerdã€runC</a></li>
            <li><a href="#docker-daemoncontainerdä¸runc">Docker Daemonã€containerdä¸runC</a></li>
            <li><a href="#kubernetesä¸docker">Kubernetesä¸Docker</a></li>
          </ul>
        </li>
        <li><a href="#å®¹å™¨è¿è¡Œæ—¶-runcåˆ†æ">å®¹å™¨è¿è¡Œæ—¶-runCåˆ†æ</a>
          <ul>
            <li><a href="#ociæ ‡å‡†">OCIæ ‡å‡†</a></li>
            <li><a href="#runcç›¸å…³å‘½ä»¤">runCç›¸å…³å‘½ä»¤</a></li>
            <li><a href="#runc-run">runC-run</a></li>
            <li><a href="#runc-init">runC-init</a></li>
            <li><a href="#runc-run-init-è¿è¡Œæµç¨‹">runC-run-init-è¿è¡Œæµç¨‹</a></li>
          </ul>
        </li>
        <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
