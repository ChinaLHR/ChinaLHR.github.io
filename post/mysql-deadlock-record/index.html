<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<title>Mysql死锁排查记录</title>


  
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-JLJBQBW5WM');
  </script>
  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://chinalhr.github.io/index.xml"
  title="ChinaLHR Blog"
/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mysql死锁排查记录"/>
<meta name="twitter:description" content="
记一次MySql死锁排查
"/>



<link rel="stylesheet" href="https://chinalhr.github.io/fontawesome/css/all.min.css" />




<link
  crossorigin="anonymous"
  href="/css/styles.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>




<link
  id="dark-mode-theme"
  crossorigin="anonymous"
  href="/css/dark.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')

  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>


<script defer crossorigin="anonymous" src="/js/theme.js" integrity=""></script>


<script defer crossorigin="anonymous" src="/js/instantpage.min.js" integrity=""></script><meta name="generator" content="Hugo 0.68.3" />
  </head>
  <body>
    
  




  <header>
    <nav class="navbar">
  <div class="nav">
    
      <a href="https://chinalhr.github.io/" class="nav-logo">
        <img
          src="https://chinalhr.github.io/images/icon.png"
          width="50"
          height="50"
          alt="Logo"
        />
      </a>
    

    <ul class="nav-links">
      
        
          <li>
            <a href="/about/" id="About"
              ><em class="fas fa-user fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/categories/" id="Categories"
              ><em class="fas fa-filter fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/tags/" id="Tags"
              ><em class="fas fa-tags fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/archives/" id="Archives"
              ><em class="fas fa-archive fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/search/" id="Search"
              ><em class="fas fa-search fa-lg"></em
            ></a>
          </li>
          
      
    </ul>
  </div>
</nav>

    <div class="intro-header">
      <div class="container">
        <div class="post-heading">
          
            <h1>
              Mysql死锁排查记录
            </h1>
          
          
            <span class="meta-post">
  <em class="fa fa-calendar-alt"></em
  >&nbsp;Apr 8, 2019
  
    &nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
    
      <a
        href="https://chinalhr.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"
        >数据库</a
      >&nbsp;
    
  
</span>

          
        </div>
      </div>
    </div>
  </header>
  

    
  <div class="container" role="main">
    <article class="article" class="blog-post">
      <blockquote>
<p>记一次MySql死锁排查</p>
</blockquote>
<h3 id="情况uniq-duplicate-key检查">情况(uniq duplicate key检查)</h3>
<h4 id="业务">业务</h4>
<p>用户通过访问他人的个人主页删除访问用户-被访用户记录，并重新插入。(为什么删除再插入而不是update,由于另一套库里的访客不存在 customerId, targetCustomerId 的唯一索引, 所以肯定会有脏数据. 这里直接删掉规避更新异常)</p>
<ul>
<li>伪代码</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">//外层Async调用
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Transactional</span><span style="color:#f92672">(</span>rollbackFor <span style="color:#f92672">=</span> Exception<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveOrUpdate</span><span style="color:#f92672">(</span>Long customerId<span style="color:#f92672">,</span> Long visitCustomerId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        deleteVisit<span style="color:#f92672">(</span>customerId<span style="color:#f92672">,</span> visitCustomerId<span style="color:#f92672">);</span>
        customerVisitDao<span style="color:#f92672">.</span><span style="color:#a6e22e">insertVisit</span><span style="color:#f92672">(</span>customerId<span style="color:#f92672">,</span> visitCustomerId<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h4 id="伪表结构">(伪)表结构</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>customer_visit<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>created_date<span style="color:#f92672">`</span> <span style="color:#66d9ef">timestamp</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;创建时间&#39;</span>,
  <span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;-1&#39;</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;访问用户&#39;</span>,
  <span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;-1&#39;</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;被访问用户&#39;</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>uniq_customer_id_visit_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>index_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>index_visit_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COMMENT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;访客记录&#39;</span>;
</code></pre></div><h4 id="分析死锁原因">分析死锁原因</h4>
<p>通过<code>show engine innodb status</code>查看最近一次的死锁日志</p>
<pre><code>------------------------
LATEST DETECTED DEADLOCK
------------------------
2019-04-08 22:58:23 7f8d2fbff700
//事务1 编号694322167 活跃0.005s 事务状态:根据索引读取数据
*** (1) TRANSACTION: 

TRANSACTION 694322167, ACTIVE 0.005 sec starting index read
//事务1使用一个表 表锁1
mysql tables in use 1, locked 1
//等待锁链表的长度为2 当前事务持有的行记录锁/gap(间隙锁)锁1
LOCK WAIT 2 lock struct(s), heap size 360, 1 row lock(s)
LOCK BLOCKING MySQL thread id: 5828505 block 5835430
MySQL thread id 5835430, OS thread handle 0x7f8d6afff700, query id 4891428548 192.168.0.47 web_user updating
//事务1正在等待锁的sql
DELETE FROM customer_visit
        where
        customer_id = 735***68
        and
        visit_customer_id =624***90
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
//事务1 正在等待表customer_visit上索引uniq_customer_id_visit_customer_id的X锁(排他锁)-记录锁 
RECORD LOCKS space id 47 page no 25368 n bits 616 index `uniq_customer_id_visit_customer_id` of table `huayan`.`customer_visit` trx id 694322167 lock_mode X locks rec but not gap waiting
Record lock, heap no 502 PHYSICAL RECORD: n_fields 3; compact format; info bits 32
 0: len 8; hex 800000000462ed68; asc      b h;;
 1: len 8; hex 8000000003b97a96; asc       z ;;
 2: len 8; hex 8000000000eb5fb1; asc       _ ;;
 

//事务2 编号694322166 活跃0.005s 事务状态:插入数据
*** (2) TRANSACTION:
TRANSACTION 694322166, ACTIVE 0.005 sec inserting
//事务2使用一个表 表锁1
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1184, 3 row lock(s), undo log entries 2
MySQL thread id 5828505, OS thread handle 0x7f8d2fbff700, query id 4891428551 192.168.0.48 web_user update
insert customer_visit(customer_id,visit_customer_id)
      values (735***68,624***90)

//事务2 持有表customer_visit上索引uniq_customer_id_visit_customer_id的X锁 记录锁
//由于是RC隔离模式下的基于唯一索引的等值查询，会申请一个记录锁
//此处是事务2通过delete fromcustomer_visit where customer_id = 735***68 and visit_customer_id =624***90申请的锁
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 47 page no 25368 n bits 616 index `uniq_customer_id_visit_customer_id` of table `huayan`.`customer_visit` trx id 694322166 lock_mode X locks rec but not gap
Record lock, heap no 502 PHYSICAL RECORD: n_fields 3; compact format; info bits 32
 0: len 8; hex 800000000462ed68; asc      b h;;
 1: len 8; hex 8000000003b97a96; asc       z ;;
 2: len 8; hex 8000000000eb5fb1; asc       _ ;;
 
//事务2 正在申请S锁(共享锁) 
//此处是事务2通过insert customer_visit(customer_id,visit_customer_id) values (735***68,624***90) 申请的
//insert语句在普通情况下是会申请排他锁，也就是X锁，但是这里出现了S锁。这是因为a字段是一个唯一索引，
//所以insert语句会在插入前进行一次duplicate key的检查，为了使这次检查成功，需要申请S锁防止其他事务对a字段进行修改。
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 47 page no 25368 n bits 616 index `uniq_customer_id_visit_customer_id` of table `huayan`.`customer_visit` trx id 694322166 lock mode S waiting
Record lock, heap no 502 PHYSICAL RECORD: n_fields 3; compact format; info bits 32
 0: len 8; hex 800000000462ed68; asc      b h;;
 1: len 8; hex 8000000003b97a96; asc       z ;;
 2: len 8; hex 8000000000eb5fb1; asc       _ ;;

</code></pre><p>综上，推测出死锁原因:对于同一个的字段的锁申请是需要排队的，针对uniq_customer_id_visit_customer_id索引,T2 insert申请的S锁之前,T1的delete在申请X锁,而T1的X锁又在等待T2 Delete申请的X锁释放，T2的S锁在等待T1的X锁申请，形成循环等待，导致死锁。</p>
<h4 id="并发的情况下发生死锁情况">并发的情况下，发生死锁情况</h4>
<table>
<thead>
<tr>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>begin</td>
</tr>
<tr>
<td></td>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[执行成功，事务2占有1001-1002uniq的X锁，类型为记录锁]</td>
</tr>
<tr>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[事务1希望申请1001-1002uniq的X锁,事务2已经申请到了,事务wait，X锁申请进入锁请求队列]</td>
<td></td>
</tr>
<tr>
<td>Deadlock</td>
<td>insert customer_visit(customer_id,visit_customer_id) values (1001,1002)[事务2需要申请1001-1002uniq的S锁以便检查duplicate key，排在事务1的1001-1002uniq的X之后,形成循环等待 事务1等待事务2commit,事务2等待事务1commit，造成死锁]</td>
</tr>
</tbody>
</table>
<h4 id="解决">解决</h4>
<p>消除uniq_customer_id_visit_customer_id的X锁等待，在事务delete之前，先进行select查询是否存在记录，不存在则不进行delete操作，避免事务获取到X锁，避免循环等待。</p>
<h3 id="另一种死锁情况非主键索引更新引起的死锁">另一种死锁情况(非主键索引更新引起的死锁)</h3>
<h4 id="业务-1">业务</h4>
<p>数据库表相比情况一缺少了uniq_customer_id_visit_customer_id这个唯一索引(主要是历史问题导致的,一开始就没有唯一索引，后续已经产生了很多脏数据不好添加索引)，业务逻辑是相同的。</p>
<h4 id="非主键索引行锁相关">非主键索引行锁相关</h4>
<p><strong>关于MySql行锁</strong>：<!-- raw HTML omitted -->
行级锁并不是直接锁记录，而是锁索引，如果一条SQL语句用到了主键索引，mysql会锁住主键索引；如果一条语句操作了非主键索引，mysql会先锁住非主键索引，再锁定主键索引。</p>
<p><strong>依据索引执行DELETE/UPDATE的执行步骤</strong>：<!-- raw HTML omitted --></p>
<ol>
<li>由于用到了非主键索引，首先需要获取index_customer_id|index_visit_customer_id上的行级锁(锁非聚簇索引)</li>
<li>根据主键进行更新，所以需要获取主键上的行级锁(锁聚簇索引)</li>
<li>更新完毕，提交并释放所有的锁</li>
</ol>
<p><strong>语句分析EXPLAIN</strong>
发现执行的时候使用的type是index merge。在mysql5.0之前，一个表仅仅能使用一个索引，从5.1开始，引入了 index merge 优化技术，对同一个表可以使用多个索引分别进行条件扫描。
使用index merge的情况下 ，update/delete 需要对多个非主键索引相继获取锁，再获取主键上的锁。</p>
<h4 id="并发情况下死锁发生">并发情况下,死锁发生</h4>
<p>在并发情况下，可能会出现</p>
<table>
<thead>
<tr>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>begin</td>
</tr>
<tr>
<td></td>
<td>DELETE FROM customer_visit where customer_id = 1003 and visit_customer_id =1002[走主键索引，获取pk锁]</td>
</tr>
<tr>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[走非主键索引：获取index锁]</td>
<td></td>
</tr>
<tr>
<td>Deadlock</td>
<td>事务2等待获取index锁，事务1等待获取pk锁，形成循环等待，导致死锁</td>
</tr>
</tbody>
</table>


      
        <div class="blog-tags">
          
            <a
              href="https://chinalhr.github.io/tags/mysql/"
              >MySql</a
            >&nbsp;
          
        </div>
      
    </article>
    
      <script>
  document.addEventListener('scroll', function () {
    if (
      document.body.scrollTop > 50 ||
      document.documentElement.scrollTop > 50
    ) {
      document.getElementById('backtotopButton').style.opacity = '1'
      document.getElementById('backtotopButton').style.transition = '0.5s'
    } else {
      document.getElementById('backtotopButton').style.opacity = '0'
      document.getElementById('backtotopButton').style.transition = '0.5s'
    }
  })

  function topFunction() {
    document.body.scrollTop = 0 
    document.documentElement.scrollTop = 0 
  }
</script>

      <button onclick="topFunction()" id="backtotopButton">
        <em class="fa fa-angle-up"></em>
      </button>
    
    
      

    
  </div>

    <footer>
  

<div class="social-icons">
  
    
    
      
      <a href="https://github.com/chinalhr" name="GitHub">
        <em class="fab fa-github"></em>
      </a>
    
       &nbsp;&ndash;&nbsp;
      <a href="mailto:13435500980@163.com" name="Email">
        <em class="fas fa-envelope"></em>
      </a>
    
  

  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://chinalhr.github.io/about">hanrong.li</a>
      &nbsp;&copy;
      2022
      
        &nbsp;/&nbsp;
        <a href="https://chinalhr.github.io/">ChinaLHR Blog</a>
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
  </div>
</footer>

  </body>
</html>
