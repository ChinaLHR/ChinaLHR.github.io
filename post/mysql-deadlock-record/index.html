<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Mysqlæ­»é”æ’æŸ¥è®°å½•</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, mysql'>

    <meta property="og:url" content="https://chinalhr.github.io/post/mysql-deadlock-record/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Mysqlæ­»é”æ’æŸ¥è®°å½•">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mysqlæ­»é”æ’æŸ¥è®°å½•">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/mysql-deadlock-record/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/mysql-deadlock-record/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/mysql-deadlock-record/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Mysqlæ­»é”æ’æŸ¥è®°å½•</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            April 8, 2019
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/mysql">mysql</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>è®°ä¸€æ¬¡MySqlæ­»é”æ’æŸ¥</p>
</blockquote>
<h3 id="æ’æŸ¥è®°å½•">æ’æŸ¥è®°å½•</h3>
<h4 id="ä¸šåŠ¡">ä¸šåŠ¡</h4>
<p>ç”¨æˆ·é€šè¿‡è®¿é—®ä»–äººçš„ä¸ªäººä¸»é¡µåˆ é™¤è®¿é—®ç”¨æˆ·-è¢«è®¿ç”¨æˆ·è®°å½•ï¼Œå¹¶é‡æ–°æ’å…¥ã€‚(ä¸ºä»€ä¹ˆåˆ é™¤å†æ’å…¥è€Œä¸æ˜¯update,ç”±äºæ­¤ç³»ç»Ÿçš„å¦ä¸€å¥—æ•°æ®åº“é‡Œçš„è®¿å®¢ä¸å­˜åœ¨ customerId, targetCustomerId çš„å”¯ä¸€ç´¢å¼•, æ‰€ä»¥è‚¯å®šä¼šæœ‰è„æ•°æ®. ä¸ºäº†å…¼å®¹ï¼Œè¿™é‡Œç›´æ¥åˆ æ‰è§„é¿æ›´æ–°å¼‚å¸¸)</p>
<ul>
<li>ä¼ªä»£ç </li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">//å¤–å±‚Asyncè°ƒç”¨
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Transactional</span><span style="color:#f92672">(</span>rollbackFor <span style="color:#f92672">=</span> Exception<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveOrUpdate</span><span style="color:#f92672">(</span>Long customerId<span style="color:#f92672">,</span> Long visitCustomerId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        deleteVisit<span style="color:#f92672">(</span>customerId<span style="color:#f92672">,</span> visitCustomerId<span style="color:#f92672">);</span>
        customerVisitDao<span style="color:#f92672">.</span><span style="color:#a6e22e">insertVisit</span><span style="color:#f92672">(</span>customerId<span style="color:#f92672">,</span> visitCustomerId<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h4 id="ä¼ªè¡¨ç»“æ„">(ä¼ª)è¡¨ç»“æ„</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>customer_visit<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>created_date<span style="color:#f92672">`</span> <span style="color:#66d9ef">timestamp</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;åˆ›å»ºæ—¶é—´&#39;</span>,
  <span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;-1&#39;</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;è®¿é—®ç”¨æˆ·&#39;</span>,
  <span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;-1&#39;</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;è¢«è®¿é—®ç”¨æˆ·&#39;</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>uniq_customer_id_visit_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>index_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>customer_id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>index_visit_customer_id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>visit_customer_id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COMMENT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;è®¿å®¢è®°å½•&#39;</span>;
</code></pre></div><h4 id="åˆ†ææ­»é”åŸå› ">åˆ†ææ­»é”åŸå› </h4>
<p>é€šè¿‡<code>show engine innodb status</code>æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡çš„æ­»é”æ—¥å¿—</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">------------------------
</span><span style="color:#75715e"></span>LATEST DETECTED DEADLOCK
<span style="color:#75715e">------------------------
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">08</span> <span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">58</span>:<span style="color:#ae81ff">23</span> <span style="color:#ae81ff">7</span>f8d2fbff700
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">ç¼–å·</span><span style="color:#ae81ff">694322167</span> <span style="color:#960050;background-color:#1e0010">æ´»è·ƒ</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">005</span>s <span style="color:#960050;background-color:#1e0010">äº‹åŠ¡çŠ¶æ€</span>:<span style="color:#960050;background-color:#1e0010">æ ¹æ®ç´¢å¼•è¯»å–æ•°æ®</span>
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">TRANSACTION</span>: 

<span style="color:#66d9ef">TRANSACTION</span> <span style="color:#ae81ff">694322167</span>, ACTIVE <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">005</span> sec starting <span style="color:#66d9ef">index</span> <span style="color:#66d9ef">read</span>
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">ä½¿ç”¨ä¸€ä¸ªè¡¨</span> <span style="color:#960050;background-color:#1e0010">è¡¨é”</span><span style="color:#ae81ff">1</span>
mysql tables <span style="color:#66d9ef">in</span> use <span style="color:#ae81ff">1</span>, locked <span style="color:#ae81ff">1</span>
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">ç­‰å¾…é”é“¾è¡¨çš„é•¿åº¦ä¸º</span><span style="color:#ae81ff">2</span> <span style="color:#960050;background-color:#1e0010">å½“å‰äº‹åŠ¡æŒæœ‰çš„è¡Œè®°å½•é”</span><span style="color:#f92672">/</span>gap(<span style="color:#960050;background-color:#1e0010">é—´éš™é”</span>)<span style="color:#960050;background-color:#1e0010">é”</span><span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">LOCK</span> WAIT <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">lock</span> struct(s), heap <span style="color:#66d9ef">size</span> <span style="color:#ae81ff">360</span>, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">lock</span>(s)
<span style="color:#66d9ef">LOCK</span> BLOCKING MySQL thread id: <span style="color:#ae81ff">5828505</span> block <span style="color:#ae81ff">5835430</span>
MySQL thread id <span style="color:#ae81ff">5835430</span>, OS thread handle <span style="color:#ae81ff">0</span>x7f8d6afff700, query id <span style="color:#ae81ff">4891428548</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">47</span> web_user updating
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">æ­£åœ¨ç­‰å¾…é”çš„</span><span style="color:#66d9ef">sql</span>
<span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> customer_visit
        <span style="color:#66d9ef">where</span>
        customer_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">735</span><span style="color:#f92672">***</span><span style="color:#ae81ff">68</span>
        <span style="color:#66d9ef">and</span>
        visit_customer_id <span style="color:#f92672">=</span><span style="color:#ae81ff">624</span><span style="color:#f92672">***</span><span style="color:#ae81ff">90</span>
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">1</span>) WAITING <span style="color:#66d9ef">FOR</span> THIS <span style="color:#66d9ef">LOCK</span> <span style="color:#66d9ef">TO</span> BE <span style="color:#66d9ef">GRANTED</span>:
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">æ­£åœ¨ç­‰å¾…è¡¨</span>customer_visitä¸Šç´¢å¼•uniq_customer_id_visit_customer_idçš„Xé”(<span style="color:#960050;background-color:#1e0010">æ’ä»–é”</span>)<span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">è®°å½•é”</span> 
RECORD LOCKS <span style="color:#66d9ef">space</span> id <span style="color:#ae81ff">47</span> page <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">25368</span> n bits <span style="color:#ae81ff">616</span> <span style="color:#66d9ef">index</span> <span style="color:#f92672">`</span>uniq_customer_id_visit_customer_id<span style="color:#f92672">`</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">`</span>huayan<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>customer_visit<span style="color:#f92672">`</span> trx id <span style="color:#ae81ff">694322167</span> lock_mode X locks rec but <span style="color:#66d9ef">not</span> gap waiting
Record <span style="color:#66d9ef">lock</span>, heap <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">502</span> PHYSICAL RECORD: n_fields <span style="color:#ae81ff">3</span>; compact format; info bits <span style="color:#ae81ff">32</span>
 <span style="color:#ae81ff">0</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">800000000462</span>ed68; <span style="color:#66d9ef">asc</span>      b h;;
 <span style="color:#ae81ff">1</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000003</span>b97a96; <span style="color:#66d9ef">asc</span>       z ;;
 <span style="color:#ae81ff">2</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000000</span>eb5fb1; <span style="color:#66d9ef">asc</span>       _ ;;
 

<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">2</span> <span style="color:#960050;background-color:#1e0010">ç¼–å·</span><span style="color:#ae81ff">694322166</span> <span style="color:#960050;background-color:#1e0010">æ´»è·ƒ</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">005</span>s <span style="color:#960050;background-color:#1e0010">äº‹åŠ¡çŠ¶æ€</span>:<span style="color:#960050;background-color:#1e0010">æ’å…¥æ•°æ®</span>
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">TRANSACTION</span>:
<span style="color:#66d9ef">TRANSACTION</span> <span style="color:#ae81ff">694322166</span>, ACTIVE <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">005</span> sec inserting
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ä½¿ç”¨ä¸€ä¸ªè¡¨</span> <span style="color:#960050;background-color:#1e0010">è¡¨é”</span><span style="color:#ae81ff">1</span>
mysql tables <span style="color:#66d9ef">in</span> use <span style="color:#ae81ff">1</span>, locked <span style="color:#ae81ff">1</span>
<span style="color:#ae81ff">4</span> <span style="color:#66d9ef">lock</span> struct(s), heap <span style="color:#66d9ef">size</span> <span style="color:#ae81ff">1184</span>, <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">lock</span>(s), undo log entries <span style="color:#ae81ff">2</span>
MySQL thread id <span style="color:#ae81ff">5828505</span>, OS thread handle <span style="color:#ae81ff">0</span>x7f8d2fbff700, query id <span style="color:#ae81ff">4891428551</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">48</span> web_user <span style="color:#66d9ef">update</span>
<span style="color:#66d9ef">insert</span> customer_visit(customer_id,visit_customer_id)
      <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">735</span><span style="color:#f92672">***</span><span style="color:#ae81ff">68</span>,<span style="color:#ae81ff">624</span><span style="color:#f92672">***</span><span style="color:#ae81ff">90</span>)

<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">2</span> <span style="color:#960050;background-color:#1e0010">æŒæœ‰è¡¨</span>customer_visitä¸Šç´¢å¼•uniq_customer_id_visit_customer_idçš„Xé” <span style="color:#960050;background-color:#1e0010">è®°å½•é”</span>
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">ç”±äºæ˜¯</span>RCéš”ç¦»æ¨¡å¼ä¸‹çš„åŸºäºå”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢<span style="color:#960050;background-color:#1e0010">ï¼Œä¼šç”³è¯·ä¸€ä¸ªè®°å½•é”</span>
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">æ­¤å¤„æ˜¯äº‹åŠ¡</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">é€šè¿‡</span><span style="color:#66d9ef">delete</span> fromcustomer_visit <span style="color:#66d9ef">where</span> customer_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">735</span><span style="color:#f92672">***</span><span style="color:#ae81ff">68</span> <span style="color:#66d9ef">and</span> visit_customer_id <span style="color:#f92672">=</span><span style="color:#ae81ff">624</span><span style="color:#f92672">***</span><span style="color:#ae81ff">90</span><span style="color:#960050;background-color:#1e0010">ç”³è¯·çš„é”</span>
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">2</span>) HOLDS THE <span style="color:#66d9ef">LOCK</span>(S):
RECORD LOCKS <span style="color:#66d9ef">space</span> id <span style="color:#ae81ff">47</span> page <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">25368</span> n bits <span style="color:#ae81ff">616</span> <span style="color:#66d9ef">index</span> <span style="color:#f92672">`</span>uniq_customer_id_visit_customer_id<span style="color:#f92672">`</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">`</span>huayan<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>customer_visit<span style="color:#f92672">`</span> trx id <span style="color:#ae81ff">694322166</span> lock_mode X locks rec but <span style="color:#66d9ef">not</span> gap
Record <span style="color:#66d9ef">lock</span>, heap <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">502</span> PHYSICAL RECORD: n_fields <span style="color:#ae81ff">3</span>; compact format; info bits <span style="color:#ae81ff">32</span>
 <span style="color:#ae81ff">0</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">800000000462</span>ed68; <span style="color:#66d9ef">asc</span>      b h;;
 <span style="color:#ae81ff">1</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000003</span>b97a96; <span style="color:#66d9ef">asc</span>       z ;;
 <span style="color:#ae81ff">2</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000000</span>eb5fb1; <span style="color:#66d9ef">asc</span>       _ ;;
 
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">äº‹åŠ¡</span><span style="color:#ae81ff">2</span> <span style="color:#960050;background-color:#1e0010">æ­£åœ¨ç”³è¯·</span>Sé”(<span style="color:#960050;background-color:#1e0010">å…±äº«é”</span>) 
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">æ­¤å¤„æ˜¯äº‹åŠ¡</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">é€šè¿‡</span><span style="color:#66d9ef">insert</span> customer_visit(customer_id,visit_customer_id) <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">735</span><span style="color:#f92672">***</span><span style="color:#ae81ff">68</span>,<span style="color:#ae81ff">624</span><span style="color:#f92672">***</span><span style="color:#ae81ff">90</span>) <span style="color:#960050;background-color:#1e0010">ç”³è¯·çš„</span>
<span style="color:#f92672">//</span>insertè¯­å¥åœ¨æ™®é€šæƒ…å†µä¸‹æ˜¯ä¼šç”³è¯·æ’ä»–é”<span style="color:#960050;background-color:#1e0010">ï¼Œä¹Ÿå°±æ˜¯</span>Xé”<span style="color:#960050;background-color:#1e0010">ï¼Œä½†æ˜¯è¿™é‡Œå‡ºç°äº†</span>Sé”<span style="color:#960050;background-color:#1e0010">ã€‚è¿™æ˜¯å› ä¸º</span>aå­—æ®µæ˜¯ä¸€ä¸ªå”¯ä¸€ç´¢å¼•<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>
<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">æ‰€ä»¥</span>insertè¯­å¥ä¼šåœ¨æ’å…¥å‰è¿›è¡Œä¸€æ¬¡duplicate keyçš„æ£€æŸ¥<span style="color:#960050;background-color:#1e0010">ï¼Œä¸ºäº†ä½¿è¿™æ¬¡æ£€æŸ¥æˆåŠŸï¼Œéœ€è¦ç”³è¯·</span>Sé”é˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹aå­—æ®µè¿›è¡Œä¿®æ”¹<span style="color:#960050;background-color:#1e0010">ã€‚</span>
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">2</span>) WAITING <span style="color:#66d9ef">FOR</span> THIS <span style="color:#66d9ef">LOCK</span> <span style="color:#66d9ef">TO</span> BE <span style="color:#66d9ef">GRANTED</span>:
RECORD LOCKS <span style="color:#66d9ef">space</span> id <span style="color:#ae81ff">47</span> page <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">25368</span> n bits <span style="color:#ae81ff">616</span> <span style="color:#66d9ef">index</span> <span style="color:#f92672">`</span>uniq_customer_id_visit_customer_id<span style="color:#f92672">`</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">`</span>huayan<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>customer_visit<span style="color:#f92672">`</span> trx id <span style="color:#ae81ff">694322166</span> <span style="color:#66d9ef">lock</span> <span style="color:#66d9ef">mode</span> S waiting
Record <span style="color:#66d9ef">lock</span>, heap <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">502</span> PHYSICAL RECORD: n_fields <span style="color:#ae81ff">3</span>; compact format; info bits <span style="color:#ae81ff">32</span>
 <span style="color:#ae81ff">0</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">800000000462</span>ed68; <span style="color:#66d9ef">asc</span>      b h;;
 <span style="color:#ae81ff">1</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000003</span>b97a96; <span style="color:#66d9ef">asc</span>       z ;;
 <span style="color:#ae81ff">2</span>: len <span style="color:#ae81ff">8</span>; hex <span style="color:#ae81ff">8000000000</span>eb5fb1; <span style="color:#66d9ef">asc</span>       _ ;;

</code></pre></div><p>ç»¼ä¸Šï¼Œæ¨æµ‹å‡ºMySQLæ­»é”åŸå› : å¯¹äºåŒä¸€ä¸ªçš„å­—æ®µçš„é”ç”³è¯·æ˜¯éœ€è¦æ’é˜Ÿçš„ï¼Œé’ˆå¯¹uniq_customer_id_visit_customer_idç´¢å¼•,T2 insertç”³è¯·çš„Sé”ä¹‹å‰,T1çš„deleteåœ¨ç”³è¯·Xé”,è€ŒT1çš„Xé”åˆåœ¨ç­‰å¾…T2 Deleteç”³è¯·çš„Xé”é‡Šæ”¾ï¼ŒT2çš„Sé”åœ¨ç­‰å¾…T1çš„Xé”ç”³è¯·ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”ã€‚</p>
<h4 id="å¹¶å‘çš„æƒ…å†µä¸‹å‘ç”Ÿæ­»é”æƒ…å†µ">å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿæ­»é”æƒ…å†µ</h4>
<table>
<thead>
<tr>
<th>äº‹åŠ¡1</th>
<th>äº‹åŠ¡2</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>begin</td>
</tr>
<tr>
<td></td>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[æ‰§è¡ŒæˆåŠŸï¼Œäº‹åŠ¡2å æœ‰1001-1002uniqçš„Xé”ï¼Œç±»å‹ä¸ºè®°å½•é”]</td>
</tr>
<tr>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[äº‹åŠ¡1å¸Œæœ›ç”³è¯·1001-1002uniqçš„Xé”,äº‹åŠ¡2å·²ç»ç”³è¯·åˆ°äº†,äº‹åŠ¡waitï¼ŒXé”ç”³è¯·è¿›å…¥é”è¯·æ±‚é˜Ÿåˆ—]</td>
<td></td>
</tr>
<tr>
<td>Deadlock</td>
<td>insert customer_visit(customer_id,visit_customer_id) values (1001,1002)[äº‹åŠ¡2éœ€è¦ç”³è¯·1001-1002uniqçš„Sé”ä»¥ä¾¿æ£€æŸ¥duplicate keyï¼Œæ’åœ¨äº‹åŠ¡1çš„1001-1002uniqçš„Xä¹‹å,å½¢æˆå¾ªç¯ç­‰å¾… äº‹åŠ¡1ç­‰å¾…äº‹åŠ¡2commit,äº‹åŠ¡2ç­‰å¾…äº‹åŠ¡1commitï¼Œé€ æˆæ­»é”]</td>
</tr>
</tbody>
</table>
<h4 id="è§£å†³">è§£å†³</h4>
<p>æ¶ˆé™¤uniq_customer_id_visit_customer_idçš„Xé”ç­‰å¾…ï¼Œåœ¨äº‹åŠ¡deleteä¹‹å‰ï¼Œå…ˆè¿›è¡ŒselectæŸ¥è¯¢æ˜¯å¦å­˜åœ¨è®°å½•ï¼Œä¸å­˜åœ¨åˆ™ä¸è¿›è¡Œdeleteæ“ä½œï¼Œé¿å…äº‹åŠ¡è·å–åˆ°Xé”ï¼Œé¿å…å¾ªç¯ç­‰å¾…ã€‚</p>
<h3 id="å¦ä¸€ç§æ­»é”æƒ…å†µéä¸»é”®ç´¢å¼•æ›´æ–°å¼•èµ·çš„æ­»é”">å¦ä¸€ç§æ­»é”æƒ…å†µ(éä¸»é”®ç´¢å¼•æ›´æ–°å¼•èµ·çš„æ­»é”)</h3>
<h4 id="ä¸šåŠ¡-1">ä¸šåŠ¡</h4>
<p>æ•°æ®åº“è¡¨ç›¸æ¯”æƒ…å†µä¸€ç¼ºå°‘äº†uniq_customer_id_visit_customer_idè¿™ä¸ªå”¯ä¸€ç´¢å¼•(ä¸»è¦æ˜¯å†å²é—®é¢˜å¯¼è‡´çš„,ä¸€å¼€å§‹å°±æ²¡æœ‰å”¯ä¸€ç´¢å¼•ï¼Œåç»­å·²ç»äº§ç”Ÿäº†å¾ˆå¤šè„æ•°æ®ä¸å¥½æ·»åŠ ç´¢å¼•)ï¼Œä¸šåŠ¡é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚</p>
<h4 id="éä¸»é”®ç´¢å¼•è¡Œé”ç›¸å…³">éä¸»é”®ç´¢å¼•è¡Œé”ç›¸å…³</h4>
<p><strong>å…³äºMySqlè¡Œé”</strong>ï¼š<!-- raw HTML omitted -->
è¡Œçº§é”å¹¶ä¸æ˜¯ç›´æ¥é”è®°å½•ï¼Œè€Œæ˜¯é”ç´¢å¼•ï¼Œå¦‚æœä¸€æ¡SQLè¯­å¥ç”¨åˆ°äº†ä¸»é”®ç´¢å¼•ï¼Œmysqlä¼šé”ä½ä¸»é”®ç´¢å¼•ï¼›å¦‚æœä¸€æ¡è¯­å¥æ“ä½œäº†éä¸»é”®ç´¢å¼•ï¼Œmysqlä¼šå…ˆé”ä½éä¸»é”®ç´¢å¼•ï¼Œå†é”å®šä¸»é”®ç´¢å¼•ã€‚</p>
<p><strong>ä¾æ®ç´¢å¼•æ‰§è¡ŒDELETE/UPDATEçš„æ‰§è¡Œæ­¥éª¤</strong>ï¼š<!-- raw HTML omitted --></p>
<ol>
<li>ç”±äºç”¨åˆ°äº†éä¸»é”®ç´¢å¼•ï¼Œé¦–å…ˆéœ€è¦è·å–index_customer_id|index_visit_customer_idä¸Šçš„è¡Œçº§é”(é”éèšç°‡ç´¢å¼•)</li>
<li>æ ¹æ®ä¸»é”®è¿›è¡Œæ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦è·å–ä¸»é”®ä¸Šçš„è¡Œçº§é”(é”èšç°‡ç´¢å¼•)</li>
<li>æ›´æ–°å®Œæ¯•ï¼Œæäº¤å¹¶é‡Šæ”¾æ‰€æœ‰çš„é”</li>
</ol>
<p><strong>è¯­å¥åˆ†æEXPLAIN</strong>
å‘ç°æ‰§è¡Œçš„æ—¶å€™ä½¿ç”¨çš„typeæ˜¯index mergeã€‚åœ¨mysql5.0ä¹‹å‰ï¼Œä¸€ä¸ªè¡¨ä»…ä»…èƒ½ä½¿ç”¨ä¸€ä¸ªç´¢å¼•ï¼Œä»5.1å¼€å§‹ï¼Œå¼•å…¥äº† index merge ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯¹åŒä¸€ä¸ªè¡¨å¯ä»¥ä½¿ç”¨å¤šä¸ªç´¢å¼•åˆ†åˆ«è¿›è¡Œæ¡ä»¶æ‰«æã€‚
ä½¿ç”¨index mergeçš„æƒ…å†µä¸‹ ï¼Œupdate/delete éœ€è¦å¯¹å¤šä¸ªéä¸»é”®ç´¢å¼•ç›¸ç»§è·å–é”ï¼Œå†è·å–ä¸»é”®ä¸Šçš„é”ã€‚</p>
<h4 id="å¹¶å‘æƒ…å†µä¸‹æ­»é”å‘ç”Ÿ">å¹¶å‘æƒ…å†µä¸‹,æ­»é”å‘ç”Ÿ</h4>
<p>åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°</p>
<table>
<thead>
<tr>
<th>äº‹åŠ¡1</th>
<th>äº‹åŠ¡2</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>begin</td>
</tr>
<tr>
<td></td>
<td>DELETE FROM customer_visit where customer_id = 1003 and visit_customer_id =1002[èµ°ä¸»é”®ç´¢å¼•ï¼Œè·å–pké”]</td>
</tr>
<tr>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>DELETE FROM customer_visit where customer_id = 1001 and visit_customer_id =1002[èµ°éä¸»é”®ç´¢å¼•ï¼šè·å–indexé”]</td>
<td></td>
</tr>
<tr>
<td>Deadlock</td>
<td>äº‹åŠ¡2ç­‰å¾…è·å–indexé”ï¼Œäº‹åŠ¡1ç­‰å¾…è·å–pké”ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”</td>
</tr>
</tbody>
</table>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#æ’æŸ¥è®°å½•">æ’æŸ¥è®°å½•</a>
              <ul>
                <li><a href="#ä¸šåŠ¡">ä¸šåŠ¡</a></li>
                <li><a href="#ä¼ªè¡¨ç»“æ„">(ä¼ª)è¡¨ç»“æ„</a></li>
                <li><a href="#åˆ†ææ­»é”åŸå› ">åˆ†ææ­»é”åŸå› </a></li>
                <li><a href="#å¹¶å‘çš„æƒ…å†µä¸‹å‘ç”Ÿæ­»é”æƒ…å†µ">å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿæ­»é”æƒ…å†µ</a></li>
                <li><a href="#è§£å†³">è§£å†³</a></li>
              </ul>
            </li>
            <li><a href="#å¦ä¸€ç§æ­»é”æƒ…å†µéä¸»é”®ç´¢å¼•æ›´æ–°å¼•èµ·çš„æ­»é”">å¦ä¸€ç§æ­»é”æƒ…å†µ(éä¸»é”®ç´¢å¼•æ›´æ–°å¼•èµ·çš„æ­»é”)</a>
              <ul>
                <li><a href="#ä¸šåŠ¡-1">ä¸šåŠ¡</a></li>
                <li><a href="#éä¸»é”®ç´¢å¼•è¡Œé”ç›¸å…³">éä¸»é”®ç´¢å¼•è¡Œé”ç›¸å…³</a></li>
                <li><a href="#å¹¶å‘æƒ…å†µä¸‹æ­»é”å‘ç”Ÿ">å¹¶å‘æƒ…å†µä¸‹,æ­»é”å‘ç”Ÿ</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
