<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Spring Aopåˆ†æ</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, Java, Spring'>

    <meta property="og:url" content="https://chinalhr.github.io/post/spring-aop/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Spring Aopåˆ†æ">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Spring Aopåˆ†æ">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/spring-aop/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/spring-aop/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/spring-aop/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Spring Aopåˆ†æ</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            September 24, 2018
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/java">Java</a></li>
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/spring">Spring</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>Spring Aopæºç åˆ†æ</p>
</blockquote>
<h2 id="ç¤ºä¾‹">ç¤ºä¾‹</h2>
<h3 id="ç¼–ç¨‹å¼aop">ç¼–ç¨‹å¼aop</h3>
<pre><code> ProxyFactory proxyFactory = new ProxyFactory();//åˆ›å»ºä»£ç†å·¥å‚
 proxyFactory.setTarget(new LoginServiceImpl());//è®¾ç½®ç›®æ ‡å¯¹è±¡
 proxyFactory.addAdvice(new LogAroundLogin());//ç¯ç»•å¢å¼º
 LoginService loginService = (LoginService) proxyFactory.getProxy();//ä»ä»£ç†å·¥å‚ä¸­è·å–ä»£ç†
 loginService.login(); //æ‰§è¡Œæ–¹æ³•
</code></pre><h2 id="ä»£ç†å·¥å‚proxyfactory">ä»£ç†å·¥å‚ProxyFactory</h2>
<p>ProxyFactory proxyFactory = new ProxyFactory();ä»£ç†å·¥å‚çš„ä½œç”¨å°±æ˜¯ä½¿ç”¨ç¼–ç¨‹çš„æ–¹å¼åˆ›å»ºAOPä»£ç†ã€‚ProxyFactoryç»§æ‰¿è‡ªAdvisedSupportï¼Œ
AdvicedSupportæ˜¯AOPä»£ç†çš„é…ç½®ç®¡ç†å™¨ã€‚</p>
<h3 id="targetsource">TargetSource</h3>
<p>TargetSourceç”¨æ¥è·å–å½“å‰çš„Targetï¼Œä¹Ÿå°±æ˜¯TargetSourceä¸­ä¼šä¿å­˜ç€æˆ‘ä»¬çš„çš„å®ç°ç±»ã€‚</p>
<pre><code>public interface TargetSource {

	//è¿”å›ç›®æ ‡ç±»çš„ç±»å‹
	Class getTargetClass();
	
	//æŸ¥çœ‹TargetSourceæ˜¯å¦æ˜¯staticçš„
    //é™æ€çš„TargetSourceæ¯æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªTarget
	boolean isStatic();
	
	//è·å–ç›®æ ‡ç±»çš„å®ä¾‹
	Object getTarget() throws Exception;
	
	//é‡Šæ”¾ç›®æ ‡ç±»
	void releaseTarget(Object target) throws Exception;

}
</code></pre><p>åœ¨AdvisedSupportä¸­ï¼ŒsetTargetç­‰äºè®¾ç½®ä¸€ä¸ªSingletonTargetSourceã€‚</p>
<h3 id="addadvice">addAdvice</h3>
<pre><code>public void addAdvice(Advice advice) throws AopConfigException {
	//advisorsæ˜¯Adviceåˆ—è¡¨ï¼Œæ˜¯ä¸€ä¸ªLinkedList
    //å¦‚æœè¢«æ·»åŠ è¿›æ¥çš„æ˜¯ä¸€ä¸ªInterceptorï¼Œä¼šå…ˆè¢«åŒ…è£…æˆä¸€ä¸ªAdvice
    //æ·»åŠ ä¹‹å‰ç°è·å–advisorçš„å¤§å°ï¼Œå½“åšæ·»åŠ çš„Adviceçš„ä½ç½®
    int pos = (this.advisors != null) ? this.advisors.size() : 0;
    //æ·»åŠ Advice
    addAdvice(pos, advice);
}

public void addAdvice(int pos, Advice advice) throws AopConfigException {
	//åªèƒ½å¤„ç†å®ç°äº†AOPè”ç›Ÿçš„æ¥å£çš„æ‹¦æˆªå™¨
    if (advice instanceof Interceptor &amp;&amp; !(advice instanceof MethodInterceptor)) {
        throw new AopConfigException(getClass().getName() + &quot; only handles AOP Alliance MethodInterceptors&quot;);
    }
	//IntroductionInfoæ¥å£ç±»å‹ï¼Œè¡¨ç¤ºå¼•ä»‹ä¿¡æ¯
    if (advice instanceof IntroductionInfo) {
    	//ä¸éœ€è¦IntroductionAdvisor
        addAdvisor(pos, new DefaultIntroductionAdvisor(advice, (IntroductionInfo) advice));
    }
    //åŠ¨æ€å¼•ä»‹å¢å¼ºçš„å¤„ç†
    else if (advice instanceof DynamicIntroductionAdvice) {
        //éœ€è¦IntroductionAdvisor
        throw new AopConfigException(&quot;DynamicIntroductionAdvice may only be added as part of IntroductionAdvisor&quot;);
    }
    else {
    	//æ·»åŠ å¢å¼ºå™¨ï¼Œéœ€è¦å…ˆæŠŠæˆ‘ä»¬çš„å¢å¼ºåŒ…è£…æˆå¢å¼ºå™¨ï¼Œç„¶åæ·»åŠ 
        addAdvisor(pos, new DefaultPointcutAdvisor(advice));
    }
}
</code></pre><p>åˆ°æ·»åŠ å¢å¼ºçš„æ—¶å€™ï¼Œå®é™…è°ƒç”¨æ·»åŠ å¢å¼ºå™¨è¿™ä¸ªæ–¹æ³•ï¼Œé¦–å…ˆéœ€è¦æŠŠæˆ‘ä»¬çš„AdviceåŒ…è£…æˆä¸€ä¸ªPointCutAdvisorï¼Œç„¶ååœ¨æ·»åŠ å¢å¼ºå™¨ã€‚æ–¹æ³•new DefaultPointcutAdvisor(advice)ï¼Œå°†AdviceåŒ…è£…æˆä¸€ä¸ªDefaultPointcutAdvisorã€‚å…¶å®å°±æ˜¯å°†adviceå’Œé»˜è®¤çš„PointcutåŒ…è£…è¿›DefaultPointcutAdvisorã€‚</p>
<p>DefaultPointcutAdvisoræ˜¯Advisorçš„æœ€å¸¸ç”¨çš„ä¸€ä¸ªå®ç°ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹çš„Pointcutå’ŒAdviceï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨Introductionã€‚</p>
<h3 id="è·å–ä»£ç†">è·å–ä»£ç†</h3>
<ul>
<li>ProxyFactoryçš„getProxyæ–¹æ³•</li>
</ul>
<pre><code>public Object getProxy() {
	//åˆ›å»ºä¸€ä¸ªAOPä»£ç†
    AopProxy proxy = createAopProxy();
    //è¿”å›ä»£ç†
    return proxy.getProxy();
}

protected synchronized AopProxy createAopProxy() {
    if (!this.isActive) {
        activate();
    }
    //è·å–AOPä»£ç†å·¥å‚ï¼Œç„¶ååˆ›å»ºä»£ç†
    return getAopProxyFactory().createAopProxy(this);
}

public AopProxy createAopProxy(AdvisedSupport advisedSupport) throws AopConfigException {
	//å¯¹äºæŒ‡å®šäº†ä½¿ç”¨CGLIBæ–¹å¼ï¼Œæˆ–è€…ä»£ç†çš„æ˜¯ç±»ï¼Œæˆ–è€…ä»£ç†çš„ä¸æ˜¯æ¥å£ï¼Œå°±ä½¿ç”¨CGLIBçš„æ–¹å¼æ¥åˆ›å»ºä»£ç†
    boolean useCglib = advisedSupport.getOptimize() || advisedSupport.getProxyTargetClass() || advisedSupport.getProxiedInterfaces().length == 0;
    if (useCglib) {
        return CglibProxyFactory.createCglibProxy(advisedSupport);
    }
    else {
        //ä½¿ç”¨JDKåŠ¨æ€ä»£ç†æ¥åˆ›å»ºä»£ç†
        return new JdkDynamicAopProxy(advisedSupport);
    }
}
</code></pre><h2 id="joinpointè¿æ¥ç‚¹">Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰</h2>
<p>è¿æ¥ç‚¹æ˜¯æŒ‡é‚£äº›è¢«æ‹¦æˆªåˆ°çš„ç‚¹ã€‚åœ¨Spring ä¸­,è¿™äº›ç‚¹æŒ‡çš„æ˜¯æ–¹æ³•,å› ä¸º Spring åªæ”¯æŒæ–¹æ³•ç±»å‹çš„è¿æ¥ç‚¹ã€‚</p>
<pre><code>public interface Joinpoint {

   //å¼€å§‹è°ƒç”¨æ‹¦æˆªå™¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨
   Object proceed() throws Throwable;

   //
   Object getThis();

   //
   AccessibleObject getStaticPart();   

}
</code></pre><h2 id="pointcutåˆ‡å…¥ç‚¹">Pointcut(åˆ‡å…¥ç‚¹)</h2>
<p>æ‰€è°“åˆ‡å…¥ç‚¹æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº› Joinpoint è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰ã€‚
PointCut ä¾èµ–äº†ClassFilterå’ŒMethodMatcher,ClassFilterç”¨æ¥æŒ‡å®šç‰¹å®šçš„ç±»ï¼ŒMethodMatcher æŒ‡å®šç‰¹å®šçš„å‡½æ•°,èƒ½å®ç°å‡½æ•°çº§åˆ«çš„AOPã€‚</p>
<p><img src="https://user-images.githubusercontent.com/19829495/56457151-269da800-63a9-11e9-9867-ca24aa81bbfb.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜" title="å±å¹•æˆªå›¾.png"></p>
<pre><code>public interface Pointcut {
	//ç±»è¿‡æ»¤å™¨ï¼Œå¯ä»¥çŸ¥é“å“ªäº›ç±»éœ€è¦æ‹¦æˆª
	ClassFilter getClassFilter();
	//æ–¹æ³•åŒ¹é…å™¨ï¼Œå¯ä»¥çŸ¥é“å“ªäº›æ–¹æ³•éœ€è¦æ‹¦æˆª
	MethodMatcher getMethodMatcher();
	
	// could add getFieldMatcher() without breaking most existing code
	Pointcut TRUE = TruePointcut.INSTANCE; 

}
</code></pre><ul>
<li>ClassFilteræ¥å£</li>
</ul>
<pre><code>public interface ClassFilter {
	
	//åˆ¤æ–­ç»™å®šçš„ç±»æ˜¯ä¸æ˜¯è¦æ‹¦æˆª
	boolean matches(Class clazz);

	ClassFilter TRUE = TrueClassFilter.INSTANCE;

}
</code></pre><ul>
<li>MethodMatcheræ¥å£</li>
</ul>
<pre><code>public interface MethodMatcher {
	
	/ é™æ€æ–¹æ³•åŒ¹é…
	boolean matches(Method m, Class targetClass);
	
	//æ˜¯å¦æ˜¯è¿è¡Œæ—¶åŠ¨æ€åŒ¹é…
	boolean isRuntime();
	
	//è¿è¡Œæ˜¯åŠ¨æ€åŒ¹é…
	boolean matches(Method m, Class targetClass, Object[] args);
	
	MethodMatcher TRUE = TrueMethodMatcher.INSTANCE;

}
</code></pre><ul>
<li>MethodMatcher ä¸¤ä¸ªå®ç°ç±»
<ul>
<li>StaticMethodMatcherï¼šä¸åœ¨è¿è¡Œæ—¶æ£€æµ‹Joinpointçš„å‚æ•°(å¯ä»¥åˆ©ç”¨æ¡†æ¶å†…ç¼“å­˜ï¼Œæ€§èƒ½é«˜)</li>
<li>DynamicMethodMatcherï¼šDynamicMethodMatcherè¦åœ¨è¿è¡Œæ—¶å®æ—¶æ£€æµ‹Joinpointçš„å‚æ•°</li>
</ul>
</li>
</ul>
<h2 id="adviceé€šçŸ¥å¢å¼º">Adviceï¼ˆé€šçŸ¥/å¢å¼ºï¼‰</h2>
<p>Adviceä¸å±äºSpringï¼Œæ˜¯AOPè”ç›Ÿå®šä¹‰çš„æ¥å£ã€‚Adviceæ¥å£å¹¶æ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªç©ºçš„æ¥å£ï¼Œç”¨æ¥åšæ ‡è®°ï¼Œå®ç°äº†æ­¤æ¥å£çš„çš„ç±»æ˜¯ä¸€ä¸ªé€šçŸ¥ç±»ã€‚
é€šçŸ¥æ˜¯æŒ‡æ‹¦æˆªåˆ° Joinpoint ä¹‹åæ‰€è¦åšçš„äº‹æƒ…å°±æ˜¯é€šçŸ¥ã€‚é€šçŸ¥åˆ†ä¸ºã€å‰ç½®é€šçŸ¥ã€‘, ã€åç½®é€šçŸ¥ã€‘,ã€å¼‚å¸¸é€šçŸ¥ã€‘,ã€æœ€ç»ˆé€šçŸ¥ã€‘, ã€ç¯ç»•é€šçŸ¥ã€‘(åˆ‡é¢è¦å®Œæˆçš„åŠŸèƒ½)</p>
<pre><code>BeforeAdviceï¼Œå‰ç½®å¢å¼ºï¼Œæ„æ€æ˜¯åœ¨æˆ‘ä»¬çš„ç›®æ ‡ç±»ä¹‹å‰è°ƒç”¨çš„å¢å¼ºã€‚è¿™ä¸ªæ¥å£ä¹Ÿæ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ã€‚
AfterReturningAdviceï¼Œæ–¹æ³•æ­£å¸¸è¿”å›å‰çš„å¢å¼ºï¼Œè¯¥å¢å¼ºå¯ä»¥çœ‹åˆ°æ–¹æ³•çš„è¿”å›å€¼ï¼Œä½†æ˜¯ä¸èƒ½æ›´æ”¹è¿”å›å€¼ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ªæ–¹æ³•afterReturning
ThrowsAdviceï¼ŒæŠ›å‡ºå¼‚å¸¸æ—¶å€™çš„å¢å¼ºï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ ‡å¿—æ¥å£ï¼Œæ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ã€‚
Interceptorï¼Œæ‹¦æˆªå™¨ï¼Œä¹Ÿæ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œè¡¨ç¤ºä¸€ä¸ªé€šç”¨çš„æ‹¦æˆªå™¨ã€‚ä¸å±äºSpringï¼Œæ˜¯AOPè”ç›Ÿå®šä¹‰çš„æ¥å£
DynamicIntroductionAdviceï¼ŒåŠ¨æ€å¼•ä»‹å¢å¼ºï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•implementsInterfaceã€‚
</code></pre><ul>
<li>per-classç±»å‹çš„Adviceï¼ˆå¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡ç±»çš„æ‰€æœ‰å®ä¾‹ä¹‹é—´å…±äº«ï¼Œé€šå¸¸åªæä¾›æ–¹æ³•æ‹¦æˆªåŠŸèƒ½ï¼Œä¸ä¼šå¯¹ç›®æ ‡å¯¹è±¡ä¿å­˜ä»»ä½•çŠ¶æ€æˆ–æ·»åŠ æ–°åŠŸèƒ½ï¼‰</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/19829495/56457157-4339e000-63a9-11e9-9c97-567220dd93ea.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜" title="å±å¹•æˆªå›¾.png"></p>
<ul>
<li>per-instanceç±»å‹çš„Adviceï¼ˆä¸ä¼šåœ¨ç›®æ ‡ç±»æ‰€æœ‰å®ä¾‹ä¹‹é—´å…±äº«ï¼Œè€Œæ˜¯ä¼šä¸ºä¸åŒçš„å®ä¾‹å¯¹è±¡ä¿å­˜ä»–ä»¬å„è‡ªçš„çŠ¶æ€ä»¥åŠç›¸å…³é€»è¾‘ï¼‰Introductionå¯ä»¥åœ¨ä¸æ”¹å˜ç›®æ ‡ç±»çš„å®šä¹‰çš„æƒ…å†µä¸‹ï¼Œä¸ºå¯¹è±¡æ·»åŠ æ–°çš„å±æ€§ä¸è¡Œä¸º</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/19829495/56457167-564cb000-63a9-11e9-9e88-baba8a45ee6c.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜" title="å±å¹•æˆªå›¾.png"></p>
<h2 id="advisoråˆ‡é¢å¢å¼ºå™¨">Advisor(åˆ‡é¢/å¢å¼ºå™¨)</h2>
<p>Advisoræ˜¯åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ï¼ˆå¼•ä»‹ï¼‰çš„ç»“åˆã€‚å¢å¼ºå™¨ï¼Œå®ƒæŒæœ‰ä¸€ä¸ªå¢å¼ºAdviceï¼Œè¿˜æŒæœ‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ¥å†³å®šAdviceå¯ä»¥ç”¨åœ¨å“ªé‡Œã€‚</p>
<p>Spring AOPçš„Pointcut Advisor</p>
<p>AbstractPointcutAdvisor å®ç°äº†Ordered,ä¸ºå¤šä¸ªAdviceæŒ‡å®šé¡ºåºï¼Œé¡ºåºä¸ºIntç±»å‹ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜,
AbstractGenericPointcutAdvisor æŒ‡å®šäº†Adviceï¼Œé™¤äº†Introductionä¹‹å¤–çš„ç±»å‹</p>
<p><img src="https://user-images.githubusercontent.com/19829495/56457173-63699f00-63a9-11e9-8198-227db1c4e8d4.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜" title="å±å¹•æˆªå›¾.png"></p>
<h2 id="proxyä»£ç†">Proxy(ä»£ç†)</h2>
<p>ä¸€ä¸ªç±»è¢« AOP ç»‡å…¥å¢å¼ºåï¼Œå°±äº§ç”Ÿä¸€ä¸ªç»“æœä»£ç†ç±»ã€‚
<img src="https://user-images.githubusercontent.com/19829495/56457348-dd028c80-63ab-11e9-814f-002dccf43651.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜" title="å±å¹•æˆªå›¾.png"></p>
<ul>
<li>ProxyConfig</li>
</ul>
<pre><code>	private boolean proxyTargetClass = false;//true,ä½¿ç”¨CGLIB,false,ä½¿ç”¨åŸç”Ÿ
	
	private boolean optimize = false;//æ˜¯å¦è¿›è¡Œä¼˜åŒ–
	
	boolean opaque = false;//æ˜¯å¦å¼ºåˆ¶è½¬åŒ–ä¸ºadvised
	
	boolean exposeProxy = false;//AOPç”Ÿæˆå¯¹è±¡æ—¶ï¼Œç»‘å®šåˆ°ThreadLocal, å¯ä»¥é€šè¿‡AopContextè·å–
	
	private boolean frozen = false;//ä»£ç†ä¿¡æ¯ä¸€æ—¦è®¾ç½®ï¼Œæ˜¯å¦å…è®¸æ”¹å˜
</code></pre><ul>
<li>ProxyFactory
ProxyFactoryæ˜¯Springçš„AOPç»‡å…¥å™¨ï¼Œæ¥å—Pointcut/Adviceè¿”å›ç»‡å…¥äº†æ¨ªåˆ‡é€»è¾‘çš„ç›®æ ‡å¯¹è±¡ä»£ç†ã€‚</li>
<li>ProxyFactoryBean
æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”¨æ¥ç”Ÿäº§Proxyçš„FactoryBeanï¼ŒAOPä¸IOCçš„èåˆã€‚
ï¼ˆå¦‚æœå®¹å™¨ä¸­æŸä¸ªå¯¹è±¡ä¾èµ–äºProxyFactoryBean ï¼Œä»–å°†ä¼šä½¿ç”¨åˆ°ProxyFactoryBeançš„getObject()æ–¹æ³•è¿”å›çš„å†…å®¹ï¼‰</li>
</ul>
<h2 id="aopæ ¸å¿ƒå®ç°weavingç»‡å…¥å™¨">aopæ ¸å¿ƒå®ç°(Weavingç»‡å…¥å™¨)</h2>
<p>å°†AOPèå…¥Beançš„åˆ›å»ºè¿‡ç¨‹,AspectJæ–¹å¼ç»‡å…¥çš„æ ¸å¿ƒï¼Œæ˜¯ä¸€ä¸ªBeanPostProcessï¼ˆä¼šæ‰«ææ‰€æœ‰çš„Pointcutä¸éå†æ‰€æœ‰Bean,å¹¶å¯¹éœ€è¦çš„Beanè¿›è¡Œç»‡å…¥-è‡ªåŠ¨ä»£ç†ï¼Œå½“å¯¹è±¡å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œä¸ºå…¶ç”Ÿæˆä»£ç†å¯¹è±¡å¹¶è¿”å›ï¼‰</p>
<p>ç®€å•çš„å®ç°å¦‚ä¸‹:</p>
<pre><code>public class AspectJAwareAdvisorAutoProxyCreator implements BeanPostProcessor, BeanFactoryAware {

	private AbstractBeanFactory beanFactory;

	@Override
	public Object postProcessBeforeInitialization(Object bean, String beanName) throws Exception {
		return bean;
	}


	//åœ¨Beanåˆ›å»ºä¹‹åå¯¹Beanè¿›è¡ŒAOPå¤„ç†
	@Override
	public Object postProcessAfterInitialization(Object bean, String beanName) throws Exception {
	if (bean instanceof AspectJExpressionPointcutAdvisor) {
			return bean;
	}
    if (bean instanceof MethodInterceptor) {
            return bean;
    }

    //è·å–æ‰€æœ‰Pointcutï¼Œè¿›è¡Œåˆ‡é¢å¤„ç†ï¼Œè¿”å›å®ŒæˆAopçš„Proxy
List&lt;AspectJExpressionPointcutAdvisor&gt; advisors = beanFactory
				.getBeansForType(AspectJExpressionPointcutAdvisor.class);
for (AspectJExpressionPointcutAdvisor advisor : advisors) {
	if (advisor.getPointcut().getClassFilter().matches(bean.getClass())) {
	// 1. è®¾ç½®è¢«ä»£ç†å¯¹è±¡(Joinpoint)
	AdvisedSupport advisedSupport = new AdvisedSupport();
	TargetSource targetSource = new TargetSource(bean, bean.getClass().getInterfaces());
	advisedSupport.setTargetSource(targetSource);
	// 2. è®¾ç½®æ‹¦æˆªå™¨(Advice)
	advisedSupport.setMethodInterceptor((MethodInterceptor) advisor.getAdvice());
	advisedSupport.setMethodMatcher(advisor.getPointcut().getMethodMatcher());
	// 3. åˆ›å»ºä»£ç†(Proxy)
	return new JdkDynamicAopProxy(advisedSupport).getProxy();
			}
		}
		return bean;
	}
	@Override
	public void setBeanFactory(BeanFactory beanFactory) throws Exception {
		this.beanFactory = (AbstractBeanFactory) beanFactory;
	}
}

</code></pre>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ç¤ºä¾‹">ç¤ºä¾‹</a>
          <ul>
            <li><a href="#ç¼–ç¨‹å¼aop">ç¼–ç¨‹å¼aop</a></li>
          </ul>
        </li>
        <li><a href="#ä»£ç†å·¥å‚proxyfactory">ä»£ç†å·¥å‚ProxyFactory</a>
          <ul>
            <li><a href="#targetsource">TargetSource</a></li>
            <li><a href="#addadvice">addAdvice</a></li>
            <li><a href="#è·å–ä»£ç†">è·å–ä»£ç†</a></li>
          </ul>
        </li>
        <li><a href="#joinpointè¿æ¥ç‚¹">Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰</a></li>
        <li><a href="#pointcutåˆ‡å…¥ç‚¹">Pointcut(åˆ‡å…¥ç‚¹)</a></li>
        <li><a href="#adviceé€šçŸ¥å¢å¼º">Adviceï¼ˆé€šçŸ¥/å¢å¼ºï¼‰</a></li>
        <li><a href="#advisoråˆ‡é¢å¢å¼ºå™¨">Advisor(åˆ‡é¢/å¢å¼ºå™¨)</a></li>
        <li><a href="#proxyä»£ç†">Proxy(ä»£ç†)</a></li>
        <li><a href="#aopæ ¸å¿ƒå®ç°weavingç»‡å…¥å™¨">aopæ ¸å¿ƒå®ç°(Weavingç»‡å…¥å™¨)</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
