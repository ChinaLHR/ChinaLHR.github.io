<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Linux-logrotate详解</title>
    <meta name="description" content="Keep curious">
    <meta name="keywords" content='blog, chinalhr, lhr, Linux'>

    <meta property="og:url" content="https://chinalhr.github.io/post/linux-logrotate/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Linux-logrotate详解">
    <meta property="og:description" content="Keep curious">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Linux-logrotate详解">
    <meta name="twitter:description" content="Keep curious">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/linux-logrotate/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/linux-logrotate/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/linux-logrotate/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
  <script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Linux-logrotate详解</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            January 31, 2020
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/linux">Linux</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>logrotate学习记录</p>
</blockquote>
<h2 id="关于logrotate">关于logrotate</h2>
<p>logrotate 是一个 linux 系统日志的管理工具。可以对单个日志文件或者某个目录下的文件按时间 / 大小进行切割，压缩操作；指定日志保存数量；还可以在切割之后运行自定义命令。</p>
<p>logrotate 是基于 crontab 运行的，查询crontab 的配置文件 /etc/anacrontab可以查询具体的配置。logrotate的配置文件，例如每天运行的在 /etc/cron.daily/logrotate配置文件里面。</p>
<h2 id="logrotate运行机制">logrotate运行机制</h2>
<p>测试系统为Centos7 ，查询/etc/anacrontab</p>
<pre><code>1	5	cron.daily		nice run-parts /etc/cron.daily
7	25	cron.weekly		nice run-parts /etc/cron.weekly
@monthly 45	cron.monthly		nice run-parts /etc/cron.monthly
</code></pre><p>会根据配置的周期运行/etc/cron.daily，/etc/cron.weekly和/etc/cron.monthly目录下的脚本文件，如cron.daily下的logrotate文件，内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf
EXITVALUE<span style="color:#f92672">=</span>$?
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $EXITVALUE !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    /usr/bin/logger -t logrotate <span style="color:#e6db74">&#34;ALERT exited abnormally with [</span>$EXITVALUE<span style="color:#e6db74">]&#34;</span>
<span style="color:#66d9ef">fi</span>
exit <span style="color:#ae81ff">0</span>

</code></pre></div><p>这个脚本主要做的事就是以 <code>/etc/logrotate.conf</code> 为配置文件执行了 logrotate。就是这样实现了每天执行一次 logrotate。</p>
<p>logrotate.conf包含了/etc/logrotate.d目录下的配置文件，很多程序的会用到 logrotate 滚动日志，比如 nginx。它们安装后，会在 <code>/etc/logrotate.d</code> 这个目录下增加自己的 logrotate 的配置文件。logrotate.conf配置如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># see &#34;man logrotate&#34; for details</span>
<span style="color:#75715e"># rotate log files weekly</span>
weekly

<span style="color:#75715e"># keep 4 weeks worth of backlogs</span>
rotate <span style="color:#ae81ff">4</span>

<span style="color:#75715e"># create new (empty) log files after rotating old ones</span>
create

<span style="color:#75715e"># use date as a suffix of the rotated file</span>
dateext

<span style="color:#75715e"># uncomment this if you want your log files compressed</span>
<span style="color:#75715e">#compress</span>

<span style="color:#75715e"># RPM packages drop log rotation information into this directory</span>
include /etc/logrotate.d

<span style="color:#75715e"># no packages own wtmp and btmp -- we&#39;ll rotate them here</span>
/var/log/wtmp <span style="color:#f92672">{</span>
    monthly
    create <span style="color:#ae81ff">0664</span> root utmp
	minsize 1M
    rotate <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>

/var/log/btmp <span style="color:#f92672">{</span>
    missingok
    monthly
    create <span style="color:#ae81ff">0600</span> root utmp
    rotate <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="logrotate配置">logrotate配置</h2>
<h3 id="logrotate运行命令">logrotate运行命令</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">logrotate <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> &lt;configfile&gt;
-d, --debug ：debug 模式，测试配置文件是否有错误。
-f, --force ：强制转储文件。
-m, --mail<span style="color:#f92672">=</span>command ：压缩日志后，发送日志到指定邮箱。
-s, --state<span style="color:#f92672">=</span>statefile ：使用指定的状态文件。
-v, --verbose ：显示转储过程。
</code></pre></div><p>例如，通过logrotate -f /etc/logrotate.d/nginx进行手动执行。</p>
<h3 id="配置参数">配置参数</h3>
<p>示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/var/log/log_file <span style="color:#f92672">{</span>

    monthly
    rotate <span style="color:#ae81ff">5</span>
    compress
    delaycompress
    missingok
    notifempty
    create <span style="color:#ae81ff">644</span> root root
    postrotate
        /usr/bin/killall -HUP rsyslogd
    endscript
<span style="color:#f92672">}</span>
</code></pre></div><p>常用参数说明：</p>
<ul>
<li>daily ：指定转储周期为每天</li>
<li>weekly ：指定转储周期为每周</li>
<li>monthly ：指定转储周期为每月</li>
<li>rotate count ：指定日志文件删除之前转储的次数，0 指没有备份，5 指保留 5 个备份</li>
<li>tabooext [+] list：让 logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig, .rpmsave, v, 和～</li>
<li>missingok：在日志轮循期间，任何错误将被忽略，例如 “文件无法找到” 之类的错误。</li>
<li>size size：当日志文件到达指定的大小时才转储，bytes (缺省) 及 KB (sizek) 或 MB (sizem)</li>
<li>compress： 通过 gzip 压缩转储以后的日志</li>
<li>nocompress： 不压缩</li>
<li>copytruncate：用于还在打开中的日志文件，把当前日志备份并截断</li>
<li>nocopytruncate： 备份日志文件但是不截断</li>
<li>create mode owner group ： 转储文件，使用指定的文件模式创建新的日志文件</li>
<li>nocreate： 不建立新的日志文件</li>
<li>delaycompress： 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩</li>
<li>nodelaycompress： 覆盖 delaycompress 选项，转储同时压缩。</li>
<li>errors address ： 专储时的错误信息发送到指定的 Email 地址</li>
<li>ifempty ：即使是空文件也转储，这个是 logrotate 的缺省选项。</li>
<li>notifempty ：如果是空文件的话，不转储</li>
<li>mail address ： 把转储的日志文件发送到指定的 E-mail 地址</li>
<li>nomail ： 转储时不发送日志文件</li>
<li>olddir directory：储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统</li>
<li>noolddir： 转储后的日志文件和当前日志文件放在同一个目录下</li>
<li>prerotate/endscript： 在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行</li>
</ul>
<p>示例（10天周期，nginx日志压缩处理）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/var/log/nginx/*log <span style="color:#f92672">{</span>
    create <span style="color:#ae81ff">0664</span> nginx root
    daily
    rotate <span style="color:#ae81ff">10</span>
    missingok
    notifempty
    compress
    sharedscripts
    postrotate
        /bin/kill -USR1 <span style="color:#e6db74">`</span>cat /run/nginx.pid 2&gt;/dev/null<span style="color:#e6db74">`</span> 2&gt;/dev/null <span style="color:#f92672">||</span> true
    endscript
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="shell脚本实现">Shell脚本实现</h2>
<p>如下，对java应用产生的日志进行压缩，清理操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell"><span style="color:#75715e">#--------------------------------------------</span>
<span style="color:#75715e"># 自动化日志每日压缩,清理</span>
<span style="color:#75715e"># gzip 压缩一天前日志</span>
<span style="color:#75715e"># 删除两天前的压缩文件</span>
<span style="color:#75715e">#--------------------------------------------</span>

<span style="color:#75715e">#! /bin/bash</span>

ZIPDATE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +%F -d <span style="color:#e6db74">&#34;-1 day&#34;</span><span style="color:#66d9ef">)</span>;
DELDATE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +%F -d <span style="color:#e6db74">&#34;-2 day&#34;</span><span style="color:#66d9ef">)</span>;
SECOND<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $RANDOM | cut -c1-3<span style="color:#66d9ef">)</span>

sleep $SECOND

<span style="color:#75715e"># 清理 /volume1/docker/java/log下hour目录下的日志,</span>
<span style="color:#75715e"># type d和l(目录/链接文件) -o 相当于 ||,</span>
<span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">`</span>find /volume1/docker/java/log -maxdepth <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\(</span> -type d -o -type l <span style="color:#ae81ff">\)</span> -name hour<span style="color:#e6db74">`</span>;
<span style="color:#66d9ef">do</span>

        find -L $i -maxdepth <span style="color:#ae81ff">1</span> -type f <span style="color:#ae81ff">\(</span> -name <span style="color:#e6db74">&#34;*</span><span style="color:#e6db74">${</span>ZIPDATE<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#34;</span> -a ! -name <span style="color:#e6db74">&#34;*.gz&#34;</span> <span style="color:#ae81ff">\)</span> -exec gzip <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
        find -L $i -maxdepth <span style="color:#ae81ff">1</span> -type f <span style="color:#ae81ff">\(</span> -name <span style="color:#e6db74">&#34;*</span><span style="color:#e6db74">${</span>DELDATE<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#34;</span> -a -name <span style="color:#e6db74">&#34;*.gz&#34;</span> <span style="color:#ae81ff">\)</span> -exec rm -f <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
<span style="color:#66d9ef">done</span>
</code></pre></div>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#关于logrotate">关于logrotate</a></li>
        <li><a href="#logrotate运行机制">logrotate运行机制</a></li>
        <li><a href="#logrotate配置">logrotate配置</a>
          <ul>
            <li><a href="#logrotate运行命令">logrotate运行命令</a></li>
            <li><a href="#配置参数">配置参数</a></li>
          </ul>
        </li>
        <li><a href="#shell脚本实现">Shell脚本实现</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
