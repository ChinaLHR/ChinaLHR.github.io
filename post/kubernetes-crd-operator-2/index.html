<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸‹)</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, kubernetes'>

    <meta property="og:url" content="https://chinalhr.github.io/post/kubernetes-crd-operator-2/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸‹)">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸‹)">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/kubernetes-crd-operator-2/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/kubernetes-crd-operator-2/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/kubernetes-crd-operator-2/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸‹)</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            January 23, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/kubernetes">kubernetes</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Operator-SDKå¼€å‘Kubernetes Operator</p>
</blockquote>
<h2 id="operator">Operator</h2>
<h3 id="ä»€ä¹ˆæ˜¯operator">ä»€ä¹ˆæ˜¯Operator</h3>
<blockquote>
<p>å‚è€ƒï¼š<a href="https://www.redhat.com/zh/topics/containers/what-is-a-kubernetes-operator">https://www.redhat.com/zh/topics/containers/what-is-a-kubernetes-operator</a></p>
</blockquote>
<p>Kubernetes Operator æ˜¯ä¸€ç§ç‰¹å®šäºåº”ç”¨çš„æ§åˆ¶å™¨ï¼Œå¯æ‰©å±• Kubernetes API çš„åŠŸèƒ½ï¼Œæ¥ä¸º Kubernetes ç”¨æˆ·åˆ›å»ºã€é…ç½®å’Œç®¡ç†å¤æ‚åº”ç”¨çš„å®ä¾‹ã€‚</p>
<p>å®ƒåŸºäºåŸºæœ¬ Kubernetes Resourceä¸Controlleræ¦‚å¿µæ„å»ºï¼Œåˆæ¶µç›–äº†ç‰¹å®šäºåŸŸæˆ–åº”ç”¨çš„çŸ¥è¯†ï¼Œç”¨äºå®ç°å…¶æ‰€ç®¡ç†è½¯ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„è‡ªåŠ¨åŒ–ï¼›å¯ä»¥çœ‹ä½œæ˜¯CRDä¸Custom Controllerçš„ç»„åˆæ¨¡å¼çš„å°è£…åŠæœ€ä½³å®è·µã€‚</p>
<p>å¯¹æ¯”é€šè¿‡å®šä¹‰CRDä¸åŸºäºclient-goå»å®ç°Custom Controllerï¼›Operatoråœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œäº†æ ‡å‡†åŒ–çš„æµç¨‹è§„èŒƒã€é«˜çº§APIæŠ½è±¡ã€å¿«é€Ÿå¯åŠ¨è„šæ‰‹æ¶ä¸ä»£ç ç”Ÿæˆå·¥å…·ã€RBACæ§åˆ¶ã€æŒç»­ç›‘æ§ã€æ•°æ®å¤‡ä»½ã€æ•…éšœæ¢å¤ã€è‡ªåŠ¨åŒ–å‡çº§Operatorçš„CICDç­‰ã€‚</p>
<p>ç›®å‰æ¯”è¾ƒä¸»æµçš„Operatoræ¡†æ¶æ˜¯å¦‚ä¸‹ä¸¤ä¸ªï¼š</p>
<ul>
<li><strong>operator-framework</strong>ï¼š ç”±CoreOSå¼€å‘å’Œç»´æŠ¤ï¼ŒåŒ…å«operator-sdkä¸operator-lifecycle-managerã€‚</li>
<li><strong>kubebuilder</strong>ï¼šç”± Kubernetes SIGs å¼€å‘å’Œç»´æŠ¤ã€‚</li>
</ul>
<h3 id="operator-sdk-vs-kubebuilder">Operator-SDK Vs Kubebuilder</h3>
<p>ç›®å‰æ¥çœ‹ï¼Œ<a href="https://github.com/operator-framework/operator-sdk">operator-sdk</a>ä¸<a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>éƒ½æ˜¯ç±»ä¼¼çš„æ”¯æŒå¿«é€Ÿåˆ›å»ºå’Œç®¡ç† Operator çš„æ¡†æ¶ï¼Œè¿™ä¸¤ä¸ªé¡¹ç›®éƒ½å¹¿æ³›ä½¿ç”¨äº†<a href="https://github.com/kubernetes-sigs/controller-runtime">controller-runtime</a> å’Œ <a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> é¡¹ç›®ï¼Œå› æ­¤æœ‰ç€ç±»ä¼¼çš„ Go æºæ–‡ä»¶ã€åŒ…ç»“æ„ï¼Œè€Œä¸”ç›®å‰operator-sdkä¹Ÿä¸kubebuilderè¿›è¡Œäº†æ·±åº¦æ•´åˆï¼Œå¯ä»¥å‚è€ƒkubebuilderçš„<a href="https://github.com/kubernetes-sigs/kubebuilder/projects/7">github projects</a> ä¸ operator-sdkçš„<a href="https://sdk.operatorframework.io/docs/faqs/">faq</a>ã€‚</p>
<ul>
<li>operator-sdk-go åº•å±‚åŸºäºkuberbuilderè¿›è¡Œæ“ä½œã€‚</li>
<li>operator-sdkåœ¨Kubebuilderæä¾›çš„åŸºæœ¬é¡¹ç›®è„šæ‰‹æ¶ä¹‹ä¸Šæä¾›äº†å…¶ä»–åŠŸèƒ½ï¼Œå¦‚operator-sdk initä¼šç”Ÿæˆã€‚
<ul>
<li><a href="https://github.com/operator-framework/operator-lifecycle-manager">Operator Lifecycle Manager</a> operatorçš„å®‰è£…å’Œè¿è¡Œç®¡ç†ç³»ç»Ÿã€‚</li>
<li>æ”¯æŒå‘å¸ƒ<a href="https://operatorhub.io/">OperatorHub</a>ã€‚</li>
<li><a href="https://sdk.operatorframework.io/docs/testing-operators/scorecard/">Operator SDK scorecard</a> ç”¨äºç¡®ä¿operatoræœ€ä½³å®è·µå’Œå¼€å‘é›†ç¾¤æµ‹è¯•çš„å·¥å…·ã€‚</li>
</ul>
</li>
<li>operator-sdkæ”¯æŒ Go ä»¥å¤–çš„ operator typesï¼Œå¦‚Ansible å’Œ Helmã€‚</li>
<li>operator-sdkä¸kubebuilderçš„æ–‡æ¡£æ˜¯é€šç”¨çš„ã€‚</li>
</ul>
<h3 id="operator-å·¥ä½œæ¨¡å¼">Operator å·¥ä½œæ¨¡å¼</h3>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/_attachment/f5015e168e358b3d3ff180d30e8cb30b_MD5.png">
    <img src="/_attachment/f5015e168e358b3d3ff180d30e8cb30b_MD5.png" alt="OperatoråŸºæœ¬å·¥ä½œæ¨¡å¼"  />
    </a>
</div></p>
<ol>
<li>ç”¨æˆ·åˆ›å»ºä¸€ä¸ªCRDï¼Œå¹¶æäº¤ç»™åˆ° kube-apiserverã€‚</li>
<li>kube-apiserver æ ¹æ®è‡ªå·±æ³¨å†Œçš„ä¸€ä¸ª pass åˆ—è¡¨ï¼ŒæŠŠè¯¥ CRD çš„è¯·æ±‚è½¬å‘ç»™ webhookã€‚</li>
<li>webhookå®Œæˆè¯¥CRD çš„ç¼ºçœå€¼ä¸å‚æ•°æ£€éªŒï¼Œå¤„ç†å®Œæˆåï¼Œç›¸åº”çš„ CR ä¼šè¢«æŒä¹…åŒ–åˆ°etcdï¼Œåå“åº”ç”¨æˆ·ã€‚</li>
<li>controllerä¼šåœ¨åå°ç›‘æµ‹è¯¥è‡ªå®šä¹‰èµ„æºï¼ŒæŒ‰ç…§ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†ä¸è¯¥è‡ªå®šä¹‰èµ„æºç›¸å…³è”çš„ç‰¹æ®Šæ“ä½œã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸å‰æ–‡æ‰€ç¤ºçš„<code>sample-controller</code>æ–¹å¼çš„å¤„ç†æµç¨‹å¤§è‡´ç›¸åŒã€‚</p>
<h3 id="operator-åº”ç”¨åœºæ™¯">Operator åº”ç”¨åœºæ™¯</h3>
<ul>
<li>åˆ†å¸ƒå¼åº”ç”¨çš„è‡ªåŠ¨åŒ–è¿ç»´ï¼šetcd-operatorã€ mongodb-enterprise-kubernetesã€prometheus-operatorã€kafka-operator&hellip;</li>
<li>æ‰©å±•Kubernetesï¼šistioã€kruiseã€kubeedge&hellip;</li>
</ul>
<h2 id="kubernetes-admission-controller">Kubernetes Admission Controller</h2>
<blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/</a></p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/</a></p>
</blockquote>
<p><strong>Admission Controllerï¼ˆå‡†å…¥æ§åˆ¶å™¨ï¼‰</strong></p>
<p><code>å‡†å…¥æ§åˆ¶å™¨</code>æ˜¯åœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰ç”¨äºå¯¹ Kubernetes API Server çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªçš„ä»£ç æ®µã€‚å‡†å…¥æ§åˆ¶å™¨å¯èƒ½æ˜¯<code>validating</code>ã€<code>mutating</code>æˆ–è€…ä¸¤è€…éƒ½æœ‰ï¼ŒMutating æ§åˆ¶å™¨å¯ä»¥ä¿®æ”¹ä»–ä»¬çš„å¤„ç†çš„èµ„æºå¯¹è±¡ï¼ŒValidating æ§åˆ¶å™¨ä¸ä¼šï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªé˜¶æ®µä¸­çš„ä»»ä½•æ§åˆ¶å™¨æ‹’ç»äº†è¯·æ±‚ï¼Œåˆ™ä¼šç«‹å³æ‹’ç»æ•´ä¸ªè¯·æ±‚ï¼Œå¹¶å°†é”™è¯¯è¿”å›ç»™æœ€ç»ˆçš„ç”¨æˆ·ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå·±çš„å‡†å…¥æ§åˆ¶å™¨ï¼Œä½†æ˜¯å‡†å…¥æ§åˆ¶å™¨éœ€è¦è¢«ç¼–è¯‘è¿› kube-apiserverï¼Œå¹¶ä¸”åœ¨ kube-apiserver å¯åŠ¨æ—¶å¯åŠ¨ã€‚ä¸ºäº†å¢åŠ æ‰©å±•æ€§ï¼Œè€Œä¸æ˜¯å’Œ apiserver è€¦åˆåœ¨ä¸€èµ·ï¼Œä¾¿æœ‰äº†<code>Admission webhooks</code>è¿™ç§é€šè¿‡ä¸€ç§åŠ¨æ€é…ç½®webhookçš„æ–¹å¼ã€‚</p>
<p><strong>admission webhooks</strong></p>
<p>åœ¨ kube-apiserver ä¸­åŒ…å«ä¸¤ä¸ªç‰¹æ®Šçš„å‡†å…¥æ§åˆ¶å™¨ï¼š<code>MutatingAdmissionWebhook</code>å’Œ<code>ValidatingAdmissionWebhook</code>ã€‚è¿™ä¸¤ä¸ªæ§åˆ¶å™¨æ”¯æŒwebhookæ¨¡å¼ï¼Œå°†å‘é€å‡†å…¥è¯·æ±‚åˆ°å¤–éƒ¨çš„ HTTP æœåŠ¡å¹¶æ¥æ”¶ä¸€ä¸ªå‡†å…¥å“åº”ï¼›åˆ›å»ºadmission webhookçš„æµç¨‹å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/_attachment/d350e6cc2c516a9818bd98577625aa9d_MD5.png">
    <img src="/_attachment/d350e6cc2c516a9818bd98577625aa9d_MD5.png" alt="image"  />
    </a>
</div></p>
<h2 id="operatorå¼€å‘å®è·µ">Operatorå¼€å‘å®è·µ</h2>
<blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://sdk.operatorframework.io/docs/">https://sdk.operatorframework.io/docs/</a></p>
<p><a href="https://olm.operatorframework.io/docs/">https://olm.operatorframework.io/docs/</a></p>
<p><a href="https://book.kubebuilder.io/">https://book.kubebuilder.io/</a></p>
</blockquote>
<h3 id="operator-framework">Operator-Framework</h3>
<p>Operator-Frameworkä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<h4 id="operator-sdk">Operator-SDK</h4>
<p>ç¼–å†™Operatorçš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œæä¾›é«˜çº§APIï¼Œå¯ä»¥æ›´ç›´è§‚åœ°ç¼–å†™Controlleré€»è¾‘ï¼›æä¾›ç”¨äºå¿«é€Ÿå¯åŠ¨æ–°é¡¹ç›®çš„è„šæ‰‹æ¶ä¸ä»£ç ç”Ÿæˆå·¥å…·ã€‚</p>
<p><strong>Go-Operatorå·¥ä½œæµç¨‹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨ SDK å‘½ä»¤è¡Œç•Œé¢ (CLI) åˆ›å»ºOperatoré¡¹ç›®ã€‚</li>
<li>é€šè¿‡æ·»åŠ CRD æ¥å®šä¹‰æ–°çš„èµ„æº APIã€‚</li>
<li>å®šä¹‰æ§åˆ¶å™¨æ¥ç›‘è§†å’Œåè°ƒèµ„æºã€‚</li>
<li>ä½¿ç”¨ SDK å’Œ controller-runtime APIs ä¸ºæ§åˆ¶å™¨ç¼–å†™åè°ƒé€»è¾‘ã€‚</li>
<li>ä½¿ç”¨ SDK CLI æ„å»ºå’Œç”ŸæˆOperatoréƒ¨ç½²æ¸…å•ã€‚</li>
</ol>
<p><strong>Operatorèƒ½åŠ›ç­‰çº§ï¼š</strong></p>
<p>æ ‡å‡†åŒ–äº†Operatorçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›æ–¹é¢ä¸åŒçš„æˆç†Ÿåº¦çº§åˆ«ï¼ˆåŸºæœ¬å®‰è£…ã€æ— ç¼å‡çº§ã€å…¨ç”Ÿå‘½å‘¨æœŸã€æ·±åº¦å¯è§‚æµ‹ã€è‡ªåŠ¨ä¼¸ç¼©æ‰©å±•ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/_attachment/8c8640442ddf7a1187d0a6c60905bd96_MD5.png">
    <img src="/_attachment/8c8640442ddf7a1187d0a6c60905bd96_MD5.png" alt="image"  />
    </a>
</div></p>
<p><strong>Go-Operator-SDKæ¶æ„å›¾</strong></p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/_attachment/6a93a097aead4c3890e66cf3d2c42b8d_MD5.png">
    <img src="/_attachment/6a93a097aead4c3890e66cf3d2c42b8d_MD5.png" alt="uTools_1644509865678"  />
    </a>
</div></p>
<h4 id="operator-lifecycle-managerolm">Operator-Lifecycle-Managerï¼ˆOLMï¼‰</h4>
<p>OLM æ‰©å±•äº† Kubernetesï¼Œä»¥æä¾›ä¸€ç§å£°æ˜å¼çš„æ–¹å¼æ¥å®‰è£…ã€ç®¡ç†å’Œå‡çº§ Operator åŠå…¶åœ¨é›†ç¾¤ä¸­çš„ä¾èµ–é¡¹ï¼›æä¾›çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>Over-the-Air Updates and Catalogsï¼šOLM æœ‰ä¸€ä¸ª Catalogsæ¦‚å¿µï¼ŒOperator å¯ä»¥ä»ä¸­å®‰è£…å¹¶ä¿æŒæ›´æ–°ã€‚</li>
<li>Dependency Modelï¼šä½¿ç”¨ OLMs æ‰“åŒ…æ ¼å¼ï¼Œå¯ä»¥è¡¨è¾¾å¯¹å¹³å°å…¶ä»–Operatorçš„ä¾èµ–å…³ç³»ã€‚</li>
<li>Discoverabilityï¼šå¯å‘ç°çš„Operatorï¼ŒOLM å°†å·²å®‰è£…çš„ Operator åŠå…¶æœåŠ¡é€šå‘Šåˆ°ç§Ÿæˆ·çš„å‘½åç©ºé—´ä¸­ï¼Œä»¥è¾¾åˆ°è‡ªåŠ¨å‘ç°å¯å®‰è£…çš„Operatorã€‚</li>
<li>Cluster Stability ï¼šé›†ç¾¤ç¨³å®šæ€§ä¿è¯ï¼ŒOperatorå£°æ˜å¯¹å…¶APIçš„æ‰€æœ‰æƒï¼ŒOLM å°†é˜²æ­¢æ‹¥æœ‰ç›¸åŒ API çš„ Operator å‘ç”Ÿå†²çªï¼Œç¡®ä¿é›†ç¾¤ç¨³å®šæ€§ã€‚</li>
<li>å£°æ˜å¼ UI æ§ä»¶</li>
</ul>
<h3 id="åŸºäºoperator-sdkå¼€å‘sidecar-operator">åŸºäºOperator-SDKå¼€å‘Sidecar-Operator</h3>
<h4 id="sidecar-operatorçš„åŠŸèƒ½">Sidecar-Operatorçš„åŠŸèƒ½</h4>
<p>ä¸Istioçš„è‡ªåŠ¨æ³¨å…¥Envoyä»£ç†æ–¹å¼ç±»ä¼¼ï¼Œsidcar-operatoræ”¯æŒè‡ªåŠ¨ä¸ºé›†ç¾¤ä¸­ç¬¦åˆæ¡ä»¶çš„Podæ³¨å…¥sidecarå®¹å™¨ï¼Œå¹¶è´Ÿè´£æ›´æ–°sidecarSetè‡ªå®šä¹‰èµ„æºçš„çŠ¶æ€ã€‚</p>
<h4 id="å®‰è£…operator-sdk">å®‰è£…Operator-SDK</h4>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯Ubuntuç³»ç»Ÿè¿›è¡Œå¼€å‘ï¼Œå®‰è£…å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">export ARCH<span style="color:#f92672">=</span><span style="color:#66d9ef">$(case</span> <span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span> in x86_64<span style="color:#66d9ef">)</span> echo -n amd64 ;; aarch64<span style="color:#f92672">)</span> echo -n arm64 ;; *<span style="color:#f92672">)</span> echo -n <span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span> ;; <span style="color:#66d9ef">esac</span><span style="color:#f92672">)</span>
export OS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>uname | awk <span style="color:#e6db74">&#39;{print tolower($0)}&#39;</span><span style="color:#66d9ef">)</span>
export OPERATOR_SDK_DL_URL<span style="color:#f92672">=</span>https://github.com/operator-framework/operator-sdk/releases/download/v1.16.0
curl -LO <span style="color:#e6db74">${</span>OPERATOR_SDK_DL_URL<span style="color:#e6db74">}</span>/operator-sdk_<span style="color:#e6db74">${</span>OS<span style="color:#e6db74">}</span>_<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>
chmod +x operator-sdk_<span style="color:#e6db74">${</span>OS<span style="color:#e6db74">}</span>_<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> sudo mv operator-sdk_<span style="color:#e6db74">${</span>OS<span style="color:#e6db74">}</span>_<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span> /usr/local/bin/operator-sdk

</code></pre></div><h4 id="åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># åˆ›å»ºé¡¹ç›®</span>
mkdir -p sidecar-operator <span style="color:#f92672">&amp;&amp;</span> cd sidecar-operator
<span style="color:#75715e"># åˆå§‹åŒ–é¡¹ç›®ï¼Œè¿™é‡Œçš„domainæŒ‡å®šäº†åç»­æ³¨å†ŒCRDå¯¹è±¡çš„GroupåŸŸåï¼Œinitåˆå§‹åŒ–åä¼šç”Ÿæˆä»£ç æ¡†æ¶ã€Makefileå·¥å…·æ–‡ä»¶ã€æ‹‰å–ä¾èµ–ä»£ç åº“</span>
operator-sdk init --domain chinalhr.github.io --repo github.com/ChinaLHR/sidecar-operator
 
<span style="color:#75715e"># æŸ¥çœ‹é¡¹ç›®ç»“æ„</span>
tree -L <span style="color:#ae81ff">2</span>
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ LICENSE
â”œâ”€â”€ Makefile
â”œâ”€â”€ PROJECT
â”œâ”€â”€ README.md
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ default
â”‚   â”œâ”€â”€ manager
â”‚   â”œâ”€â”€ manifests
â”‚   â”œâ”€â”€ prometheus
â”‚   â”œâ”€â”€ rbac
â”‚   â””â”€â”€ scorecard
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ hack
â”‚   â””â”€â”€ boilerplate.go.txt
â””â”€â”€ main.go
</code></pre></div><ul>
<li>go.mod ï¼šé¡¹ç›®åŸºæœ¬ä¾èµ–ï¼Œclient-goï¼Œcontroller-runtime&hellip;</li>
<li>Makefileï¼šæ„å»ºï¼Œéƒ¨ç½²Operator</li>
<li>PROJECTï¼šç”¨äºæ­å»ºæ–°ç»„ä»¶çš„ Kubebuilder å…ƒæ•°æ®</li>
<li>configç›®å½•ï¼šå¯åŠ¨é…ç½®ï¼ŒåŒ…å«åœ¨é›†ç¾¤ä¸Šå¯åŠ¨æ§åˆ¶å™¨æ‰€éœ€çš„Kustomize YAML å®šä¹‰ï¼Œè¿˜ä¼šä¿å­˜CRDã€RBACä¸Webhooké…ç½®</li>
<li>main.goï¼šåˆå§‹åŒ–å¹¶è¿è¡ŒManager</li>
</ul>
<h4 id="åˆ›å»ºcustom-resource-ä¸-custom-controlleræ¨¡æ¿ä»£ç ">åˆ›å»ºCustom Resource ä¸ Custom Controlleræ¨¡æ¿ä»£ç </h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">operator-sdk create api --group apps --version v1alpha1 --kind SidecarSet --resource --controller
</code></pre></div><p>é€šè¿‡operator-sdk toolç”Ÿæˆ SidecarSet APIèµ„æº <code>api/v1alpha1/sidecarset_types.go</code>å’Œæ§åˆ¶å™¨<code>controllers/sidecarset_controller.go</code> æ¨¡æ¿ã€‚</p>
<p><strong>è‡ªå®šä¹‰èµ„æºç»“æ„ä¿®æ”¹</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ ¹æ®æˆ‘ä»¬è‡ªèº«çš„éœ€æ±‚å»å®šä¹‰æˆ‘ä»¬è‡ªå®šä¹‰èµ„æºçš„ç»“æ„ï¼Œå³ä¿®æ”¹<code>controllers/sidecarset_controller.go</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">Copyright 2022.
</span><span style="color:#75715e">
</span><span style="color:#75715e">Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span style="color:#75715e">you may not use this file except in compliance with the License.
</span><span style="color:#75715e">You may obtain a copy of the License at
</span><span style="color:#75715e">
</span><span style="color:#75715e">    http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#75715e">
</span><span style="color:#75715e">Unless required by applicable law or agreed to in writing, software
</span><span style="color:#75715e">distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#75715e">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#75715e">See the License for the specific language governing permissions and
</span><span style="color:#75715e">limitations under the License.
</span><span style="color:#75715e">*/</span>

<span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
)

<span style="color:#75715e">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
</span><span style="color:#75715e">// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// SidecarSetSpec defines the desired state of SidecarSet
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SidecarSetSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//query over pods that should be injected sidecar
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Selector</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelector</span> <span style="color:#e6db74">`json:&#34;selector,omitempty&#34;`</span>
	<span style="color:#a6e22e">Containers</span> []<span style="color:#a6e22e">SidecarContainer</span>    <span style="color:#e6db74">`json:&#34;containers,omitempty&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SidecarContainer</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Container</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
}

<span style="color:#75715e">// SidecarSetStatus defines the observed state of SidecarSet
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SidecarSetStatus</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//the number of Pods whose labels are matched with this SidecarSet&#39;s selector
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MatchedPods</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`json:&#34;matchedPods&#34;`</span>
	<span style="color:#75715e">//the number of matched Pods that are injected with the latest SidecarSet&#39;s
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">UpdatedPods</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`json:&#34;updatedPods&#34;`</span>
	<span style="color:#75715e">//the number of matched Pods that have a ready condition
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ReadyPods</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`json:&#34;readyPods&#34;`</span>
}

<span style="color:#75715e">// +genclient
</span><span style="color:#75715e">// +genclient:nonNamespaced
</span><span style="color:#75715e">// +kubebuilder:object:root=true
</span><span style="color:#75715e">// +kubebuilder:subresource:status
</span><span style="color:#75715e">// +kubebuilder:resource:scope=Cluster
</span><span style="color:#75715e">// +kubebuilder:printcolumn:name=&#34;MATCHED&#34;,type=&#34;integer&#34;,JSONPath=&#34;.status.matchedPods&#34;,description=&#34;The number of pods matched.&#34;
</span><span style="color:#75715e">// +kubebuilder:printcolumn:name=&#34;UPDATED&#34;,type=&#34;integer&#34;,JSONPath=&#34;.status.updatedPods&#34;,description=&#34;The number of pods matched and updated.&#34;
</span><span style="color:#75715e">// +kubebuilder:printcolumn:name=&#34;READY&#34;,type=&#34;integer&#34;,JSONPath=&#34;.status.readyPods&#34;,description=&#34;the number of matched Pods that have a ready condition.&#34;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// SidecarSet is the Schema for the sidecarsets API
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SidecarSet</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>

	<span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">SidecarSetSpec</span>   <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>
	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">SidecarSetStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>
}

<span style="color:#75715e">//+kubebuilder:object:root=true
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// SidecarSetList contains a list of SidecarSet
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SidecarSetList</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
	<span style="color:#a6e22e">Items</span>           []<span style="color:#a6e22e">SidecarSet</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#75715e">//å°†ç±»å‹æ³¨å†Œåˆ°APIç»„ä¸­
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SchemeBuilder</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SidecarSet</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SidecarSetList</span>{})
}
</code></pre></div><p>è¿™é‡Œä¸»è¦æ˜¯æ›´æ–°äº†SidecarSetçš„Specç»“æ„ï¼Œå¢åŠ äº†<code>Selector</code>ä¸<code>Containers</code>å±æ€§ï¼Œç”¨äºåŒ¹é…éœ€è¦æ³¨å…¥sidecarçš„Podä»¥åŠsidecaræ³¨å…¥å®¹å™¨çš„å®šä¹‰ã€‚æ›´æ–°äº†SidecarSetçš„Statusç»“æ„ï¼Œå¢åŠ äº†<code>MatchedPods</code>ã€<code>UpdatedPods</code>ä¸<code>ReadyPods</code>æè¿°åŒ¹é…çš„Podæ•°é‡ä¸å·²æ³¨å…¥sidecarçš„Podæ•°é‡ä¸å·²æ³¨å…¥æˆåŠŸå¹¶ä¸”å°±ç»ªçš„Podæ•°é‡ã€‚</p>
<p>è¿™é‡Œè¿˜è¡¥å……äº†code generatorä¾èµ–æ³¨é‡Šï¼Œå¦‚ï¼š<code>+genclient:nonNamespaced</code>ç”Ÿæˆénamespaceå¯¹è±¡ã€<code>+kubebuilder:resource:scope=Cluster</code>æŒ‡å®šèµ„æºçš„èŒƒå›´ã€<code>kubebuilder:printcolumn...</code> ç”¨äºkubectlè·å–æ•°æ®å±•ç¤º&hellip;</p>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œä»£ç ç”Ÿæˆå‘½ä»¤<code>make generate</code> ä¸ºèµ„æºç±»å‹æ›´æ–°\ç”Ÿæˆä»£ç ï¼Œè¯¥å‘½ä»¤ä¼šè°ƒç”¨controller-genç¨‹åºæ¥æ›´æ–°<code>api/v1alpha1/zz_generated.deepcopy.go</code>æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make generate
</code></pre></div><p><strong>è‡ªå®šä¹‰æ§åˆ¶å™¨æ¨¡æ¿</strong></p>
<p>ç”Ÿæˆçš„<code>controllers/sidecarset_controller.go</code>æ¨¡æ¿</p>
<ul>
<li><code>SetupWithManager()</code>å‡½æ•°ï¼šä¸ºæ„å»ºæ§åˆ¶å™¨ä»¥ç›‘è§† CR å’Œè¯¥æ§åˆ¶å™¨æ‹¥æœ‰å’Œç®¡ç†çš„å…¶ä»–èµ„æºã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// SetupWithManager sets up the controller with the Manager.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSetReconciler</span>) <span style="color:#a6e22e">SetupWithManager</span>(<span style="color:#a6e22e">mgr</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Manager</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">NewControllerManagedBy</span>(<span style="color:#a6e22e">mgr</span>).	<span style="color:#75715e">//æ§åˆ¶å™¨æ„å»ºå™¨
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">For</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1alpha1</span>.<span style="color:#a6e22e">SidecarSet</span>{}).		<span style="color:#75715e">//ç›‘æ§çš„ä¸»èµ„æº,å¯¹äºæ¯ä¸ªSidecarSetç±»å‹çš„Add/Update/Deleteäº‹ä»¶ï¼Œå°†å‘é€ç»™åè°ƒå¾ªç¯ï¼ˆReconcileï¼‰
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Complete</span>(<span style="color:#a6e22e">r</span>)								
}
</code></pre></div><ul>
<li><code>Reconcile()</code>å‡½æ•°ï¼šåè°ƒå¾ªç¯ï¼ˆReconcile loopï¼‰ï¼Œæ¥å—Requestå‚æ•°ï¼Œè¯¥å‚æ•°ä¸ºï¼ˆå‘½åç©ºé—´/åç§°é”®ï¼‰ï¼Œç”¨äºä»ç¼“å­˜ä¸­æŸ¥æ‰¾ä¸»è¦èµ„æºå¯¹è±¡å¦‚Sidecarsetï¼›å®ç°ç‰¹å®šç±»å‹åè°ƒé€»è¾‘ï¼ˆå¦‚replicesetçš„reconcileå³åœ¨å…¶åˆ›å»ºçš„æ—¶å€™å»åˆ›å»ºå…³è”çš„podï¼‰å¹¶è¿”å›ç»“æœã€å¼‚å¸¸æˆ–è€…é‡è¯•ã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSetReconciler</span>) <span style="color:#a6e22e">Reconcile</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#75715e">// TODO(user): your logic here
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h4 id="åˆ›å»ºcustom-resouces-admission-webhookæ¨¡æ¿ä»£ç ">åˆ›å»ºCustom Resouces Admission Webhookæ¨¡æ¿ä»£ç </h4>
<p><strong>Admission Webhooksåˆ†ä¸ºå¦‚ä¸‹ä¸¤ç§ï¼š</strong></p>
<ul>
<li><strong>Validating admission webhookï¼š</strong> ç”¨äºæ‰§è¡Œè¶…å‡º OpenAPI æ¨¡å¼éªŒè¯åŠŸèƒ½çš„éªŒè¯ï¼Œæ³¨æ„è¿™é‡Œå¯ä»¥æ‹’ç»è¯·æ±‚ï¼Œä½†ä¸èƒ½ä¿®æ”¹åœ¨è¯·æ±‚ä¸­æ¥æ”¶çš„å¯¹è±¡ã€‚</li>
<li><strong>Mutating admission webhookï¼š</strong> ç”¨äºé»˜è®¤è®¾ç½®ï¼ˆåœ¨åˆ›å»ºæ—¶ä¸ºèµ„æºä¸­æœªè®¾ç½®çš„å­—æ®µæ·»åŠ é»˜è®¤å€¼ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªè¡¥ä¸æ¥ä¿®æ”¹å¯¹è±¡ã€‚</li>
</ul>
<p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ›å»ºValidating Admission Webhookæ¨¡æ¿ä»£ç </p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># --programmatic-validationå‚æ•°åˆ›å»ºValidating admission webhookæ‰€éœ€è¦çš„èµ„æº</span>
<span style="color:#75715e"># --defaulting å‚æ•°åˆ›å»ºMutating admission webhookæ‰€éœ€è¦çš„èµ„æº</span>
operator-sdk create webhook --group apps --version v1alpha1 --kind SidecarSet --programmatic-validation
</code></pre></div><p>ç”Ÿæˆçš„<code>api/v1alpha1/sidecarset_webhook.go</code>æ¨¡æ¿</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-GO" data-lang="GO"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateCreate</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate create&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#75715e">// TODO(user): fill in your validation logic upon object creation.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateUpdate</span>(<span style="color:#a6e22e">old</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate update&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#75715e">// TODO(user): fill in your validation logic upon object update.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateDelete</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate delete&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#75715e">// TODO(user): fill in your validation logic upon object deletion.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†<code>ValidateCreate</code>ã€<code>ValidateUpdate</code>ã€<code>ValidateDelete</code>ä¸‰ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œåˆ†åˆ«åœ¨CRåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ—¶è¿›è¡Œå›è°ƒã€‚</p>
<h4 id="æ ¸å¿ƒé€»è¾‘æ¢³ç†">æ ¸å¿ƒé€»è¾‘æ¢³ç†</h4>
<ol>
<li>åœ¨ç”¨æˆ·åˆ›å»ºSidecarSet Custom Resouceçš„æ—¶å€™è¿›è¡Œé…ç½®é¡¹æ ¡éªŒï¼šé€šè¿‡å®ç°SidecarSet Validating admission webhook æ ¡éªŒé€»è¾‘è¿›è¡Œå¤„ç†ã€‚</li>
<li>åœ¨ç”¨æˆ·åˆ›å»ºPodçš„æ—¶å€™ï¼Œè‡ªåŠ¨åŒ¹é…å¯¹åº”çš„SidecarSetï¼Œå¦‚æœåŒ¹é…åˆ°SidecarSetçš„è¯è§£æå‡ºSidecarSetå¯¹åº”çš„sidecarå®¹å™¨æ³¨å…¥åˆ°Podä¸­ï¼šè¿™é‡Œéœ€è¦é€šè¿‡å®ç°Podçš„Mutating admission webhookè¾¾åˆ°ç›®çš„ï¼Œç”±äº kubebuilder ä¸æ”¯æŒæ ¸å¿ƒç±»å‹çš„ webhook è‡ªåŠ¨ç”Ÿæˆï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ controller-runtime çš„åº“æ¥å¤„ç†ã€‚</li>
<li>å®æ—¶ç›‘æµ‹Podä¿¡æ¯ï¼Œæ›´æ–°SidecarSet Statusï¼š è¿™é‡Œå°±éœ€è¦å®ç°<code>sidecarset_controller</code>çš„<code>Reconcile</code>é€»è¾‘è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
<p><strong>å®Œæ•´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/_attachment/4afb328f907b6fab626c10c7c76dcd3d_MD5.png">
    <img src="/_attachment/4afb328f907b6fab626c10c7c76dcd3d_MD5.png" alt="SIdecarSetè¿è¡Œæµç¨‹ (1)"  />
    </a>
</div></p>
<h4 id="å®ç°podç±»å‹çš„mutating-admission-webhook">å®ç°Podç±»å‹çš„Mutating Admission Webhook</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//+kubebuilder:webhook:path=/mutate-sidecar-pod,mutating=true,failurePolicy=fail,groups=&#34;&#34;,resources=pods,verbs=create;update,versions=v1,name=mpod.kb.io,admissionReviewVersions=v1,sideEffects=None
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">podHandler</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Client</span>  <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">Decoder</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Decoder</span>
}

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">SidecarEnvKey</span> = <span style="color:#e6db74">&#34;IS_INJECTED&#34;</span>
	<span style="color:#a6e22e">SidecarAnnotationHashKey</span> = <span style="color:#e6db74">&#34;chinalhr.github.io/sidecar-hash&#34;</span>
)

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">mgr</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Manager</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetWebhookServer</span>().<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;/mutate-sidecar-pod&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">Admission</span>{<span style="color:#a6e22e">Handler</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">podHandler</span>{<span style="color:#a6e22e">Client</span>: <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetClient</span>()}})
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">handler</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">podHandler</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">request</span> <span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">log</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Decoder</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">pod</span>)
	<span style="color:#a6e22e">copy</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">DeepCopy</span>()

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;begin to process sidecarSet webhook&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Errored</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;sidecarSet webhook hand pod %v&#34;</span>, <span style="color:#e6db74">&#34;pod&#34;</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">mutatingPodFunc</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">copy</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Errored</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#a6e22e">marshaledPod</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">copy</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">PatchResponseFromRaw</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">Raw</span>, <span style="color:#a6e22e">marshaledPod</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">handler</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">podHandler</span>) <span style="color:#a6e22e">mutatingPodFunc</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">//1. get sidecarSet resource list
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sidecarSets</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SidecarSetList</span>{}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">sidecarSets</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sidecarContainers</span> []<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Container</span>
	<span style="color:#a6e22e">sidecarSetHash</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)

	<span style="color:#a6e22e">matchNothing</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">sidecarSet</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">sidecarSets</span>.<span style="color:#a6e22e">Items</span> {
		<span style="color:#a6e22e">needInject</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PodSidecarSetMatch</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">sidecarSet</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">needInject</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#a6e22e">matchNothing</span> = <span style="color:#66d9ef">false</span>
		<span style="color:#a6e22e">sidecarSetHash</span>[<span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Name</span>] = <span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">SidecarAnnotationHashKey</span>]

		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> {
			<span style="color:#a6e22e">sidecarContainer</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#a6e22e">i</span>]
			<span style="color:#a6e22e">sidecarContainer</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">sidecarContainer</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EnvVar</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">SidecarEnvKey</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;true&#34;</span>})
			<span style="color:#a6e22e">sidecarContainers</span> = append(<span style="color:#a6e22e">sidecarContainers</span>, <span style="color:#a6e22e">sidecarContainer</span>.<span style="color:#a6e22e">Container</span>)
		}
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">matchNothing</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> = append(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>, <span style="color:#a6e22e">sidecarContainers</span><span style="color:#f92672">...</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">sidecarSetHash</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">encodedStr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">sidecarSetHash</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">SidecarAnnotationHashKey</span>] = string(<span style="color:#a6e22e">encodedStr</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PodSidecarSetMatch</span>(<span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">sidecarSet</span> <span style="color:#a6e22e">SidecarSet</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">selector</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelectorAsSelector</span>(<span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">selector</span>.<span style="color:#a6e22e">Empty</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">selector</span>.<span style="color:#a6e22e">Matches</span>(<span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Labels</span>)) {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// InjectDecoder injects the decoder.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">handler</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">podHandler</span>) <span style="color:#a6e22e">InjectDecoder</span>(<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">admission</span>.<span style="color:#a6e22e">Decoder</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Decoder</span> = <span style="color:#a6e22e">d</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>è¿™é‡Œå®ç°åŒ…æ‹¬ï¼š</p>
<ol>
<li><code>InjectDecoder</code>æ–¹æ³•æ³¨å…¥è§£ç å™¨ï¼Œç”¨ä»¥è§£æadmission requestï¼›å®ç° <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/webhook/admission?tab=doc#Handler">admission.Handler</a> æ¥å£çš„<code>Handle</code>æ–¹æ³•ï¼Œè§£æå‡ºPod èµ„æºçš„ä¿¡æ¯ï¼Œè·å–å½“å‰sidecarSetåˆ—è¡¨ï¼Œæ ¹æ®sidecarSetçš„<code>selector</code>åŒ¹é…Podçš„<code>labels</code>ï¼ŒåŒ¹é…æˆåŠŸåˆ™è¿›è¡Œsidecarçš„æ³¨å…¥ï¼Œå°†sidecarSetçš„Containeræ³¨å…¥åˆ°å½“å‰çš„Podä¸­ï¼Œå¹¶å¯¹å·²æ³¨å…¥çš„Podè¿›è¡Œannotationsæ ‡è¯†ï¼ˆåç»­SidecarSet Controllerè¿›è¡Œè¯†åˆ«ç›‘æ§ï¼‰ï¼›æœ€åé€šè¿‡<code>PatchResponseFromRaw</code> åˆå¹¶æ›´æ–°Podçš„ä¿¡æ¯ç›¸åº”admission controllerã€‚</li>
<li><code>Register</code>æ–¹æ³•æ³¨å†Œå½“å‰çš„mutating webhookã€‚</li>
<li>æ³¨é‡Škubebuilderæ ‡è®°ï¼Œè®©<code>controller-gen</code>å¯ä»¥ç”Ÿæˆå¯¹åº”çš„webhook é…ç½®</li>
</ol>
<h4 id="å®ç°sidecarset-validating-admission-webhooké€»è¾‘">å®ç°SidecarSet Validating Admission Webhooké€»è¾‘</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// log is for logging in this package.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sidecarsetlog</span> = <span style="color:#a6e22e">logf</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">WithName</span>(<span style="color:#e6db74">&#34;sidecarset-resource&#34;</span>)

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">SetupWebhookWithManager</span>(<span style="color:#a6e22e">mgr</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Manager</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">NewWebhookManagedBy</span>(<span style="color:#a6e22e">mgr</span>).
		<span style="color:#a6e22e">For</span>(<span style="color:#a6e22e">r</span>).
		<span style="color:#a6e22e">Complete</span>()
}

<span style="color:#75715e">//+kubebuilder:webhook:path=/validate-apps-chinalhr-github-io-v1alpha1-sidecarset,mutating=false,failurePolicy=fail,sideEffects=None,groups=apps.chinalhr.github.io,resources=sidecarsets,verbs=create;update,versions=v1alpha1,name=vsidecarset.kb.io,admissionReviewVersions=v1
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">Validator</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SidecarSet</span>{}

<span style="color:#75715e">// ValidateCreate implements webhook.Validator so a webhook will be registered for the type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateCreate</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate create&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">validateSpec</span>()
}

<span style="color:#75715e">// ValidateUpdate implements webhook.Validator so a webhook will be registered for the type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateUpdate</span>(<span style="color:#a6e22e">old</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate update&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">validateSpec</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">validateSpec</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">apierrors</span>.<span style="color:#a6e22e">StatusError</span> {
	<span style="color:#a6e22e">spec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Spec</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">allErrs</span> <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">ErrorList</span>

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Selector</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">allErrs</span> = append(<span style="color:#a6e22e">allErrs</span>, <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Required</span>(<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">NewPath</span>(<span style="color:#e6db74">&#34;spec&#34;</span>).<span style="color:#a6e22e">Child</span>(<span style="color:#e6db74">&#34;selector&#34;</span>), <span style="color:#e6db74">&#34;no selector defined for sidecarset&#34;</span>))
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Selector</span>.<span style="color:#a6e22e">MatchLabels</span>)<span style="color:#f92672">+</span>len(<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Selector</span>.<span style="color:#a6e22e">MatchExpressions</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">allErrs</span> = append(<span style="color:#a6e22e">allErrs</span>, <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Invalid</span>(<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">NewPath</span>(<span style="color:#e6db74">&#34;spec&#34;</span>).<span style="color:#a6e22e">Child</span>(<span style="color:#e6db74">&#34;selector&#34;</span>), <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Selector</span>, <span style="color:#e6db74">&#34;empty selector is not valid for sidecarset.&#34;</span>))
		}
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">allErrs</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">apierrors</span>.<span style="color:#a6e22e">NewInvalid</span>(
		<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupKind</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#e6db74">&#34;apps.chinalhr.github.io&#34;</span>, <span style="color:#a6e22e">Kind</span>: <span style="color:#e6db74">&#34;SidecarSet&#34;</span>},
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">allErrs</span>)
}

<span style="color:#75715e">// ValidateDelete implements webhook.Validator so a webhook will be registered for the type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSet</span>) <span style="color:#a6e22e">ValidateDelete</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">sidecarsetlog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;validate delete&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>)

	<span style="color:#75715e">// TODO(user): fill in your validation logic upon object deletion.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>è¿™é‡Œä¸»è¦æ˜¯å®ç°äº†<code>validateSpec</code>æ–¹æ³•ï¼Œæ”¯æŒå¯¹SidecarSetåˆ›å»º/æ›´æ–°çš„è¯·æ±‚ï¼Œè¿›è¡Œ<code>spec</code> ä¸­<code>Selector</code>å±æ€§çš„æ ¡éªŒï¼›å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œåˆ™è¿”å›å¼‚å¸¸æ‹’ç»èµ„æºçš„åˆ›å»º/æ›´æ–°ã€‚</p>
<h4 id="å®ç°æ§åˆ¶å™¨åè°ƒé€»è¾‘">å®ç°æ§åˆ¶å™¨åè°ƒé€»è¾‘</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//+kubebuilder:rbac:groups=apps.chinalhr.github.io,resources=sidecarsets,verbs=get;list;watch;create;update;patch;delete
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=apps.chinalhr.github.io,resources=sidecarsets/status,verbs=get;update;patch
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=apps.chinalhr.github.io,resources=sidecarsets/finalizers,verbs=update
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=&#34;&#34;,resources=pods,verbs=get;list;watch;create;update;patch;delete
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=&#34;&#34;,resources=pods/status,verbs=get
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SidecarSetReconciler</span>) <span style="color:#a6e22e">Reconcile</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">log</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#75715e">//next reconcile
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">reconcileResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{<span style="color:#a6e22e">RequeueAfter</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>, <span style="color:#a6e22e">Requeue</span>: <span style="color:#66d9ef">true</span>}

	<span style="color:#75715e">//fetch the SidecarSet instance
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sidecarSet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1alpha1</span>.<span style="color:#a6e22e">SidecarSet</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">NamespacedName</span>, <span style="color:#a6e22e">sidecarSet</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;process sidecarSet error : object not found&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcileResult</span>, <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;process sidecarSet error : reading object error&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;begin to process sidecarSet [%s]&#34;</span>, <span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#75715e">//list matched pod
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">selector</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelectorAsSelector</span>(<span style="color:#a6e22e">sidecarSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;process sidecarSet error&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">listOpts</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">LabelSelector</span>: <span style="color:#a6e22e">selector</span>}

	<span style="color:#a6e22e">matchedPods</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">PodList</span>{}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">matchedPods</span>, <span style="color:#a6e22e">listOpts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;list matched pods error&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;process sidecarSet matchedPods&#34;</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">matchedPods</span>)

	<span style="color:#75715e">// ignore inactive pods
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">filteredPods</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">matchedPods</span>.<span style="color:#a6e22e">Items</span> {
		<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">matchedPods</span>.<span style="color:#a6e22e">Items</span>[<span style="color:#a6e22e">i</span>]
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsPodActive</span>(<span style="color:#a6e22e">pod</span>) {
			<span style="color:#a6e22e">filteredPods</span> = append(<span style="color:#a6e22e">filteredPods</span>, <span style="color:#a6e22e">pod</span>)
		}
	}

	<span style="color:#75715e">//calculateSidecarSetStatus
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">calculateSidecarSetStatus</span>(<span style="color:#a6e22e">sidecarSet</span>, <span style="color:#a6e22e">filteredPods</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;calculateSidecarSetStatus error&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//updateSidecarSetStatus
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">updateSidecarSetStatus</span>(<span style="color:#a6e22e">log</span>, <span style="color:#a6e22e">sidecarSet</span>, <span style="color:#a6e22e">status</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;updateSidecarSetStatus error&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcileResult</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>è¿™é‡Œå®ç°åŒ…æ‹¬ï¼š</p>
<ol>
<li>è·å–åˆ°sidecarSetèµ„æºï¼Œæ ¹æ®sidecarSetçš„<code>selector</code>è·å–åŒ¹é…çš„Podé›†åˆï¼Œæ ¹æ®Podçš„çŠ¶æ€è®¡ç®—å‡ºsidecarSetçš„Statusï¼Œå³å·²åŒ¹é…çš„Podæ•°é‡æ›´æ–°<code>MatchedPods</code> ï¼Œå·²ç»æ³¨å…¥sidecarå®¹å™¨çš„Podæ•°é‡æ›´æ–°<code>UpdatedPods</code>ï¼Œå·²ç»æ³¨å…¥sidecarå®¹å™¨å¹¶ä¸”å¤„äºRunningçŠ¶æ€çš„Podæ•°é‡æ›´æ–°<code>ReadyPods</code>ã€‚</li>
<li>æ·»åŠ kubebuilderæ³¨é‡Šæ ‡è®°ï¼Œå¢åŠ å¯¹Podï¼ŒPod Statuså¯¹åº”çš„æƒé™ã€‚</li>
</ol>
<h3 id="éƒ¨ç½²operator">éƒ¨ç½²Operator</h3>
<ul>
<li>ç”ŸæˆCRD/Webhook manifests</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ä½¿ç”¨spec/statuså­—æ®µä¸æ ‡è®°å’ŒCRD validationæ ‡è®°å®šä¹‰APIï¼Œä»¥åŠæ–°å¢äº†å…¶ä»–èµ„æºçš„Webhookï¼Œéœ€è¦ä½¿ç”¨make manifestsç”Ÿæˆ/æ›´æ–°CRDä¸webhookçš„ manifests</span>
make manifests
</code></pre></div><ul>
<li>éƒ¨ç½²cert-manager</li>
</ul>
<p>å› ä¸ºéœ€è¦ä¸ºwebhook serveré…ç½®è¯ä¹¦ï¼Œè¿™é‡Œéœ€è¦åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²cert managerä½œè¯ä¹¦ç®¡ç†ï¼Œå¯ä»¥å‚è€ƒ<a href="https://cert-manager.io/docs/">https://cert-manager.io/docs/</a>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.yaml
</code></pre></div><p><code>cert-manager</code>çš„CA injectorç»„ä»¶ä¼šå°† CA åŒ…æ³¨å…¥åˆ° Mutating|ValidatingWebhookConfiguration ä¸­ï¼Œoperator-sdkå·²ç»ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†å¯¹åº”çš„kustomize patchæ–‡ä»¶åœ¨<code>config/default/webhookcainjection_patch.yaml</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: admissionregistration.k8s.io/v1
<span style="color:#66d9ef">kind</span>: MutatingWebhookConfiguration
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: mutating-webhook-configuration
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">cert-manager.io/inject-ca-from</span>: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
---
<span style="color:#66d9ef">apiVersion</span>: admissionregistration.k8s.io/v1
<span style="color:#66d9ef">kind</span>: ValidatingWebhookConfiguration
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: validating-webhook-configuration
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">cert-manager.io/inject-ca-from</span>: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
</code></pre></div><ul>
<li>é€šè¿‡ kustomize å¯ç”¨ webhook å’Œ cert-manager é…ç½®config/default/kustomization.yamlä¸config/crd/kustomization.yamlï¼Œæ ¹æ®æ³¨é‡Šè¿›è¡Œé…ç½®</li>
<li>é€šè¿‡<code>make docker-build docker-push</code>è¿›è¡Œå®¹å™¨é•œåƒæ‰“åŒ…ä¸æ¨é€ï¼›é€šè¿‡<code>make deploy</code>éƒ¨ç½²Operatoråˆ°é›†ç¾¤ä¸­</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make docker-build docker-push IMG<span style="color:#f92672">=</span>ccr.ccs.tencentyun.com/open-operator/sidecar-operator:1.0.0
make deploy IMG<span style="color:#f92672">=</span>ccr.ccs.tencentyun.com/open-operator/sidecar-operator:1.0.0
</code></pre></div><h2 id="ä»£ç ä»“åº“">ä»£ç ä»“åº“</h2>
<p><a href="https://github.com/ChinaLHR/sidecar-operator">https://github.com/ChinaLHR/sidecar-operator</a></p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#operator">Operator</a>
          <ul>
            <li><a href="#ä»€ä¹ˆæ˜¯operator">ä»€ä¹ˆæ˜¯Operator</a></li>
            <li><a href="#operator-sdk-vs-kubebuilder">Operator-SDK Vs Kubebuilder</a></li>
            <li><a href="#operator-å·¥ä½œæ¨¡å¼">Operator å·¥ä½œæ¨¡å¼</a></li>
            <li><a href="#operator-åº”ç”¨åœºæ™¯">Operator åº”ç”¨åœºæ™¯</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes-admission-controller">Kubernetes Admission Controller</a></li>
        <li><a href="#operatorå¼€å‘å®è·µ">Operatorå¼€å‘å®è·µ</a>
          <ul>
            <li><a href="#operator-framework">Operator-Framework</a>
              <ul>
                <li><a href="#operator-sdk">Operator-SDK</a></li>
                <li><a href="#operator-lifecycle-managerolm">Operator-Lifecycle-Managerï¼ˆOLMï¼‰</a></li>
              </ul>
            </li>
            <li><a href="#åŸºäºoperator-sdkå¼€å‘sidecar-operator">åŸºäºOperator-SDKå¼€å‘Sidecar-Operator</a>
              <ul>
                <li><a href="#sidecar-operatorçš„åŠŸèƒ½">Sidecar-Operatorçš„åŠŸèƒ½</a></li>
                <li><a href="#å®‰è£…operator-sdk">å®‰è£…Operator-SDK</a></li>
                <li><a href="#åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</a></li>
                <li><a href="#åˆ›å»ºcustom-resource-ä¸-custom-controlleræ¨¡æ¿ä»£ç ">åˆ›å»ºCustom Resource ä¸ Custom Controlleræ¨¡æ¿ä»£ç </a></li>
                <li><a href="#åˆ›å»ºcustom-resouces-admission-webhookæ¨¡æ¿ä»£ç ">åˆ›å»ºCustom Resouces Admission Webhookæ¨¡æ¿ä»£ç </a></li>
                <li><a href="#æ ¸å¿ƒé€»è¾‘æ¢³ç†">æ ¸å¿ƒé€»è¾‘æ¢³ç†</a></li>
                <li><a href="#å®ç°podç±»å‹çš„mutating-admission-webhook">å®ç°Podç±»å‹çš„Mutating Admission Webhook</a></li>
                <li><a href="#å®ç°sidecarset-validating-admission-webhooké€»è¾‘">å®ç°SidecarSet Validating Admission Webhooké€»è¾‘</a></li>
                <li><a href="#å®ç°æ§åˆ¶å™¨åè°ƒé€»è¾‘">å®ç°æ§åˆ¶å™¨åè°ƒé€»è¾‘</a></li>
              </ul>
            </li>
            <li><a href="#éƒ¨ç½²operator">éƒ¨ç½²Operator</a></li>
          </ul>
        </li>
        <li><a href="#ä»£ç ä»“åº“">ä»£ç ä»“åº“</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
