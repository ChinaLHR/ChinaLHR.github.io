<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>JavaæŠ€æœ¯åŸŸä¸­çš„å¼‚æ­¥ç¼–ç¨‹</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, java'>

    <meta property="og:url" content="https://chinalhr.github.io/post/java-asyncprogram/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="JavaæŠ€æœ¯åŸŸä¸­çš„å¼‚æ­¥ç¼–ç¨‹">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="JavaæŠ€æœ¯åŸŸä¸­çš„å¼‚æ­¥ç¼–ç¨‹">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/java-asyncprogram/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/java-asyncprogram/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/java-asyncprogram/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>JavaæŠ€æœ¯åŸŸä¸­çš„å¼‚æ­¥ç¼–ç¨‹</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            April 3, 2020
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/java">java</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>JavaæŠ€æœ¯åŸŸå¼‚æ­¥ç¼–ç¨‹æ€»ç»“</p>
</blockquote>
<h2 id="å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿">å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿</h2>
<p>å¼‚æ­¥ç¼–ç¨‹æ˜¯å¯ä»¥è®©ç¨‹åºå¹¶è¡Œè¿è¡Œçš„ä¸€ç§æ‰‹æ®µï¼Œå…¶å¯ä»¥è®©ç¨‹åºä¸­çš„ä¸€ä¸ªå·¥ä½œå•å…ƒä¸ä¸»åº”ç”¨ç¨‹åºçº¿ç¨‹åˆ†å¼€ç‹¬ç«‹è¿è¡Œï¼Œå¹¶ä¸”ç­‰å·¥ä½œå•å…ƒè¿è¡Œç»“æŸåé€šçŸ¥ä¸»åº”ç”¨ç¨‹åºçº¿ç¨‹å®ƒçš„è¿è¡Œç»“æœæˆ–è€…å¤±è´¥åŸå› ã€‚ä½¿ç”¨å®ƒæœ‰è®¸å¤šå¥½å¤„ï¼Œä¾‹å¦‚æ”¹è¿›çš„åº”ç”¨ç¨‹åºæ€§èƒ½å’Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ç­‰ã€‚å¼‚æ­¥ç¼–ç¨‹å……åˆ†åˆ©ç”¨å•æ ¸CPUçš„æ€§èƒ½ï¼Œæ„åœ¨å•ä¸ªCPUä¸Šæ‰§è¡Œå‡ ä¸ªæ¾è€¦åˆçš„ä»»åŠ¡ã€‚</p>
<p><strong>åŒæ­¥é˜»å¡å¯¹æ¯”å¼‚æ­¥éé˜»å¡</strong></p>
<p>å½“çº¿ç¨‹å‘ç”Ÿä¸€æ¬¡rpcè°ƒç”¨æˆ–è€…httpè°ƒç”¨ï¼Œåˆæˆ–è€…å…¶ä»–çš„ä¸€äº›è€—æ—¶çš„IOè°ƒç”¨ï¼Œå‘èµ·ä¹‹åï¼Œå¦‚æœæ˜¯åŒæ­¥é˜»å¡ï¼Œè¿™ä¸ªçº¿ç¨‹å°±ä¼šè¢«é˜»å¡æŒ‚èµ·ï¼Œç›´åˆ°ç»“æœè¿”å›ï¼Œå¦‚æœIOè°ƒç”¨å¾ˆé¢‘ç¹çš„è¯CPUä½¿ç”¨ç‡å…¶å®ä¼šå¾ˆä½ã€‚é€šè¿‡å¼‚æ­¥éé˜»å¡è°ƒç”¨ï¼Œå½“å‘ç”ŸIOè°ƒç”¨æ—¶æˆ‘åªéœ€è¦æŠŠå›è°ƒå‡½æ•°å†™å…¥è¿™æ¬¡IOè°ƒç”¨ï¼Œæˆ‘è¿™ä¸ªæ—¶å€™çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†æ–°çš„è¯·æ±‚ï¼Œå½“IOè°ƒç”¨ç»“æŸç»“æŸæ—¶ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚</p>
<p><strong>å¼‚æ­¥ç¼–ç¨‹åœºæ™¯</strong>ï¼š</p>
<p>å¼‚æ­¥åŒ–å¹¶ä¸æ˜¯ä¸‡èƒ½ï¼Œå¼‚æ­¥åŒ–ç¨‹åºå¹¶ä¸èƒ½ç¼©çŸ­æ•´ä¸ªé“¾è·¯è°ƒç”¨æ—¶é—´é•¿çš„é—®é¢˜ï¼Œè€Œæ˜¯æ—¨åœ¨æœ€å¤§åŒ–æå‡qpsï¼Œä½†ä¹Ÿéœ€è¦é’ˆå¯¹åœºæ™¯å¼‚æ­¥ä¼˜åŒ–ã€‚</p>
<p>IOå¯†é›†å‹ï¼šä¾‹å¦‚ç½‘ç»œè°ƒç”¨ï¼Œæ–‡ä»¶ä¼ è¾“ï¼Œæ–‡ä»¶è¯»å–&hellip;ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹ä¸€èˆ¬ä¼šæŒ‚èµ·é˜»å¡ï¼Œå¼‚æ­¥ç¼–ç¨‹å¯ä»¥é’ˆå¯¹è¿™ä¸ªåœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>CPUå¯†é›†å‹ï¼šä¾‹å¦‚ä¸€äº›æ•°æ®çš„èšåˆè¿ç®—ï¼Œå¯¹è±¡çš„åºåˆ—åŒ–ï¼Œæ’åºæŸ¥æ‰¾ç­‰CPUè€—æ—¶ä»»åŠ¡ï¼Œå¼‚æ­¥åŒ–å¹¶ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦è¿›è¡Œä¸€äº›ç®—æ³•çš„ä¼˜åŒ–æˆ–è€…åˆ©ç”¨ä¸€äº›å¹¶è¡Œå¤„ç†æ¡†æ¶è¿›è¡Œä¼˜åŒ–ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUã€‚</p>
<h2 id="javaå¼‚æ­¥ç¼–ç¨‹æŠ€æœ¯å®ç°æ–¹å¼">Javaå¼‚æ­¥ç¼–ç¨‹æŠ€æœ¯å®ç°æ–¹å¼</h2>
<h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h3>
<p>å…·ä½“ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> ThreadPoolExecutor POOL_EXECUTOR <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">(</span>AVALIABLE_PROCESSORS<span style="color:#f92672">,</span> AVALIABLE_PROCESSORS <span style="color:#f92672">*</span> 2<span style="color:#f92672">,</span>
                    1<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTES</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;&gt;(</span>5<span style="color:#f92672">),</span>
                    <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">CallerRunsPolicy</span><span style="color:#f92672">());</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * æŠ•é€’ä»»åŠ¡ï¼Œä¸è·å–è¿”å›å€¼
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">threadPoolAsyncRunnable</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        StopWatch watch <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StopWatch<span style="color:#f92672">();</span>
        watch<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ThreadPoolAsyncTask&#34;</span><span style="color:#f92672">);</span>
        POOL_EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task1&#34;</span><span style="color:#f92672">));</span>
        doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task2&#34;</span><span style="color:#f92672">);</span>
        watch<span style="color:#f92672">.</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;total time :{} millisecond&#34;</span><span style="color:#f92672">,</span> watch<span style="color:#f92672">.</span><span style="color:#a6e22e">getTotalTimeMillis</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * æŠ•é€’ä»»åŠ¡ï¼ŒåŒæ­¥è·å–
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">threadPoolAsyncSubmit</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ExecutionException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        StopWatch watch <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StopWatch<span style="color:#f92672">();</span>
        watch<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ThreadPoolAsyncTask&#34;</span><span style="color:#f92672">);</span>
        Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> resultFuture <span style="color:#f92672">=</span> POOL_EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task1&#34;</span><span style="color:#f92672">));</span>
        doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task2&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//åŒæ­¥ç­‰å¾…ç»“æœ
</span><span style="color:#75715e"></span>        String result <span style="color:#f92672">=</span> resultFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        watch<span style="color:#f92672">.</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;total time :{} millisecond&#34;</span><span style="color:#f92672">,</span> watch<span style="color:#f92672">.</span><span style="color:#a6e22e">getTotalTimeMillis</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h4 id="æ ¸å¿ƒç†å¿µ">æ ¸å¿ƒç†å¿µ</h4>
<p>ä½¿ç”¨çº¿ç¨‹æ¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡å½“å‰çº¿ç¨‹ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æ¥å®ç°çº¿ç¨‹çš„å¤ç”¨ã€‚</p>
<h4 id="çº¿ç¨‹æ± æ„é€ ">çº¿ç¨‹æ± æ„é€ </h4>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/1118bb1f37969f9b88845a222ab34a53_MD5.png">
    <img src="/attachment/1118bb1f37969f9b88845a222ab34a53_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<ul>
<li>ctlï¼šæ˜¯Integerçš„åŸå­å˜é‡ï¼ŒåŒæ—¶è®°å½•çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹ä¸ªæ•°</li>
</ul>
<pre><code>- çº¿ç¨‹æ± çŠ¶æ€
RUNNINGï¼šæ¥æ”¶æ–°ä»»åŠ¡å¹¶ä¸”å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡
SHUTDOWNï¼šæ‹’ç»æ–°ä»»åŠ¡ä½†æ˜¯å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡
STOPï¼šæ‹’ç»æ–°ä»»åŠ¡å¹¶ä¸”æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼ŒåŒæ—¶ä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡
TIDYINGï¼šæ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼ˆåŒ…å«é˜»å¡é˜Ÿåˆ—é‡Œé¢ä»»åŠ¡ï¼‰ï¼Œå½“å‰çº¿ç¨‹æ± æ´»åŠ¨çº¿ç¨‹ä¸º0ï¼Œå°†è¦è°ƒç”¨terminatedæ–¹æ³•
TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ã€‚terminatedæ–¹æ³•è°ƒç”¨å®Œæˆä»¥åçš„çŠ¶æ€

- çŠ¶æ€è½¬æ¢
æ˜¾å¼è°ƒç”¨shutdown()æ–¹æ³•æˆ–è€…éšå¼è°ƒç”¨äº†finalize()ï¼šRUNNINGâ†’SHUTDOWN
æ˜¾å¼è°ƒç”¨shutdownNow()æ–¹æ³•ï¼šRUNNINGæˆ–è€…SHUTDOWNâ†’STOP
å½“çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©ºæ—¶ï¼šSHUTDOWNâ†’TIDYING
å½“çº¿ç¨‹æ± ä¸ºç©ºæ—¶ï¼šSTOPâ†’TIDYING
å½“terminated() hookæ–¹æ³•æ‰§è¡Œå®Œæˆæ—¶ï¼šTIDYINGâ†’TERMINATED
</code></pre><ul>
<li>corePoolSizeï¼šçº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä¸ªæ•°</li>
<li>workQueueï¼šç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</li>
<li>maximunPoolSizeï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°é‡</li>
<li>threadFactoryï¼šåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»</li>
<li>defaultHandlerï¼šé¥±å’Œç­–ç•¥ï¼Œå½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”çº¿ç¨‹ä¸ªæ•°è¾¾åˆ°maximunPoolSizeåé‡‡å–çš„ç­–ç•¥ï¼Œæ¯”å¦‚AbortPolicyï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ã€CallerRunsPolicyï¼ˆä½¿ç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡ï¼‰ã€DiscardOldestPolicyï¼ˆè°ƒç”¨pollä¸¢å¼ƒä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå½“å‰ä»»åŠ¡ï¼‰ã€DiscardPolicyï¼ˆé»˜é»˜ä¸¢å¼ƒï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼‰</li>
<li>keeyAliveTimeï¼šå­˜æ´»æ—¶é—´ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ¯”æ ¸å¿ƒçº¿ç¨‹æ•°é‡è¦å¤šï¼Œå¹¶ä¸”æ˜¯é—²ç½®çŠ¶æ€çš„è¯ï¼Œè¿™äº›é—²ç½®çš„çº¿ç¨‹èƒ½å­˜æ´»çš„æœ€å¤§æ—¶é—´ã€‚</li>
</ul>
<h4 id="çº¿ç¨‹æ± æŠ•é€’ä»»åŠ¡åŸç†ç®€è¿°">çº¿ç¨‹æ± æŠ•é€’ä»»åŠ¡åŸç†ç®€è¿°</h4>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/c8bd520fcd24c33aff8d52db0587b3ba_MD5.png">
    <img src="/attachment/c8bd520fcd24c33aff8d52db0587b3ba_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<ul>
<li>execute</li>
</ul>
<p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">...</span>

            <span style="color:#75715e">//1. è·å–å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€+çº¿ç¨‹ä¸ªæ•°å˜é‡çš„ç»„åˆå€¼
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">//2. å½“å‰çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°æ˜¯å¦å°äºcorePoolSizeï¼Œå°äºåˆ™å¼€å¯æ–°çº¿ç¨‹è¿è¡Œ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> corePoolSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>addWorker<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        	<span style="color:#75715e">//3. å¦‚æœçº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€ï¼Œåˆ™æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isRunning<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>command<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>

            <span style="color:#75715e">//3.1 äºŒæ¬¡æ£€æŸ¥
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> recheck <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">//3.2 å¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯RUNNINGåˆ™ä»é˜Ÿåˆ—åˆ é™¤ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œæ‹’ç»ç­–ç•¥
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span> isRunning<span style="color:#f92672">(</span>recheck<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> remove<span style="color:#f92672">(</span>command<span style="color:#f92672">))</span>
                reject<span style="color:#f92672">(</span>command<span style="color:#f92672">);</span>

            <span style="color:#75715e">//3.3 å¦‚æœå½“å‰çº¿ç¨‹æ± çº¿ç¨‹ä¸ºç©ºï¼Œåˆ™æ·»åŠ ä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>recheck<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                addWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//4. å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™æ–°å¢çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å¤§äºmaximumPoolSizeæ‰§è¡Œæ‹’ç»ç­–ç•¥
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span> addWorker<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">))</span>
            reject<span style="color:#f92672">(</span>command<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

</code></pre></div><ul>
<li>submit</li>
</ul>
<p>submitä¼šå°†RunnableåŒ…è£…æˆRunnableFutureåï¼Œè°ƒç”¨executeæŠ•é€’åˆ°çº¿ç¨‹æ± æ‰§è¡Œ</p>
<ul>
<li>worker</li>
</ul>
<p>ä¸Šè¿°addWorkeræ–¹æ³•æ‰§è¡Œåï¼Œç”¨æˆ·çº¿ç¨‹ä¼šé©¬ä¸Šè¿”å›ï¼Œä»»åŠ¡ç¨åå†ç”±Workerçº¿ç¨‹æ‰§è¡Œã€‚Workeræœ¬èº«å®ç°äº†Runnableæ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	runWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span> <span style="color:#75715e">//å§”æ‰˜ç»™runWorkeræ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>workerçš„runWorkeræ–¹æ³•ä¼šè·å–çº¿ç¨‹è¿›è¡Œä»»åŠ¡æ‰§è¡Œï¼Œå¹¶ä¸”ä¼šæ‰§è¡Œè°ƒç”¨å‰åçš„é’©å­æ–¹æ³•ã€‚</p>
<h4 id="çº¿ç¨‹æ± å…³é—­">çº¿ç¨‹æ± å…³é—­</h4>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/1bae749cdb6b9ee028b4e9d9175ee023_MD5.png">
    <img src="/attachment/1bae749cdb6b9ee028b4e9d9175ee023_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<h4 id="æ€»ç»“">æ€»ç»“</h4>
<p>è™½ç„¶çº¿ç¨‹æ± æ–¹å¼æä¾›äº†çº¿ç¨‹å¤ç”¨å¯ä»¥è·å–ä»»åŠ¡è¿”å›å€¼ï¼Œä½†æ˜¯è·å–è¿”å›å€¼æ—¶è¿˜æ˜¯éœ€è¦é˜»å¡è°ƒç”¨çº¿ç¨‹çš„ã€‚</p>
<h3 id="jdkçš„future">JDKçš„Future</h3>
<p>JUCåŒ…ä¸­Futureå¯ä»¥ç”¨äºå¼‚æ­¥è®¡ç®—ï¼ŒFutureä¸­æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ç”¨æ¥æ£€æŸ¥è®¡ç®—ç»“æœæ˜¯å¦å·²ç»å®Œæˆã€åŒæ­¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€è·å–è®¡ç®—ç»“æœã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/f7bfd325999c4ecb98e0fef8100019a1_MD5.png">
    <img src="/attachment/f7bfd325999c4ecb98e0fef8100019a1_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<h4 id="futuretask">FutureTask</h4>
<p>FutureTaskå®ç°äº†Futureæ¥å£ï¼Œæ¥å—çš„ä»»åŠ¡å¯ä»¥æ˜¯Callableç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯Runnableç±»å‹ï¼Œä¸€èˆ¬è¢«æäº¤åˆ°çº¿ç¨‹æ± ä¸­è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œæœ€åè°ƒç”¨getç³»åˆ—æ–¹æ³•é˜»å¡è·å–ã€‚å…·ä½“ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> 		<span style="color:#75715e">//å¼‚æ­¥æ‰§è¡Œtask1
</span><span style="color:#75715e"></span>        FutureTask<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> task <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FutureTask<span style="color:#f92672">&lt;&gt;(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task1&#34;</span><span style="color:#f92672">));</span>
        POOL_EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>

        <span style="color:#75715e">//åŒæ­¥æ‰§è¡Œtask2
</span><span style="color:#75715e"></span>        String result2 <span style="color:#f92672">=</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task2&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//åŒæ­¥ç­‰å¾…task1
</span><span style="color:#75715e"></span>        String result1 <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</code></pre></div><h4 id="futuretaskæ„é€ ">FutureTaskæ„é€ </h4>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/28c8c56c5c0db411d5662c2b04cbc40b_MD5.png">
    <img src="/attachment/28c8c56c5c0db411d5662c2b04cbc40b_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<ul>
<li>stateï¼šç”¨æ¥è®°å½•ä»»åŠ¡çš„çŠ¶æ€</li>
</ul>
<pre><code>private static final int NEW           = 0;		//æ–°å»º
private static final int COMPLETING    = 1;		//å®Œæˆä¸­...
private static final int NORMAL        = 2;		//æ­£å¸¸
private static final int EXCEPTIONAL   = 3;		//å¼‚å¸¸
private static final int CANCELLED     = 4;		//å–æ¶ˆ
private static final int INTERRUPTING  = 5;		//ä¸­æ–­ä¸­...
private static final int INTERRUPTED   = 6;		//ä¸­æ–­

- çŠ¶æ€è½¬æ¢
NEWâ†’COMPLETINGâ†’NORMALï¼šæ­£å¸¸ç»ˆæ­¢æµç¨‹è½¬æ¢
NEWâ†’COMPLETINGâ†’EXCEPTIONALï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æµç¨‹è½¬æ¢
NEWâ†’CANCELLEDï¼šä»»åŠ¡è¿˜æ²¡å¼€å§‹å°±è¢«å–æ¶ˆ
NEWâ†’INTERRUPTINGâ†’INTERRUPTEDï¼šä»»åŠ¡è¢«ä¸­æ–­
</code></pre><ul>
<li>outcomeï¼šä»»åŠ¡è¿è¡Œçš„ç»“æœ</li>
<li>runnerï¼šè®°å½•è¿è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹</li>
<li>waitersï¼šé“¾è¡¨ç»“æ„ï¼Œè®°å½•ç­‰å¾…ä»»åŠ¡ç»“æœçš„çº¿ç¨‹</li>
</ul>
<h4 id="futuretaskæ‰§è¡Œä¸è·å–">FutureTaskæ‰§è¡Œä¸è·å–</h4>
<ul>
<li>runï¼ˆRunnableæ¥å£å®ç°ï¼‰</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">!=</span> NEW <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> runnerOffset<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()))</span>
        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        Callable<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> c <span style="color:#f92672">=</span> callable<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> state <span style="color:#f92672">==</span> NEW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            V result<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">boolean</span> ran<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">();</span>
                ran <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                ran <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                setException<span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ran<span style="color:#f92672">)</span>
                set<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// runner must be non-null until state is settled to
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// prevent concurrent calls to run()
</span><span style="color:#75715e"></span>        runner <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// state must be re-read after nulling runner to prevent
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// leaked interrupts
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;=</span> INTERRUPTING<span style="color:#f92672">)</span>
            handlePossibleCancellationInterrupt<span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“åˆ›å»ºä¸€ä¸ªFutureTaskæ—¶ï¼Œå…¶ä»»åŠ¡çŠ¶æ€åˆå§‹åŒ–ä¸ºNEWï¼Œæäº¤åˆ°çº¿ç¨‹æˆ–è€…çº¿ç¨‹æ± åï¼Œä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¯¥FutureTaskä»»åŠ¡ï¼Œé€šè¿‡è°ƒç”¨FutureTaskçš„run()æ‰§è¡Œã€‚run()æ–¹æ³•åˆ¤æ–­å¹¶ä¸”è®¾ç½®stateçŠ¶æ€ï¼Œè°ƒç”¨call() æ‰§è¡Œä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åä¼šæŠŠç»“æœæˆ–è€…å¼‚å¸¸ä¿¡æ¯è®¾ç½®åˆ°outcomeå˜é‡ï¼Œæœ€åè°ƒç”¨LockSupport.unpark()å”¤é†’waitersé“¾è¡¨ä¸­æ‰€æœ‰ç”±äºç­‰å¾…è·å–ç»“æœè€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¹¶ä»waitersé“¾è¡¨ä¸­ç§»é™¤å®ƒä»¬ã€‚</p>
<ul>
<li>get</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> ExecutionException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&lt;=</span> COMPLETING<span style="color:#f92672">)</span>
        s <span style="color:#f92672">=</span> awaitDone<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> report<span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">awaitDone</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> timed<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanos<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> deadline <span style="color:#f92672">=</span> timed <span style="color:#f92672">?</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> nanos <span style="color:#f92672">:</span> 0L<span style="color:#f92672">;</span>
    WaitNode q <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">boolean</span> queued <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            removeWaiter<span style="color:#f92672">(</span>q<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;</span> COMPLETING<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                q<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span> s<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> COMPLETING<span style="color:#f92672">)</span> <span style="color:#75715e">// cannot time out yet
</span><span style="color:#75715e"></span>            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            q <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WaitNode<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>queued<span style="color:#f92672">)</span>
            queued <span style="color:#f92672">=</span> UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> waitersOffset<span style="color:#f92672">,</span>
                                                 q<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> waiters<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            nanos <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanos <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                removeWaiter<span style="color:#f92672">(</span>q<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> state<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">parkNanos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> nanos<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span>
            LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨FutureTaskçš„get()æ–¹æ³•æ¥ç­‰å¾…è·å–ç»“æœï¼Œget()æ–¹æ³•ä¼šåˆ¤æ–­ä»»åŠ¡çŠ¶æ€æ˜¯å¦å°äºç­‰äºCOMPLETINGï¼Œæ˜¯åˆ™é˜»å¡çº¿ç¨‹å¾ªç¯ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ŒåŠ å…¥waitersé“¾è¡¨ï¼Œè°ƒç”¨LockSupport.park()æŒ‚èµ·çº¿ç¨‹ï¼Œå¦‚æœä»»åŠ¡çŠ¶æ€ä¸ºCOMPLETINGï¼ˆæ­£åœ¨æ‰§è¡Œï¼‰ï¼Œè°ƒç”¨Thread.yield()è¿›è¡Œçº¿ç¨‹è®©æ­¥ã€‚å½“çº¿ç¨‹è¢«æ¿€æ´»æ—¶ï¼Œä¼šå»è·å–outcomeå˜é‡æ‹¿åˆ°ç»“æœã€‚</p>
<h4 id="æ€»ç»“-1">æ€»ç»“</h4>
<p>FutureTaskè™½ç„¶æä¾›äº†ç”¨æ¥æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆã€ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æœã€è·å–ä»»åŠ¡æ‰§è¡Œç»“æœçš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå¹¶ä¸èƒ½æ¸…æ¥šåœ°è¡¨è¾¾å¤šä¸ªFutureTaskä¹‹é—´çš„å…³ç³»ã€‚è€Œä¸”ä»Futureè·å–ç»“æœéœ€è¦è°ƒç”¨get()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å‰é˜»å¡è°ƒç”¨çº¿ç¨‹ã€‚</p>
<h3 id="jdkçš„completablefuture">JDKçš„CompletableFuture</h3>
<p>CompletableFutureæ˜¯ä¸€ä¸ªå¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼æ˜¾å¼åœ°è®¾ç½®è®¡ç®—ç»“æœå’ŒçŠ¶æ€ä»¥ä¾¿è®©ä»»åŠ¡ç»“æŸçš„Futureï¼Œå¹¶ä¸”å…¶å¯ä»¥ä½œä¸ºä¸€ä¸ªCompletionStageï¼ˆè®¡ç®—é˜¶æ®µï¼‰ï¼Œå½“å®ƒçš„è®¡ç®—å®Œæˆæ—¶å¯ä»¥è§¦å‘ä¸€ä¸ªå‡½æ•°æˆ–è€…è¡Œä¸ºï¼›å½“å¤šä¸ªçº¿ç¨‹ä¼å›¾è°ƒç”¨åŒä¸€ä¸ªCompletableFutureçš„completeã€cancelæ–¹å¼æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸã€‚</p>
<p>CompletableFutureæ‰€æœ‰å¼‚æ­¥çš„æ–¹æ³•åœ¨æ²¡æœ‰æ˜¾å¼æŒ‡å®šExecutorå‚æ•°çš„æƒ…å½¢ä¸‹éƒ½æ˜¯å¤ForkJoinPoolçš„commonPool()çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚</p>
<p>CompletableFutureåŸºäºæ ˆæ”¶é›†ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªCompletableFutureå¯¹è±¡ä¸Šè¡Œä¸ºæ³¨å†Œçš„é¡ºåºä¸è¡Œä¸ºæ‰§è¡Œçš„é¡ºåºæ˜¯ç›¸åçš„ã€‚</p>
<h4 id="æ˜¾å¼è®¾ç½®completablefutureç»“æœ">æ˜¾å¼è®¾ç½®CompletableFutureç»“æœ</h4>
<p>é€šè¿‡ç¼–ç¨‹æ˜¾å¼è®¾ç½®ç»“æœçš„futureï¼ˆcompleteï¼‰ï¼Œé˜»å¡è·å–ç»“æœï¼ˆgetï¼‰ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompletableFuture<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CompletableFuture<span style="color:#f92672">&lt;&gt;();</span>
        POOL_EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(()-&gt;{</span>
            String result <span style="color:#f92672">=</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task1&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">//æ˜¾å¼è®¾ç½®
</span><span style="color:#75715e"></span>            future<span style="color:#f92672">.</span><span style="color:#a6e22e">complete</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#f92672">});</span>
        <span style="color:#75715e">//é˜»å¡è·å–
</span><span style="color:#75715e"></span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;result:{}&#34;</span><span style="color:#f92672">,</span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">());</span>
</code></pre></div><h4 id="å¼‚æ­¥è®¡ç®—ä¸ç»“æœè½¬æ¢">å¼‚æ­¥è®¡ç®—ä¸ç»“æœè½¬æ¢</h4>
<p><strong>æ–¹æ³•å‘½åè§„å¾‹</strong>ï¼šä»¥runä¸ºä¾‹å­ï¼Œä¸ä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±åŸæ¥çš„çº¿ç¨‹è®¡ç®—ï¼Œä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±é»˜è®¤çš„çº¿ç¨‹æ± ForkJoinPool.commonPool()æˆ–è€…æŒ‡å®šçš„çº¿ç¨‹æ± executorè¿è¡Œã€‚</p>
<p><strong>runAsync</strong>ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥è®¡ç®—</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> CompletableFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">runAsync</span><span style="color:#f92672">(</span>Runnable runnable<span style="color:#f92672">,</span>Executor executor<span style="color:#f92672">)</span>
</code></pre></div><p><strong>supplyAsync</strong>ï¼šå¸¦æœ‰è¿”å›å€¼çš„å¼‚æ­¥è®¡ç®—ï¼Œå¯ä»¥é€šè¿‡getæ–¹æ³•è·å–è¿”å›å€¼</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> CompletableFuture<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(</span>Supplier<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> supplier<span style="color:#f92672">,</span>Executor executor<span style="color:#f92672">)</span>
</code></pre></div><p><strong>thenRunAsync</strong>ï¼šæ‰§è¡Œå®Œæˆä»»åŠ¡åï¼Œæ¿€æ´»å…¶ä»–ä»»åŠ¡ï¼ˆå…¶ä»–ä»»åŠ¡æ‹¿ä¸åˆ°ä¹‹å‰ä»»åŠ¡çš„è¿”å›å€¼ï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> CompletableFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">thenRunAsync</span><span style="color:#f92672">(</span>Runnable action<span style="color:#f92672">,</span>Executor executor<span style="color:#f92672">)</span>
</code></pre></div><p><strong>thenAcceptAsync</strong>ï¼šæ‰§è¡Œå®Œæˆä»»åŠ¡åï¼Œæ¿€æ´»å…¶ä»–ä»»åŠ¡ï¼ˆå…¶ä»–ä»»åŠ¡å¯ä»¥æ‹¿åˆ°ä¹‹å‰ä»»åŠ¡çš„è¿”å›å€¼ï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompletableFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">thenAcceptAsync</span><span style="color:#f92672">(</span>Consumer<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">&gt;</span> action<span style="color:#f92672">,</span>Executor executor<span style="color:#f92672">)</span>
<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> CompletableFuture<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">thenApplyAsync</span><span style="color:#f92672">(</span>Function<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">,?</span> <span style="color:#66d9ef">extends</span> U<span style="color:#f92672">&gt;</span> fn<span style="color:#f92672">,</span> Executor executor<span style="color:#f92672">)</span>

<span style="color:#75715e">//example
</span><span style="color:#75715e"></span>CompletableFuture<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from thenRun1&#34;</span><span style="color:#f92672">),</span>POOL_EXECUTOR<span style="color:#f92672">);</span>
CompletableFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> thenRunFuture <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">thenRunAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from thenRun2&#34;</span><span style="color:#f92672">),</span>POOL_EXECUTOR<span style="color:#f92672">);</span>

</code></pre></div><p><strong>whenCompleteAsync</strong>ï¼šè®¾ç½®å›è°ƒå‡½æ•°ï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼ï¼Œä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompletableFuture<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">);</span>
       future<span style="color:#f92672">.</span><span style="color:#a6e22e">whenCompleteAsync</span><span style="color:#f92672">((</span>s<span style="color:#f92672">,</span> throwable<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
           <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Objects<span style="color:#f92672">.</span><span style="color:#a6e22e">nonNull</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)){</span>
               log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;result:{}&#34;</span><span style="color:#f92672">,</span>s<span style="color:#f92672">);</span>
           <span style="color:#f92672">}</span>
       <span style="color:#f92672">},</span>POOL_EXECUTOR<span style="color:#f92672">);</span>
</code></pre></div><h4 id="å¤šcompletablefutureç»„åˆè¿ç®—">å¤šCompletableFutureç»„åˆè¿ç®—</h4>
<p><strong>thenCompose</strong>ï¼šå½“ä¸€ä¸ªCompletableFutureæ‰§è¡Œå®Œæ¯•åï¼Œæ‰§è¡Œå¦å¤–ä¸€ä¸ªCompletableFuture</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> CompletableFuture<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">thenComposeAsync</span><span style="color:#f92672">(</span>
        Function<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">,</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">extends</span> CompletionStage<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;&gt;</span> fn<span style="color:#f92672">)</span>
</code></pre></div><p><strong>thenCombine</strong>ï¼šå½“ä¸¤ä¸ªå¹¶å‘è¿è¡Œçš„CompletableFutureä»»åŠ¡éƒ½å®Œæˆåï¼Œä½¿ç”¨ä¸¤è€…çš„ç»“æœä½œä¸ºå‚æ•°å†æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>U<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> CompletableFuture<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">thenCombineAsync</span><span style="color:#f92672">(</span>
        CompletionStage<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> U<span style="color:#f92672">&gt;</span> other<span style="color:#f92672">,</span>
        BiFunction<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">,?</span> <span style="color:#66d9ef">super</span> U<span style="color:#f92672">,?</span> <span style="color:#66d9ef">extends</span> V<span style="color:#f92672">&gt;</span> fn<span style="color:#f92672">)</span> 

<span style="color:#75715e">//example
</span><span style="color:#75715e"></span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync1&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">thenCombineAsync</span><span style="color:#f92672">(</span>CompletableFuture
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync2&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">)</span>
                        <span style="color:#f92672">,</span> <span style="color:#f92672">(</span>result1<span style="color:#f92672">,</span> result2<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> result1 <span style="color:#f92672">+</span> result2<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">whenCompleteAsync</span><span style="color:#f92672">((</span>s<span style="color:#f92672">,</span> throwable<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Objects<span style="color:#f92672">.</span><span style="color:#a6e22e">nonNull</span><span style="color:#f92672">(</span>s<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;result:{}&#34;</span><span style="color:#f92672">,</span> s<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">},</span> POOL_EXECUTOR<span style="color:#f92672">);</span>

</code></pre></div><p><strong>allOf</strong>ï¼šç­‰å¾…å¤šä¸ªå¹¶å‘è¿è¡Œçš„CompletableFutureä»»åŠ¡æ‰§è¡Œå®Œæ¯•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#66d9ef">static</span> CompletableFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">allOf</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">&lt;?&gt;...</span> cfs<span style="color:#f92672">)</span> 

 <span style="color:#75715e">//example
</span><span style="color:#75715e"></span>ArrayList<span style="color:#f92672">&lt;</span>CompletableFuture<span style="color:#f92672">&gt;</span> futures <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
        futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync1&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">));</span>
        futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync2&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">));</span>
        futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> doSomeThing<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;task from supplyAsync3&#34;</span><span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">));</span>

        CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">allOf</span><span style="color:#f92672">(</span>futures<span style="color:#f92672">.</span><span style="color:#a6e22e">toArray</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> CompletableFuture<span style="color:#f92672">[</span>futures<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()])).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</code></pre></div><p><strong>anyOf</strong>ï¼šç­‰å¤šä¸ªå¹¶å‘è¿è¡Œçš„CompletableFutureä»»åŠ¡ä»»æ„ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#66d9ef">static</span> CompletableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">anyOf</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">&lt;?&gt;...</span> cfs<span style="color:#f92672">)</span>
</code></pre></div><h4 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</h4>
<p>å½“å‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯ä»¥è°ƒç”¨future.completeExceptionally(e) æŠŠå¼‚å¸¸ä¿¡æ¯è®¾ç½®åˆ°futureå†…éƒ¨ï¼Œgetè·å–æ—¶ä¼šæŠŠå¼‚å¸¸å¸¦å‡ºæ¥ï¼Œæˆ–è€…future.exceptionallyè®¾ç½®å‡ºç°å¼‚å¸¸æ—¶è¿”å›çš„é»˜è®¤å€¼ã€‚</p>
<h4 id="streamä¸completablefuture">Streamä¸CompletableFuture</h4>
<p>å¯ä»¥ä½¿ç”¨mapå°†ä¸€äº›æ•°æ®ä¼ è¿›CompletableFutureè¿›è¡Œå¼‚æ­¥è°ƒç”¨ï¼Œå¹¶è½¬æ¢æˆCompletableFutureã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> requests <span style="color:#f92672">=</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;request1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;request2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;request3&#34;</span><span style="color:#f92672">);</span>

        <span style="color:#75715e">//è½¬æ¢æˆCompletableFutureï¼Œå¼‚æ­¥è°ƒç”¨
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>CompletableFuture<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> futures <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>request <span style="color:#f92672">-&gt;</span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> getRpcResult<span style="color:#f92672">(</span>request<span style="color:#f92672">),</span> POOL_EXECUTOR<span style="color:#f92672">))</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toList</span><span style="color:#f92672">());</span>

        <span style="color:#75715e">//åŒæ­¥é˜»å¡ç­‰å¾…è°ƒç”¨å®Œæ¯•ï¼Œæ”¶é›†ç»“æœ
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> rpcResponse <span style="color:#f92672">=</span> futures<span style="color:#f92672">.</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">::</span>join<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toList</span><span style="color:#f92672">());</span>

        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;rpcResponse:{}&#34;</span><span style="color:#f92672">,</span> rpcResponse<span style="color:#f92672">);</span>
</code></pre></div><h3 id="rxjavaä¸reactor">RxJavaä¸Reactor</h3>
<p>å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰æ˜¯ä¸€ç§æ¶‰åŠæ•°æ®æµå’Œå˜åŒ–ä¼ æ’­çš„å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ï¼Œå¯ä»¥é€šè¿‡æ‰€é‡‡ç”¨çš„ç¼–ç¨‹è¯­è¨€è½»æ¾åœ°è¡¨è¾¾é™æ€ï¼ˆä¾‹å¦‚é˜µåˆ—ï¼‰æˆ–åŠ¨æ€ï¼ˆä¾‹å¦‚äº‹ä»¶å‘å°„å™¨ï¼‰æ•°æ®æµã€‚RxJavaä¸Reactoréƒ½æ˜¯å¯¹å“åº”å¼ç¼–ç¨‹ç†å¿µå®ç°ï¼ŒåŸºäºReactive Streamsæ ‡å‡†ï¼Œéµå¾ªäº†åŒä¸€ä¸ªè§„èŒƒï¼Œå¯ä»¥å¾ˆè½»æ˜“åœ°ä»ä¸€æ–¹åˆ‡æ¢åˆ°å¦ä¸€æ–¹ ã€‚</p>
<p><strong>å¯¹æ¯”Javaçš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹</strong></p>
<p>Javaæä¾›äº†ä¸¤ç§å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹</p>
<ul>
<li><strong>CallBacks</strong>ï¼šå¼‚æ­¥æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œé‡‡ç”¨ callback ä½œä¸ºå‚æ•°ï¼ˆlambda æˆ–åŒ¿åç±»ï¼‰ï¼Œå½“ç»“æœå‡ºæ¥åå›è°ƒ callbackã€‚å¦‚CompletableFuture.whenCompleteAsyncã€EventListenerã€‚</li>
<li><strong>Futures</strong>ï¼šå¼‚æ­¥æ–¹æ³•ç«‹å³è¿”å›<code>Future&lt;T&gt;</code>ï¼Œå¼‚æ­¥çº¿ç¨‹è®¡ç®—ä»»åŠ¡ï¼Œå¹¶å½“ç»“æœTè®¡ç®—å‡ºæ¥åè®¾ç½®åˆ°Futureä¸­ã€‚å¦‚ExecutorServiceæ‰§è¡Œ<code>Callable&lt;T&gt;</code> ä»»åŠ¡åè¿”å›Futureå¯¹è±¡ã€‚</li>
</ul>
<p><strong>CallBacksä¸Futureså±€é™æ€§</strong>ï¼š</p>
<p>å¤šä¸ªCallbackç»„åˆåœ¨ä¸€èµ·åï¼Œå®¹æ˜“å½¢æˆå›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰ï¼›å¤šä¸ªFutureéš¾ä»¥ç¼–æ’ï¼Œå°½ç®¡ä½¿ç”¨æ”¹è¿›åçš„CompletableFutureï¼Œä¹Ÿå­˜åœ¨ä¸æ”¯æŒå»¶è¿Ÿè®¡ç®—å’Œé«˜çº§é”™è¯¯å¤„ç†çš„ç¼ºé™·ã€‚</p>
<p>å“åº”å¼ç¼–ç¨‹åº“åŸºäºå£°æ˜å¼ç¼–ç¨‹ï¼Œæ¯”è¾ƒCallbacksæ›´é€šä¿—æ˜“æ‡‚ï¼ŒåŒæ—¶è‡ªå¸¦å¾ˆå¤šæ“ä½œç¬¦ï¼Œæä¾›é«˜çº§ç‰¹æ€§ï¼Œç®€åŒ–å¤„ç†ã€‚</p>
<p>å‚è€ƒå¯¹æ¯”ï¼š<a href="https://htmlpreview.github.io/?https://github.com/get-set/reactor-core/blob/master-zh/src/docs/index.html#_%E5%BC%82%E6%AD%A5%E5%8F%AF%E4%BB%A5%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E5%90%97">Reactor 3 å‚è€ƒæ–‡æ¡£</a></p>
<p><strong>å“åº”å¼ç¼–ç¨‹åº“é€šè¿‡å¦‚ä¸‹å‡ ç‚¹å¼¥è¡¥Javaå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹çš„ä¸è¶³</strong></p>
<ul>
<li><strong>å¯ç¼–æ’æ€§ï¼ˆComposabilityï¼‰</strong> ä»¥åŠ <strong>å¯è¯»æ€§ï¼ˆReadabilityï¼‰</strong></li>
<li>ä½¿ç”¨ä¸°å¯Œçš„ <strong>æ“ä½œç¬¦</strong> æ¥å¤„ç†å½¢å¦‚ <strong>æµ</strong> çš„æ•°æ®</li>
<li>åœ¨ <strong>è®¢é˜…ï¼ˆsubscribeï¼‰</strong> ä¹‹å‰ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ</li>
<li><strong>èƒŒå‹ï¼ˆbackpressureï¼‰</strong> å…·ä½“æ¥è¯´å³æ¶ˆè´¹è€…èƒ½å¤Ÿåå‘å‘ŠçŸ¥ç”Ÿäº§è€…ç”Ÿäº§å†…å®¹çš„é€Ÿåº¦çš„èƒ½åŠ›</li>
<li><strong>é«˜å±‚æ¬¡</strong> ï¼ˆåŒæ—¶ä¹Ÿæ˜¯æœ‰é«˜ä»·å€¼çš„ï¼‰çš„æŠ½è±¡ï¼Œä»è€Œè¾¾åˆ° å¹¶å‘æ— å…³ çš„æ•ˆæœ</li>
</ul>
<h4 id="åŸºäºrxjavaå®ç°å¼‚æ­¥ç¼–ç¨‹">åŸºäºRxJavaå®ç°å¼‚æ­¥ç¼–ç¨‹</h4>
<ul>
<li>observeOnï¼ˆåˆ‡æ¢è°ƒåº¦çº¿ç¨‹æ‰§è¡Œè®¢é˜…è€…å‡½æ•°ï¼‰</li>
</ul>
<p>æ³¨æ„ï¼ŒobserveOnåˆ‡æ¢åˆ°äº†å…¶ä»–çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œä½†æ˜¯äº‹ä»¶è¿˜æ˜¯æŒ‰å‘é€é¡ºåºåŒæ­¥æ‰§è¡Œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   Flowable<span style="color:#f92672">.</span><span style="color:#a6e22e">fromArray</span><span style="color:#f92672">(</span>requests<span style="color:#f92672">.</span><span style="color:#a6e22e">toArray</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span>0<span style="color:#f92672">]))</span>
                <span style="color:#75715e">//åˆ‡æ¢åˆ°IOè°ƒåº¦çº¿ç¨‹æ‰§è¡Œè®¢é˜…è€…å‡½æ•°
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">observeOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">())</span>
                <span style="color:#75715e">//å¼‚æ­¥è°ƒç”¨ï¼ŒæŒ‰å‘å¸ƒé¡ºåºé¡ºåºæ‰§è¡Œ
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>getRpcResponse<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>response<span style="color:#f92672">-&gt;</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get Rpc Response:{}&#34;</span><span style="color:#f92672">,</span>response<span style="color:#f92672">));</span>
</code></pre></div><ul>
<li>subscribeOnï¼ˆåˆ‡æ¢åˆ°è°ƒåº¦çº¿ç¨‹æ‰§è¡Œå‘å¸ƒè€…å‡½æ•°ï¼‰</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Flowable<span style="color:#f92672">.</span><span style="color:#a6e22e">fromCallable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>generateRequests<span style="color:#f92672">)</span>
            <span style="color:#75715e">//åˆ‡æ¢åˆ°IOè°ƒåº¦çº¿ç¨‹æ‰§è¡Œå‘å¸ƒè€…å‡½æ•°
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribeOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">())</span>
            <span style="color:#75715e">//åˆ‡æ¢åˆ°Signleè°ƒåº¦çº¿ç¨‹æ‰§è¡Œè®¢é˜…è€…å‡½æ•°
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">observeOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">single</span><span style="color:#f92672">())</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">::</span>print<span style="color:#f92672">);</span>
</code></pre></div><ul>
<li>flatMapä¸subscribeOnè¿›è¡Œå¹¶å‘è°ƒç”¨</li>
</ul>
<p>é’ˆå¯¹ä¸Šè¿°observeOnä¾‹å­é¡ºåºæ‰§è¡Œçš„æƒ…å†µï¼Œè¦åšåˆ°å¹¶å‘æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡flatMapæ“ä½œç¬¦é…åˆsubscribeOnè¿›è¡Œæ“ä½œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨flatMapå°†Requestå‚æ•°è½¬æ¢ä¸ºFlowableï¼Œåˆ©ç”¨subscribeOnåˆ‡æ¢åˆ°è°ƒåº¦çº¿ç¨‹æ‰§è¡Œï¼Œåšåˆ°äº†å¹¶å‘è°ƒç”¨ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  Flowable<span style="color:#f92672">.</span><span style="color:#a6e22e">fromArray</span><span style="color:#f92672">(</span>generateRequests<span style="color:#f92672">())</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">flatMap</span><span style="color:#f92672">(</span>requests <span style="color:#f92672">-&gt;</span>
                        <span style="color:#75715e">//flatMapå°†Requestè½¬æ¢ä¸ºFlowableå¯¹è±¡
</span><span style="color:#75715e"></span>                        Flowable<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>requests<span style="color:#f92672">)</span>
                                <span style="color:#75715e">//åˆ‡æ¢åˆ°è°ƒåº¦çº¿ç¨‹æ‰§è¡Œå‘å¸ƒè€…å‡½æ•°
</span><span style="color:#75715e"></span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribeOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">())</span>
                                <span style="color:#75715e">//æ‰§è¡Œrpcè°ƒç”¨è½¬æ¢æˆResponse
</span><span style="color:#75715e"></span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>getRpcResponse<span style="color:#f92672">))</span>
                <span style="color:#75715e">//é˜»å¡ç­‰å¾…æ‰€æœ‰çš„rpcè°ƒç”¨å¹¶å‘æ‰§è¡Œå®Œæ¯•
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">blockingSubscribe</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">::</span>print<span style="color:#f92672">);</span>
</code></pre></div><h4 id="åŸºäºreactorå®ç°å¼‚æ­¥ç¼–ç¨‹">åŸºäºReactorå®ç°å¼‚æ­¥ç¼–ç¨‹</h4>
<p>Reactorä¸­çš„æµæ“ä½œç¬¦ä¸RxJavaåŸºæœ¬ç›¸åŒï¼Œä¸‹é¢ç®€å•é‡å†™äº†ä¸Šè¿°RxJavaçš„ä¾‹å­</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  
  Flux<span style="color:#f92672">.</span><span style="color:#a6e22e">fromArray</span><span style="color:#f92672">(</span>generateRequests<span style="color:#f92672">())</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">flatMap</span><span style="color:#f92672">(</span>requests <span style="color:#f92672">-&gt;</span>
                        <span style="color:#75715e">//flatMapå°†Requestè½¬æ¢ä¸ºFlowableå¯¹è±¡
</span><span style="color:#75715e"></span>                        Flux<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>requests<span style="color:#f92672">)</span>
                                <span style="color:#75715e">//åˆ‡æ¢åˆ°è°ƒåº¦çº¿ç¨‹æ‰§è¡Œå‘å¸ƒè€…å‡½æ•°
</span><span style="color:#75715e"></span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribeOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">elastic</span><span style="color:#f92672">())</span>
                                <span style="color:#75715e">//æ‰§è¡Œrpcè°ƒç”¨è½¬æ¢æˆResponse
</span><span style="color:#75715e"></span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>getRpcResponse<span style="color:#f92672">))</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>response <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
                    log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get Rpc Response :{}&#34;</span><span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
                <span style="color:#f92672">});</span>
                
Flux<span style="color:#f92672">.</span><span style="color:#a6e22e">fromArray</span><span style="color:#f92672">(</span>generateRequests<span style="color:#f92672">())</span>
                <span style="color:#75715e">//åˆ‡æ¢åˆ°IOè°ƒåº¦çº¿ç¨‹æ‰§è¡Œè®¢é˜…è€…å‡½æ•°
</span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">publishOn</span><span style="color:#f92672">(</span>Schedulers<span style="color:#f92672">.</span><span style="color:#a6e22e">elastic</span><span style="color:#f92672">())</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>getRpcResponse<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>response <span style="color:#f92672">-&gt;</span> log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get Rpc Response:{}&#34;</span><span style="color:#f92672">,</span> response<span style="color:#f92672">));</span>
</code></pre></div><h3 id="springçš„taskexecutor">Springçš„TaskExecutor</h3>
<p>Spring 2.0ç‰ˆæœ¬å¼€å§‹æä¾›äº†ä¸€ç§æ–°çš„å¤„ç†æ‰§è¡Œå™¨ï¼ˆexecutorsï¼‰çš„æŠ½è±¡ï¼ŒTaskExecutorã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">TaskExecutor</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>Runnable task<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p><strong>Springå†…ç½®TaskExecutorå®ç°</strong></p>
<ul>
<li>SimpleAsyncTaskExecutorï¼ˆæ¯ä¸ªè¯·æ±‚ä¼šæ–°åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹æ¥æ‰§è¡Œï¼‰</li>
<li>SyncTaskExecutorï¼ˆåŒæ­¥ä½¿ç”¨è°ƒç”¨çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼‰</li>
<li>ConcurrentTaskExecutorï¼ˆå¯¹JDK5ä¸­çš„java.util.concurrent.Executorçš„ä¸€ä¸ªåŒ…è£…ï¼Œé€šè¿‡setConcurrentExecutorè®¾ç½®ä¸€ä¸ªJUCä¸­çš„çº¿ç¨‹æ± åˆ°å…¶å†…éƒ¨æ¥åšé€‚é…ï¼‰</li>
<li>SimpleThreadPoolTaskExecutorï¼ˆQuartzçš„SimpleThreadPoolçš„å­ç±»ï¼Œä¼šç›‘å¬Springçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼‰</li>
<li>ThreadPoolTaskExecutorï¼ˆæ¯”è¾ƒå¸¸ç”¨ï¼Œç”¨äºé…ç½®java.util.concurrent.ThreadPoolExecutorå¹¶å°†å…¶åŒ…è£…åœ¨TaskExecutorä¸­ã€‚å¦‚æœéœ€è¦ä¸€äº›é«˜çº§çš„æ¥å£ï¼Œä¾‹å¦‚ScheduledThreadPoolExecutorï¼Œå¯ä»¥ä½¿ç”¨Concurrent TaskExecutorï¼‰</li>
<li>TimerTaskExecutorï¼ˆå¯¹æ‰€æœ‰æäº¤çš„ä»»åŠ¡éƒ½åœ¨Timerå†…çš„å•ç‹¬çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰</li>
</ul>
<h4 id="åœ¨springbootä¸­ä½¿ç”¨taskexecutorè¿›è¡Œå¼‚æ­¥å¤„ç†">åœ¨SpringBootä¸­ä½¿ç”¨TaskExecutorè¿›è¡Œå¼‚æ­¥å¤„ç†</h4>
<ol>
<li>é…ç½®Executorå‚æ•°</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsyncTaskConfig</span> <span style="color:#66d9ef">implements</span> AsyncConfigurer <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Executor <span style="color:#a6e22e">getAsyncExecutor</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        ThreadPoolTaskExecutor threadPoolTaskExecutor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPoolTaskExecutor<span style="color:#f92672">();</span>
        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setThreadNamePrefix</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;AsyncThread-&#34;</span><span style="color:#f92672">);</span>
        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setCorePoolSize</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxPoolSize</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setRejectedExecutionHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">CallerRunsPolicy</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rejectedExecution</span><span style="color:#f92672">(</span>Runnable r<span style="color:#f92672">,</span> ThreadPoolExecutor e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ‰“å°çº¿ç¨‹æ± å¼‚å¸¸ä¿¡æ¯...
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rejectedExecution</span><span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        <span style="color:#75715e">//å…³é—­æ‰§è¡Œå™¨æ—¶ä¸ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å°±ä¸­æ–­æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setWaitForTasksToCompleteOnShutdown</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        threadPoolTaskExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> threadPoolTaskExecutor<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
	
	<span style="color:#75715e">//æ‹’ç»ç­–ç•¥
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> AsyncUncaughtExceptionHandler <span style="color:#a6e22e">getAsyncUncaughtExceptionHandler</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> SimpleAsyncUncaughtExceptionHandler<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><ol start="2">
<li>åœ¨SpringBootApplicationç±»ä¸Šæ·»åŠ @EnableAsyncæ³¨è§£ã€‚</li>
<li>åœ¨æ–¹æ³•ä¸Šæ·»åŠ @Asyncï¼Œå¼‚æ­¥æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®é™…æ‰§è¡Œå°†å‘ç”Ÿåœ¨Springçš„TaskExecutorå¼‚æ­¥å¤„ç†å™¨çº¿ç¨‹ä¸­ã€‚åŸºäº@Asyncæ³¨è§£çš„å¼‚æ­¥å¤„ç†æ˜¯æ”¯æŒè¿”å›å€¼çš„ï¼Œä½†æ˜¯è¿”å›å€¼ç±»å‹å¿…é¡»æ˜¯Futureæˆ–è€…å…¶å­ç±»ç±»å‹çš„ï¼Œå¦‚JDKçš„Futureç±»å‹ï¼ŒSpringæ¡†æ¶çš„ListenableFutureç±»å‹ï¼Œæˆ–è€…JDK8ä¸­çš„ CompletableFutureç±»å‹ï¼Œåˆæˆ–è€…Springä¸­çš„AsyncResultç±»å‹ç­‰ã€‚</li>
</ol>
<h4 id="asyncæ³¨è§£æ‰§è¡ŒåŸç†">@Asyncæ³¨è§£æ‰§è¡ŒåŸç†</h4>
<p>@EnableAsyncå¼€å¯åä¼šæŠŠProxyAsyncConfigurationçš„å®ä¾‹æ³¨å…¥Springå®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringæ¡†æ¶æ˜¯ä½¿ç”¨Cglibå¯¹æ ‡æ³¨@Asyncæ³¨è§£çš„æ–¹æ³•è¿›è¡Œä»£ç†çš„ï¼Œå…·ä½“æ‹¦æˆªå™¨æ˜¯AnnotationAsyncExecutionInterceptorä½œä¸ºåˆ‡é¢é€»è¾‘ï¼Œå½“æˆ‘ä»¬è°ƒç”¨å«æœ‰@Asyncæ³¨è§£çš„Beançš„æ–¹æ³•æ—¶å€™ï¼Œå®é™…è°ƒç”¨çš„æ˜¯è¢«ä»£ç†åçš„Beanï¼ŒAnnotationAsyncExecutionInterceptorçš„invokeæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MethodInvocation invocation<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
        <span style="color:#75715e">//1ï¼è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡
</span><span style="color:#75715e"></span>        Class<span style="color:#f92672">&lt;?&gt;</span> targetClass <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">getThis</span><span style="color:#f92672">()</span> <span style="color:#f92672">!</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> AopUtils<span style="color:#f92672">.</span>
                <span style="color:#a6e22e">getTargetClass</span><span style="color:#f92672">(</span>invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">getThis</span><span style="color:#f92672">())</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//2. è·å–è¢«ä»£ç†çš„æ–¹æ³•
</span><span style="color:#75715e"></span>        Method specificMethod <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getMostSpecificMethod</span><span style="color:#f92672">(</span>invocation<span style="color:#f92672">.</span>
                <span style="color:#a6e22e">getMethod</span><span style="color:#f92672">(),</span> targetClass<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> Method userDeclaredMethod <span style="color:#f92672">=</span> BridgeMethodResolver<span style="color:#f92672">.</span><span style="color:#a6e22e">findBridgedMethod</span><span style="color:#f92672">(</span>
                specificMethod<span style="color:#f92672">);</span>
        <span style="color:#75715e">//3. åˆ¤æ–­ä½¿ç”¨å“ªä¸ªæ‰§è¡Œå™¨æ‰§è¡Œè¢«ä»£ç†çš„æ–¹æ³•
</span><span style="color:#75715e"></span>        AsyncTaskExecutor executor <span style="color:#f92672">=</span> determineAsyncExecutor<span style="color:#f92672">(</span>userDeclaredMethod<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>executor <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;No executor specified and no default executor set on
</span><span style="color:#e6db74">                    AsyncExecutionInterceptor either&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//4. ä½¿ç”¨CallableåŒ…è£…è¦æ‰§è¡Œçš„æ–¹æ³•
</span><span style="color:#75715e"></span>        Callable<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> task <span style="color:#f92672">=</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Object result <span style="color:#f92672">=</span> invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">proceed</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#66d9ef">instanceof</span> Future<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>Future<span style="color:#f92672">&lt;?&gt;)</span> result<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                handleError<span style="color:#f92672">(</span>ex<span style="color:#f92672">.</span><span style="color:#a6e22e">getCause</span><span style="color:#f92672">(),</span> userDeclaredMethod<span style="color:#f92672">,</span> invocation<span style="color:#f92672">.</span>
                        <span style="color:#a6e22e">getArguments</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                handleError<span style="color:#f92672">(</span>ex<span style="color:#f92672">,</span> userDeclaredMethod<span style="color:#f92672">,</span> invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">getArguments</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">};</span>
        <span style="color:#75715e">//5. æäº¤åŒ…è£…çš„Callableä»»åŠ¡åˆ°æŒ‡å®šæ‰§è¡Œå™¨æ‰§è¡Œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> doSubmit<span style="color:#f92672">(</span>task<span style="color:#f92672">,</span> executor<span style="color:#f92672">,</span> invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>doSubmitä¼šåˆ¤æ–­æ–¹æ³•çš„è¿”å›å€¼ç±»å‹è¿›è¡ŒåŒ…è£…ï¼Œç„¶åæäº¤åˆ°çº¿ç¨‹æ± ä¸­è¿è¡Œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">doSubmit</span><span style="color:#f92672">(</span>Callable<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> task<span style="color:#f92672">,</span> AsyncTaskExecutor executor<span style="color:#f92672">,</span>
                              Class<span style="color:#f92672">&lt;?&gt;</span> returnType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//5.1åˆ¤æ–­æ–¹æ³•è¿”å›å€¼æ˜¯å¦ä¸ºCompletableFutureç±»å‹æˆ–è€…æ˜¯å…¶å­ç±»
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">supplyAsync</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> CompletionException<span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> executor<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//5.2åˆ¤æ–­è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºListenableFutureç±»å‹æˆ–è€…æ˜¯å…¶å­ç±»
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ListenableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>AsyncListenableTaskExecutor<span style="color:#f92672">)</span> executor<span style="color:#f92672">).</span>
                    submitListenable<span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//5.3åˆ¤æ–­è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºListenableFutureç±»å‹æˆ–è€…æ˜¯å…¶å­ç±»
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Future<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> executor<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//5.4å…¶ä»–æƒ…å†µä¸‹æ²¡æœ‰è¿”å›å€¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            executor<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="java-servletå¼‚æ­¥ç¼–ç¨‹">Java Servletå¼‚æ­¥ç¼–ç¨‹</h3>
<p>Servlet3.0è§„èŒƒå‰ï¼ŒServletå®¹å™¨çš„çº¿ç¨‹æ¨¡å‹å¦‚ä¸‹ï¼š</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/6b27d1c966c776ec41c1a26eb10783bc_MD5.png">
    <img src="/attachment/6b27d1c966c776ec41c1a26eb10783bc_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<p>æ¯ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹è¿™ç§1 : 1çš„æ¨¡å¼è¿›è¡Œå¤„ç†çš„åŒæ­¥çº¿ç¨‹æ¨¡å‹ï¼Œçº¿ç¨‹æ•°æ˜¯æœ‰é™çš„ï¼Œå½“çº¿ç¨‹æ± èµ„æºè€—å°½åå°±ä¸èƒ½æ¥æ”¶å¤„ç†æ–°çš„è¯·æ±‚äº†ï¼Œé™åˆ¶äº†æœåŠ¡å™¨çš„å¹¶å‘è¯·æ±‚æ•°ã€‚</p>
<h4 id="servlet30-æä¾›çš„å¼‚æ­¥å¤„ç†">Servlet3.0 æä¾›çš„å¼‚æ­¥å¤„ç†</h4>
<p>Servlet 3.0è§„èŒƒä¸­å¼•å…¥äº†å¼‚æ­¥å¤„ç†è¯·æ±‚çš„èƒ½åŠ›ï¼Œç›¸å¯¹3.0ä¹‹å‰çš„åŒæ­¥çº¿ç¨‹æ¨¡å‹ï¼ŒServletå†…å¼€å¯å¼‚æ­¥å¤„ç†åä¼šç«‹åˆ»é‡Šæ”¾Servletå®¹å™¨çº¿ç¨‹ï¼Œå…·ä½“å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ä¸å“åº”çš„æ˜¯ä¸šåŠ¡çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/dc0102d70a8d2aadcfddc326406284c4_MD5.png">
    <img src="/attachment/dc0102d70a8d2aadcfddc326406284c4_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<p>å®˜æ–¹ä¾‹å­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@WebServlet</span><span style="color:#f92672">(</span>urlPatterns<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/asyncservlet&#34;</span><span style="color:#f92672">},</span> asyncSupported<span style="color:#f92672">=</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsyncServlet</span> <span style="color:#66d9ef">extends</span> HttpServlet <span style="color:#f92672">{</span>
   <span style="color:#75715e">/* ... Same variables and init method as in SyncServlet ... */</span>

   <span style="color:#a6e22e">@Override</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doGet</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> 
                     HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      response<span style="color:#f92672">.</span><span style="color:#a6e22e">setContentType</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
      <span style="color:#66d9ef">final</span> AsyncContext acontext <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">startAsync</span><span style="color:#f92672">();</span>
      acontext<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
         <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            String param <span style="color:#f92672">=</span> acontext<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;param&#34;</span><span style="color:#f92672">);</span>
            String result <span style="color:#f92672">=</span> resource<span style="color:#f92672">.</span><span style="color:#a6e22e">process</span><span style="color:#f92672">(</span>param<span style="color:#f92672">);</span>
            HttpServletResponse response <span style="color:#f92672">=</span> acontext<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">/* ... print to the response ... */</span>
            acontext<span style="color:#f92672">.</span><span style="color:#a6e22e">complete</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
      <span style="color:#f92672">});</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="servlet31-æä¾›çš„éé˜»å¡ioå¤„ç†">Servlet3.1 æä¾›çš„éé˜»å¡IOå¤„ç†</h4>
<p>Servlet 3.0è§„èŒƒè®©Servletçš„æ‰§è¡Œå˜ä¸ºäº†å¼‚æ­¥ï¼Œä½†æ˜¯å…¶IOè¿˜æ˜¯é˜»å¡å¼çš„ï¼ˆä»ServletInputStreamä¸­è¯»å–è¯·æ±‚ä½“æ—¶æ˜¯é˜»å¡çš„ï¼‰ã€‚</p>
<p>ä¸ºæ­¤åœ¨Servlet3.1è§„èŒƒä¸­æä¾›äº†éé˜»å¡IOå¤„ç†æ–¹å¼ï¼Œï¼ˆå½“å†…æ ¸æ”¯æŒï¼‰Servlet3.1å…è®¸æˆ‘ä»¬åœ¨ServletInputStreamä¸Šé€šè¿‡å‡½æ•°setReadListeneræ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨åœ¨å‘ç°å†…æ ¸æœ‰æ•°æ®æ—¶æ‰ä¼šè¿›è¡Œå›è°ƒå¤„ç†å‡½æ•°ã€‚</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/c3cb834e1b93dae0c75bc69d6440a620_MD5.png">
    <img src="/attachment/c3cb834e1b93dae0c75bc69d6440a620_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> AsyncContext asyncContext <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">startAsync</span><span style="color:#f92672">();</span>

    <span style="color:#75715e">//è®¾ç½®æ•°æ®å°±ç»ªç›‘å¬å™¨
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> ServletInputStream inputStream <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">();</span>
    inputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">setReadListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ReadListener<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onError</span> <span style="color:#f92672">(</span>Throwable throwable<span style="color:#f92672">){</span>
            <span style="color:#75715e">//å¼‚å¸¸å¤„ç†
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onDataAvailable</span> <span style="color:#f92672">()</span><span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
            <span style="color:#75715e">//æ•°æ®å°±ç»ªæ—¶å›è°ƒï¼Œè·å–æ•°æ®æµ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> ServletInputStream inputStream <span style="color:#f92672">=</span> asyncContext<span style="color:#f92672">.</span>
                    <span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onAllDataRead</span> <span style="color:#f92672">()</span><span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
            <span style="color:#75715e">//è¯·æ±‚ä½“çš„æ•°æ®å…¨éƒ¨è¢«è¯»å–å®Œæ¯•åï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="netty">Netty</h3>
<p>Nettyæ˜¯ä¸€ä¸ªå¼‚æ­¥ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œå…¶å¯¹Java NIOè¿›è¡Œäº†å°è£…ï¼Œç®€åŒ–äº†TCP/UDPæœåŠ¡å™¨çš„ç½‘ç»œç¼–ç¨‹å¼€å‘ã€‚</p>
<p>Nettyæ¡†æ¶å°†ç½‘ç»œç¼–ç¨‹é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘å¤„ç†åˆ†ç¦»å¼€æ¥ï¼Œå…¶å†…éƒ¨ä¼šè‡ªåŠ¨å¤„ç†å¥½ç½‘ç»œä¸å¼‚æ­¥å¤„ç†é€»è¾‘ï¼Œä½¿ç”¨è€…åªéœ€è¦å…³æ³¨é€»è¾‘å¤„ç†ã€‚Nettyçš„å¼‚æ­¥éé˜»å¡èƒ½åŠ›ä¸CompletableFutureç»“åˆå¯ä»¥è®©æˆ‘ä»¬è½»æ¾å®ç°ç½‘ç»œè¯·æ±‚çš„å¼‚æ­¥è°ƒç”¨ã€‚</p>
<p>å¾ˆå¤šç°ä»£åŒ–ï¼Œé«˜æ€§èƒ½çš„Webæ¡†æ¶ï¼ŒRPCæ¡†æ¶åº•å±‚éƒ½æ˜¯ç”¨æ¥Nettyæ¥å®ç°ï¼Œä¾‹å¦‚WebFluxï¼ŒVert.xï¼ŒDubboï¼ŒRocketMq&hellip;ã€‚</p>
<h4 id="çº¿ç¨‹æ¨¡å‹">çº¿ç¨‹æ¨¡å‹</h4>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/996bbec23607f2fcbfb5b3a7de94834c_MD5.png">
    <img src="/attachment/996bbec23607f2fcbfb5b3a7de94834c_MD5.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<p>ä»¥Netty Serverç«¯ä¸ºä¾‹å­ï¼ŒNettyServerå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸¤ä¸ªNioEventLoop Groupçº¿ç¨‹æ± ç»„ï¼Œå…¶ä¸­Boss Groupç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„è¿æ¥ï¼ŒWorker Group åˆ™è´Ÿè´£å¯¹å®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥è¿›è¡Œå¤„ç†ã€‚å›¾ä¸­æ¯ä¸ªNioEventLoopGroupé‡Œé¢åŒ…å«äº†å¤šä¸ªNio EventLoopï¼Œæ¯ä¸ªNioEventLoopä¸­åŒ…å«äº†ä¸€ä¸ªNIO Selectorã€ä¸€ä¸ªé˜Ÿåˆ—ã€ä¸€ä¸ªçº¿ç¨‹ï¼›å…¶ä¸­çº¿ç¨‹ç”¨æ¥åšè½®è¯¢æ³¨å†Œåˆ°Selectorä¸Šçš„Channelçš„è¯»å†™äº‹ä»¶å’Œå¯¹æŠ•é€’åˆ°é˜Ÿåˆ—é‡Œé¢çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p>
<p>å½“å®¢æˆ·ç«¯å‘æ¥ä¸€ä¸ªè¿æ¥è¯·æ±‚æ—¶ï¼ŒBossçº¿ç¨‹æ± ç»„ä¸­æ³¨å†Œäº†ç›‘å¬å¥—æ¥å­—çš„NioEventLoopä¸­çš„Selectorä¼šè¯»å–TCPä¸‰æ¬¡æ¡æ‰‹çš„è¯·æ±‚ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„è¿æ¥å¥—æ¥å­—é€šé“NioSocketChannelï¼Œæ¥ç€æŠŠå…¶æ³¨å†Œåˆ°Workerçº¿ç¨‹æ± ç»„çš„æŸä¸€ä¸ªNioEventLoopä¸­ç®¡ç†çš„ä¸€ä¸ªNIO Selectorä¸Šï¼Œè¯¥è¿æ¥å¥—æ¥å­—é€šé“NioSocketChannelä¸Šçš„æ‰€æœ‰è¯»å†™äº‹ä»¶éƒ½ç”±è¯¥NioEventLoopç®¡ç†ã€‚</p>
<ul>
<li>éé˜»å¡write</li>
</ul>
<p>NioSocketChannelçš„writeç³»åˆ—æ–¹æ³•å‘è¿æ¥é‡Œé¢å†™å…¥æ•°æ®æ—¶æ˜¯éé˜»å¡çš„ï¼Œå…·ä½“å®ç°æ˜¯æ‰§è¡Œwriteæ–¹æ³•æ—¶åˆ¤æ–­æ˜¯å¦æ˜¯IOçº¿ç¨‹è°ƒç”¨ï¼Œä¸æ˜¯åˆ™æŠŠå†™å…¥è¯·æ±‚å°è£…ä¸ºWriteTaskå¹¶æŠ•é€’åˆ°ä¸å…¶å¯¹åº”çš„NioEventLoopä¸­çš„é˜Ÿåˆ—é‡Œé¢ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>Object msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> flush<span style="color:#f92672">,</span> ChannelPromise promise<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
            <span style="color:#75715e">//1ï¼å¦‚æœè°ƒç”¨çº¿ç¨‹æ˜¯IOçº¿ç¨‹,ç›´æ¥æ‰§è¡Œ
</span><span style="color:#75715e"></span>            EventExecutor executor <span style="color:#f92672">=</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">executor</span><span style="color:#f92672">();</span>
              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>executor<span style="color:#f92672">.</span><span style="color:#a6e22e">inEventLoop</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flush<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                      next<span style="color:#f92672">.</span><span style="color:#a6e22e">invokeWriteAndFlush</span><span style="color:#f92672">(</span>m<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
                  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                      next<span style="color:#f92672">.</span><span style="color:#a6e22e">invokeWrite</span><span style="color:#f92672">(</span>m<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
                  <span style="color:#f92672">}</span>
              <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span><span style="color:#75715e">//2ï¼å¦‚æœè°ƒç”¨çº¿ç¨‹ä¸æ˜¯IOçº¿ç¨‹ï¼Œå°è£…ä¸ºWriteTaskæŠ•é€’åˆ°å¯¹åº”çš„NioEventLoopä¸­çš„é˜Ÿåˆ—ï¼ŒNioEventLoopçš„çº¿ç¨‹è½®è¯¢é˜Ÿåˆ—å¤„ç†
</span><span style="color:#75715e"></span>                  AbstractWriteTask task<span style="color:#f92672">;</span>
                  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flush<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                      task <span style="color:#f92672">=</span> WriteAndFlushTask<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>next<span style="color:#f92672">,</span> m<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
                  <span style="color:#f92672">}</span>   <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                      task <span style="color:#f92672">=</span> WriteTask<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>next<span style="color:#f92672">,</span> m<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
                  <span style="color:#f92672">}</span>
                  safeExecute<span style="color:#f92672">(</span>executor<span style="color:#f92672">,</span> task<span style="color:#f92672">,</span> promise<span style="color:#f92672">,</span> m<span style="color:#f92672">);</span>
              <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>

</code></pre></div><ul>
<li>éé˜»å¡read</li>
</ul>
<p>NioSocketChannelä¸­è¯»å–æ•°æ®æ—¶ï¼Œç­‰NioEventLoopä¸­çš„IOè½®è¯¢çº¿ç¨‹å‘ç°Selectorä¸Šæœ‰æ•°æ®å°±ç»ªæ—¶ï¼Œé€šè¿‡äº‹ä»¶é€šçŸ¥æ–¹å¼æ¥é€šçŸ¥æˆ‘ä»¬ä¸šåŠ¡æ•°æ®å·²ç»å°±ç»ªï¼Œæ˜¯éé˜»å¡çš„ã€‚</p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿">å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿</a></li>
        <li><a href="#javaå¼‚æ­¥ç¼–ç¨‹æŠ€æœ¯å®ç°æ–¹å¼">Javaå¼‚æ­¥ç¼–ç¨‹æŠ€æœ¯å®ç°æ–¹å¼</a>
          <ul>
            <li><a href="#çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a>
              <ul>
                <li><a href="#æ ¸å¿ƒç†å¿µ">æ ¸å¿ƒç†å¿µ</a></li>
                <li><a href="#çº¿ç¨‹æ± æ„é€ ">çº¿ç¨‹æ± æ„é€ </a></li>
                <li><a href="#çº¿ç¨‹æ± æŠ•é€’ä»»åŠ¡åŸç†ç®€è¿°">çº¿ç¨‹æ± æŠ•é€’ä»»åŠ¡åŸç†ç®€è¿°</a></li>
                <li><a href="#çº¿ç¨‹æ± å…³é—­">çº¿ç¨‹æ± å…³é—­</a></li>
                <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
              </ul>
            </li>
            <li><a href="#jdkçš„future">JDKçš„Future</a>
              <ul>
                <li><a href="#futuretask">FutureTask</a></li>
                <li><a href="#futuretaskæ„é€ ">FutureTaskæ„é€ </a></li>
                <li><a href="#futuretaskæ‰§è¡Œä¸è·å–">FutureTaskæ‰§è¡Œä¸è·å–</a></li>
                <li><a href="#æ€»ç»“-1">æ€»ç»“</a></li>
              </ul>
            </li>
            <li><a href="#jdkçš„completablefuture">JDKçš„CompletableFuture</a>
              <ul>
                <li><a href="#æ˜¾å¼è®¾ç½®completablefutureç»“æœ">æ˜¾å¼è®¾ç½®CompletableFutureç»“æœ</a></li>
                <li><a href="#å¼‚æ­¥è®¡ç®—ä¸ç»“æœè½¬æ¢">å¼‚æ­¥è®¡ç®—ä¸ç»“æœè½¬æ¢</a></li>
                <li><a href="#å¤šcompletablefutureç»„åˆè¿ç®—">å¤šCompletableFutureç»„åˆè¿ç®—</a></li>
                <li><a href="#å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</a></li>
                <li><a href="#streamä¸completablefuture">Streamä¸CompletableFuture</a></li>
              </ul>
            </li>
            <li><a href="#rxjavaä¸reactor">RxJavaä¸Reactor</a>
              <ul>
                <li><a href="#åŸºäºrxjavaå®ç°å¼‚æ­¥ç¼–ç¨‹">åŸºäºRxJavaå®ç°å¼‚æ­¥ç¼–ç¨‹</a></li>
                <li><a href="#åŸºäºreactorå®ç°å¼‚æ­¥ç¼–ç¨‹">åŸºäºReactorå®ç°å¼‚æ­¥ç¼–ç¨‹</a></li>
              </ul>
            </li>
            <li><a href="#springçš„taskexecutor">Springçš„TaskExecutor</a>
              <ul>
                <li><a href="#åœ¨springbootä¸­ä½¿ç”¨taskexecutorè¿›è¡Œå¼‚æ­¥å¤„ç†">åœ¨SpringBootä¸­ä½¿ç”¨TaskExecutorè¿›è¡Œå¼‚æ­¥å¤„ç†</a></li>
                <li><a href="#asyncæ³¨è§£æ‰§è¡ŒåŸç†">@Asyncæ³¨è§£æ‰§è¡ŒåŸç†</a></li>
              </ul>
            </li>
            <li><a href="#java-servletå¼‚æ­¥ç¼–ç¨‹">Java Servletå¼‚æ­¥ç¼–ç¨‹</a>
              <ul>
                <li><a href="#servlet30-æä¾›çš„å¼‚æ­¥å¤„ç†">Servlet3.0 æä¾›çš„å¼‚æ­¥å¤„ç†</a></li>
                <li><a href="#servlet31-æä¾›çš„éé˜»å¡ioå¤„ç†">Servlet3.1 æä¾›çš„éé˜»å¡IOå¤„ç†</a></li>
              </ul>
            </li>
            <li><a href="#netty">Netty</a>
              <ul>
                <li><a href="#çº¿ç¨‹æ¨¡å‹">çº¿ç¨‹æ¨¡å‹</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2025 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
