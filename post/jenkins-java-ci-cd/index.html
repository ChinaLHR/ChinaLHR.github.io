<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Jenkins-pipeline-Docker 实现CI/CD</title>
    <meta name="description" content="keep curious 😼">
    <meta name="keywords" content='blog, chinalhr, lhr, jenkins, CI&CD'>

    <meta property="og:url" content="https://chinalhr.github.io/post/jenkins-java-ci-cd/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Jenkins-pipeline-Docker 实现CI/CD">
    <meta property="og:description" content="keep curious 😼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jenkins-pipeline-Docker 实现CI/CD">
    <meta name="twitter:description" content="keep curious 😼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/jenkins-java-ci-cd/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/jenkins-java-ci-cd/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/jenkins-java-ci-cd/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Jenkins-pipeline-Docker 实现CI/CD</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            December 29, 2019
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/jenkins">jenkins</a></li>
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/cicd">CI&amp;CD</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>基于Jenkins和Docker，对于Java应用CI/CD实践的记录。</p>
</blockquote>
<h2 id="关于cicd">关于CI/CD</h2>
<h3 id="持续集成ci">持续集成(CI)</h3>
<p>持续集成开发人员能够频繁地将其代码集成到公共代码仓库的主分支中。 开发人员能够在任何时候多次向仓库提交作品，而不是独立地开发每个功能模块并在开发周期结束时一一提交。主要目的是尽早发现集成错误，使团队更加紧密结合，更好地协作。</p>
<p><strong>目的</strong></p>
<ul>
<li>减少集成的开销，如代码冲突</li>
<li>将集成简化成一个简单、易于重复的日常开发任务，降低总体的构建成本，及早发现缺陷</li>
</ul>
<h3 id="持续交付cd">持续交付(CD)</h3>
<p>持续交付(CD)是CI的扩展，指软件交付流程的进一步自动化，可以随时自动化地部署到生产环境。使用CD后，开发团队可以在日常开发的任何时间进行产品级的发布，而不需要详细的发布方案或者特殊的后期测试。</p>
<p><strong>持续交付与流水线</strong></p>
<ul>
<li>CD 集中依赖于部署流水线，通过流水线自动化测试和部署过程</li>
<li>流水线包含了 构建-测试-部署</li>
<li>在流水线的每个阶段，如果无法构建通过或者关键测试失败会向团队发出警报，流水线的最后一个部分会将构建部署到和生产环境等效的环境中</li>
</ul>
<h3 id="持续部署cd">持续部署(CD)</h3>
<p>持续部署扩展了持续交付，以便软件构建在通过所有测试时自动部署。在这样的流程中， 不需要人为决定何时及如何投入生产环境。CI/CD 系统的最后一步将在构建后的组件/包退出流水线时自动部署。 此类自动部署可以配置为快速向客户分发组件、功能模块或修复补丁，并准确说明当前提供的内容。</p>
<p><strong>目的</strong></p>
<ul>
<li>将新功能快速传递给用户，得到用户对于新版本的快速反馈，并且可以迅速处理任何明显的缺陷。</li>
</ul>
<h2 id="jenkins安装配置基于docker">jenkins安装/配置(基于Docker)</h2>
<h3 id="安装">安装</h3>
<pre><code># docker获取jenkins镜像
docker pull jenkins/jenkins

# 启动Jenkins
docker run -u root -itd --name jenkins \
-p 10080:8080 \
-v $(which docker):/usr/bin/docker -v /var/run/docker.sock:/var/run/docker.sock \
-e TZ=&quot;Asia/Shanghai&quot; -v /etc/localtime:/etc/localtime \
-e JAVA_OPTS='-Xms1024m -Xmx1024m -XX:NewSize=512m' \
-v /volume1/docker/jenkins:/var/jenkins_home jenkins/jenkins

# -p 10080:8080 映射容器的8080端口到外部主机的10080端口
# -v $(which docker):/usr/bin/docker -v /var/run/docker.sock:/var/run/docker.sock 使jenkins内部可以使用docker命令
# -e TZ=&quot;Asia/Shanghai&quot; -v /etc/localtime:/etc/localtime 配置Jenkins容器的时区
# -v /volume1/docker/jenkins:/var/jenkins_home jenkins/jenkins 将Jenkins的配置映射到外部主机卷/volume1/docker/jenkins（删除容器后可保留）
</code></pre><h3 id="插件推荐">插件推荐</h3>
<table>
<thead>
<tr>
<th>插件名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Blue Ocean</td>
<td>Jenkins的一种新视图，能够通过图形化的界面创建和编辑Jenkinsfile，实现pipeline as code</td>
</tr>
<tr>
<td>Pipeline Maven Integration Plugin</td>
<td>在pipeline中集成maven，即可使用withMaven{}命令</td>
</tr>
<tr>
<td>Config File Provider Plugin</td>
<td>可创建并管理Maven的settings文件及其他配置文件</td>
</tr>
<tr>
<td>JUnit Attachments Plugin</td>
<td>可以对单元测试生成的测试结果在Jenkins中进行展示</td>
</tr>
<tr>
<td>HTTP Request Plugin</td>
<td>发送HTTP请求</td>
</tr>
</tbody>
</table>
<h3 id="配置">配置</h3>
<ul>
<li>配置Git凭据</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/19829495/76158772-60f46d00-6154-11ea-9a0e-7d7e53b62deb.png" alt="图片"></p>
<ul>
<li>配置maven setting文件</li>
</ul>
<p>需要安装插件Config File Provider Plugin</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158776-72d61000-6154-11ea-9c8e-23274b0b26fe.png" alt="图片"></p>
<h2 id="jenkins-pipeline">Jenkins Pipeline</h2>
<h3 id="什么是pipline">什么是Pipline</h3>
<p>pipeline 是jenkins2.X 最核心的特性， 帮助jenkins 实现从CI 到 CD与 DevOps的转变。pipeline 是一套运行于jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。</p>
<h3 id="pipeline优势">pipeline优势</h3>
<ol>
<li>代码：pipeline 以代码的形式实现，通过被捡入源代码控制， 使团队能够编译，审查和迭代其cd流程</li>
<li>可连续性：jenkins 重启 或者中断后都不会影响pipeline job</li>
<li>停顿：pipeline 可以选择停止并等待人工输入或者批准，然后在继续pipeline运行</li>
<li>多功能：pipeline 支持现实世界的复杂CD要求， 包括fork、join子进程，循环和并行执行工作的能力</li>
<li>可扩展：pipeline 插件支持其DSL的自动扩展以及其插件集成的多个选项。</li>
</ol>
<h3 id="pipeline组成">pipeline组成</h3>
<ul>
<li>基本结构</li>
</ul>
<pre><code>pipeline {
    agent { docker 'maven:3.3.3' }
    stages {
        stage('build') {
            steps {
                sh 'mvn --version'
            }
        }
    }
	post {
        always {
            echo 'This will always run'
        }
        success {
            echo 'This will run only if successful'
        }
        failure {
            echo 'This will run only if failed'
        }
        ...
    }
}
</code></pre><ul>
<li>agent</li>
</ul>
<p>agent指定整个Pipeline或特定stage将在Jenkins环境中执行的位置，具体取决于该agent 部分的位置。该部分必须在pipeline块内的顶层定义，stage块内的agent是可选的。</p>
<ul>
<li>post</li>
</ul>
<p>post定义将在Pipeline运行或stage结束时运行的操作。</p>
<ul>
<li>stage stages</li>
</ul>
<p>包含一个或多个stage指令的序列，该stages部分是Pipeline 描述的大部分“工作”所在的位置。</p>
<ul>
<li>steps</li>
</ul>
<p>steps部分定义了在给定stage指令中执行的一系列一个或多个步骤。</p>
<h2 id="jenkins-pipeline实现cicd">Jenkins Pipeline实现CI/CD</h2>
<h3 id="基本流程">基本流程</h3>
<p>架构图：</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158855-571f3980-6155-11ea-957b-f82c19b055b4.png" alt="图片"></p>
<p>基本流程：</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158862-7027ea80-6155-11ea-92b8-aa40a124bd4c.png" alt="图片"></p>
<p>步骤：</p>
<ol>
<li>Jenkins拉取Git代码</li>
<li>静态代码分析</li>
<li>mavem构建项目</li>
<li>单元测试</li>
<li>build镜像</li>
<li>push镜像到镜像仓库</li>
<li>远程部署(完成下载镜像，执行镜像的命令)</li>
</ol>
<h3 id="pipeline实现">Pipeline实现</h3>
<h4 id="jenkins拉取git代码">Jenkins拉取Git代码</h4>
<p>可以使用checkout插件进行Git代码拉取（利用pipeline-syntax生成pipeline流水线脚本）</p>
<pre><code> steps {
			//checkout到master分支进行代码拉取
            checkout([$class: 'GitSCM', 
            branches: [[name: 'master']], 
            doGenerateSubmoduleConfigurations: false, 
            gitTool: 'Default', 
            extensions: [],
            submoduleCfg: [], 
            userRemoteConfigs: [[credentialsId: '8f240564-XXX-40b7-9faf-c08167aa27a3', url: 'git@gitee.com:XXX/XXX.git']]])
        }
</code></pre><p>适配git-flow分支模型，实现发布前进行merge操作和push代码操作。勾选参数化构建过程,选择Git Parameter,然后在pipeline实现相关参数。</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158868-7c13ac80-6155-11ea-9ed2-62bc6ae95ce5.png" alt="图片"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">
   parameters <span style="color:#f92672">{</span>
    	gitParameter branchFilter: <span style="color:#e6db74">&#39;origin/(.*)&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#e6db74">&#39;master&#39;</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;BRANCH&#39;</span><span style="color:#f92672">,</span> type: <span style="color:#e6db74">&#39;PT_BRANCH&#39;</span><span style="color:#f92672">,</span> sortMode:<span style="color:#e6db74">&#39;DESCENDING&#39;</span>
   <span style="color:#f92672">}</span>
   
   stages <span style="color:#f92672">{</span>
       stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Pull Source code&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        steps <span style="color:#f92672">{</span>
			<span style="color:#75715e">//checkout到master 和 merge 指定分支操作
</span><span style="color:#75715e"></span>            checkout<span style="color:#f92672">([</span>$class<span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GitSCM&#39;</span><span style="color:#f92672">,</span> 
            branches: <span style="color:#f92672">[[</span>name: <span style="color:#e6db74">&#39;master&#39;</span><span style="color:#f92672">]],</span> 
            doGenerateSubmoduleConfigurations: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 
            gitTool: <span style="color:#e6db74">&#39;Default&#39;</span><span style="color:#f92672">,</span> 
            extensions: <span style="color:#f92672">[</span>
                <span style="color:#f92672">[</span>$class<span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PreBuildMerge&#39;</span><span style="color:#f92672">,</span> options: <span style="color:#f92672">[</span>mergeRemote: <span style="color:#e6db74">&#39;origin&#39;</span><span style="color:#f92672">,</span> mergeStrategy: <span style="color:#e6db74">&#39;RECURSIVE&#39;</span><span style="color:#f92672">,</span> mergeTarget: <span style="color:#e6db74">&#34;${params.BRANCH}&#34;</span><span style="color:#f92672">]]</span>
            <span style="color:#f92672">],</span>
            submoduleCfg: <span style="color:#f92672">[],</span> 
            userRemoteConfigs: <span style="color:#f92672">[[</span>credentialsId: <span style="color:#e6db74">&#39;8f240564-XXX-40b7-9faf-c08167aa27a3&#39;</span><span style="color:#f92672">,</span> url: <span style="color:#e6db74">&#39;git@gitee.com:XXX/XXX.git&#39;</span><span style="color:#f92672">]]])</span>
        
			<span style="color:#75715e">//代码推送到master操作(可以将此步骤下放到远程部署后或者post阶段，确保一个完整的成功的发布后才进行分支合并提交)
</span><span style="color:#75715e"></span>			sshagent<span style="color:#f92672">([</span><span style="color:#e6db74">&#39;8f240564-XXX-40b7-9faf-c08167aa27a3&#39;</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
                sh <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">                  git config --global user.email &#34;******&#34;
</span><span style="color:#e6db74">                    git config --global user.name &#34;******&#34;
</span><span style="color:#e6db74">				    git commit -m &#34;header changed ci commit automatically&#34; || true
</span><span style="color:#e6db74">                    git push origin HEAD:refs/heads/master
</span><span style="color:#e6db74">				&#34;&#34;&#34;</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
		<span style="color:#f92672">...</span>
	<span style="color:#f92672">}</span>
</code></pre></div><h4 id="mavem构建项目">mavem构建项目</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         steps <span style="color:#f92672">{</span>
          withMaven<span style="color:#f92672">(</span>maven: <span style="color:#e6db74">&#39;Maven3.6.3&#39;</span><span style="color:#f92672">,</span> mavenSettingsConfig: <span style="color:#e6db74">&#39;f6f97751-3c04-4394-876f-cee0879cfc02&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
              <span style="color:#75715e">//这里使用了maven-resources-plugin插件对资源进行统一的COPY到path目录
</span><span style="color:#75715e"></span>                 sh <span style="color:#e6db74">&#39;mvn clean package -Dmaven.test.skip=true -Dbuild.path=/var/jenkins_home/build/bfreeman -f pom.xml&#39;</span>
            <span style="color:#f92672">}</span>
         <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
</code></pre></div><h4 id="单元测试">单元测试</h4>
<p>简单的单元测试可以基于maven-shade-plugin插件，配合Junit跑单元测试。也可以 配合jacoco插件和 maven-jacoco-plugin 进行测试覆盖率的检测。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit testing&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         steps <span style="color:#f92672">{</span>
             withMaven<span style="color:#f92672">(</span>maven: <span style="color:#e6db74">&#39;Maven3.6.3&#39;</span><span style="color:#f92672">,</span> mavenSettingsConfig: <span style="color:#e6db74">&#39;f6f97751-3c04-4394-876f-cee0879cfc02&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                 <span style="color:#75715e">//这里使用了maven-shade-plugin插件进行单元测试
</span><span style="color:#75715e"></span>                 sh <span style="color:#e6db74">&#39;mvn clean test&#39;</span>
            <span style="color:#f92672">}</span>
         <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
</code></pre></div><h4 id="build-docker镜像">build docker镜像</h4>
<ul>
<li>编写Dockerfile</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:8u212-jdk</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> /dev/* /build/conf/dev/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> /production/* /build/conf/production/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> api-1.0.0-fat.jar /build/api.jar<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-jar&#34;</span>,<span style="color:#e6db74">&#34;/build/api.jar&#34;</span>,<span style="color:#e6db74">&#34;--vertx-id=&#39;bfreeman-api&#39;&#34;</span>,<span style="color:#e6db74">&#34;--java-opts=&#39;-Xms512m -Xmx512m -XX:NewSize=256m&#39;&#34;</span>,<span style="color:#e6db74">&#34;-conf /build/conf/production/conf.json&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>大致为COPY jar和配置文件到指定目录，ENTRYPOINT指定JVM参数和vertx参数</p>
<ul>
<li>执行docker build相关Shell脚本</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span>
cd /var/jenkins_home/build/bfreeman
docker build -t bfreeman/api:1.0.0 .
</code></pre></div><h4 id="push-docker镜像到镜像仓库">push docker镜像到镜像仓库</h4>
<p>这里使用的是阿里云容器镜像服务，<a href="https://help.aliyun.com/product/60716.html">参考文档</a></p>
<p>相关Shell脚本如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 1. 获取构建的image id</span>
IMAGES_ID<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>docker images|grep -i bfreeman/api|awk <span style="color:#e6db74">&#39;{print $3}&#39;</span><span style="color:#e6db74">`</span>
<span style="color:#75715e"># 2. 设置repository相关信息</span>
REPOSITORY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bfreeman/web&#34;</span>
TAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span>
<span style="color:#75715e"># 3. 登录Docker Registry ，使用docker tag命令重命名镜像并推送至登录Docker Registry</span>
docker login -u<span style="color:#f92672">=</span>xx -p<span style="color:#f92672">=</span>xx registry.cn-hangzhou.aliyuncs.com
docker tag <span style="color:#e6db74">${</span>IMAGES_ID<span style="color:#e6db74">}</span> registry.cn-hangzhou.aliyuncs.com/<span style="color:#e6db74">${</span>REPOSITORY<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span>
docker push registry.cn-hangzhou.aliyuncs.com/<span style="color:#e6db74">${</span>REPOSITORY<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span>
</code></pre></div><h4 id="远程部署镜像pull重新部署">远程部署(镜像Pull，重新部署)</h4>
<ul>
<li>jenkins pipeline sshagent实现远程执行shell脚本</li>
</ul>
<p>生成ssh密钥对，并将私钥配置到jenkins的凭证中，将公钥配置到对应部署服务器的.ssh/authorized_keys文件中，pipeline脚本如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">sshagent<span style="color:#f92672">([</span><span style="color:#e6db74">&#39;feb51b70-****-45a5-a69b-319e41f7f146&#39;</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
                    sh <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">                   ...
</span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>镜像Pull</li>
</ul>
<p>相关Shell脚本如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 1. 设置repository相关信息</span>
REPOSITORY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bfreeman/web&#34;</span>
TAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span>

<span style="color:#75715e"># 2. 登录Docker Registry ，从Docker Registry中拉取镜像</span>
docker login -u<span style="color:#f92672">=</span>xx -p<span style="color:#f92672">=</span>xx registry.cn-hangzhou.aliyuncs.com
docker pull registry.cn-hangzhou.aliyuncs.com/<span style="color:#e6db74">${</span>REPOSITORY<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span>

</code></pre></div><ul>
<li>重新部署</li>
</ul>
<p>相关Shell脚本如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 1. 设置repository相关信息</span>
REPOSITORY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bfreeman/web&#34;</span>
TAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span>

docker stop bfreeman-api
docker container rm bfreeman-api
docker run -u root -d --name bfreeman-api <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-p 10010:10010  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-p 10030:10030  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>-v /volume1/docker/java:/data registry.cn-hangzhou.aliyuncs.com/<span style="color:#e6db74">${</span>REPOSITORY<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span>

</code></pre></div><p>此处可以基于k8s进行改造，实现jenkins部署到k8s集群。</p>
<h4 id="相关pipeline">相关pipeline</h4>
<pre><code>pipeline {
  agent any
  
  environment {
       imageid = &quot;&quot;
  }
   
  parameters {
    gitParameter branchFilter: 'origin/(.*)', defaultValue: 'master', name: 'BRANCH', type: 'PT_BRANCH', sortMode:'DESCENDING'
  }
   
   stages {
      //拉取代码
      stage('Pull Source Code') {
        steps {
			//checkout到master 和 merge 指定分支操作
			checkout([$class: 'GitSCM', 
			branches: [[name: 'master']], 
			doGenerateSubmoduleConfigurations: false, 
			 extensions: [
                [$class: 'PreBuildMerge', options: [mergeRemote: 'origin', mergeStrategy: 'RECURSIVE', mergeTarget: &quot;${params.BRANCH}&quot;]]
            ],
			submoduleCfg: [], 
			gitTool: 'Default',
			userRemoteConfigs: [[credentialsId: '0baad767-754c-****-8639-be2559a124ac', url: 'git@gitee.com:****/****.git']]]
			)
			}
      }
      
      //代码静态分析
      stage('Static Analysis') {
         steps {
            echo 'Program Static Analysis' 
         }
      }
      
      //构建代码
      stage('Build') {
         steps {
          withMaven(maven: 'Maven3.6.3', mavenSettingsConfig: 'f6f97751-****-4394-876f-cee0879cfc02') {
                 sh 'mvn clean package -Dmaven.test.skip=true -Dbuild.path=/var/jenkins_home/build/bfreeman -f pom.xml'
            }
         }
      }
      
      //单元测试
      stage('Unit testing') {
         steps {
             withMaven(maven: 'Maven3.6.3', mavenSettingsConfig: 'f6f97751-****-4394-876f-cee0879cfc02') {
                 sh 'mvn clean test'
            }
         }
      }
      
      //构建Docker镜像
      stage('Build Docker Image') {
         steps {
            sh &quot;&quot;&quot;
				    cd /var/jenkins_home/script/auto/deploy
				    sh docker_build.sh
				&quot;&quot;&quot;
         }
      }
      
      //推送Docker镜像到远程仓库
      stage('Push Remote Repositry') {
         steps {
            sh &quot;&quot;&quot;
				    cd /var/jenkins_home/script/auto/deploy
				    sh docker_push.sh
				&quot;&quot;&quot;
         }
      }
      
      //部署代码
      stage('Deploy') {
         steps {
            sshagent(['feb51b70-****-45a5-a69b-319e41f7f146']) {
                    sh &quot;&quot;&quot;
                    ssh -p 16022 root@**** &quot;sh /home/bfreeman/script/auto/deploy/docker_pull.sh&quot;
                     ssh -p 16022 root@**** &quot;sh /home/bfreeman/script/auto/deploy/docker_run.sh&quot;
                    &quot;&quot;&quot;
                }
         }
      }
      
      //推送代码
      stage('Push Code') {
         steps {
            //代码推送到master操作
			sshagent(['0baad767-****-4122-8639-be2559a124ac']) {
                sh &quot;&quot;&quot;
                    git config --global user.email &quot;******&quot;
                    git config --global user.name &quot;******&quot;
				    git commit -m &quot;header changed ci commit automatically&quot; || true
                    git push origin HEAD:refs/heads/master
				&quot;&quot;&quot;
			}
         }
         
      }
      
   }
   
}
</code></pre><h2 id="参考">参考</h2>
<p><a href="https://jenkins.io/zh/doc/">https://jenkins.io/zh/doc/</a></p>
<p><a href="https://www.jianshu.com/nb/30544461">https://www.jianshu.com/nb/30544461</a></p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#关于cicd">关于CI/CD</a>
          <ul>
            <li><a href="#持续集成ci">持续集成(CI)</a></li>
            <li><a href="#持续交付cd">持续交付(CD)</a></li>
            <li><a href="#持续部署cd">持续部署(CD)</a></li>
          </ul>
        </li>
        <li><a href="#jenkins安装配置基于docker">jenkins安装/配置(基于Docker)</a>
          <ul>
            <li><a href="#安装">安装</a></li>
            <li><a href="#插件推荐">插件推荐</a></li>
            <li><a href="#配置">配置</a></li>
          </ul>
        </li>
        <li><a href="#jenkins-pipeline">Jenkins Pipeline</a>
          <ul>
            <li><a href="#什么是pipline">什么是Pipline</a></li>
            <li><a href="#pipeline优势">pipeline优势</a></li>
            <li><a href="#pipeline组成">pipeline组成</a></li>
          </ul>
        </li>
        <li><a href="#jenkins-pipeline实现cicd">Jenkins Pipeline实现CI/CD</a>
          <ul>
            <li><a href="#基本流程">基本流程</a></li>
            <li><a href="#pipeline实现">Pipeline实现</a>
              <ul>
                <li><a href="#jenkins拉取git代码">Jenkins拉取Git代码</a></li>
                <li><a href="#mavem构建项目">mavem构建项目</a></li>
                <li><a href="#单元测试">单元测试</a></li>
                <li><a href="#build-docker镜像">build docker镜像</a></li>
                <li><a href="#push-docker镜像到镜像仓库">push docker镜像到镜像仓库</a></li>
                <li><a href="#远程部署镜像pull重新部署">远程部署(镜像Pull，重新部署)</a></li>
                <li><a href="#相关pipeline">相关pipeline</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
