<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>ä½¿ç”¨kubeadméƒ¨ç½²Kubernetesé›†ç¾¤å®è·µ</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, kubernetes, kubeadm'>

    <meta property="og:url" content="https://chinalhr.github.io/post/kubeadm-install-kubernetes/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ä½¿ç”¨kubeadméƒ¨ç½²Kubernetesé›†ç¾¤å®è·µ">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ä½¿ç”¨kubeadméƒ¨ç½²Kubernetesé›†ç¾¤å®è·µ">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/kubeadm-install-kubernetes/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/kubeadm-install-kubernetes/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/kubeadm-install-kubernetes/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>ä½¿ç”¨kubeadméƒ¨ç½²Kubernetesé›†ç¾¤å®è·µ</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            June 8, 2020
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/kubernetes">kubernetes</a></li>
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/kubeadm">kubeadm</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>ä½¿ç”¨kubeadméƒ¨ç½²Kubernetes 1.18.0 é›†ç¾¤å®è·µè®°å½•</p>
</blockquote>
<h2 id="kubeadm">kubeadm</h2>
<p>Kubeadmæ˜¯ä¸€ç§å·¥å…·ï¼Œæ—¨åœ¨ä¸ºåˆ›å»ºKubernetesé›†ç¾¤æä¾›æœ€ä½³å®è·µçš„â€œå¿«é€Ÿè·¯å¾„â€ï¼Œå®ƒä»¥ç”¨æˆ·å‹å¥½çš„æ–¹å¼æ‰§è¡Œå¿…è¦çš„æ“ä½œï¼Œä»¥ä½¿å¯ä»¥æœ€ä½é™åº¦çš„å¯è¡Œï¼Œå®‰å…¨çš„å¯åŠ¨å¹¶è¿è¡Œç¾¤é›†ã€‚åªéœ€å°†<code>kubeadm</code>,<code>kubelet</code>ï¼Œ<code>kubectl</code>å®‰è£…åˆ°æœåŠ¡å™¨ï¼Œå…¶ä»–æ ¸å¿ƒç»„ä»¶ä»¥å®¹å™¨åŒ–æ–¹å¼å¿«é€Ÿéƒ¨ç½²ã€‚</p>
<p>kubeadmåœ°å€ï¼š<a href="https://github.com/kubernetes/kubeadm">https://github.com/kubernetes/kubeadm</a></p>
<p>å‚è€ƒæ–‡æ¡£åœ°å€ï¼š<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/</a></p>
<ul>
<li>å¸¸è§çš„cmd</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm init å¯åŠ¨ä¸€ä¸ª Kubernetes ä¸»èŠ‚ç‚¹
kubeadm join å¯åŠ¨ä¸€ä¸ª Kubernetes å·¥ä½œèŠ‚ç‚¹å¹¶ä¸”å°†å…¶åŠ å…¥åˆ°é›†ç¾¤
kubeadm upgrade æ›´æ–°ä¸€ä¸ª Kubernetes é›†ç¾¤åˆ°æ–°ç‰ˆæœ¬
kubeadm config å¦‚æœä½ ä½¿ç”¨ kubeadm v1.7.x æˆ–è€…æ›´ä½ç‰ˆæœ¬ï¼Œä½ éœ€è¦å¯¹ä½ çš„é›†ç¾¤åšä¸€äº›é…ç½®ä»¥ä¾¿ä½¿ç”¨ kubeadm upgrade å‘½ä»¤
kubeadm token ä½¿ç”¨ kubeadm join æ¥ç®¡ç†ä»¤ç‰Œ
kubeadm reset è¿˜åŸä¹‹å‰ä½¿ç”¨ kubeadm init æˆ–è€… kubeadm join å¯¹èŠ‚ç‚¹äº§ç”Ÿçš„æ”¹å˜
kubeadm version æ‰“å°å‡º kubeadm ç‰ˆæœ¬
kubeadm alpha é¢„è§ˆä¸€ç»„å¯ç”¨çš„æ–°åŠŸèƒ½ä»¥ä¾¿ä»ç¤¾åŒºæœé›†åé¦ˆ
</code></pre></div><ul>
<li>æˆç†Ÿåº¦</li>
</ul>
<table>
<thead>
<tr>
<th>Area</th>
<th>Maturity Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command line UX</td>
<td>GA</td>
</tr>
<tr>
<td>Implementation</td>
<td>GA</td>
</tr>
<tr>
<td>Config file API</td>
<td>beta</td>
</tr>
<tr>
<td>CoreDNS</td>
<td>GA</td>
</tr>
<tr>
<td>kubeadm alpha subcommands</td>
<td>alpha</td>
</tr>
<tr>
<td>High availability</td>
<td>alpha</td>
</tr>
<tr>
<td>DynamicKubeletConfig</td>
<td>alpha</td>
</tr>
<tr>
<td>Self-hosting</td>
<td>alpha</td>
</tr>
</tbody>
</table>
<ul>
<li>MasterèŠ‚ç‚¹</li>
</ul>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>6443*</td>
<td>Kubernetes API server</td>
<td>All</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>Self</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>Self</td>
</tr>
</tbody>
</table>
<ul>
<li>nodeèŠ‚ç‚¹</li>
</ul>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>30000-32767</td>
<td>NodePort Servicesâ€ </td>
<td>All</td>
</tr>
</tbody>
</table>
<h2 id="å‰ç½®å‡†å¤‡">å‰ç½®å‡†å¤‡</h2>
<h3 id="ç³»ç»Ÿå‡†å¤‡">ç³»ç»Ÿå‡†å¤‡</h3>
<ul>
<li>å¼€æ”¾ç«¯å£ï¼š</li>
</ul>
<p>å¼€æ”¾Kuberneteså„ä¸ªç»„ä»¶æ‰€éœ€è¦çš„ç«¯å£ï¼Œå¯ä»¥å‚è€ƒä¸Šæ–‡æ‰€å±•ç¤ºçš„ç«¯å£èŒƒå›´è¿›è¡Œè®¾ç½®</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŸ¥çœ‹å·²å¼€æ”¾çš„ç«¯å£(é»˜è®¤ä¸å¼€æ”¾ä»»ä½•ç«¯å£)</span>
firewall-cmd --list-ports
<span style="color:#75715e"># å¼€å¯80ç«¯å£</span>
firewall-cmd --zone<span style="color:#f92672">=</span>public<span style="color:#f92672">(</span>ä½œç”¨åŸŸ<span style="color:#f92672">)</span> --add-port<span style="color:#f92672">=</span>10250/tcp<span style="color:#f92672">(</span>ç«¯å£å’Œè®¿é—®ç±»å‹<span style="color:#f92672">)</span> --permanent<span style="color:#f92672">(</span>æ°¸ä¹…ç”Ÿæ•ˆ<span style="color:#f92672">)</span>
firewall-cmd --zone<span style="color:#f92672">=</span>public --add-port<span style="color:#f92672">=</span>10250/tcp --permanent
<span style="color:#75715e"># é‡å¯é˜²ç«å¢™</span>
firewall-cmd --reload
<span style="color:#75715e"># åœæ­¢é˜²ç«å¢™</span>
systemctl stop firewalld.service
<span style="color:#75715e"># ç¦æ­¢é˜²ç«å¢™å¼€æœºå¯åŠ¨</span>
systemctl disable firewalld.service
</code></pre></div><ul>
<li>ç¦ç”¨SELINUXï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">setenforce <span style="color:#ae81ff">0</span>
vi /etc/selinux/config
<span style="color:#75715e"># è®¾ç½®SELINUX=disabled</span>
</code></pre></div><ul>
<li>bridgeè®¾ç½®</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">touch /etc/sysctl.d/k8s.conf
<span style="color:#75715e"># æ·»åŠ å¦‚ä¸‹å†…å®¹</span>
net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
net.bridge.bridge-nf-call-iptables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># æ‰§è¡Œå‘½ä»¤</span>
modprobe br_netfilter
sysctl -p /etc/sysctl.d/k8s.conf
</code></pre></div><ul>
<li>å…³é—­ç³»ç»Ÿswap</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å…³é—­swapåˆ†åŒº</span>
swapoff -a
<span style="color:#75715e"># ä¿®æ”¹é…ç½®æ–‡ä»¶ - /etc/fstab æ³¨é‡Šæ‰å¦‚ä¸‹è¡Œ</span>
/mnt/swap swap swap defaults <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> 
<span style="color:#75715e"># è°ƒæ•´ swappiness å‚æ•°</span>
vim /etc/sysctl.conf <span style="color:#75715e"># æ°¸ä¹…ç”Ÿæ•ˆ</span>
<span style="color:#75715e"># ä¿®æ”¹ vm.swappiness çš„ä¿®æ”¹ä¸º 0</span>
</code></pre></div><h3 id="kube-proxyå¼€å¯ipvsè®¾ç½®">kube-proxyå¼€å¯ipvsè®¾ç½®</h3>
<p>ä¸ºkube-proxyå¼€å¯ipvsçš„å‰æéœ€è¦åŠ è½½ä»¥ä¸‹çš„å†…æ ¸æ¨¡å—ï¼š</p>
<pre><code>ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack_ipv4
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">touch /etc/sysconfig/modules/ipvs.modules
<span style="color:#75715e"># æ·»åŠ å¦‚ä¸‹è„šæœ¬ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—</span>
<span style="color:#75715e">#!/bin/bash</span>
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
<span style="color:#75715e"># å¯ç”¨å¹¶æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å—</span>
chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack_ipv4
</code></pre></div><p>å®‰è£…<code>ipset</code>è½¯ä»¶åŒ…ä¸<code>ipvsadm</code>ç®¡ç†å·¥å…·</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum -y install ipset
yum -y install ipvsadm
</code></pre></div><h3 id="å®‰è£…å¹¶è®¾ç½®docker">å®‰è£…å¹¶è®¾ç½®docker</h3>
<p>Kubernetesä»1.6å¼€å§‹ä½¿ç”¨CRI(Container Runtime Interface)å®¹å™¨è¿è¡Œæ—¶æ¥å£ã€‚é»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ä»ç„¶æ˜¯Dockerï¼Œä½¿ç”¨çš„æ˜¯kubeletä¸­å†…ç½®<code>dockershim</code> CRIå®ç°ã€‚</p>
<ul>
<li>å®‰è£…docker</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æ›´æ–°yumåŒ…</span>
sudo yum update
<span style="color:#75715e"># å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…</span>
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
<span style="color:#75715e"># è®¾ç½®yumæº</span>
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span style="color:#75715e"># å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“ä¸­æ‰€æœ‰dockerç‰ˆæœ¬ï¼Œå¹¶é€‰æ‹©ç‰¹å®šç‰ˆæœ¬å®‰è£…</span>
yum list docker-ce --showduplicates | sort -r
<span style="color:#75715e"># å®‰è£…docker</span>
sudo yum install docker-ce
sudo yum install &lt;FQPN docker-ce.x86_64 3:19.03.5-3.el7&gt;
<span style="color:#75715e"># å¯åŠ¨å¹¶åŠ å…¥å¼€æœºå¯åŠ¨</span>
sudo systemctl start docker
sudo systemctl enable docker
<span style="color:#75715e"># é•œåƒåŠ é€Ÿ</span>
vim /etc/docker/daemon.json
<span style="color:#75715e">## åŠ å…¥é•œåƒåœ°å€</span>
<span style="color:#f92672">{</span>
 <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>,
  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;https://hub-mirror.c.163.com&#34;</span>,
    <span style="color:#e6db74">&#34;https://registry.aliyuncs.com&#34;</span>,
    <span style="color:#e6db74">&#34;https://registry.docker-cn.com&#34;</span>,
    <span style="color:#e6db74">&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>
 <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">## é‡å¯æœåŠ¡</span>
sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre></div><ul>
<li>ä¿®æ”¹docker cgroup driverä¸ºsystemd</li>
</ul>
<p>å¯¹äºä½¿ç”¨systemdä½œä¸ºinit systemçš„Linuxçš„å‘è¡Œç‰ˆï¼Œä½¿ç”¨systemdä½œä¸ºdockerçš„cgroup driverå¯ä»¥ç¡®ä¿æœåŠ¡å™¨èŠ‚ç‚¹åœ¨èµ„æºç´§å¼ çš„æƒ…å†µæ›´åŠ ç¨³å®š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># åˆ›å»ºæˆ–ä¿®æ”¹/etc/docker/daemon.json</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e"># é‡å¯docker</span>
sudo systemctl daemon-reload
sudo systemctl restart docker

</code></pre></div><h3 id="å®‰è£…kubeadmkubectlå’Œkubelet">å®‰è£…kubeadm,kubectlå’Œkubelet</h3>
<ul>
<li>Centoså®‰è£…</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æ·»åŠ  kubernetes.repo</span> 
vim /etc/yum.repos.d/kubernetes.repo

<span style="color:#75715e"># å†™å…¥å¦‚ä¸‹ä¿¡æ¯åä¿å­˜</span>
<span style="color:#f92672">[</span>kubernetes<span style="color:#f92672">]</span>
name<span style="color:#f92672">=</span>Kubernetes
baseurl<span style="color:#f92672">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
gpgcheck<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
repo_gpgcheck<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
gpgkey<span style="color:#f92672">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg

<span style="color:#75715e"># ä½¿ç”¨yum makecache ç”Ÿæˆç¼“å­˜</span>
yum makecache fast
<span style="color:#75715e"># æŸ¥çœ‹kubeadmç‰ˆæœ¬</span>
yum list kubelet kubeadm kubectl  --showduplicates|sort -r
<span style="color:#75715e"># å®‰è£…kubeadm</span>
yum install -y kubelet kubeadm kubectl
<span style="color:#75715e"># å®‰è£…æŒ‡å®šç‰ˆæœ¬kubeadm</span>
yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
</code></pre></div><pre><code>kubeadmï¼šç”¨äºåˆå§‹åŒ– Kubernetes é›†ç¾¤
kubectlï¼šKubernetes çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦ä½œç”¨æ˜¯éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ï¼ŒæŸ¥çœ‹å„ç§èµ„æºï¼Œåˆ›å»ºï¼Œåˆ é™¤å’Œæ›´æ–°ç»„ä»¶
kubeletï¼šä¸»è¦è´Ÿè´£å¯åŠ¨ Pod å’Œå®¹å™¨
</code></pre><h2 id="kubeadméƒ¨ç½²kubernetesé›†ç¾¤">kubeadméƒ¨ç½²kubernetesé›†ç¾¤</h2>
<h3 id="kubeadm-init-é…ç½®kubernetes-masterèŠ‚ç‚¹">kubeadm init é…ç½®kubernetes masterèŠ‚ç‚¹</h3>
<ul>
<li>è®¾ç½®å¼€æœºå¯åŠ¨kubeletæœåŠ¡</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl enable kubelet.service
</code></pre></div><ul>
<li>å¯¼å‡ºé…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å¯¼å‡ºé…ç½®æ–‡ä»¶</span>
kubeadm config print init-defaults --kubeconfig ClusterConfiguration &gt; /data/kubeadm/config/kubeadm.yml
<span style="color:#75715e"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span>
vim kubeadm.yml
<span style="color:#75715e"># ä¿®æ”¹å†…å®¹å¦‚ä¸‹</span>
apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
<span style="color:#75715e"># ä¿®æ”¹ä¸ºä¸»èŠ‚ç‚¹ IP</span>
  advertiseAddress: 192.168.1.102
  bindPort: <span style="color:#ae81ff">6443</span>
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: localhost.localdomain
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager:
  extraArgs:
        horizontal-pod-autoscaler-use-rest-clients: <span style="color:#e6db74">&#34;true&#34;</span>
        horizontal-pod-autoscaler-sync-period: <span style="color:#e6db74">&#34;10s&#34;</span>
        node-monitor-grace-period: <span style="color:#e6db74">&#34;10s&#34;</span>
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
<span style="color:#75715e"># ä¿®æ”¹registryä¸ºé˜¿é‡Œäº‘</span>
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
<span style="color:#75715e"># ä¿®æ”¹Kubernetesç‰ˆæœ¬å·</span>
kubernetesVersion: v1.18.0
networking:
  dnsDomain: cluster.local
  <span style="color:#75715e"># é…ç½®Calico çš„é»˜è®¤ç½‘æ®µ</span>
  podSubnet: <span style="color:#e6db74">&#34;172.16.0.0/16&#34;</span>
  serviceSubnet: 10.96.0.0/12
scheduler: <span style="color:#f92672">{}</span>
---
<span style="color:#75715e"># å¼€å¯ IPVS æ¨¡å¼</span>
apiVersion: kubeadm.k8s.io/v1beta2
kind: KubeProxyConfiguration
featureGates:
  supportipvsproxymodedm.ymlvim kubeadm.yml: true
  mode: ipvs
</code></pre></div><ul>
<li>æŸ¥çœ‹å¹¶æ‹‰å–é•œåƒ</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŸ¥çœ‹é•œåƒ</span>
kubeadm config images list --config /data/kubeadm/config/kubeadm.yml
<span style="color:#75715e"># æ‹‰å–é•œåƒ</span>
kubeadm config images pull --config /data/kubeadm/config/kubeadm.yml 
</code></pre></div><ul>
<li>é…ç½®kubernetes masterèŠ‚ç‚¹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm init --config<span style="color:#f92672">=</span>/data/kubeadm/config/kubeadm.yml --upload-certs | tee /data/kubeadm/log/kubeadm-init.log
</code></pre></div><p><code>--upload-certs</code> å‚æ•°ï¼šå¯ä»¥åœ¨åç»­æ‰§è¡ŒåŠ å…¥èŠ‚ç‚¹æ—¶è‡ªåŠ¨åˆ†å‘è¯ä¹¦æ–‡ä»¶</p>
<p><code>tee kubeadm-init.log</code>å‚æ•°ï¼š ç”¨ä»¥è¾“å‡ºæ—¥å¿—</p>
<ul>
<li>Kubeadm init æ‰§è¡Œè¿‡ç¨‹</li>
</ul>
<p>æ‰§è¡Œinitæ“ä½œçš„æ—¶å€™å¯ä»¥çœ‹åˆ°æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">W0601 11:33:16.858211    <span style="color:#ae81ff">1719</span> strict.go:47<span style="color:#f92672">]</span> unknown configuration schema.GroupVersionKind<span style="color:#f92672">{</span>Group:<span style="color:#e6db74">&#34;kubeadm.k8s.io&#34;</span>, Version:<span style="color:#e6db74">&#34;v1beta2&#34;</span>, Kind:<span style="color:#e6db74">&#34;KubeProxyConfiguration&#34;</span><span style="color:#f92672">}</span> <span style="color:#66d9ef">for</span> scheme definitions in <span style="color:#e6db74">&#34;k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/scheme/scheme.go:31&#34;</span> and <span style="color:#e6db74">&#34;k8s.io/kubernetes/cmd/kubeadm/app/componentconfigs/scheme.go:28&#34;</span>
W0601 11:33:16.858535    <span style="color:#ae81ff">1719</span> configset.go:202<span style="color:#f92672">]</span> WARNING: kubeadm cannot validate component configs <span style="color:#66d9ef">for</span> API groups <span style="color:#f92672">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>config<span style="color:#f92672">]</span> WARNING: Ignored YAML document with GroupVersionKind kubeadm.k8s.io/v1beta2, Kind<span style="color:#f92672">=</span>KubeProxyConfiguration
<span style="color:#f92672">[</span>init<span style="color:#f92672">]</span> Using Kubernetes version: v1.18.0
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Running pre-flight checks
	<span style="color:#f92672">[</span>WARNING Firewalld<span style="color:#f92672">]</span>: firewalld is active, please ensure ports <span style="color:#f92672">[</span><span style="color:#ae81ff">6443</span> 10250<span style="color:#f92672">]</span> are open or your cluster may not <span style="color:#66d9ef">function</span> correctly
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Pulling images required <span style="color:#66d9ef">for</span> setting up a Kubernetes cluster
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> This might take a minute or two, depending on the speed of your internet connection
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> You can also perform this action in beforehand using <span style="color:#e6db74">&#39;kubeadm config images pull&#39;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Using certificateDir folder <span style="color:#e6db74">&#34;/etc/kubernetes/pki&#34;</span>
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;ca&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> apiserver serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>localhost.localdomain kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>10.96.0.1 192.168.1.102<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver-kubelet-client&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;front-proxy-ca&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;front-proxy-client&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/ca&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/server&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> etcd/server serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>localhost.localdomain localhost<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>192.168.1.102 127.0.0.1 ::1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/peer&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> etcd/peer serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>localhost.localdomain localhost<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>192.168.1.102 127.0.0.1 ::1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/healthcheck-client&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver-etcd-client&#34;</span> certificate and key
<span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;sa&#34;</span> key and public key
<span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Using kubeconfig folder <span style="color:#e6db74">&#34;/etc/kubernetes&#34;</span>
<span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;admin.conf&#34;</span> kubeconfig file
<span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;kubelet.conf&#34;</span> kubeconfig file
<span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;controller-manager.conf&#34;</span> kubeconfig file
<span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;scheduler.conf&#34;</span> kubeconfig file
<span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Using manifest folder <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>
<span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-apiserver&#34;</span>
W0601 11:33:33.405533    <span style="color:#ae81ff">1719</span> manifests.go:225<span style="color:#f92672">]</span> the default kube-apiserver authorization-mode is <span style="color:#e6db74">&#34;Node,RBAC&#34;</span>; using <span style="color:#e6db74">&#34;Node,RBAC&#34;</span>
<span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-controller-manager&#34;</span>
<span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-scheduler&#34;</span>
W0601 11:33:33.411476    <span style="color:#ae81ff">1719</span> manifests.go:225<span style="color:#f92672">]</span> the default kube-apiserver authorization-mode is <span style="color:#e6db74">&#34;Node,RBAC&#34;</span>; using <span style="color:#e6db74">&#34;Node,RBAC&#34;</span>
<span style="color:#f92672">[</span>etcd<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> local etcd in <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>
<span style="color:#f92672">[</span>wait-control-plane<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to boot up the control plane as static Pods from directory <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
<span style="color:#f92672">[</span>apiclient<span style="color:#f92672">]</span> All control plane components are healthy after 31.511863 seconds
<span style="color:#f92672">[</span>upload-config<span style="color:#f92672">]</span> Storing the configuration used in ConfigMap <span style="color:#e6db74">&#34;kubeadm-config&#34;</span> in the <span style="color:#e6db74">&#34;kube-system&#34;</span> Namespace
<span style="color:#f92672">[</span>kubelet<span style="color:#f92672">]</span> Creating a ConfigMap <span style="color:#e6db74">&#34;kubelet-config-1.18&#34;</span> in namespace kube-system with the configuration <span style="color:#66d9ef">for</span> the kubelets in the cluster
<span style="color:#f92672">[</span>upload-certs<span style="color:#f92672">]</span> Storing the certificates in Secret <span style="color:#e6db74">&#34;kubeadm-certs&#34;</span> in the <span style="color:#e6db74">&#34;kube-system&#34;</span> Namespace
<span style="color:#f92672">[</span>upload-certs<span style="color:#f92672">]</span> Using certificate key:
ca23402e2e70c5613b2ee10507b6065a548bb715f992c335e6498f25d30c0f96
<span style="color:#f92672">[</span>mark-control-plane<span style="color:#f92672">]</span> Marking the node localhost.localdomain as control-plane by adding the label <span style="color:#e6db74">&#34;node-role.kubernetes.io/master=&#39;&#39;&#34;</span>
<span style="color:#f92672">[</span>mark-control-plane<span style="color:#f92672">]</span> Marking the node localhost.localdomain as control-plane by adding the taints <span style="color:#f92672">[</span>node-role.kubernetes.io/master:NoSchedule<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Using token: abcdef.0123456789abcdef
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span style="color:#66d9ef">for</span> nodes to get long term certificate credentials
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> configured RBAC rules to allow certificate rotation <span style="color:#66d9ef">for</span> all node client certificates in the cluster
<span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Creating the <span style="color:#e6db74">&#34;cluster-info&#34;</span> ConfigMap in the <span style="color:#e6db74">&#34;kube-public&#34;</span> namespace
<span style="color:#f92672">[</span>kubelet-finalize<span style="color:#f92672">]</span> Updating <span style="color:#e6db74">&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
<span style="color:#f92672">[</span>addons<span style="color:#f92672">]</span> Applied essential addon: CoreDNS
<span style="color:#f92672">[</span>addons<span style="color:#f92672">]</span> Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.1.102:6443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:2d14d0998d3d2921771e6c6a81477b5124d87f920b7c4caeec8ebefe3c94fe5b 
</code></pre></div><p>æ‰§è¡Œè¿‡ç¨‹å…³é”®å†…å®¹ï¼š</p>
<pre><code>[kubelet-start] ç”Ÿæˆkubeletçš„é…ç½®æ–‡ä»¶â€/var/lib/kubelet/config.yamlâ€
[certificates] ç”Ÿæˆç›¸å…³çš„å„ç§è¯ä¹¦
[kubeconfig] ç”Ÿæˆ KubeConfig æ–‡ä»¶ï¼Œå­˜æ”¾åœ¨ /etc/kubernetes ç›®å½•ä¸­ï¼Œç»„ä»¶ä¹‹é—´é€šä¿¡éœ€è¦ä½¿ç”¨å¯¹åº”æ–‡ä»¶
[control-plane] ä½¿ç”¨ /etc/kubernetes/manifest ç›®å½•ä¸‹çš„ YAML æ–‡ä»¶ï¼Œå®‰è£… Master ç»„ä»¶
[etcd] ä½¿ç”¨ /etc/kubernetes/manifest/etcd.yaml å®‰è£… Etcd æœåŠ¡
[kubelet] ä½¿ç”¨ configMap é…ç½® kubelet
[patchnode] æ›´æ–° CNI ä¿¡æ¯åˆ° Node ä¸Šï¼Œé€šè¿‡æ³¨é‡Šçš„æ–¹å¼è®°å½•
[mark-control-plane] ä¸ºå½“å‰èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œæ‰“äº†è§’è‰² Masterï¼Œå’Œä¸å¯è°ƒåº¦æ ‡ç­¾ï¼Œé»˜è®¤å°±ä¸ä¼šä½¿ç”¨ Master èŠ‚ç‚¹æ¥è¿è¡Œ Pod
[bootstrap-token] ç”Ÿæˆtokenè®°å½•ä¸‹æ¥ï¼Œåè¾¹ä½¿ç”¨kubeadm joinå¾€é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°
[addons] å®‰è£…é™„åŠ ç»„ä»¶ CoreDNS å’Œ kube-proxy
</code></pre><ul>
<li>é…ç½®Kubectl</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

<span style="color:#75715e"># é ROOT ç”¨æˆ·æ‰§è¡Œ</span>
chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</code></pre></div><p>éªŒè¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get node
<span style="color:#75715e"># ç»“æœ</span>
NAME                    STATUS     ROLES    AGE   VERSION
kubernetes-master   	NotReady   master   92m   v1.18.0
</code></pre></div><h3 id="kubeadm-join-é…ç½®kubernetes-slaveèŠ‚ç‚¹">kubeadm join é…ç½®kubernetes slaveèŠ‚ç‚¹</h3>
<p>å°† slave èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œåªéœ€è¦åœ¨ slave æœåŠ¡å™¨ä¸Šå®‰è£… kubeadmï¼Œkubectlï¼Œkubelet ä¸‰ä¸ªå·¥å…·ï¼Œç„¶åä½¿ç”¨ <code>kubeadm join</code> å‘½ä»¤åŠ å…¥</p>
<ul>
<li>é…ç½®kubernetes slaveèŠ‚ç‚¹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubeadm join 192.168.1.120:6443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     --discovery-token-ca-cert-hash sha256:4133848ddc81242c50c95b684be0fa049e63362b1af542a49d9c31a65c2b138b

<span style="color:#75715e"># ç»“æœ</span>
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Reading configuration from the cluster...
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> FYI: You can look at this config file with <span style="color:#e6db74">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Downloading configuration <span style="color:#66d9ef">for</span> the kubelet from the <span style="color:#e6db74">&#34;kubelet-config-1.18&#34;</span> ConfigMap in the kube-system namespace
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span style="color:#e6db74">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</code></pre></div><ul>
<li>éªŒè¯</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get nodes
<span style="color:#75715e"># ç»“æœ</span>
NAME                    STATUS     ROLES    AGE     VERSION
kubernetes-slave1       NotReady   &lt;none&gt;   5m14s   v1.18.0
kubernetes-master   	NotReady   master   92m   v1.18.0
</code></pre></div><h3 id="é…ç½®ç½‘ç»œæ’ä»¶">é…ç½®ç½‘ç»œæ’ä»¶</h3>
<ul>
<li>å…³äºå®¹å™¨ç½‘ç»œ</li>
</ul>
<p>å®¹å™¨ç½‘ç»œæ˜¯å®¹å™¨é€‰æ‹©è¿æ¥åˆ°å…¶ä»–å®¹å™¨ã€ä¸»æœºå’Œå¤–éƒ¨ç½‘ç»œçš„æœºåˆ¶ã€‚å®¹å™¨çš„ runtime æä¾›äº†å„ç§ç½‘ç»œæ¨¡å¼ï¼Œä»¥Dockerä¸ºä¾‹å­ï¼ŒDocker é»˜è®¤æƒ…å†µä¸‹å¯ä»¥ä¸ºå®¹å™¨é…ç½®ä»¥ä¸‹ç½‘ç»œï¼š</p>
<pre><code>noneï¼š å°†å®¹å™¨æ·»åŠ åˆ°ä¸€ä¸ªå®¹å™¨ä¸“é—¨çš„ç½‘ç»œå †æ ˆä¸­ï¼Œæ²¡æœ‰å¯¹å¤–è¿æ¥ã€‚
hostï¼š å°†å®¹å™¨æ·»åŠ åˆ°ä¸»æœºçš„ç½‘ç»œå †æ ˆä¸­ï¼Œæ²¡æœ‰éš”ç¦»ã€‚
default bridgeï¼š é»˜è®¤ç½‘ç»œæ¨¡å¼ã€‚æ¯ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡ IP åœ°å€ç›¸äº’è¿æ¥ã€‚
è‡ªå®šä¹‰ç½‘æ¡¥ï¼š ç”¨æˆ·å®šä¹‰çš„ç½‘æ¡¥ï¼Œå…·æœ‰æ›´å¤šçš„çµæ´»æ€§ã€éš”ç¦»æ€§å’Œå…¶ä»–ä¾¿åˆ©åŠŸèƒ½ã€‚
</code></pre><ul>
<li>CNI</li>
</ul>
<pre><code>CNIï¼ˆContainer Network Interfaceï¼‰æ˜¯CNCFæ——ä¸‹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç”±ä¸€ç»„ç”¨äºé…ç½®Linuxå®¹å™¨çš„ç½‘ç»œæ¥å£çš„è§„èŒƒå’Œåº“ç»„æˆï¼ŒåŒæ—¶è¿˜åŒ…å«äº†ä¸€äº›æ’ä»¶ã€‚CNIä»…å…³å¿ƒå®¹å™¨åˆ›å»ºæ—¶çš„ç½‘ç»œåˆ†é…ï¼Œå’Œå½“å®¹å™¨è¢«åˆ é™¤æ—¶é‡Šæ”¾ç½‘ç»œèµ„æºã€‚

CNI çš„åˆè¡·æ˜¯åˆ›å»ºä¸€ä¸ªæ¡†æ¶ï¼Œç”¨äºåœ¨é…ç½®æˆ–é”€æ¯å®¹å™¨æ—¶åŠ¨æ€é…ç½®é€‚å½“çš„ç½‘ç»œé…ç½®å’Œèµ„æºã€‚æ’ä»¶è´Ÿè´£ä¸ºæ¥å£é…ç½®å’Œç®¡ç† IP åœ°å€ï¼Œå¹¶ä¸”é€šå¸¸æä¾›ä¸ IP ç®¡ç†ã€æ¯ä¸ªå®¹å™¨çš„ IP åˆ†é…ã€ä»¥åŠå¤šä¸»æœºè¿æ¥ç›¸å…³çš„åŠŸèƒ½ã€‚å®¹å™¨è¿è¡Œæ—¶ä¼šè°ƒç”¨ç½‘ç»œæ’ä»¶ï¼Œä»è€Œåœ¨å®¹å™¨å¯åŠ¨æ—¶åˆ†é… IP åœ°å€å¹¶é…ç½®ç½‘ç»œï¼Œå¹¶åœ¨åˆ é™¤å®¹å™¨æ—¶å†æ¬¡è°ƒç”¨å®ƒä»¥æ¸…ç†è¿™äº›èµ„æºã€‚

è¿è¡Œæ—¶æˆ–åè°ƒå™¨å†³å®šäº†å®¹å™¨åº”è¯¥åŠ å…¥å“ªä¸ªç½‘ç»œä»¥åŠå®ƒéœ€è¦è°ƒç”¨å“ªä¸ªæ’ä»¶ã€‚ç„¶åï¼Œæ’ä»¶ä¼šå°†æ¥å£æ·»åŠ åˆ°å®¹å™¨ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œä½œä¸ºä¸€ä¸ª veth å¯¹çš„ä¸€ä¾§ã€‚æ¥ç€ï¼Œå®ƒä¼šåœ¨ä¸»æœºä¸Šè¿›è¡Œæ›´æ”¹ï¼ŒåŒ…æ‹¬å°† veth çš„å…¶ä»–éƒ¨åˆ†è¿æ¥åˆ°ç½‘æ¡¥ã€‚å†ä¹‹åï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨å•ç‹¬çš„ IPAMï¼ˆIPåœ°å€ç®¡ç†ï¼‰æ’ä»¶æ¥åˆ†é… IP åœ°å€å¹¶è®¾ç½®è·¯ç”±ã€‚

åœ¨ Kubernetes ä¸­ï¼Œkubelet å¯ä»¥åœ¨é€‚å½“çš„æ—¶é—´è°ƒç”¨å®ƒæ‰¾åˆ°çš„æ’ä»¶ï¼Œä¸ºé€šè¿‡ kubelet å¯åŠ¨çš„ podè¿›è¡Œè‡ªåŠ¨çš„ç½‘ç»œé…ç½®ã€‚
Kubernetes ä¸­å¯é€‰çš„ CNI æ’ä»¶å¦‚ä¸‹ï¼š
- Flannel
- Calico
- Canal
- Weave
</code></pre><ul>
<li>å®‰è£…calico</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml

configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
</code></pre></div><ul>
<li>éªŒè¯</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">watch kubectl get pods --all-namespaces
</code></pre></div><h3 id="kube-proxyå¼€å¯ipvs">kube-proxyå¼€å¯ipvs</h3>
<ul>
<li>ä¿®æ”¹é…ç½®æ–‡ä»¶</li>
</ul>
<p>ä¿®æ”¹ConfigMapçš„kube-system/kube-proxyä¸­çš„config.confï¼Œ<code>mode: &quot;ipvs&quot;</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl edit cm kube-proxy -n kube-system
</code></pre></div><ul>
<li>é‡å¯å„ä¸ªèŠ‚ç‚¹ä¸Šçš„kube-proxy pod</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pod -n kube-system | grep kube-proxy | awk <span style="color:#e6db74">&#39;{system(&#34;kubectl delete pod &#34;$1&#34; -n kube-system&#34;)}&#39;</span>
</code></pre></div><ul>
<li>éªŒè¯</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl logs kube-proxy- -n kube-system
</code></pre></div><h3 id="kubectl-éƒ¨ç½²nginx">kubectl éƒ¨ç½²Nginx</h3>
<ul>
<li>æ£€æµ‹ç»„ä»¶è¿è¡ŒçŠ¶æ€</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get cs

NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> 
</code></pre></div><ul>
<li>æ£€æµ‹masterä¸slaveèŠ‚ç‚¹çŠ¶æ€</li>
</ul>
<pre><code>kubectl cluster-info
kubectl get nodes
</code></pre><ul>
<li>YAMLé…ç½®æ–‡ä»¶</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: nginx-deployment
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app</span>: nginx
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app</span>: nginx
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: nginx
        <span style="color:#66d9ef">image</span>: nginx:<span style="color:#ae81ff">1.7.9</span>
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>è¿™é‡Œçš„yamlé…ç½®æ–‡ä»¶ï¼Œå¯¹åº”åˆ° Kubernetes ä¸­ï¼Œå°±æ˜¯ä¸€ä¸ª API Objectï¼ˆAPI å¯¹è±¡ï¼‰ã€‚å°†é…ç½®æ–‡ä»¶æäº¤ç»™Kubernetesåï¼Œ Kubernetes å°±ä¼šè´Ÿè´£åˆ›å»ºå‡ºè¿™äº›å¯¹è±¡æ‰€å®šä¹‰çš„å®¹å™¨æˆ–è€…å…¶ä»–ç±»å‹çš„ API èµ„æºã€‚</p>
<p>Kind å­—æ®µï¼šæŒ‡å®šäº†è¿™ä¸ª API å¯¹è±¡çš„ç±»å‹ï¼ˆTypeï¼‰ä¸º Deploymentã€‚</p>
<p>Pod æ¨¡ç‰ˆï¼ˆspec.templateï¼‰ï¼šå®šä¹‰ä¸€ä¸ª Pod æ¨¡ç‰ˆï¼ˆspec.templateï¼‰, Pod åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨çš„é•œåƒï¼ˆspec.containers.imageï¼‰æ˜¯ nginx:1.7.9ï¼Œå®¹å™¨ç›‘å¬ç«¯å£ï¼ˆcontainerPortï¼‰æ˜¯ 80</p>
<p>Metadata å­—æ®µï¼šè®¾ç½®æ ‡è¯†ï¼ŒLabels å­—æ®µä¸»è¦ç”¨äº Kubernetes è¿‡æ»¤å¯¹è±¡</p>
<p>ä¸€ä¸ª Kubernetes çš„ API å¯¹è±¡çš„å®šä¹‰ï¼Œå¯ä»¥åˆ†ä¸º Metadata å’Œ Spec ä¸¤ä¸ªéƒ¨åˆ†ã€‚å‰è€…å­˜æ”¾çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„å…ƒæ•°æ®ï¼›è€Œåè€…å­˜æ”¾å±äºè¿™ä¸ªå¯¹è±¡ç‹¬æœ‰çš„å®šä¹‰ï¼Œç”¨æ¥æè¿°å®ƒæ‰€è¦è¡¨è¾¾çš„åŠŸèƒ½ã€‚</p>
<p>è¿™é‡Œä½¿ç”¨ä¸€ç§ API å¯¹è±¡ï¼ˆDeploymentï¼‰ç®¡ç†å¦ä¸€ç§ API å¯¹è±¡ï¼ˆPodï¼‰çš„æ–¹æ³•ï¼Œåœ¨ Kubernetes ä¸­å«ä½œâ€œæ§åˆ¶å™¨â€æ¨¡å¼ï¼ˆcontroller patternï¼‰ã€‚Deployment æ˜¯ Pod çš„æ§åˆ¶å™¨çš„è§’è‰²ã€‚</p>
<ul>
<li>ç›¸å…³æŒ‡ä»¤</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># è¿è¡Œ</span>
kubectl create -f nginx-deployment.yaml
<span style="color:#75715e"># æ›´æ–°</span>
kubectl replace -f nginx-deployment.yaml
kubectl apply -f nginx-deployment.yaml
kubectl edit -f nginx-deployment.yaml
<span style="color:#75715e"># åˆ é™¤</span>
kubectl delete -f nginx_deployment.yml
<span style="color:#75715e"># è¿›å…¥pod</span>
 kubectl exec -it nginx-deployment-cc7df4f8f-nlcn8
<span style="color:#75715e"># æŸ¥çœ‹å¯¹åº”çš„podçŠ¶æ€</span>
kubectl get pods -l app<span style="color:#f92672">=</span>nginx
<span style="color:#75715e"># æŸ¥çœ‹Pod çš„è¯¦ç»†ä¿¡æ¯</span>
kubectl describe pod nginx-deployment-cc7df4f8f-nlcn8
</code></pre></div><ul>
<li>æ˜ å°„æœåŠ¡</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æ˜ å°„NginxæœåŠ¡80ç«¯å£</span>
kubectl expose deployment nginx-deployment --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>LoadBalancer
<span style="color:#75715e"># æŸ¥çœ‹å·²å‘å¸ƒæœåŠ¡</span>
kubectl get services

NAME               TYPE           CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
kubernetes         ClusterIP      10.96.0.1     &lt;none&gt;        443/TCP        7h55m
nginx-deployment   LoadBalancer   10.103.3.26   &lt;pending&gt;     80:30626/TCP   18s
<span style="color:#75715e"># å¯ä»¥é€šè¿‡è®¿é—®http://ip:30626/ è®¿é—®nginxé¡µé¢</span>
</code></pre></div><h2 id="kuberneteså¸¸ç”¨ç»„ä»¶éƒ¨ç½²">Kuberneteså¸¸ç”¨ç»„ä»¶éƒ¨ç½²</h2>
<h3 id="helm">Helm</h3>
<ul>
<li>å…³äºHelmä¸chart</li>
</ul>
<p>Helmæ˜¯ä¸€ä¸ª Kubernetes åº”ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥ç®¡ç† charâ€”â€”é¢„å…ˆé…ç½®å¥½çš„å®‰è£…åŒ…èµ„æºï¼Œç±»ä¼¼äº Ubuntu çš„ APT å’Œ CentOS ä¸­çš„ YUMã€‚</p>
<p>Helm chart æ˜¯ç”¨æ¥å°è£… Kubernetes åŸç”Ÿåº”ç”¨ç¨‹åºçš„ YAML æ–‡ä»¶ï¼Œç”¨äºåœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™è‡ªå®šä¹‰åº”ç”¨ç¨‹åºçš„ä¸€äº› metadataï¼Œä¾¿äºåº”ç”¨ç¨‹åºçš„åˆ†å‘ã€‚</p>
<ul>
<li>Chartç›¸å…³æ¦‚å¿µ</li>
</ul>
<p>ä¸€ä¸ª Chart æ˜¯ä¸€ä¸ª Helm åŒ…ï¼Œå®ƒåŒ…å«åœ¨ Kubernetes é›†ç¾¤å†…éƒ¨è¿è¡Œåº”ç”¨ç¨‹åºï¼Œå·¥å…·æˆ–æœåŠ¡æ‰€éœ€çš„æ‰€æœ‰èµ„æºå®šä¹‰ã€‚å¯ä»¥æŠŠå®ƒæƒ³åƒä¸ºä¸€ä¸ªè‡ªåˆ¶è½¯ä»¶ï¼Œä¸€ä¸ª Apt dpkg æˆ–ä¸€ä¸ª Yum RPM æ–‡ä»¶çš„ Kubernetes ç¯å¢ƒé‡Œé¢çš„ç­‰ä»·ç‰©ã€‚</p>
<p>ä¸€ä¸ª Repository æ˜¯ Charts æ”¶é›†å’Œå…±äº«çš„åœ°æ–¹ï¼Œç±»ä¼¼äºåŒ…ç®¡ç†ä¸­å¿ƒã€‚</p>
<p>ä¸€ä¸ª Release æ˜¯å¤„äº Kubernetes é›†ç¾¤ä¸­è¿è¡Œçš„ Chart çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸€ä¸ª chart é€šå¸¸å¯ä»¥å¤šæ¬¡å®‰è£…åˆ°åŒä¸€ä¸ªç¾¤é›†ä¸­ã€‚æ¯æ¬¡å®‰è£…æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–° release ã€‚</p>
<ul>
<li>Helmç›¸å…³æ¦‚å¿µ</li>
</ul>
<p>Helm å°† charts å®‰è£…åˆ° Kubernetes ä¸­ï¼Œæ¯ä¸ªå®‰è£…åˆ›å»ºä¸€ä¸ªæ–° release ã€‚è¦æ‰¾åˆ°æ–°çš„ chartï¼Œå¯ä»¥æœç´¢ Helm charts å­˜å‚¨åº“ repositoriesã€‚</p>
<ul>
<li>
<p>Helmä¸chartä½œç”¨</p>
<ol>
<li>
<p>åº”ç”¨ç¨‹åºå°è£…</p>
</li>
<li>
<p>ç‰ˆæœ¬ç®¡ç†</p>
</li>
<li>
<p>ä¾èµ–æ£€æŸ¥</p>
</li>
<li>
<p>ä¾¿äºåº”ç”¨ç¨‹åºåˆ†å‘</p>
</li>
</ol>
</li>
<li>
<p>Helmå®‰è£…</p>
</li>
</ul>
<p>Helmç”±å®¢æˆ·ç«¯å‘½helmä»¤è¡Œå·¥å…·å’ŒæœåŠ¡ç«¯tillerç»„æˆï¼Œä¸‹è½½helmå‘½ä»¤è¡Œå·¥å…·åˆ°masterèŠ‚ç‚¹node1çš„/usr/local/binä¸‹è¿›è¡Œå®‰è£…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://storage.googleapis.com/kubernetes-helm/helm-v2.15.1-linux-amd64.tar.gz
tar -zxvf helm-v2.15.1-linux-amd64.tar.gz
cd linux-amd64/
cp helm /usr/local/bin/
</code></pre></div><p>Helm çš„æœåŠ¡å™¨ç«¯éƒ¨åˆ† Tiller é€šå¸¸è¿è¡Œåœ¨ Kubernetes é›†ç¾¤å†…éƒ¨ã€‚å› ä¸ºKubernetes APIServerå¼€å¯äº†RBACè®¿é—®æ§åˆ¶ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºtillerä½¿ç”¨çš„service account: tillerå¹¶åˆ†é…åˆé€‚çš„è§’è‰²ç»™å®ƒã€‚ é€šè¿‡æŸ¥çœ‹helmæ–‡æ¡£ä¸­çš„<a href="https://helm.sh/docs/topics/rbac/">Role-based Access Control</a>ã€‚ ç®€å•çš„ç›´æ¥åˆ†é…cluster-adminè¿™ä¸ªé›†ç¾¤å†…ç½®çš„ClusterRoleç»™å®ƒï¼Œrbac-config.yamlæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ServiceAccount
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: tiller
  <span style="color:#66d9ef">namespace</span>: kube-system
---
<span style="color:#66d9ef">apiVersion</span>: rbac.authorization.k8s.io/v1beta1
<span style="color:#66d9ef">kind</span>: ClusterRoleBinding
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: tiller
<span style="color:#66d9ef">spec</span>:
  
<span style="color:#66d9ef">roleRef</span>:
  <span style="color:#66d9ef">apiGroup</span>: rbac.authorization.k8s.io
  <span style="color:#66d9ef">kind</span>: ClusterRole
  <span style="color:#66d9ef">name</span>: cluster-admin
<span style="color:#66d9ef">subjects</span>:
  - <span style="color:#66d9ef">kind</span>: ServiceAccount
    <span style="color:#66d9ef">name</span>: tiller
    <span style="color:#66d9ef">namespace</span>: kube-system
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># è¿è¡Œ</span>
kubectl create -f rbac-config.yaml
<span style="color:#75715e"># ç»“æœ</span>
serviceaccount/tiller created
clusterrolebinding.rbac.authorization.k8s.io/tiller created
</code></pre></div><p>ä½¿ç”¨helméƒ¨ç½²tiller</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># tilleré•œåƒåœ°å€ä¿®æ”¹ä¸ºå¯ç”¨çš„ï¼Œå¯ä»¥é€šè¿‡docker search tilleræŸ¥çœ‹å¯ç”¨é•œåƒï¼Œcharts repoåœ°å€ä¿®æ”¹ä¸ºå›½å†…æº</span>
helm init --upgrade -i sapcc/tiller:v2.15.1 --service-account<span style="color:#f92672">=</span>tiller --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
</code></pre></div><p>æŸ¥çœ‹è¿è¡ŒçŠ¶å†µ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># tilleré»˜è®¤è¢«éƒ¨ç½²åœ¨k8sé›†ç¾¤ä¸­çš„kube-systemçš„helmä¸‹</span>
kubectl get pods -n kube-system -l app<span style="color:#f92672">=</span>helm
NAME                             READY   STATUS    RESTARTS   AGE
tiller-deploy-6bdbf9884d-pstx4   1/1     Running   <span style="color:#ae81ff">0</span>          5m43s
</code></pre></div><ul>
<li>Helmå¸¸ç”¨å‘½ä»¤</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># æŸ¥çœ‹ç‰ˆæœ¬</span>
helm version
<span style="color:#75715e"># æŸ¥çœ‹å½“å‰å®‰è£…çš„charts</span>
helm list
<span style="color:#75715e"># æŸ¥è¯¢ charts</span>
helm search nginx
<span style="color:#75715e"># ä¸‹è½½è¿œç¨‹å®‰è£…åŒ…åˆ°æœ¬åœ°</span>
helm fetch rancher-stable/rancher
<span style="color:#75715e"># æŸ¥çœ‹packageè¯¦ç»†ä¿¡æ¯</span>
helm inspect chart
<span style="color:#75715e">#å®‰è£…charts</span>
helm install --name nginx --namespaces prod bitnami/nginx
<span style="color:#75715e"># æŸ¥çœ‹chartsçŠ¶æ€</span>
helm status nginx
<span style="color:#75715e"># åˆ é™¤charts</span>
helm delete --purge nginx
<span style="color:#75715e"># å¢åŠ repo</span>
helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
helm repo add --username admin --password password myps https://harbor.pt1.cn/chartrepo/charts
<span style="color:#75715e"># æ›´æ–°repoä»“åº“èµ„æº</span>
helm repo update
<span style="color:#75715e"># åˆ›å»ºcharts</span>
helm create helm_charts
<span style="color:#75715e"># æµ‹è¯•chartsè¯­æ³•</span>
helm lint 
<span style="color:#75715e"># æ‰“åŒ…charts</span>
cd helm_charts <span style="color:#f92672">&amp;&amp;</span> helm package ./
<span style="color:#75715e"># æŸ¥çœ‹ç”Ÿæˆçš„yamlæ–‡ä»¶</span>
helm  template  helm_charts-0.1.1.tgz
<span style="color:#75715e"># æ›´æ–°image</span>
helm upgrade --set image.tag<span style="color:#f92672">=</span>â€˜v201908â€˜ test update myharbor/study-api-en-oral
<span style="color:#75715e"># å›æ»šrelase</span>
helm rollback nginx
</code></pre></div><h3 id="ä½¿ç”¨helméƒ¨ç½²ingress-nginx">ä½¿ç”¨Helméƒ¨ç½²Ingress-nginx</h3>
<ul>
<li>éƒ¨ç½²Ingress-nginxï¼Œå¯ä»¥æ–¹ä¾¿åœ°å°†é›†ç¾¤ä¸­çš„æœåŠ¡æš´éœ²åˆ°é›†ç¾¤å¤–éƒ¨ï¼Œä»é›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä½¿ç”¨helméƒ¨ç½²æ“ä½œå¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŸ¥è¯¢ç›¸å…³çš„Charts</span>
helm search stable/nginx-ingress
<span style="color:#75715e"># ä¸‹è½½è¿œç¨‹å®‰è£…åŒ…åˆ°æœ¬åœ°</span>
helm fetch stable/nginx-ingress
tar -xvf nginx-ingress-1.40.2.tgz
</code></pre></div><ul>
<li>ä¿®æ”¹values.yamlé…ç½®å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#75715e"># 1. ä¿®æ”¹repository åœ°å€</span>
  <span style="color:#66d9ef">name</span>: controller
  <span style="color:#66d9ef">image</span>:
    <span style="color:#66d9ef">repository</span>: siriuszg/nginx-ingress-controller
    <span style="color:#66d9ef">tag</span>: <span style="color:#e6db74">&#34;0.33.0&#34;</span>
    <span style="color:#66d9ef">pullPolicy</span>: IfNotPresent
    <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">101</span>
    <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">true</span>

 <span style="color:#75715e"># ......</span>
 
  <span style="color:#75715e"># Required for use with CNI based kubernetes installations (such as ones set up by kubeadm),</span>
  <span style="color:#75715e"># since CNI and hostport don&#39;t mix yet. Can be deprecated once https://github.com/kubernetes/kubernetes/issues/23920</span>
  <span style="color:#75715e"># is merged</span>
  <span style="color:#75715e"># 2. è®¾ç½®nginx ingress controllerä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œè®¾ç½®hostNetworkä¸ºtrue</span>
  <span style="color:#66d9ef">hostNetwork</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">dnsConfig</span>: {}
  <span style="color:#66d9ef">dnsPolicy</span>: ClusterFirst
  <span style="color:#66d9ef">reportNodeInternalIp</span>: <span style="color:#66d9ef">false</span>

  <span style="color:#75715e">## Use host ports 80 and 443</span>
  <span style="color:#75715e"># 3. ä½¿ç”¨ä¸»æœºç«¯å£æ‰“å¼€</span>
  <span style="color:#66d9ef">daemonset</span>:
    <span style="color:#66d9ef">useHostPort</span>: <span style="color:#66d9ef">true</span>

    <span style="color:#66d9ef">hostPorts</span>:
      <span style="color:#66d9ef">http</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#66d9ef">https</span>: <span style="color:#ae81ff">443</span>
 
 <span style="color:#75715e"># ......</span>
 <span style="color:#75715e"># 4. å› ä¸ºä½¿ç”¨çš„æ˜¯hostnetworkçš„æ–¹å¼ï¼Œå› æ­¤ä¸åˆ›å»ºserviceï¼Œè¿™é‡Œè®¾ç½®enabledä¸ºfalse</span>

  <span style="color:#66d9ef">service</span>:
    <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">false</span>

    <span style="color:#66d9ef">annotations</span>: {}
    <span style="color:#66d9ef">labels</span>: {}
 <span style="color:#75715e"># ......</span>
</code></pre></div><ul>
<li>å®‰è£…Chart</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm install --name nginx-ingress -f nginx-values.yaml . --namespace kube-system
</code></pre></div><ul>
<li>éªŒè¯</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># æŸ¥çœ‹nginx-ingress-controller éƒ¨ç½²åˆ°çš„ipï¼Œè®¿é—®http://192.168.1.121è¿”å›default backendï¼Œåˆ™éƒ¨ç½²å®Œæˆ</span>
kubectl get pod -n kube-system -o wide
</code></pre></div><h3 id="ä½¿ç”¨helméƒ¨ç½²kubernetes-dashboard">ä½¿ç”¨Helméƒ¨ç½²kubernetes-dashboard</h3>
<ul>
<li>åˆ›å»º/å®‰è£…tls secret</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">openssl req -x509 -nodes -days <span style="color:#ae81ff">3650</span> -newkey rsa:2048 -keyout ./tls.key -out ./tls.crt -subj <span style="color:#e6db74">&#34;/CN=192.168.1.121&#34;</span>
kubectl -n kube-system  create secret tls dashboard-tls-secret --key ./tls.key --cert ./tls.crt
<span style="color:#75715e"># æŸ¥çœ‹</span>
kubectl get secret -n kube-system |grep dashboard
</code></pre></div><ul>
<li>helmä¸‹è½½kubernetes-dashboard</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
helm search kubernetes-dashboard/kubernetes-dashboard
helm fetch kubernetes-dashboard/kubernetes-dashboard
tar -xvf kubernetes-dashboard-2.2.0.tgz
cp values.yaml dashboard-chart-2.yaml
</code></pre></div><ul>
<li>è‡ªå®šä¹‰chartæ–‡ä»¶</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">image</span>:
  <span style="color:#66d9ef">repository</span>: kubernetesui/dashboard
  <span style="color:#66d9ef">tag</span>: v2<span style="color:#ae81ff">.0.3</span>
  <span style="color:#66d9ef">pullPolicy</span>: IfNotPresent
  <span style="color:#66d9ef">pullSecrets</span>: []

<span style="color:#66d9ef">replicaCount</span>: <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">ingress</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">kubernetes.io/ingress.class</span>: nginx
    <span style="color:#66d9ef">kubernetes.io/tls-acme</span>: <span style="color:#e6db74">&#39;true&#39;</span>
    <span style="color:#66d9ef">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
  <span style="color:#66d9ef">hosts</span>:
    - lhr.dashboard.com
  <span style="color:#66d9ef">tls</span>:
    - <span style="color:#66d9ef">secretName</span>: dashboard-tls-secret
      <span style="color:#66d9ef">hosts</span>:
        - lhr.dashboard.com
  <span style="color:#66d9ef">paths</span>:
    - /
<span style="color:#66d9ef">metricsScraper</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">image</span>:
    <span style="color:#66d9ef">repository</span>: kubernetesui/metrics-scraper
    <span style="color:#66d9ef">tag</span>: v1<span style="color:#ae81ff">.0.4</span>
  <span style="color:#66d9ef">resources</span>: {}
  <span style="color:#66d9ef">containerSecurityContext</span>:
    <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">1001</span>
    <span style="color:#66d9ef">runAsGroup</span>: <span style="color:#ae81ff">2001</span>
<span style="color:#66d9ef">rbac</span>:
  <span style="color:#66d9ef">create</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">clusterRoleMetrics</span>: <span style="color:#66d9ef">true</span>
<span style="color:#66d9ef">serviceAccount</span>:
  <span style="color:#66d9ef">create</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">name</span>: dashboard-admin

<span style="color:#66d9ef">livenessProbe</span>:
  <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
  <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">30</span>

<span style="color:#66d9ef">podDisruptionBudget</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">minAvailable</span>:
  <span style="color:#66d9ef">maxUnavailable</span>:

<span style="color:#66d9ef">containerSecurityContext</span>:
  <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">1001</span>
  <span style="color:#66d9ef">runAsGroup</span>: <span style="color:#ae81ff">2001</span>

<span style="color:#66d9ef">networkPolicy</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">false</span>
</code></pre></div><ul>
<li>chartå®‰è£…</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># å®‰è£…</span>
helm install --name kubernetes-dashboard<span style="color:#ae81ff">-2</span> -f dashboard-chart.yaml . --namespace kube-system
<span style="color:#75715e"># æ›´æ–°é…ç½®</span>
helm upgrade kubernetes-dashboard<span style="color:#ae81ff">-2</span> -f dashboard-chart.yaml . --namespace kube-system
</code></pre></div><ul>
<li>tokenè·å–</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># æ–°å¢tokenè·å–è„šæœ¬</span>
vim dashboard-token.sh
<span style="color:#75715e"># å¦‚ä¸‹æ‰€ç¤º</span>
<span style="color:#75715e">#!/bin/sh</span>

TOKENS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl describe serviceaccount dashboard-admin -n kube-system | grep <span style="color:#e6db74">&#34;Tokens:&#34;</span> | awk <span style="color:#e6db74">&#39;{ print $2}&#39;</span><span style="color:#66d9ef">)</span>
kubectl describe secret $TOKENS -n kube-system | grep <span style="color:#e6db74">&#34;token:&#34;</span> | awk <span style="color:#e6db74">&#39;{ print $2}&#39;</span>
<span style="color:#75715e"># è®¾ç½®åˆ«å</span>
vim ~/.bashrc 
alias k8s-dashboard-token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sh /data/chart/dashboard/kubernetes-dashboard/dashboard-token.sh&#34;</span>
source ~/.bashrc 
</code></pre></div><h3 id="ä½¿ç”¨helméƒ¨ç½²metrics-server">ä½¿ç”¨Helméƒ¨ç½²metrics-server</h3>
<p>metrics-serveræ˜¯kubernetesçš„ç›‘æ§ç»„ä»¶ï¼Œå¯ä»¥é…åˆkubernetes-dashboardä½¿ç”¨</p>
<ul>
<li>helmä¸‹è½½metrics-server</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm search stable/metrics-server
helm fetch stable/metrics-server
tar -xvf metrics-server-2.11.1.tgz
</code></pre></div><ul>
<li>è‡ªå®šä¹‰chartæ–‡ä»¶</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">rbac</span>:
  <span style="color:#66d9ef">create</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">pspEnabled</span>: <span style="color:#66d9ef">true</span>
<span style="color:#66d9ef">serviceAccount</span>: 
  <span style="color:#66d9ef">create</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">name</span>: metircs-admin
<span style="color:#66d9ef">apiService</span>:
  <span style="color:#66d9ef">create</span>: <span style="color:#66d9ef">true</span>
<span style="color:#66d9ef">hostNetwork</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">image</span>:
  <span style="color:#66d9ef">repository</span>: mirrorgooglecontainers/metrics-server-amd64
  <span style="color:#66d9ef">tag</span>: v0<span style="color:#ae81ff">.3.6</span>
  <span style="color:#66d9ef">pullPolicy</span>: IfNotPresent
<span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">args</span>:
- --logtostderr
- --kubelet-insecure-tls=<span style="color:#66d9ef">true</span>
- --kubelet-preferred-address-types=InternalIP
<span style="color:#66d9ef">livenessProbe</span>:
  <span style="color:#66d9ef">httpGet</span>:
    <span style="color:#66d9ef">path</span>: /healthz
    <span style="color:#66d9ef">port</span>: https
    <span style="color:#66d9ef">scheme</span>: HTTPS
  <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
<span style="color:#66d9ef">readinessProbe</span>:
  <span style="color:#66d9ef">httpGet</span>:
    <span style="color:#66d9ef">path</span>: /healthz
    <span style="color:#66d9ef">port</span>: https
    <span style="color:#66d9ef">scheme</span>: HTTPS
  <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
<span style="color:#66d9ef">securityContext</span>:
  <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">capabilities</span>:
    <span style="color:#66d9ef">drop</span>: [<span style="color:#e6db74">&#34;all&#34;</span>]
  <span style="color:#66d9ef">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">runAsGroup</span>: <span style="color:#ae81ff">10001</span>
  <span style="color:#66d9ef">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">10001</span>
<span style="color:#66d9ef">service</span>:
  <span style="color:#66d9ef">annotations</span>: {}
  <span style="color:#66d9ef">labels</span>: {}
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">443</span>
  <span style="color:#66d9ef">type</span>: ClusterIP
<span style="color:#66d9ef">podDisruptionBudget</span>:
  <span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">minAvailable</span>:
  <span style="color:#66d9ef">maxUnavailable</span>:
</code></pre></div><ul>
<li>Chartå®‰è£…</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm install --name metrics-server -f metrics-chart.yaml . --namespace kube-system
helm upgrade metrics-server -f metrics-chart.yaml . --namespace kube-system
</code></pre></div><ul>
<li>æŸ¥çœ‹ç›¸å…³æŒ‡æ ‡</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># kubectl top node</span>
NAME                CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
kubernetes-master   396m         19%    1189Mi          68%       
kubernetes-slave    194m         19%    746Mi           42%    
</code></pre></div><ul>
<li>æ•ˆæœå›¾</li>
</ul>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/86820664-f29cc880-c0bb-11ea-91af-ee96b94999fd.png">
    <img src="https://user-images.githubusercontent.com/19829495/86820664-f29cc880-c0bb-11ea-91af-ee96b94999fd.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/86820749-0ba57980-c0bc-11ea-911d-5596941741e0.png">
    <img src="https://user-images.githubusercontent.com/19829495/86820749-0ba57980-c0bc-11ea-911d-5596941741e0.png" alt="å›¾ç‰‡"  />
    </a>
</div></p>
<h2 id="faq">FAQ</h2>
<ul>
<li>Kubernetesçš„slaveèŠ‚ç‚¹ä¸Šæ‰§è¡Œkubectlå‘½ä»¤å‡ºç°é”™è¯¯ï¼šThe connection to the server localhost:8080 was refused - did you specify the right host or port?</li>
</ul>
<p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯kubectlå‘½ä»¤éœ€è¦ä½¿ç”¨kubernetes-adminæ¥è¿è¡Œï¼Œéœ€è¦å°†ä¸»èŠ‚ç‚¹ä¸­çš„<code>/etc/kubernetes/admin.conf</code>æ–‡ä»¶æ‹·è´åˆ°ä»èŠ‚ç‚¹ç›¸åŒç›®å½•ä¸‹ï¼Œç„¶åé…ç½®ç¯å¢ƒå˜é‡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æ‹·è´å†…å®¹</span>
vim /etc/kubernetes/admin.conf
<span style="color:#75715e"># é…ç½®ç¯å¢ƒå˜é‡</span>
echo <span style="color:#e6db74">&#34;export KUBECONFIG=/etc/kubernetes/admin.conf&#34;</span> &gt;&gt; ~/.bash_profile
source ~/.bash_profile
</code></pre></div><ul>
<li>helm listå‘½ä»¤å‡ºç° Error: Get https://10.96.0.1:443/api/v1/namespaces/kube-system/configmaps?labelSelector=OWNER%!D(MISSING)TILLER: dial tcp 10.96.0.1:443: i/o timeout</li>
</ul>
<p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸæœ‰æ˜¯ç½‘ç»œç»„ä»¶ï¼ˆæ¯”å¦‚Calico)çš„IP_POOLå’Œå®¿ä¸»æœºæ‰€åœ¨çš„å±€åŸŸç½‘IPæ®µå†²çªäº†ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Calicoï¼Œå¯ä»¥é€šè¿‡calicoctlä¿®æ”¹Calicoæ’ä»¶çš„IPæ± ã€‚</p>
<p><code>calicoctl</code>å…è®¸æ‚¨ä»å‘½ä»¤è¡Œåˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤Calicoå¯¹è±¡ã€‚å¯ä»¥å‚è€ƒç›¸å…³çš„æ–‡æ¡£ï¼š<a href="https://docs.projectcalico.org/introduction/">https://docs.projectcalico.org/introduction/</a></p>
<p>1-å®‰è£…calicoctlåˆ°kubernetesçš„masterèŠ‚ç‚¹ä¸Š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cd /usr/local/bin
curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.8.2/calicoctl
chmod +x calicoctl
</code></pre></div><p>2-å®‰è£… calicoctl ä¸º Kubernetes pod,è®¾ç½®alias</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"> kubectl apply -f https://docs.projectcalico.org/manifests/calicoctl.yaml
 alias calicoctl<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubectl exec -i -n kube-system calicoctl -- /calicoctl&#34;</span>
</code></pre></div><p>3-å˜æ›´IPæ± </p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŸ¥çœ‹ipæ± </span>
calicoctl get ippool -o wide

NAME                  CIDR             NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   
default-ipv4-ippool   192.168.0.0/16   true   Always     Never       false      all<span style="color:#f92672">()</span>   

<span style="color:#75715e"># æ·»åŠ æ–°çš„ipæ± </span>
calicoctl create -f -<span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">apiVersion: projectcalico.org/v3
</span><span style="color:#e6db74">kind: IPPool
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: b-ipv4-pool
</span><span style="color:#e6db74">spec:
</span><span style="color:#e6db74">  cidr: 172.16.0.0/16
</span><span style="color:#e6db74">  ipipMode: Always
</span><span style="color:#e6db74">  natOutgoing: true
</span><span style="color:#e6db74">EOF</span>;

<span style="color:#75715e"># å†æ¬¡æŸ¥çœ‹ipæ± </span>
calicoctl get ippool -o wide
NAME                  CIDR             NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   
b-ipv4-pool           172.16.0.0/16    true   Always     Never       false      all<span style="color:#f92672">()</span>      
default-ipv4-ippool   192.168.0.0/16   true   Always     Never       false      all<span style="color:#f92672">()</span>

<span style="color:#75715e"># ç¦ç”¨æ—§çš„IPæ± </span>
calicoctl get ippool -o yaml &gt; /data/calico/pools.yaml
vim /data/calico/pools.yaml
apiVersion: projectcalico.org/v3
items:
- apiVersion: projectcalico.org/v3
  kind: IPPool
  metadata:
    creationTimestamp: <span style="color:#e6db74">&#34;2020-07-01T14:32:18Z&#34;</span>
    name: b-ipv4-pool
    resourceVersion: <span style="color:#e6db74">&#34;299739&#34;</span>
    uid: f908d360-3477-4309-a207-f79ac5750b14
  spec:
    blockSize: <span style="color:#ae81ff">26</span>
    cidr: 172.16.0.0/16
    ipipMode: Always
    natOutgoing: true
    nodeSelector: all<span style="color:#f92672">()</span>
    vxlanMode: Never
- apiVersion: projectcalico.org/v3
  kind: IPPool
  metadata:
    creationTimestamp: <span style="color:#e6db74">&#34;2020-06-26T17:14:39Z&#34;</span>
    name: default-ipv4-ippool
    resourceVersion: <span style="color:#e6db74">&#34;3819&#34;</span>
    uid: 84b1ab4d-7236-4ff4-8e83-597a51856c21
  spec:
    blockSize: <span style="color:#ae81ff">26</span>
    cidr: 192.168.0.0/16
    ipipMode: Always
    natOutgoing: true
    disabled: true <span style="color:#75715e"># è®¾ç½®disabled ä¸ºtrue</span>
    nodeSelector: all<span style="color:#f92672">()</span>
    vxlanMode: Never
kind: IPPoolList
metadata:
  resourceVersion: <span style="color:#e6db74">&#34;299994&#34;</span>

<span style="color:#75715e"># æ‰§è¡Œæ“ä½œï¼Œå˜æ›´åº”ç”¨</span>
calicoctl apply -f - &lt; pools.yaml
calicoctl get ippool -o wide
NAME                  CIDR             NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   
b-ipv4-pool           172.16.0.0/16    true   Always     Never       false      all<span style="color:#f92672">()</span>      
default-ipv4-ippool   192.168.0.0/16   true   Always     Never       true       all<span style="color:#f92672">()</span>  

<span style="color:#75715e"># é‡å¯tiller pod/æ‰€æœ‰pod</span>
kubectl -n kube-system delete pods tiller-deploy-6bdbf9884d-qz978
kubectl -n <span style="color:#f92672">[</span>å‘½åç©ºé—´<span style="color:#f92672">]</span> delete pods --all

<span style="color:#75715e"># åˆ é™¤æ—§çš„ipæ± </span>
calicoctl delete pool default-ipv4-ippool
</code></pre></div><ul>
<li>è§£å†³k8s.gcr.ioè¢«å¢™é—®é¢˜</li>
</ul>
<p>ç”±äºå®˜æ–¹é•œåƒåœ°å€è¢«å¢™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¦–å…ˆè·å–æ‰€éœ€é•œåƒä»¥åŠå®ƒä»¬çš„ç‰ˆæœ¬ã€‚ç„¶åä»å›½å†…é•œåƒç«™è·å–ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># è·å–é•œåƒåˆ—è¡¨</span>
kubeadm config images list
</code></pre></div><p>ä»é˜¿é‡Œäº‘è·å–é•œåƒï¼Œé€šè¿‡<strong>docker tag</strong>å‘½ä»¤æ¥ä¿®æ”¹é•œåƒçš„æ ‡ç­¾</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">images<span style="color:#f92672">=(</span>
    kube-apiserver:v1.12.1
    kube-controller-manager:v1.12.1
    kube-scheduler:v1.12.1
    kube-proxy:v1.12.1
    pause:3.1
    etcd:3.2.24
    coredns:1.2.2
<span style="color:#f92672">)</span>

<span style="color:#66d9ef">for</span> imageName in <span style="color:#e6db74">${</span>images[@]<span style="color:#e6db74">}</span> ; <span style="color:#66d9ef">do</span>
    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName
<span style="color:#66d9ef">done</span>
</code></pre></div><ul>
<li>Charté•œåƒç‰ˆæœ¬è¿‡ä½é—®é¢˜</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ helm search kubernetes-dashboard
NAME                       	CHART VERSION	APP VERSION	DESCRIPTION                                   
stable/kubernetes-dashboard	0.6.0        	1.8.3      	General-purpose web UI <span style="color:#66d9ef">for</span> Kubernetes clusters
$ helm repo add stable http://mirror.azure.cn/kubernetes/charts/
<span style="color:#e6db74">&#34;stable&#34;</span> has been added to your repositories
$ helm search kubernetes-dashboard
NAME                       	CHART VERSION	APP VERSION	DESCRIPTION                                                 
stable/kubernetes-dashboard	1.11.1       	1.10.1     	DEPRECATED! - General-purpose web UI <span style="color:#66d9ef">for</span> Kubernetes clusters
</code></pre></div><ul>
<li>kubeadm tokenè¿‡æœŸé—®é¢˜</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ç”Ÿæˆä¸€æ¡æ°¸ä¹…æœ‰æ•ˆçš„token</span>
kubeadm token create --ttl <span style="color:#ae81ff">0</span>
<span style="color:#75715e"># è·å–caè¯ä¹¦sha256ç¼–ç hashå€¼</span>
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span>
<span style="color:#75715e"># nodeèŠ‚ç‚¹åŠ å…¥</span>
kubeadm join 192.168.1.120:6443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>     --discovery-token-ca-cert-hash sha256:4133848ddc81242c50c95b684be0fa049e63362b1af542a49d9c31a65c2b138b
</code></pre></div>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kubeadm">kubeadm</a></li>
        <li><a href="#å‰ç½®å‡†å¤‡">å‰ç½®å‡†å¤‡</a>
          <ul>
            <li><a href="#ç³»ç»Ÿå‡†å¤‡">ç³»ç»Ÿå‡†å¤‡</a></li>
            <li><a href="#kube-proxyå¼€å¯ipvsè®¾ç½®">kube-proxyå¼€å¯ipvsè®¾ç½®</a></li>
            <li><a href="#å®‰è£…å¹¶è®¾ç½®docker">å®‰è£…å¹¶è®¾ç½®docker</a></li>
            <li><a href="#å®‰è£…kubeadmkubectlå’Œkubelet">å®‰è£…kubeadm,kubectlå’Œkubelet</a></li>
          </ul>
        </li>
        <li><a href="#kubeadméƒ¨ç½²kubernetesé›†ç¾¤">kubeadméƒ¨ç½²kubernetesé›†ç¾¤</a>
          <ul>
            <li><a href="#kubeadm-init-é…ç½®kubernetes-masterèŠ‚ç‚¹">kubeadm init é…ç½®kubernetes masterèŠ‚ç‚¹</a></li>
            <li><a href="#kubeadm-join-é…ç½®kubernetes-slaveèŠ‚ç‚¹">kubeadm join é…ç½®kubernetes slaveèŠ‚ç‚¹</a></li>
            <li><a href="#é…ç½®ç½‘ç»œæ’ä»¶">é…ç½®ç½‘ç»œæ’ä»¶</a></li>
            <li><a href="#kube-proxyå¼€å¯ipvs">kube-proxyå¼€å¯ipvs</a></li>
            <li><a href="#kubectl-éƒ¨ç½²nginx">kubectl éƒ¨ç½²Nginx</a></li>
          </ul>
        </li>
        <li><a href="#kuberneteså¸¸ç”¨ç»„ä»¶éƒ¨ç½²">Kuberneteså¸¸ç”¨ç»„ä»¶éƒ¨ç½²</a>
          <ul>
            <li><a href="#helm">Helm</a></li>
            <li><a href="#ä½¿ç”¨helméƒ¨ç½²ingress-nginx">ä½¿ç”¨Helméƒ¨ç½²Ingress-nginx</a></li>
            <li><a href="#ä½¿ç”¨helméƒ¨ç½²kubernetes-dashboard">ä½¿ç”¨Helméƒ¨ç½²kubernetes-dashboard</a></li>
            <li><a href="#ä½¿ç”¨helméƒ¨ç½²metrics-server">ä½¿ç”¨Helméƒ¨ç½²metrics-server</a></li>
          </ul>
        </li>
        <li><a href="#faq">FAQ</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
