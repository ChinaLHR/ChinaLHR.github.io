<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>API认证与授权方案</title>
    <meta name="description" content="keep curious 😼">
    <meta name="keywords" content='blog, chinalhr, lhr, 认证&授权'>

    <meta property="og:url" content="https://chinalhr.github.io/post/api-auth-program/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="API认证与授权方案">
    <meta property="og:description" content="keep curious 😼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="API认证与授权方案">
    <meta name="twitter:description" content="keep curious 😼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/api-auth-program/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/api-auth-program/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/api-auth-program/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
  <script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>API认证与授权方案</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            February 11, 2020
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83">认证&amp;授权</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>Api认证授权方案总结</p>
</blockquote>
<h2 id="关于认证授权与凭证">关于认证，授权与凭证</h2>
<p><img src="https://user-images.githubusercontent.com/19829495/76158479-1fae8e00-6151-11ea-9ab1-ab98f4207862.png" alt="图片"></p>
<ul>
<li>认证（authentication）</li>
</ul>
<p>认证指的是当前用户的身份，当用户登陆过后系统便能追踪到他的身份做出符合相应业务逻辑的操作。</p>
<p>认证技术解决的是我是谁的问题。</p>
<ul>
<li>授权（authorization）</li>
</ul>
<p>授权指的是什么样的身份被允许访问某些资源，在获取到用户身份后继续检查用户的权限。单一的系统授权往往是伴随认证来完成的，但是在开放 API 的多系统结构下，授权可以由不同的系统来完成，例如 OAuth。</p>
<p>授权技术解决的是我能干什么的问题。</p>
<ul>
<li>凭证（credentials）</li>
</ul>
<p>凭证是认证和授权的基础，用来标记访问者的身份或权利，例如服务器为每一个访问者颁发 session ID 存放到 cookie，SSH 登录的密匙、JWT 令牌&hellip;</p>
<h2 id="api开发中常用的认证授权技术">API开发中常用的认证，授权技术</h2>
<h3 id="http-basic-authentication">HTTP Basic Authentication</h3>
<h4 id="流程">流程</h4>
<ol>
<li>用户在浏览器输入用户名和密码</li>
<li>组合用户名和密码然后 Base64 编码</li>
<li>给编码后的字符串添加 Basic 前缀，然后设置名称为 Authorization 的 header 头部</li>
</ol>
<p><img src="https://user-images.githubusercontent.com/19829495/76158487-30f79a80-6151-11ea-96a4-f8d282cc6d67.png" alt="图片"></p>
<p>API 也可以提供 HTTP Basic Authentication 认证方式，那么客户端可以很简单通过 Base64 传输用户名和密码即可。</p>
<h4 id="缺陷">缺陷</h4>
<p>BASE64仅仅是编码而非加密，如果以HTTP明文传输会有泄露风险。</p>
<h3 id="hmacaksk认证">HMAC（AK/SK）认证</h3>
<p>很多开放API平台都会选择基于一个AK/SK的认证方式。这种基于 AK/SK 的认证方式主要是利用散列的消息认证码 (Hash-based MessageAuthentication Code) 来实现的。HMAC是利用带有 key 值的哈希算法生成消息摘要。</p>
<p>基本过程如下：</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158499-479df180-6151-11ea-8990-7f75f26bc0fb.png" alt="图片"></p>
<h4 id="签名生成">签名生成</h4>
<p>基于参数timestamp,AK,请求PATH,请求参数进行key自然排序，然后进行字段与字段值拼接最后再拼接上SK（注意SK不传递），MD5加密生成Sign，将Sign加入请求参数/请求头中发送请求。</p>
<h4 id="鉴权">鉴权</h4>
<p>分解请求参数得出：timestamp,AK,请求PATH,请求参数。</p>
<ol>
<li>
<p>是对timestamp进行临界值判断（例如过滤掉5分钟之前的请求，规避重放攻击）。</p>
</li>
<li>
<p>是对当前请求的PATH进行权限判断，判断用户AK是否有当前PATH的请求权限。</p>
</li>
<li>
<p>是根据AK在服务端（如数据库）获取到用户的SK，对参数timestamp,AK,请求PATH,请求参数进行key自然排序，然后进行字段与字段值拼接最后再拼接上SK，MD5加密生成Sign与传递过来的Sign进行对比鉴权。</p>
</li>
</ol>
<h4 id="质疑应答算法">质疑/应答算法</h4>
<p>基于时间的一次性密码认证并不能严格避免重放攻击，质疑/应答算法需要客户端先请求一次服务器，获得一个 401 未认证的返回，并得到一个随机字符串（nonce）。将 nonce
附加到按照上面说到的方法进行 HMAC 签名，服务器使用预先分配的 nonce 同样进行签名校验，这个 nonce
在服务器只会被使用一次，因此可以提供唯一的摘要。</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158506-54bae080-6151-11ea-9fcf-1173850a18ce.png" alt="图片"></p>
<h3 id="oauth2">OAuth2</h3>
<p>OAuth2 是一个开放授权标准，它允许用户让第三方应用访问该用户在某服务的特定私有资源。</p>
<h4 id="oauth2角色">OAuth2角色</h4>
<ul>
<li><strong>Resource Owner</strong>：资源拥有者(如图片资源的所有者)</li>
<li><strong>Resource Server</strong>：资源服务器(如存储图片资源的服务器)</li>
<li><strong>Client</strong>: 任何可以消费资源服务器的第三方应用</li>
<li><strong>Authorization Server</strong> ：授权服务器，管理Resource Owner，Client和Resource Server的三角关系的中间层。</li>
</ul>
<h4 id="oauth2的部署与授权流程">OAuth2的部署与授权流程</h4>
<ol>
<li>增加一个Authorization server，提供授权的实现，一般由Resource server 来提供。</li>
<li>Resource server 为第三方应用程序提供注册接口。</li>
<li>Resource server 开放相应的受保护资源的API。</li>
<li>Client 注册成为Resource server的第三方应用。</li>
<li>Client 消费这些API。</li>
</ol>
<p>在一般情况下，Resource server提供Authorization server服务，提供授权接口与获取访问令牌接口。</p>
<p><img src="https://user-images.githubusercontent.com/19829495/76158510-64d2c000-6151-11ea-9d57-429acf9a8a14.png" alt="图片"></p>
<p>流程：</p>
<ul>
<li>（A）<strong>用户</strong>访问<strong>第三方网站</strong>，<strong>第三方网站</strong>向<strong>资源服务器</strong>发起授权请求；</li>
<li>（B）<strong>资源服务器</strong>接受<strong>第三方网站</strong>的授权请求，并返回<em>授权许可</em>给<strong>PP</strong>；</li>
<li>（C）<strong>第三方网站</strong>使用<em>授权许可</em>向<strong>Authorization server</strong>发起请求**；**</li>
<li>（D）<strong>Authorization server</strong>验证<strong>第三方网站</strong>的身份和<em>授权许可</em>，发送<em>访问令牌</em>给<strong>第三方网站</strong>；</li>
<li>（E）<strong>第三方网站</strong>用<em>访问令牌</em>请求<strong>用户</strong>存储在<strong>资源服务器</strong>的资源；</li>
<li>（F）<strong>资源服务器</strong>根据<em>访问令牌</em>，返回<strong>用户</strong>的信息给<strong>第三方网站</strong>。</li>
</ul>
<h4 id="四种授权许可方式authorization-grant">四种授权许可方式（<strong>Authorization Grant</strong>）</h4>
<p>授权许可方式对应上述的A,D,C,D阶段，授权许可是一个代表资源所有者授权（访问受保护资源）的凭据，客户端用它来获取访问令牌。授权许可是用户授予第三方获得资源服务器访问令牌的一个凭据。</p>
<ol>
<li>Authorization Code：授权码；</li>
<li>Implicit：隐式许可；</li>
<li>Resource Owner Password Credentials：资源所有者密码凭据；</li>
<li>Client Credentials ：客户端凭据。</li>
</ol>
<h4 id="authorization-code">Authorization Code</h4>
<p><img src="https://user-images.githubusercontent.com/19829495/76158549-e4f92580-6151-11ea-9d02-5e188b39c04d.png" alt="图片"></p>
<ul>
<li>（A）<strong>Client</strong>使用浏览器（用户代理）访问<strong>Authorization server。<strong>也就是用浏览器访问一个URL，这个URL是</strong>Authorization server</strong>提供的，访问的时候Client需要提供（客户端标识，请求范围，本地状态和重定向URL）这些参数。</li>
<li>（B）<strong>Authorization server</strong>验证<strong>Client</strong>在（A）中传递的参数信息，如果无误则提供一个页面供<strong>Resource owner</strong>登陆，登陆成功后选择<strong>Client</strong>可以访问<strong>Resource server</strong>的哪些资源以及读写权限。</li>
<li>（C）在（B）无误后返回一个<strong>授权码（Authorization Code）<strong>给Client</strong>。</strong></li>
<li>（D）<strong>Client</strong>拿着（C）中获得的<strong>授权码（Authorization Code）<strong>和（客户端标识、重定向URL等信息）作为参数，请求</strong>Authorization server</strong>提供的获取访问令牌的URL**。**</li>
<li>（E）<strong>Authorization server</strong>返回<strong>访问令牌</strong>和可选的<strong>刷新令牌</strong>以及<strong>令牌有效时间</strong>等信息给<strong>Client</strong>。</li>
</ul>
<h4 id="implicit">Implicit</h4>
<p>是Authorization Code的简化版本。其中省略掉了颁发授权码（Authorization Code）给客户端的过程，而是直接返回访问令牌和可选的刷新令牌。</p>
<p><img src="https://user-images.githubusercontent.com/19829495/74159778-47e0c500-4c57-11ea-8d10-c49b0e774cb5.png" alt="图片"></p>
<h4 id="resource-owner-password-credentials">Resource Owner Password Credentials</h4>
<p>和Authorzation Code类型下重要的区分就是省略了Authorization Request和Authorization
Response。而是Client直接使用Resource
owner提供的username和password来直接请求access_token（直接发起Access Token
Request然后返回Access Token Response信息）。</p>
<p><img src="https://user-images.githubusercontent.com/19829495/74160981-37c9e500-4c59-11ea-98c4-58db53fe8387.png" alt="图片"></p>
<h4 id="client-credentials">Client Credentials</h4>
<p>Client直接已自己的名义而不是Resource owner的名义去要求访问Resource server的一些受保护资源。</p>
<h4 id="oauth2参考">OAuth2参考</h4>
<p><a href="https://www.yuque.com/lihanrong/za12dz/mvf82u">https://www.yuque.com/lihanrong/za12dz/mvf82u</a></p>
<h3 id="jwt">JWT</h3>
<h4 id="json-web-token">JSON Web Token</h4>
<p>JSON Web Token是一套开放的标准（<a href="https://link.zhihu.com/?target=https%3A//tools.ietf.org/html/rfc7519">RFC 7519</a>），它定义了一套简洁（compact）且 URL 安全（URL-safe）的方案，以安全地在客户端和服务器之间传输 JSON 格式的信息。</p>
<p>无状态原则：用户登录之后，服务器会返回一串 token 并保存在本地，在这之后的服务器访问都要带上这串 token，来获得访问相关路由、服务及资源的权限。比如单点登录就比较多地使用了 JWT，因为它的体积小，并且经过简单处理（使用 HTTP 头带上 Bearer 属性 + token ）就可以支持跨域操作。</p>
<h4 id="jwt工作流程">JWT工作流程</h4>
<p><img src="https://user-images.githubusercontent.com/19829495/74165543-3b149f00-4c60-11ea-9b8d-d3e41a1e0b6e.png" alt="图片"></p>
<ul>
<li>首先，某 client 使用自己的账号密码发送 post 请求 login，由于这是首次接触，服务器会校验账号与密码是否合法</li>
<li>如果一致，则根据密钥生成一个 token 并返回</li>
<li>client 收到这个 token 并保存在本地。在这之后，需要访问一个受保护的路由或资源时，只要附加上 token（通常使用 Header 的 Authorization 属性）发送到服务器</li>
<li>服务器就会检查这个 token 是否有效，并做出响应。</li>
</ul>
<h4 id="jwt组成">JWT组成</h4>
<pre><code>// Header
{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}

// Payload
{
  // reserved claims
  &quot;iss&quot;: &quot;a.com&quot;,
  &quot;exp&quot;: &quot;1d&quot;,
  // public claims
  &quot;http://a.com&quot;: true,
  // private claims
  &quot;company&quot;: &quot;A&quot;,
  &quot;awesome&quot;: true
}

// $Signature
HS256(Base64(Header) + &quot;.&quot; + Base64(Payload), secretKey)

// JWT
JWT = Base64(Header) + &quot;.&quot; + Base64(Payload) + &quot;.&quot; + $Signature
</code></pre><p>三部分组成：</p>
<ol>
<li>
<p>经过 Base64 编码的 Header。Header 是一个 JSON 对象，对象里有一个值为 “JWT” 的 typ 属性，以及 alg 属性，值为 HS256，表明最终使用的加密算法是 HS256。</p>
</li>
<li>
<p>经过 Base64 编码的 Payload。Payload 被定义为实体的状态，就像 token 自身附加元数据一样，claim 包含我们想要传输的信息，以及用于服务器验证的信息，一般有 reserved/public/private 三类。</p>
</li>
<li>
<p>$Signature。它由 Header 指定的算法 HS256 加密产生。该算法有两个参数，第一个参数是经过 Base64 分别编码的 Header 及 Payload 通过 . 连接组成的字符串，第二个参数是生成的密钥，由服务器保存。</p>
</li>
</ol>
<p>JWT 仅仅是对 payload 做了简单的 sign 和 encode 处理，并未被加密，并不能保证数据的安全性。</p>
<h4 id="服务端验证">服务端验证</h4>
<p>服务端接收到 token 之后，会逆向构造过程，decode 出 JWT 的三个部分，这一步可以得到 sign 的算法及 payload，结合服务端配置的 secretKey，可以再次进行 $Signature 的生成得到新的 $Signature，与原有的 $Signature 比对以验证 token 是否有效，完成用户身份的认证，验证通过才会使用 payload 的数据。</p>
<p><strong>服务端最终只是为了验证 $Signature 是否仍是自己当时下发给 client 的那个，如果验证通过，则说明该 JWT 有效并且来自可靠来源，否则说明可能是对应用程序的潜在攻击，以此完成认证。</strong></p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#关于认证授权与凭证">关于认证，授权与凭证</a></li>
        <li><a href="#api开发中常用的认证授权技术">API开发中常用的认证，授权技术</a>
          <ul>
            <li><a href="#http-basic-authentication">HTTP Basic Authentication</a>
              <ul>
                <li><a href="#流程">流程</a></li>
                <li><a href="#缺陷">缺陷</a></li>
              </ul>
            </li>
            <li><a href="#hmacaksk认证">HMAC（AK/SK）认证</a>
              <ul>
                <li><a href="#签名生成">签名生成</a></li>
                <li><a href="#鉴权">鉴权</a></li>
                <li><a href="#质疑应答算法">质疑/应答算法</a></li>
              </ul>
            </li>
            <li><a href="#oauth2">OAuth2</a>
              <ul>
                <li><a href="#oauth2角色">OAuth2角色</a></li>
                <li><a href="#oauth2的部署与授权流程">OAuth2的部署与授权流程</a></li>
                <li><a href="#四种授权许可方式authorization-grant">四种授权许可方式（<strong>Authorization Grant</strong>）</a></li>
                <li><a href="#authorization-code">Authorization Code</a></li>
                <li><a href="#implicit">Implicit</a></li>
                <li><a href="#resource-owner-password-credentials">Resource Owner Password Credentials</a></li>
                <li><a href="#client-credentials">Client Credentials</a></li>
                <li><a href="#oauth2参考">OAuth2参考</a></li>
              </ul>
            </li>
            <li><a href="#jwt">JWT</a>
              <ul>
                <li><a href="#json-web-token">JSON Web Token</a></li>
                <li><a href="#jwt工作流程">JWT工作流程</a></li>
                <li><a href="#jwt组成">JWT组成</a></li>
                <li><a href="#服务端验证">服务端验证</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
