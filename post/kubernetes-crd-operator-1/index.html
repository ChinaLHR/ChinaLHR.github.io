<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸Š)</title>
    <meta name="description" content="keep curious ğŸ˜¼">
    <meta name="keywords" content='blog, chinalhr, lhr, kubernetes'>

    <meta property="og:url" content="https://chinalhr.github.io/post/kubernetes-crd-operator-1/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸Š)">
    <meta property="og:description" content="keep curious ğŸ˜¼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸Š)">
    <meta name="twitter:description" content="keep curious ğŸ˜¼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/post/kubernetes-crd-operator-1/">
    <meta property="twitter:url" content="https://chinalhr.github.io/post/kubernetes-crd-operator-1/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/post/kubernetes-crd-operator-1/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/" aria-label="Jump to a specific link"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/" aria-label="Jump to a specific link"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/" aria-label="Jump to a specific link"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/" aria-label="Jump to a specific link"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/" aria-label="Jump to a specific link"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr" aria-label="Jump to a specific link"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml" aria-label="Jump to a specific link"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Kubernetes-Operatorï¼šæ‰©å±•Kubernetes API Resourceä¸Custom Controller (ä¸Š)</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            January 22, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://chinalhr.github.io/tags/kubernetes">kubernetes</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•å¯¹Kubernetes æ ¸å¿ƒç»„ä»¶ã€æ‰©å±•æœºåˆ¶ä¸API Resourceè®¾è®¡æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®šåˆ¶èµ„æºï¼ˆCustom Resourceï¼‰ä¸å®šåˆ¶æ§åˆ¶å™¨ï¼ˆCustom Controllerï¼‰å®ç°å¯¹Kubernetes API Resourceçš„æ‰©å±•</p>
</blockquote>
<h2 id="kubernetesæ¶æ„è®¾è®¡">Kubernetesæ¶æ„è®¾è®¡</h2>
<h3 id="kubernetesæ ¸å¿ƒç»„ä»¶">Kubernetesæ ¸å¿ƒç»„ä»¶</h3>
<p>Kubernetesç³»ç»Ÿæ¶æ„æ•´ä½“é‡‡ç”¨çš„æ˜¯C/S çš„æ¶æ„ï¼Œå…¶ä¸­MasterèŠ‚ç‚¹ä½œä¸º Serverï¼Œå„Worker èŠ‚ç‚¹ä½œä¸º Clientã€‚</p>
<ul>
<li><strong>Master Nodeï¼š</strong>
<ul>
<li>kube-apiserverï¼šæä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæä¾›REST APIæ¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€API æ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼›å¸¸è§çš„ä¸kube-apiserverè¿›è¡Œäº¤äº’å¯ä»¥é€šè¿‡kubectl ã€client-go</li>
<li>kube-schedulerï¼šè´Ÿè´£kuberneteså†…èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„Nodeä¸Š</li>
<li>kube-controller-managerï¼šæ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œæä¾›äº†ä¸€äº›å†…ç½®çš„Controllerï¼Œè‡ªåŠ¨åŒ–åœ°ç®¡ç†é›†ç¾¤çŠ¶æ€ï¼ŒåŒ…æ‹¬äº†èµ„æºçŠ¶æ€ï¼ŒèŠ‚ç‚¹çŠ¶æ€ç­‰ï¼›æ ¸å¿ƒåŠŸèƒ½æ˜¯ç¡®ä¿é›†ç¾¤å§‹ç»ˆå¤„äºé¢„æœŸçŠ¶æ€ï¼Œæ§åˆ¶Kubernetesä¸­çš„èµ„æºå®ƒä»¬å‘ <code>spec</code> é…ç½®çš„æœŸæœ›çŠ¶æ€è¿›è¡Œæ”¶æ•›</li>
<li>etcdï¼šæŒä¹…åŒ–é›†ç¾¤çŠ¶æ€ã€å…ƒæ•°æ®ã€é›†ç¾¤èµ„æºå¯¹è±¡</li>
<li>kube-proxyï¼šè´Ÿè´£ Kubernetes ä¸­ Service çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½å®ç°</li>
</ul>
</li>
<li><strong>Worker Nodeï¼š</strong>
<ul>
<li>kubeletï¼šè´Ÿè´£ç®¡ç†Worker Nodeä¸ŠPodèµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œkubeletç›¸å½“äºä¸€ä¸ªä»£ç†æ‰§è¡Œå™¨ï¼Œæ¥æ”¶åˆ°kube-apiserverçš„è¯·æ±‚åæ‰§è¡ŒPodçš„ç®¡ç†é€»è¾‘ï¼Œå®šæœŸç›‘æ§èµ„æºçš„ä½¿ç”¨çŠ¶æ€ä¸ŠæŠ¥kube-apiserverï¼Œä»¥åŠå¦‚ä¸‹æ¥å£çš„ç®¡ç†
<ul>
<li>CRIï¼ˆContainer Runtime Interfaceï¼‰ï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼Œæä¾›è®¡ç®—èµ„æº</li>
<li>CNIï¼ˆContainer Network Interfaceï¼‰ï¼šå®¹å™¨ç½‘ç»œæ¥å£ï¼Œæä¾›ç½‘ç»œèµ„æº</li>
<li>CSIï¼ˆContainer Storage Interfaceï¼‰ï¼šå®¹å™¨å­˜å‚¨æ¥å£ï¼Œæä¾›å­˜å‚¨èµ„æº</li>
</ul>
</li>
<li>Container Runtimeï¼š è´Ÿè´£é•œåƒç®¡ç†åŠ Pod å’Œå®¹å™¨è¿è¡Œæ—¶æ¥å£å®ç°ï¼ˆCRIï¼‰</li>
</ul>
</li>
</ul>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/fc0b1944ca13bc7439d3a2b6fc4f0d19_MD5.png">
    <img src="/attachment/fc0b1944ca13bc7439d3a2b6fc4f0d19_MD5.png" alt="image"  />
    </a>
</div></p>
<h3 id="kubernetesæ‰©å±•æ€§">Kubernetesæ‰©å±•æ€§</h3>
<blockquote>
<p>å‚è€ƒï¼š<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/</a></p>
</blockquote>
<p>Kubernetesçš„æ¶æ„è®¾è®¡æ˜¯é«˜åº¦å¯é…ç½®ã€å¯æ‰©å±•çš„ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨Kubernetesè‡ªèº«çš„æ‰©å±•æ€§ï¼Œå³æ‰©å…… Kubernetes çš„èƒ½åŠ›å¹¶æ·±åº¦é›†æˆè½¯ä»¶ç»„ä»¶ã€‚</p>
<p><strong>æ‰©å±•æ¨¡å¼ï¼š</strong></p>
<ul>
<li>æ§åˆ¶å™¨æ¨¡å¼ï¼šç¼–å†™Kubernetes çš„å®¢æˆ·ç«¯ç¨‹åºçš„ä¸€ç§ç‰¹å®šæ¨¡å¼ï¼Œæ§åˆ¶å™¨é€šå¸¸è¯»å–ä¸€ä¸ªå¯¹è±¡çš„ <code>spec</code> å­—æ®µï¼Œåšå‡ºå¯¹åº”çš„å¤„ç†ï¼Œç„¶åæ›´æ–°å¯¹è±¡çš„ <code>status</code> å­—æ®µã€‚</li>
<li>Webhookæ¨¡å¼ï¼šKubernetesä½œä¸ºå®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æ¨¡å¼ã€‚</li>
<li>Binary Pluginæ¨¡å¼ï¼šKubernetesä½œä¸ºå®¢æˆ·ç«¯æ‰§è¡Œä¸€ä¸ªäºŒè¿›åˆ¶æ’ä»¶ç¨‹åºã€‚</li>
</ul>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/592abc8adaea2e3749c05eb15213b507_MD5.jpg">
    <img src="/attachment/592abc8adaea2e3749c05eb15213b507_MD5.jpg" alt="image"  />
    </a>
</div></p>
<p><strong>æ‰©å±•kubernetesçš„æ ¸å¿ƒç»„ä»¶ï¼š</strong></p>
<ul>
<li>kube-controller-managerä¸API Resourceæ‰©å±•ï¼šé€šè¿‡ä½¿ç”¨crdä¸custom controllerã€operator frameworkå®ç°ï¼Œæœ¬æ–‡ä¸»è¦è®²è§£è¿™æ–¹é¢çš„æ‰©å±•å®ç°ã€‚</li>
<li>kube-apiserveræ‰©å±•ï¼šé€šè¿‡ä½¿ç”¨API Aggregation layeråœ¨ä¸ä¿®æ”¹ Kubernetes æ ¸å¿ƒä»£ç çš„åŒæ—¶æ‰©å±• Kubernetes api-serverï¼Œå³å°†ç¬¬ä¸‰æ–¹æœåŠ¡æ³¨å†ŒæˆKubernetes api-serveræä¾›æœåŠ¡ã€‚</li>
<li>kube-scheduleræ‰©å±•ï¼šé€šè¿‡Kubernetes Scheduling Frameworkæ‰©å±•Kubernetesè°ƒåº¦æœºåˆ¶ã€‚</li>
</ul>
<h2 id="æ‰©å±•kubernetes-api-resourceç›¸å…³æ¦‚å¿µ">æ‰©å±•Kubernetes API Resourceç›¸å…³æ¦‚å¿µ</h2>
<p><strong>èµ„æºï¼ˆResourceï¼‰ï¼š</strong> Resourceæ˜¯ Kubernetes APIä¸­çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œç”¨äºå­˜å‚¨æŸä¸ªç±»åˆ«çš„APIå¯¹è±¡çš„ä¸€ä¸ªé›†åˆï¼›å¦‚YAMLä¸­çš„kindï¼šPodã€CronJob&hellip;</p>
<p><strong>å®šåˆ¶èµ„æºï¼ˆCustom Resourceï¼‰ï¼š</strong> è‡ªå®šä¹‰ API èµ„æºï¼ŒCustom Resourceæ˜¯å¯¹ Kubernetes API çš„æ‰©å±•ï¼Œå®šåˆ¶èµ„æºæ‰€ä»£è¡¨çš„æ˜¯å¯¹ç‰¹å®šKubernetes APIçš„ä¸€ç§å®šåˆ¶ã€‚</p>
<p><strong>å®šåˆ¶æ§åˆ¶å™¨ï¼ˆCustom Controllerï¼‰ï¼š</strong> Custom Resourceæœ¬èº«åªèƒ½ç”¨æ¥å­˜å–ç»“æ„åŒ–çš„æ•°æ®ï¼Œéœ€è¦å°†Custom Resourceä¸Custom Controllerç»“åˆï¼ŒCustom Controllerè´Ÿè´£ç›‘æ§Custom Resourceçš„å˜åŒ–ï¼ˆåˆ›å»ºã€åˆ é™¤&hellip;ï¼‰å¹¶æ‰§è¡Œå…·ä½“çš„åŠ¨ä½œã€‚</p>
<p><strong>CRDï¼ˆCustomResourceDefinitionsï¼‰ï¼š</strong> Custom Resourceçš„å®šä¹‰ï¼ŒKubernetes CustomResourceDefinition APIèµ„æºå…è®¸è‡ªå®šä¹‰Custom Resourceã€‚ å®šä¹‰CRDå¯¹è±¡çš„æ“ä½œä¼šä½¿ç”¨ä½ æ‰€è®¾å®šçš„åå­—å’Œæ¨¡å¼å®šä¹‰ï¼ˆSchemaï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„Custom Resourceï¼ŒKubernetes API ä¼šä¸ºCustom Resourceæä¾›å­˜å‚¨å’Œè®¿é—®æœåŠ¡ã€‚</p>
<p>ç®€å•çš„è¯´ï¼Œå¯ä»¥é€šè¿‡CRDå®šåˆ¶è‡ªå®šä¹‰APIèµ„æºå³Custom Resourceï¼ŒåŠ¨æ€æ³¨å†Œåˆ°Kubernetesé›†ç¾¤ä¸­ï¼›æ³¨å†Œå®Œæˆåç”¨æˆ·å¯ä»¥é€šè¿‡ kubectl æ¥åˆ›å»ºè®¿é—®è‡ªå®šä¹‰APIèµ„æºå¯¹è±¡ï¼Œç±»ä¼¼äºæ“ä½œ Pod ä¸€æ ·ã€‚CRD ä»…ä»…åªæ˜¯åšèµ„æºçš„å®šä¹‰ï¼Œéœ€è¦é…åˆæ§åˆ¶å™¨å³Custom Controller å»ç›‘å¬Custom Resourceçš„äº‹ä»¶è§¦å‘æ‰§è¡Œå¯¹åº”çš„å¤„ç†é€»è¾‘ã€‚</p>
<h2 id="kubernetes-çš„-resource-è®¾è®¡æ¦‚å¿µ">Kubernetes çš„ Resource è®¾è®¡æ¦‚å¿µ</h2>
<blockquote>
<p>é€šè¿‡ä¸Šæ–‡çš„ä»‹ç»ä¸éš¾çœ‹å‡ºï¼ŒKubernetesæ˜¯ä¸€ä¸ªä»¥èµ„æºä¸ºä¸­å¿ƒå®¹å™¨ç¼–æ’å¹³å°ï¼Œæ ¸å¿ƒç»„ä»¶kube-api-serveré€šè¿‡REST APIæš´æ¼èµ„æºæ“ä½œæ¥å£ã€kube-controller-manageræ§åˆ¶ç®¡ç†èµ„æºçš„çŠ¶æ€ã€kube-schedulerè¿›è¡Œèµ„æºçš„è°ƒåº¦ã€‚</p>
</blockquote>
<h3 id="groupversionresource">Group/Version/Resource</h3>
<p>kubernetesåœ¨èµ„æºçš„æ¦‚å¿µä¸Šè¿›è¡Œäº†åˆ†ç»„ä¸ç‰ˆæœ¬åŒ–ï¼Œï¼Œä¸€ä¸ª APIå¯¹è±¡åœ¨Etcd é‡Œçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œæ˜¯ç”±ï¼šGroupï¼ˆAPI ç»„ï¼‰ã€Versionï¼ˆAPI ç‰ˆæœ¬ï¼‰å’Œ Resourceï¼ˆAPI èµ„æºç±»å‹ï¼‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/cfbe1025f246e277b4f4aeb4fab3d83c_MD5.jpg">
    <img src="/attachment/cfbe1025f246e277b4f4aeb4fab3d83c_MD5.jpg" alt="image"  />
    </a>
</div></p>
<p><strong>èµ„æºé—´çš„å…³ç³»å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>Kubernetesæ”¯æŒå¤šä¸ª Groupï¼ˆèµ„æºç»„ï¼‰</li>
<li>æ¯ä¸ªGroupæ”¯æŒå¤šä¸ªVersionï¼ˆèµ„æºç‰ˆæœ¬ï¼‰</li>
<li>æ¯ä¸ªVersionæ”¯æŒå¤šç§Resourceï¼ˆèµ„æºï¼‰ï¼Œéƒ¨åˆ†èµ„æºè¿˜æ‹¥æœ‰è‡ªå·±çš„å­èµ„æº</li>
<li>Kind ä¸ Resource å±äºåŒä¸€çº§æ¦‚å¿µï¼ŒKind ç”¨äºæè¿° Resource çš„ç§ç±»ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Kindä¸Resourceæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œä¾‹å¦‚<code>pods</code> Resource å¯¹åº”äº <code>Pod</code> Kind</li>
</ul>
<p><strong>å®šä½èµ„æºçš„å½¢å¼å¦‚ä¸‹ï¼š</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;GROUP&gt;/&lt;VERSION&gt;/&lt;RESOURCE&gt;<span style="color:#f92672">[</span>/&lt;SUBSOURCE&gt;<span style="color:#f92672">]</span>

<span style="color:#75715e"># ä»¥Deploymentä¸ºä¾‹å­</span>
apps/v1/deployments/status
</code></pre></div><p><strong>èµ„æºå¯¹è±¡ï¼ˆèµ„æºæè¿°ï¼‰å³Resource Objectæè¿°å¦‚ä¸‹ï¼š</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;GROUP&gt;/&lt;VERSION&gt;, Kind<span style="color:#f92672">=</span>&lt;RESOURCE_NAME&gt;

<span style="color:#75715e"># ä»¥Deploymentä¸ºä¾‹å­</span>
apps/v1, Kind<span style="color:#f92672">=</span>Deployment
</code></pre></div><h3 id="group">Group</h3>
<ul>
<li>èµ„æºç»„çš„åˆ’åˆ†ä¾æ®æ˜¯èµ„æºçš„åŠŸèƒ½ï¼ŒKubernetesæ”¯æŒä¸åŒèµ„æºç»„ä¸­æ‹¥æœ‰ä¸åŒèµ„æºç‰ˆæœ¬ï¼Œæ–¹ä¾¿ç»„å†…èµ„æºè¿­ä»£å‡çº§</li>
<li>å¯¹äº Kubernetes é‡Œçš„æ ¸å¿ƒ API å¯¹è±¡ï¼ˆå¦‚ï¼šPod&hellip;ï¼‰æ˜¯æ— ç»„åGroupï¼ˆå³ï¼šGroup æ˜¯â€œâ€ï¼‰,åœ¨ /api è¿™ä¸ªå±‚çº§ä¸‹ï¼›å¯¹äºKubernetesé‡Œçš„éæ ¸å¿ƒ API å¯¹è±¡ï¼ˆå¦‚ï¼šCronJob&hellip;ï¼‰æ˜¯æœ‰ç»„åGroupï¼Œåœ¨ /apis è¿™ä¸ªå±‚çº§ä¸‹</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-BASH" data-lang="BASH">æœ‰ç»„å Group èµ„æº: .../apis/&lt;GROUP&gt;/&lt;VERSION&gt;/&lt;RESOURCE&gt;
æ— ç»„å Group èµ„æº: .../api/&lt;VERSION&gt;/&lt;RESOURCE&gt;
</code></pre></div><h3 id="version">Version</h3>
<p>Kubernetes çš„èµ„æºç‰ˆæœ¬ Version é‡‡ç”¨è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·</p>
<ul>
<li>Alpha é˜¶æ®µï¼šå†…éƒ¨æµ‹è¯•ç‰ˆæœ¬ï¼ŒAlpha ç‰ˆæœ¬ä¸­çš„åŠŸèƒ½é»˜è®¤æƒ…å†µä¸‹ä¼šè¢«ç¦ç”¨ï¼Œå¸¸è§å‘½åæ–¹å¼å¦‚ v1alpha1ã€‚</li>
<li>Beta é˜¶æ®µï¼šç›¸å¯¹ç¨³å®šç‰ˆæœ¬ï¼Œç»è¿‡äº†å®˜æ–¹å’Œç¤¾åŒºçš„æµ‹è¯•ï¼ŒBeta é˜¶æ®µä¸‹çš„åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¸¸è§å‘½åæ–¹å¼å¦‚ v2beta1ã€‚</li>
<li>Stable é˜¶æ®µï¼šæ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼Œå‘½åæ–¹å¼å¦‚ v1ã€v2 ã€‚</li>
</ul>
<h3 id="resouce">Resouce</h3>
<p>Resource æ˜¯ Kubernetes ä¸­çš„æ ¸å¿ƒæ¦‚å¿µ</p>
<ul>
<li>Resource å®ä¾‹åŒ–åç§°ä¸ºä¸€ä¸ª Resource Objectã€‚</li>
<li>Kubernetes ä¸­æ‰€æœ‰çš„ Resource Object éƒ½ç§°ä¸º Entityã€‚</li>
<li>å¯ä»¥é€šè¿‡ Kubenetes API Server å»æ“ä½œ Resource Objectã€‚</li>
</ul>
<p>Kubernetes ç›®å‰çš„ Entity åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>Persistent Entityï¼šæŒä¹…åŒ–å®ä½“ï¼ŒResource Object åˆ›å»ºåä¼šæŒä¹…å­˜åœ¨ï¼Œå¦‚ Deployment / Serviceã€‚</li>
<li>Ephemeral Entity: çŸ­æš‚å®ä½“ï¼ŒResource Object åˆ›å»ºåä¸ç¨³å®šï¼Œå¦‚å‡ºç°æ•…éšœ/è°ƒåº¦å¤±è´¥åä¸å†é‡å»ºï¼Œå¦‚Podã€‚</li>
</ul>
<h3 id="èµ„æºæ“ä½œæ–¹æ³•">èµ„æºæ“ä½œæ–¹æ³•</h3>
<p>Kubernetesèµ„æºYAMLæ–‡ä»¶æäº¤ç»™kube-apiserveråï¼Œä¼šè¢«è½¬æ¢ä¸ºResouce Objectï¼Œåºåˆ—åŒ–åæŒä¹…åŒ–åˆ°Etcdä¸­ï¼›å¯¹èµ„æºçš„æ“ä½œæ–¹æ³•ä¸»è¦æœ‰å¦‚ä¸‹8ç§ï¼š</p>
<ul>
<li>createï¼šResource Object åˆ›å»º</li>
<li>deleteï¼šResource Object åˆ é™¤</li>
<li>deletecollectionï¼šå¤šä¸ª Resource Objects åˆ é™¤</li>
<li>patchï¼šResource Object å±€éƒ¨å­—æ®µæ›´æ–°</li>
<li>updateï¼šResource Object æ•´ä½“æ›´æ–°</li>
<li>getï¼šResource Object è·å–</li>
<li>listï¼šå¤šä¸ª Resource Objects è·å–</li>
<li>watchï¼šResource Objects ç›‘æ§</li>
</ul>
<h2 id="å¦‚ä½•åˆ›å»ºcrd">å¦‚ä½•åˆ›å»ºCRD</h2>
<blockquote>
<p>å‚è€ƒæ–‡æ¡£ï¼š</p>
<p><a href="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">https://kubernetes.io/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/</a></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apiextensions.k8s.io/v1
<span style="color:#66d9ef">kind</span>: CustomResourceDefinition
metadata:
  <span style="color:#75715e"># åå­—å¿…éœ€ä¸ä¸‹é¢çš„ spec å­—æ®µåŒ¹é…ï¼Œå¹¶ä¸”æ ¼å¼ä¸º &#39;&lt;åç§°çš„å¤æ•°å½¢å¼&gt;.&lt;ç»„å&gt;&#39;</span>
  <span style="color:#66d9ef">name</span>: crontabs.stable.example.com
spec:
  <span style="color:#75715e"># ç»„åç§°ï¼Œç”¨äº REST API: /apis/&lt;ç»„&gt;/&lt;ç‰ˆæœ¬&gt;</span>
  <span style="color:#66d9ef">group</span>: stable.example.com
  <span style="color:#75715e"># åˆ—ä¸¾æ­¤ CustomResourceDefinition æ‰€æ”¯æŒçš„ç‰ˆæœ¬</span>
  versions:
    - <span style="color:#66d9ef">name</span>: v1
      <span style="color:#75715e"># æ¯ä¸ªç‰ˆæœ¬éƒ½å¯ä»¥é€šè¿‡ served æ ‡å¿—æ¥ç‹¬ç«‹å¯ç”¨æˆ–ç¦æ­¢</span>
      <span style="color:#66d9ef">served</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#75715e"># å…¶ä¸­ä¸€ä¸ªä¸”åªæœ‰ä¸€ä¸ªç‰ˆæœ¬å¿…éœ€è¢«æ ‡è®°ä¸ºå­˜å‚¨ç‰ˆæœ¬</span>
      <span style="color:#66d9ef">storage</span>: <span style="color:#66d9ef">true</span>
      schema:
        openAPIV3Schema:
          <span style="color:#66d9ef">type</span>: object
          properties:
            spec:
              <span style="color:#66d9ef">type</span>: object
              properties:
                cronSpec:
                  <span style="color:#66d9ef">type</span>: string
                image:
                  <span style="color:#66d9ef">type</span>: string
                replicas:
                  <span style="color:#66d9ef">type</span>: integer
  <span style="color:#75715e"># å¯ä»¥æ˜¯ Namespaced æˆ– Cluster</span>
  <span style="color:#66d9ef">scope</span>: Namespaced
  names:
    <span style="color:#75715e"># åç§°çš„å¤æ•°å½¢å¼ï¼Œç”¨äº URLï¼š/apis/&lt;ç»„&gt;/&lt;ç‰ˆæœ¬&gt;/&lt;åç§°çš„å¤æ•°å½¢å¼&gt;</span>
    <span style="color:#66d9ef">plural</span>: crontabs
    <span style="color:#75715e"># åç§°çš„å•æ•°å½¢å¼ï¼Œä½œä¸ºå‘½ä»¤è¡Œä½¿ç”¨æ—¶å’Œæ˜¾ç¤ºæ—¶çš„åˆ«å</span>
    <span style="color:#66d9ef">singular</span>: crontab
    <span style="color:#75715e"># kind é€šå¸¸æ˜¯å•æ•°å½¢å¼çš„å¸•æ–¯å¡ç¼–ç ï¼ˆPascalCasedï¼‰å½¢å¼ã€‚ä½ çš„èµ„æºæ¸…å•ä¼šä½¿ç”¨è¿™ä¸€å½¢å¼ã€‚</span>
    <span style="color:#66d9ef">kind</span>: CronTab
    <span style="color:#75715e"># shortNames å…è®¸ä½ åœ¨å‘½ä»¤è¡Œä½¿ç”¨è¾ƒçŸ­çš„å­—ç¬¦ä¸²æ¥åŒ¹é…èµ„æº</span>
    shortNames:
    - ct
</code></pre></div><p>å¦‚ä¸ŠCRDæ‰€ç¤ºï¼Œ æŒ‡å®šgroupä¸º<code>stable.example.com</code>ï¼Œversionä¸º<code>v1</code>ï¼ŒCustomResourceä¸ºCronTabï¼Œscopeä¸ºNamespacedï¼ˆCronTabå±äºNamespaceçš„å¯¹è±¡ï¼‰,ç„¶åéœ€è¦è®¾ç½®CustomResourceçš„å¯¹è±¡æè¿°ï¼ŒåŒ…æ‹¬ï¼šSpecã€Status &hellip;;</p>
<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºCRDåï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ namespace çº§åˆ«çš„ RESTful API å°±ä¼šè¢«åˆ›å»ºï¼š<code>/apis/stable.example.com/v1/namespaces/*/crontabs/...</code>ï¼Œç”¨ä»¥åˆ›å»ºå’Œç®¡ç†CustomResource <code>CronTab</code>ã€‚åœ¨åˆ›å»ºCRDæ—¶ï¼ŒKubernetes ä¼šå¯¹æˆ‘ä»¬æäº¤çš„å£°æ˜æ–‡ä»¶è¿›è¡Œæ ¡éªŒï¼ˆåŸºäº OpenAPI v3 schem è¿›è¡Œè§„èŒƒï¼‰ã€‚å¦‚æœæƒ³è¦æ›´åŠ å¤æ‚çš„æ ¡éªŒï¼Œéœ€è¦é€šè¿‡ Kubernetes çš„ admission webhook è¿›è¡Œå®ç°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f crd.yaml
</code></pre></div><p>åˆ›å»ºå®ŒCRDåï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®šä¹‰ä¸€ä¸ªCronTabèµ„æºå¯¹è±¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: <span style="color:#e6db74">&#34;stable.example.com/v1&#34;</span>
<span style="color:#66d9ef">kind</span>: CronTab
metadata:
  <span style="color:#66d9ef">name</span>: my-cron-object
spec:
  <span style="color:#66d9ef">cronSpec</span>: <span style="color:#e6db74">&#34;* * * * */5&#34;</span>
  <span style="color:#66d9ef">image</span>: my-image
</code></pre></div><p>åˆ›å»ºå®ŒCronTabèµ„æºå¯¹è±¡åï¼Œå°±å¯ä»¥é€šè¿‡kubectlæ¥ç®¡ç†è‡ªå®šä¹‰èµ„æºå¯¹è±¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-BASH" data-lang="BASH">$ kubectl get crontab
NAME          AGE
my-cron-tab   93s
$ kubectl get crontab -o yaml
...
</code></pre></div><h2 id="å¦‚ä½•åˆ›å»ºcustom-controllersample-controllerç¤ºä¾‹">å¦‚ä½•åˆ›å»ºCustom Controllerï¼ˆsample-controllerç¤ºä¾‹ï¼‰</h2>
<blockquote>
<p>å‚è€ƒï¼š</p>
<p>kuberneteså®˜æ–¹Custom Controllerç¤ºä¾‹ï¼š<a href="https://github.com/kubernetes/sample-controller">https://github.com/kubernetes/sample-controller</a></p>
</blockquote>
<p>ç¤ºä¾‹æ¼”ç¤ºäº†ï¼š</p>
<ul>
<li>å¦‚ä½•ä½¿ç”¨ CustomResourceDefinitionæ³¨å†Œç±»å‹çš„æ–°è‡ªå®šä¹‰èµ„æºï¼ˆè‡ªå®šä¹‰èµ„æºç±»å‹ï¼‰<code>Foo</code></li>
<li>å¦‚ä½•åˆ›å»º/è·å–/åˆ—å‡ºæ–°èµ„æºç±»å‹çš„å®ä¾‹<code>Foo</code></li>
<li>å¦‚ä½•åŸºäºæ§åˆ¶å™¨å¤„ç†èµ„æº<code>Foo</code>åˆ›å»º/æ›´æ–°/åˆ é™¤äº‹ä»¶</li>
</ul>
<p>ç¤ºä¾‹æ§åˆ¶å™¨åŸºäº<a href="https://github.com/kubernetes/client-go/tree/master/tools/cache">client-go åº“</a> è¿›è¡ŒControllerå¼€å‘ï¼›è¯¥é¡¹ç›®çš„tools/cacheç›®å½•ä¸‹åŒ…å«äº†å¼€å‘Custom Controller ä½¿ç”¨çš„å„ç§å·¥å…·ã€æœºåˆ¶ã€‚</p>
<h3 id="client-go-clientå¯¹è±¡">Client-go Clientå¯¹è±¡</h3>
<ul>
<li><strong>RESTClient</strong>ï¼šclient-go ä¸­æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œå…¶å®ƒ client éƒ½åŸºäº RESTClient å®ç°ï¼ŒRESTClient å®ç°äº† RESTful é£æ ¼çš„ API è¯·æ±‚å°è£…ï¼Œå¯ä»¥å®ç°å¯¹ä»»æ„ Kubernetes èµ„æºï¼ˆåŒ…æ‹¬å†…ç½®èµ„æºåŠ CRDsï¼‰çš„ RESTful é£æ ¼äº¤äº’ï¼Œå¦‚ Post() / Delete() / Put() / Get()ï¼ŒåŒæ—¶æ”¯æŒ Json å’Œ protobufï¼›</li>
<li><strong>ClientSet</strong>ï¼šä¸ Kubernetes å†…ç½®èµ„æºå¯¹è±¡äº¤äº’æœ€å¸¸ç”¨çš„ Clientï¼Œå¼ºè°ƒåªèƒ½å¤„ç† Kubernetes å†…ç½®èµ„æºï¼Œä¸åŒ…æ‹¬ CRD è‡ªå®šä¹‰èµ„æºï¼Œä½¿ç”¨æ—¶éœ€è¦æŒ‡å®š Groupã€æŒ‡å®š Versionï¼Œç„¶åæ ¹æ® Resource è·å–ã€‚ClientSet çš„æ“ä½œä»£ç æ˜¯é€šè¿‡ client-gen ä»£ç ç”Ÿæˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„ï¼›</li>
<li><strong>DynamicClient</strong>ï¼šDynamicClient èƒ½å¤„ç†åŒ…æ‹¬ CRD è‡ªå®šä¹‰èµ„æºåœ¨å†…çš„ä»»æ„ kubernetes èµ„æºã€‚å¦‚æœä¸€ä¸ª Controller ä¸­éœ€è¦æ§åˆ¶æ‰€æœ‰çš„ APIï¼Œå¯ä»¥ä½¿ç”¨Dynamic Clientï¼ŒDynamicClient åªæ”¯æŒJSONï¼›</li>
<li><strong>DiscoveryClient</strong>ï¼šç”¨äºå‘ç° kube-apiserver æ”¯æŒçš„ Group / Version / Resource ä¿¡æ¯ï¼›</li>
</ul>
<h3 id="client-go-ç»„ä»¶å·¥ä½œæµç¨‹ä¸ä»¥åŠä¸custom-controllerçš„äº¤äº’ç‚¹">Client-go ç»„ä»¶å·¥ä½œæµç¨‹ä¸ä»¥åŠä¸Custom Controllerçš„äº¤äº’ç‚¹</h3>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/cfa0d775b85ab574725f9a5714e61a0e_MD5.png">
    <img src="/attachment/cfa0d775b85ab574725f9a5714e61a0e_MD5.png" alt="image"  />
    </a>
</div></p>
<p><strong>client-goç»„ä»¶ï¼š</strong></p>
<ul>
<li><strong>Reflector</strong>ï¼šé€šè¿‡ Kubernetes API ç›‘æ§ Kubernetes çš„èµ„æºç±»å‹ï¼Œé€šè¿‡List/Watch æœºåˆ¶, è·å–&amp;ç›‘å¬èµ„æºå¯¹è±¡å®ä¾‹çš„å˜åŒ–ï¼Œæ·»åŠ  object å¯¹è±¡åˆ° FIFO é˜Ÿåˆ—ï¼Œåç»­Informer ä¼šä»é˜Ÿåˆ—ä¸­è¿›è¡Œæ•°æ®è·å–ã€‚</li>
<li><strong>Informer</strong>ï¼šcontroller æœºåˆ¶çš„åŸºç¡€ï¼Œæ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰å¤„ç†ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼Œæ·»åŠ åˆ° Indexer è¿›è¡Œæ•°æ®ç¼“å­˜ï¼Œæä¾›å¯¹è±¡ç›‘å¬äº‹ä»¶å›è°ƒå¤„ç†çš„ handler æ¥å£ï¼Œé€šè¿‡ ç»™Informer æ·»åŠ  ResourceEventHandler å®ä¾‹çš„å›è°ƒå‡½æ•°ï¼Œé€šè¿‡å®ç°OnAdd(obj interface{})ã€ OnUpdate(oldObj, newObj interface{}) å’Œ OnDelete(obj interface{}) æ–¹æ³•å¤„ç†èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚</li>
<li><strong>Indexer</strong>ï¼šæä¾› object å¯¹è±¡çš„ç´¢å¼•ï¼Œç¼“å­˜å¯¹è±¡ä¿¡æ¯ï¼Œindexeræ˜¯çº¿ç¨‹å®‰å…¨çš„å­˜å‚¨ã€‚</li>
</ul>
<p><strong>Custom Controllerç»„ä»¶ï¼š</strong></p>
<ul>
<li><strong>Informerä¸Indexerçš„reference</strong>ï¼š é€šè¿‡client-go æä¾›çš„<code>NewIndexerInformer</code>å‡½æ•°è¿›è¡Œåˆ›å»ºã€‚</li>
<li><strong>Resource Event Handlers</strong>ï¼šInformeråœ¨è¦å°†object å¯¹è±¡ä¼ é€’ç»™Custom Controller æ—¶å°†è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼ŒResource Event Handlers è¢«å›è°ƒåä¼šå°†Object Keyå†™å…¥åˆ°Work queueä¸­ã€‚</li>
<li><strong>Process Item</strong>ï¼šä»Work queueä¸­å–å‡ºObject keyï¼ˆäº‹ä»¶é€šçŸ¥ï¼‰ è¿›è¡Œåç»­å¤„ç†ã€‚</li>
</ul>
<h3 id="simaple-controlleræ ¸å¿ƒé€»è¾‘">Simaple-controlleræ ¸å¿ƒé€»è¾‘</h3>
<ul>
<li>é¡¹ç›®ç»“æ„</li>
</ul>
<pre><code>â””â”€â”€ sample-controller
    â”œâ”€â”€ artifacts 				# yamlç¤ºä¾‹ï¼Œå¦‚crd.yamlã€example-foo.yaml
    â”‚   â””â”€â”€ examples
    â”œâ”€â”€ code-of-conduct.md
    â”œâ”€â”€ CONTRIBUTING.md
    â”œâ”€â”€ controller.go			# custom controllerå®ç°ï¼Œæ ¸å¿ƒé€»è¾‘
    â”œâ”€â”€ controller_test.go
    â”œâ”€â”€ docs
    â”‚   â”œâ”€â”€ controller-client-go.md
    â”‚   â””â”€â”€ images
    â”œâ”€â”€ go.mod
    â”œâ”€â”€ go.sum
    â”œâ”€â”€ hack					# code generation å·¥å…·ç±»
    â”‚   â”œâ”€â”€ boilerplate.go.txt
    â”‚   â”œâ”€â”€ custom-boilerplate.go.txt
    â”‚   â”œâ”€â”€ tools.go
    â”‚   â”œâ”€â”€ update-codegen.sh
    â”‚   â””â”€â”€ verify-codegen.sh
    â”œâ”€â”€ LICENSE
    â”œâ”€â”€ main.go					# å¯åŠ¨å‡½æ•°ï¼Œå‚æ•°é…ç½®ä¸åˆå§‹åŒ–é€»è¾‘
    â”œâ”€â”€ OWNERS
    â”œâ”€â”€ pkg						# èµ„æºå®šä¹‰æ–‡ä»¶ä¸è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç 
    â”‚   â”œâ”€â”€ apis
    â”‚   â”œâ”€â”€ generated
    â”‚   â””â”€â”€ signals
    â”œâ”€â”€ README.md
    â””â”€â”€ SECURITY_CONTACTS
</code></pre><ul>
<li>åŠŸèƒ½</li>
</ul>
<p>ä½¿ç”¨ Custom Resource <code>Foo</code> çš„deploymentNameã€replicas å±æ€§ä¸Custom Resource Controller åˆ›å»ºã€æ›´æ–° Deploymentã€‚</p>
<ul>
<li>ä»£ç ç”Ÿæˆ</li>
</ul>
<p>æ­¤é¡¹ç›®åˆ©ç”¨<a href="https://github.com/kubernetes/code-generator">k8s.io/code-generator</a>ä¸­çš„ç”Ÿæˆå™¨ æ¥ç”Ÿæˆtyped clientã€informersã€listers å’Œdeep-copy functionsã€‚è‡ªåŠ¨ç”Ÿæˆäº†å¦‚ä¸‹æ–‡ä»¶ä¸ç›®å½•</p>
<p><code>pkg/apis/samplecontroller/v1alpha1/zz_generated.deepcopy.go</code></p>
<p><code>pkg/generated/</code></p>
<ul>
<li>æ ¸å¿ƒé€»è¾‘-main.goï¼ˆpseudocodeï¼‰</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">// åˆ›å»ºclientsetï¼ŒkubeClient(æ“ä½œé™¤è‡ªå®šä¹‰èµ„æºç»„å¤–çš„å…¶ä»–èµ„æº)ã€exampleClient(æ“ä½œè‡ªå®šä¹‰èµ„æºç»„)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#a6e22e">masterURL</span>, <span style="color:#a6e22e">kubeconfig</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error building kubeconfig: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}

	<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;error building kubernetes clientset: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}

	<span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error building example clientset: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}
	<span style="color:#75715e">// åˆ›å»ºInformer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kubeInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubeinformers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)
	<span style="color:#a6e22e">exampleInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)

	<span style="color:#75715e">// åˆ›å»º controllerï¼Œä¼ å…¥ clientset å’Œ informer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewController</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">exampleClient</span>,
		<span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Deployments</span>(),
		<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Samplecontroller</span>().<span style="color:#a6e22e">V1alpha1</span>().<span style="color:#a6e22e">Foos</span>())

	<span style="color:#75715e">// è¿è¡Œ Informerï¼ŒStartæ–¹æ³•éé˜»å¡ï¼Œè¿è¡Œåœ¨å•ç‹¬çš„ goroutine ä¸­
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)
	<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)
	
	<span style="color:#75715e">//è¿è¡ŒCustom Controller
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">stopCh</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error running controller: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}
}
</code></pre></div><ul>
<li>æ ¸å¿ƒé€»è¾‘controller.go ï¼ˆpseudocodeï¼‰</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">*** main.go
</span><span style="color:#75715e">*/</span>
<span style="color:#75715e">// åˆ›å»º clientset
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)		<span style="color:#75715e">// k8s clientset, &#34;k8s.io/client-go/kubernetes&#34;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)	<span style="color:#75715e">// sample clientset, &#34;k8s.io/sample-controller/pkg/generated/clientset/versioned&#34;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// åˆ›å»º Informer
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubeInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubeinformers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)		<span style="color:#75715e">// k8s informer, &#34;k8s.io/client-go/informers&#34;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">exampleInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)		<span style="color:#75715e">// sample informer, &#34;k8s.io/sample-controller/pkg/generated/informers/externalversions&#34;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// åˆ›å»º controllerï¼Œä¼ å…¥ clientset å’Œ informer
</span><span style="color:#75715e"></span><span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewController</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">exampleClient</span>,
		<span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Deployments</span>(),
		<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Samplecontroller</span>().<span style="color:#a6e22e">V1alpha1</span>().<span style="color:#a6e22e">Foos</span>())

<span style="color:#75715e">// è¿è¡Œ Informerï¼ŒStart æ–¹æ³•ä¸ºéé˜»å¡ï¼Œä¼šè¿è¡Œåœ¨å•ç‹¬çš„ goroutine ä¸­
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)
<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)

<span style="color:#75715e">// è¿è¡Œ controller
</span><span style="color:#75715e"></span><span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">stopCh</span>)

<span style="color:#75715e">/*
</span><span style="color:#75715e">*** controller.go 
</span><span style="color:#75715e">*/</span>
<span style="color:#a6e22e">NewController</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span> {}
	<span style="color:#75715e">// å°† CRD èµ„æºç±»å‹å®šä¹‰åŠ å…¥åˆ° Kubernetes çš„ Scheme ä¸­ï¼Œä»¥ä¾¿ Events å¯ä»¥è®°å½• CRD çš„äº‹ä»¶
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">Must</span>(<span style="color:#a6e22e">samplescheme</span>.<span style="color:#a6e22e">AddToScheme</span>(<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">Scheme</span>))

	<span style="color:#75715e">//åˆ›å»º Event Broadcaster
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">eventBroadcaster</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">NewBroadcaster</span>()
	<span style="color:#75715e">// ... ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// ç›‘å¬ CRD ç±»å‹Fooå˜åŒ–å¹¶æ³¨å†Œ ResourceEventHandleræ–¹æ³•ï¼Œå½“Fooçš„å®ä¾‹å˜åŒ–æ—¶è·å–Fooèµ„æºå¹¶å°†å…¶è½¬æ¢ä¸º namespace/nameå­—ç¬¦(Key)ï¼Œç„¶åå°†å…¶æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fooInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">enqueueFoo</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">enqueueFoo</span>(<span style="color:#a6e22e">new</span>)
		},
	})

	<span style="color:#75715e">// ç›‘å¬Deploymentå˜åŒ–å¹¶æ³¨å†ŒResourceEventHandleræ–¹æ³•ï¼Œ
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// å½“å®ƒçš„ ownerReferences ä¸º Foo ç±»å‹å®ä¾‹æ—¶ï¼Œå°†è¯¥Fooèµ„æºåŠ å…¥ work queue
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">deploymentInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">newDepl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">new</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>)
			<span style="color:#a6e22e">oldDepl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">old</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">newDepl</span>.<span style="color:#a6e22e">ResourceVersion</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">oldDepl</span>.<span style="color:#a6e22e">ResourceVersion</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>(<span style="color:#a6e22e">new</span>)
		},
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>,
	})

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">threadiness</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {}
	<span style="color:#75715e">// åœ¨å¯åŠ¨ worker å‰ç­‰å¾…ç¼“å­˜åŒæ­¥
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">WaitForCacheSync</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">deploymentsSynced</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">foosSynced</span>); !<span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to wait for caches to sync&#34;</span>)
	}
	<span style="color:#75715e">// è¿è¡Œä¸¤ä¸ª worker æ¥å¤„ç†èµ„æº
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">runWorker</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	}
	<span style="color:#75715e">// ä¸æ–­çš„è°ƒç”¨ processNextWorkItem å¤„ç†ä¸‹ä¸€ä¸ªå¯¹è±¡
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">runWorker</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processNextWorkItem</span>() {
		}
	}
	<span style="color:#75715e">// ä»workqueueä¸­è·å–ä¸‹ä¸€ä¸ªå¯¹è±¡å¹¶è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡è°ƒç”¨ syncHandler
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">processNextWorkItem</span>() <span style="color:#66d9ef">bool</span> {
        <span style="color:#75715e">//ä»workqueueè·å–obj
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">shutdown</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Get</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shutdown</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
		}
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
			<span style="color:#75715e">// è°ƒç”¨ workqueue.Done(obj) æ–¹æ³•å‘Šè¯‰ workqueue å½“å‰é¡¹å·²ç»å¤„ç†å®Œæ¯•ï¼Œ
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¦‚æœæˆ‘ä»¬ä¸æƒ³è®©å½“å‰é¡¹é‡æ–°å…¥é˜Ÿï¼Œå°±éœ€è¦è°ƒç”¨ workqueue.Forget(obj)ã€‚
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// å½“æˆ‘ä»¬æ²¡æœ‰è°ƒç”¨Forgetæ—¶ï¼Œå½“å‰é¡¹ä¼šé‡æ–°å…¥é˜Ÿ workqueue å¹¶åœ¨ä¸€æ®µæ—¶é—´åé‡æ–°è¢«è·å–ã€‚
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Done</span>(<span style="color:#a6e22e">obj</span>)
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>
			<span style="color:#75715e">// æ ¼å¼æ ¡éªŒï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯ key &#39;namespace/name&#39; æ ¼å¼çš„ string
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">obj</span>.(<span style="color:#66d9ef">string</span>); !<span style="color:#a6e22e">ok</span> {
				<span style="color:#75715e">// æ— æ•ˆçš„é¡¹è°ƒç”¨Forgetæ–¹æ³•ï¼Œé¿å…é‡æ–°å…¥é˜Ÿã€‚
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">obj</span>)
				<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expected string in workqueue but got %#v&#34;</span>, <span style="color:#a6e22e">obj</span>))
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}
            <span style="color:#75715e">//è¿è¡Œ syncHandlerï¼Œä¼ é€’Fooèµ„æºçš„namespace/nameå­—ç¬¦ä¸²
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">syncHandler</span>(<span style="color:#a6e22e">key</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#75715e">// æ”¾å›workqueueé¿å…å¶å‘çš„å¼‚å¸¸
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">AddRateLimited</span>(<span style="color:#a6e22e">key</span>)
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error syncing &#39;%s&#39;: %s, requeuing&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			}
            
			<span style="color:#75715e">// å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼ŒForgetå½“å‰é¡¹ï¼ŒåŒæ­¥æˆåŠŸ
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">obj</span>)
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Successfully synced &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">key</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}(<span style="color:#a6e22e">obj</span>)
        
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}
	<span style="color:#75715e">// å°†å®é™…çŠ¶æ€ä¸æœŸæœ›çš„çŠ¶æ€è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åå°è¯•å°†ä¸¤è€…æ”¶æ•›ï¼Œç„¶åå®ƒç”¨èµ„æºçš„å½“å‰çŠ¶æ€æ›´æ–°Fooèµ„æºçš„Statuså—ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">syncHandler</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#75715e">// é€šè¿‡ workqueue ä¸­çš„ key è§£æå‡º namespace å’Œ name
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SplitMetaNamespaceKey</span>(<span style="color:#a6e22e">key</span>)
		<span style="color:#75715e">// è°ƒç”¨ lister æ¥å£é€šè¿‡ namespace å’Œ name è·å– Foo å®ä¾‹
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">foosLister</span>.<span style="color:#a6e22e">Foos</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span>)
		<span style="color:#a6e22e">deploymentName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">DeploymentName</span>
		<span style="color:#75715e">// è·å– Foo å®ä¾‹ä¸­å®šä¹‰çš„ deploymentname
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">deploymentsLister</span>.<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">deploymentName</span>)
		<span style="color:#75715e">//å¦‚æœæ²¡æœ‰å‘ç°å¯¹åº”çš„ deploymentï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„deploymentã€‚å¹¶è¿˜åœ¨èµ„æºä¸Šè®¾ç½®é€‚å½“çš„ OwnerReferencesï¼Œä»¥ä¾¿ handleObject å¯ä»¥å‘ç°â€œæ‹¥æœ‰â€å®ƒçš„ Foo èµ„æºã€‚
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
			<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">newDeployment</span>(<span style="color:#a6e22e">foo</span>))
		}
		<span style="color:#75715e">// deployment OwnerReferences ä¸æ˜¯ Foo å®ä¾‹ï¼Œwarningå¹¶è¿”å›é”™è¯¯
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">IsControlledBy</span>(<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">foo</span>) {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">MessageResourceExists</span>, <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recorder</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#a6e22e">ErrResourceExists</span>, <span style="color:#a6e22e">msg</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">msg</span>)
		}
		<span style="color:#75715e">// deployment ä¸­ çš„é…ç½®å’Œ Foo å®ä¾‹ä¸­ Spec çš„é…ç½®ä¸ä¸€è‡´ï¼Œå³æ›´æ–° deployment
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> {
			<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">newDeployment</span>(<span style="color:#a6e22e">foo</span>))
		}
		<span style="color:#75715e">// æ›´æ–° Foo å®ä¾‹çŠ¶æ€
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">updateFooStatus</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">deployment</span>)
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recorder</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#a6e22e">SuccessSynced</span>, <span style="color:#a6e22e">MessageResourceSynced</span>)
	}
</code></pre></div><ul>
<li>è¿è¡Œ</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assumes you have a working kubeconfig, not required if operating in-cluster</span>
go build -o sample-controller .
./sample-controller -kubeconfig<span style="color:#f92672">=</span>$HOME/.kube/config

<span style="color:#75715e"># create a CustomResourceDefinition</span>
kubectl create -f artifacts/examples/crd-status-subresource.yaml

<span style="color:#75715e"># create a custom resource of type Foo</span>
kubectl create -f artifacts/examples/example-foo.yaml

<span style="color:#75715e"># check deployments created through the custom resource</span>
kubectl get deployments
</code></pre></div><h2 id="kubernetes-controller-é—´é€šè®¯æ–¹å¼">Kubernetes Controller é—´é€šè®¯æ–¹å¼</h2>
<p>Kubernetes ä¸‰å¤§æ ¸å¿ƒç»„å»ºä¹‹ä¸€çš„kube-controller-managerï¼Œæ˜¯è¿è¡ŒControllerç»„å»ºè¿›ç¨‹çš„æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ŒåŒ…å«äº†å¦‚ä¸‹Controlleré›†åˆ</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/f7885d0580012f0d263529c03e888751_MD5.png">
    <img src="/attachment/f7885d0580012f0d263529c03e888751_MD5.png" alt="image"  />
    </a>
</div></p>
<p>Kubernetesä¸­ä¸åŒçš„Controlleré—´ä¹Ÿä¼šè¿›è¡Œé€šè®¯ï¼Œä»¥Deployment Controllerä¸ºä¾‹å­ï¼š</p>
<ol>
<li>ç”¨æˆ·é€šè¿‡ Kubectl åˆ›å»º Deploymentï¼ŒAPIServeræ¥æ”¶åˆ°è¯·æ±‚åä¼šå¯¹è¯¥è¯·æ±‚è¿›è¡Œæƒé™ã€å‡†å…¥æ ¡éªŒï¼Œé‰´æƒé€šè¿‡åå°† Deployment çš„èµ„æºä¿¡æ¯å­˜å‚¨åˆ° Etcdä¸­ã€‚</li>
<li>Deployment Controller åŸºäºList/Watchæœºåˆ¶ï¼Œæ”¶åˆ°Deploymentèµ„æºçš„Addäº‹ä»¶å¹¶å¤„ç†ï¼Œä¸ºè¯¥ Deployment åˆ›å»º Replicasetã€‚</li>
<li>APIServer æ¥æ”¶åˆ° Replicasetåˆ›å»ºè¯·æ±‚åï¼ŒReplicasetçš„Addäº‹ä»¶å°†è¢«å‘å¸ƒï¼ŒéšåReplicaSet Controlleræ¥æ”¶åˆ°è¯¥äº‹ä»¶ï¼Œè¿›è¡Œå¯¹åº”çš„å¤„ç†é€»è¾‘ï¼šåˆ›å»º Podã€‚</li>
</ol>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="/attachment/910ac006937aa999feacf8a1eaa433f6_MD5.png">
    <img src="/attachment/910ac006937aa999feacf8a1eaa433f6_MD5.png" alt="image"  />
    </a>
</div></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒKubernetes ControlleråŸºäºäº‹ä»¶è®¢é˜…-åˆ†å‘çš„å·¥ä½œæ–¹å¼ï¼Œè¿›è¡ŒControlleré—´çš„é€šä¿¡ã€åè°ƒæ“ä½œï¼›ä¹Ÿå› ä¸ºå…¶å¼€æ”¾çš„å·¥ä½œæœºåˆ¶ï¼Œè®©æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„å®šåˆ¶ã€å¼€å‘è‡ªå·±çš„Custom Controllerã€‚</p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kubernetesæ¶æ„è®¾è®¡">Kubernetesæ¶æ„è®¾è®¡</a>
          <ul>
            <li><a href="#kubernetesæ ¸å¿ƒç»„ä»¶">Kubernetesæ ¸å¿ƒç»„ä»¶</a></li>
            <li><a href="#kubernetesæ‰©å±•æ€§">Kubernetesæ‰©å±•æ€§</a></li>
          </ul>
        </li>
        <li><a href="#æ‰©å±•kubernetes-api-resourceç›¸å…³æ¦‚å¿µ">æ‰©å±•Kubernetes API Resourceç›¸å…³æ¦‚å¿µ</a></li>
        <li><a href="#kubernetes-çš„-resource-è®¾è®¡æ¦‚å¿µ">Kubernetes çš„ Resource è®¾è®¡æ¦‚å¿µ</a>
          <ul>
            <li><a href="#groupversionresource">Group/Version/Resource</a></li>
            <li><a href="#group">Group</a></li>
            <li><a href="#version">Version</a></li>
            <li><a href="#resouce">Resouce</a></li>
            <li><a href="#èµ„æºæ“ä½œæ–¹æ³•">èµ„æºæ“ä½œæ–¹æ³•</a></li>
          </ul>
        </li>
        <li><a href="#å¦‚ä½•åˆ›å»ºcrd">å¦‚ä½•åˆ›å»ºCRD</a></li>
        <li><a href="#å¦‚ä½•åˆ›å»ºcustom-controllersample-controllerç¤ºä¾‹">å¦‚ä½•åˆ›å»ºCustom Controllerï¼ˆsample-controllerç¤ºä¾‹ï¼‰</a>
          <ul>
            <li><a href="#client-go-clientå¯¹è±¡">Client-go Clientå¯¹è±¡</a></li>
            <li><a href="#client-go-ç»„ä»¶å·¥ä½œæµç¨‹ä¸ä»¥åŠä¸custom-controllerçš„äº¤äº’ç‚¹">Client-go ç»„ä»¶å·¥ä½œæµç¨‹ä¸ä»¥åŠä¸Custom Controllerçš„äº¤äº’ç‚¹</a></li>
            <li><a href="#simaple-controlleræ ¸å¿ƒé€»è¾‘">Simaple-controlleræ ¸å¿ƒé€»è¾‘</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes-controller-é—´é€šè®¯æ–¹å¼">Kubernetes Controller é—´é€šè®¯æ–¹å¼</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2025 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
