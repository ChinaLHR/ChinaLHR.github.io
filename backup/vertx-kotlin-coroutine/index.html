<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Vertx Kotlin协程</title>
    <meta name="description" content="keep curious 😼">
    <meta name="keywords" content='blog, chinalhr, lhr'>

    <meta property="og:url" content="https://chinalhr.github.io/backup/vertx-kotlin-coroutine/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Vertx Kotlin协程">
    <meta property="og:description" content="keep curious 😼">
    <meta property="og:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vertx Kotlin协程">
    <meta name="twitter:description" content="keep curious 😼">
    <meta property="twitter:domain" content="https://chinalhr.github.io/backup/vertx-kotlin-coroutine/">
    <meta property="twitter:url" content="https://chinalhr.github.io/backup/vertx-kotlin-coroutine/">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg">

    
    <link rel="canonical" href="https://chinalhr.github.io/backup/vertx-kotlin-coroutine/" />

    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://chinalhr.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://chinalhr.github.io//css/dark.css">

    <script src="https://chinalhr.github.io//js/svg-injector.min.js"></script>
    <script src="https://chinalhr.github.io//js/feather-icons.min.js"></script>
    <script src="https://chinalhr.github.io//js/main.js"></script>

    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLJBQBW5WM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JLJBQBW5WM');
</script>
  
    
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://chinalhr.github.io/">
                <img src="https://user-images.githubusercontent.com/19829495/188320707-5b468cc9-bea4-486c-b591-57ff8324e41c.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://chinalhr.github.io/">LHR</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/post/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/chinalhr"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://chinalhr.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Vertx Kotlin协程</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            May 23, 2019
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <blockquote>
<p>Vert.x 利用 Kotlin协程特性优雅编写异步逻辑</p>
</blockquote>
<h3 id="关于协程">关于协程</h3>
<p>协程通过将复杂性放入库来简化异步编程。程序的逻辑可以在协程中顺序地表达，而底层库会为我们解决其异步性。使用协程库将用户代码的相关部分包装为回调、订阅相关事件、在不同线程（甚至不同机器）上调度执行，而代码则保持如同顺序执行一样简单。</p>
<p>轻量级的线程。线程是由系统调度的，线程切换或线程阻塞的开销都比较大。而协程依赖于线程，但是协程挂起时不需要阻塞线程，几乎是无代价的，协程是由开发者控制的。所以协程也像用户态的线程，非常轻量级，一个线程中可以创建任意个协程。</p>
<h3 id="kotlin协程">Kotlin协程</h3>
<ul>
<li>suspend</li>
</ul>
<p>suspend修饰符标记，修饰挂起函数。挂起函数能够以与普通函数相同的方式获取参数和返回值，但是调用函数可能挂起协程（如果相关调用的结果已经可用，库可以决定继续进行而不挂起），挂起函数挂起协程时，不会阻塞协程所在的线程。挂起函数执行完成后会恢复协程，后面的代码才会继续执行。</p>
<p>挂起函数只能在协程中或其他挂起函数中调用(launch函数创建协程)</p>
<ul>
<li>CoroutineScope</li>
</ul>
<p>协程本身</p>
<ul>
<li>CoroutineContext</li>
</ul>
<p>协程上下文，包括 Job 和 CoroutineDispatcher 元素，可以代表一个协程的场景。</p>
<ul>
<li>CoroutineDispatcher</li>
</ul>
<p>协程调度器，决定协程所在的线程或线程池。标准实现Dispatchers.Default、Dispatchers.IO，Dispatchers.Main和Dispatchers.Unconfined</p>
<pre><code>- Default一般用于 CPU 密集型的任务,特别是涉及到计算、算法的场景。它可以使用和 CPU 核数一样多的线程。
- IO一般用于输入/输出的场景。通常，涉及到会阻塞线程，需要等待另一个系统响应的任务，比如：网络请求、数据库操作、文件读写等，都可以使用它。因为它不使用 CPU ，可以同一时间运行多个线程，默认是数量为 64 的线程池。
- Main使用UI线程/主线程
- UnConfined不指定线程，使用的线程是不可控的
</code></pre>
<ul>
<li>Coroutine builders</li>
</ul>
<p>协程构建器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#75715e">//launch不阻塞当前线程，在后台创建一个新协程
</span><span style="color:#75715e">//context 指定调度器 start 启动模式[CoroutineStart.DEAFAULT,LAZY(延迟启动)]
</span><span style="color:#75715e"></span> GlobalScope.launch(Dispatchers.Main) {
    <span style="color:#75715e">//suspend fun
</span><span style="color:#75715e"></span> }
 
 <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#66d9ef">val</span> job = GlobalScope.launch(start = CoroutineStart.LAZY) {
            println(<span style="color:#e6db74">&#34;World!&#34;</span>)
        }
        println(<span style="color:#e6db74">&#34;Hello,&#34;</span>)
        job.start()
        Thread.sleep(<span style="color:#ae81ff">2000L</span>)
    }

<span style="color:#75715e">//runBlocking {}是创建一个新的协程同时阻塞当前线程
</span><span style="color:#75715e"></span>runBlocking {
      launch { 
        <span style="color:#75715e">//suspend fun
</span><span style="color:#75715e"></span>    }
}

<span style="color:#75715e">//withContext不会创建新的协程，在指定协程上运行挂起代码块，并挂起该协程直至代码块运行完成
</span><span style="color:#75715e"></span>withContext {}

<span style="color:#75715e">//async和launch 一个效果，但是有返回值
</span><span style="color:#75715e"></span>CoroutineScope.async {}
</code></pre></div><ul>
<li>Job &amp; Deferred</li>
</ul>
<p>launch 方法会返回一个 Job，Job 继承了协程上下文（CoroutineContext）。</p>
<p>async方法返回一个Deferred 允许并行地运行多个子线程任务，它不是一个可中断方法，所以当调用 async 启动子协程的同时，后面的代码也会立即执行。async 通常需要运行在另外一个协程内部，它会返回一个特殊的 Job，叫作 Deferred。</p>
<p>Job没有返回值，Deferred有返回值。一个Job可以有一个父Job，父Job可以控制子Job。</p>
<p>Job封装了协程中需要执行的代码逻辑。生命周期如下:</p>
<p>
<div class="post-img-view">
    <a data-fancybox="gallery" data-src="https://user-images.githubusercontent.com/19829495/58104450-64475800-7c17-11e9-8ed4-cc54edbc9e59.png">
    <img src="https://user-images.githubusercontent.com/19829495/58104450-64475800-7c17-11e9-8ed4-cc54edbc9e59.png" alt="enter description here"  />
    </a>
</div></p>
<p><strong>Job相关方法</strong>：</p>
<pre><code>- job.join(中断与当前 Job 关联的协程，直到所有子 Job 执行完成)
- job.cancel(取消所有与其关联的子 Job)
</code></pre>
<p><strong>Deferred方法</strong>
- await(当我们需要获取 async 的结果时，需要调用 await() 方法等待结果。调用 await() 方法后，会中断当前协程，直到其返回结果)</p>
<h3 id="vertx-使用协程避免callback-hell">Vertx 使用协程避免Callback Hell</h3>
<p>vert.x的非阻塞特性导致需要编写非阻塞API。vert.x的核心API使用回调函数的风格，也可以使用发布-订阅模型的RxJava。异步的API编程比同步的更复杂更容易出错，而且不可避免
Callback Hell。</p>
<p>使用vertx-lang-kotlin-coroutines，编写同步风格的异步代码</p>
<p><a href="https://github.com/ChinaLHR/vertx-kotlin-scaffold.git">示例</a></p>
        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#关于协程">关于协程</a></li>
            <li><a href="#kotlin协程">Kotlin协程</a></li>
            <li><a href="#vertx-使用协程避免callback-hell">Vertx 使用协程避免Callback Hell</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 hanrong.li</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
